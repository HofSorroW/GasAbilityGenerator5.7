# Dialogue Table Editor - v4.1 Handoff Document

## Overview
The Dialogue Table Editor is a batch dialogue creation tool for the GasAbilityGenerator plugin. It provides an Excel-like interface for creating dialogue trees that generate Narrative Pro DBP_ assets.

---

## Current State (v4.1)

### Implemented Features
- **9-column table**: Seq, DialogueID, NodeID, NodeType, Speaker, Text, OptionText, Parent, NextNodes
- **FillWidth columns**: Proportional widths filling full screen
- **Live filtering**: OnTextChanged (no Enter required)
- **Per-column filtering**: Dropdown + text input at each header
- **CSV Import/Export**: RFC 4180 compliant parsing (handles quoted fields with commas)
- **Seq column**: Shows sequence numbers (currently not following tree flow correctly)
- **Reset Flow Order button**: Exists but not working correctly
- **Validation**: Checks for missing parents, orphan nodes, required fields

### Files
- `SDialogueTableEditor.h` - Widget definitions, FDialogueTableRowEx struct
- `SDialogueTableEditor.cpp` - Full implementation (~1200 lines)
- `DialogueTableEditorTypes.h` - FDialogueTableRow, UDialogueTableData
- `DialogueTableConverter.h/cpp` - Row-to-manifest conversion (stub)
- `DialogueTableValidator.h/cpp` - Validation rules

### Sample Data
- `C:\Users\Erdem\OneDrive\Desktop\DialogueTable_Sample.csv`
- Contains DBP_Seth (14 nodes) and DBP_Marco (14 nodes)
- Full dialogue trees with branching player options

---

## Issues Identified (Session Feedback)

### 1. Flow Order Not Following Dialogue Tree
**Problem**: Reset Flow Order groups by NodeType (all NPCs then all Players) instead of following actual dialogue tree traversal.

**Expected Flow**:
```
1. root (NPC) - "Hello traveler!"
2. player_greet (Player) - child of root
3. seth_greet_response (NPC) - child of player_greet
4. player_thanks (Player) - child of seth_greet_response
5. seth_farewell (NPC) - child of player_thanks
... etc (depth-first tree traversal)
```

**Current Behavior**: Sorts alphabetically or by type, destroying dialogue flow.

**Fix Required**: Implement proper tree traversal in `CalculateSequences()`:
- Start from root nodes (ParentNodeID is empty)
- Depth-first traversal following NextNodeIDs
- Sequence numbers reflect conversation flow

### 2. Player Speaker Shows "None"
**Problem**: Player node types show empty/None in Speaker column.

**Expected**: Should show "Player" or a player identifier.

**Fix Required**: In `CreateFNameCell()` or display logic, show "Player" when NodeType is Player and Speaker is empty.

### 3. Add Node Behavior
**Problem**: Add Node adds to end of table - inefficient workflow.

**Expected Behavior**:
- Insert new row below selected row
- Auto-populate fields contextually:
  - Copy DialogueID from selected row
  - Set ParentNodeID to selected row's NodeID
  - Toggle NodeType (NPC→Player, Player→NPC)
  - Auto-add new NodeID to parent's NextNodeIDs
  - Generate unique NodeID (e.g., "new_node_1")

### 4. Generation Not Connected
**Problem**: Generate button shows preview only - not connected to FDialogueBlueprintGenerator.

**Current Output**:
```
Ready to generate 2 dialogue(s):
- DBP_Seth (14 nodes)
- DBP_Marco (14 nodes)
(Full generation integration coming in next update)
```

**Fix Required**: Implement `DialogueTableConverter::ConvertRowsToManifest()` and call `FDialogueBlueprintGenerator::Generate()`.

---

## Column Definitions

| Column | Type | Purpose | Required |
|--------|------|---------|----------|
| Seq | Display | Auto-calculated sequence/flow order | Auto |
| DialogueID | FName | DBP_ asset name (DBP_Seth) | Yes |
| NodeID | FName | Unique node identifier | Yes |
| NodeType | Enum | npc / player | Yes |
| Speaker | FName | NPC definition or "Player" | For NPC |
| Text | FString | Full dialogue line | Yes |
| OptionText | FString | Short choice label for wheel | For Player |
| Parent | FName | ParentNodeID - tree structure | No (empty = root) |
| NextNodes | FString | Semicolon-separated child NodeIDs | No (empty = leaf) |

---

## Mapping to Narrative Pro

| CSV Field | Narrative Pro Property |
|-----------|----------------------|
| DialogueID | UDialogueBlueprint asset name |
| NodeID | Node identifier in DialogueTemplate |
| NodeType=npc | UDialogueNode_NPC |
| NodeType=player | UDialogueNode_Player |
| Speaker | FSpeakerInfo.NPCDefinition |
| Text | FDialogueLine.Text |
| OptionText | Player choice label |
| Parent/NextNodes | Node linking (PlayerReplies/NPCReplies) |

---

## Implementation Phases

### Phase 1: Core Fixes (COMPLETED v4.2)
1. **Fix Flow Order** - ✅ Tree traversal in CalculateSequences() - depth-first following NextNodeIDs
2. **Fix Player Speaker** - ✅ CreateSpeakerCell() shows "Player" for player nodes
3. **Smart Add Node** - ✅ Insert below selection, auto-populate DialogueID/ParentNodeID/NodeType/NodeID, adds to parent's NextNodeIDs
4. **Connect Generation** - PENDING - Wire to FDialogueBlueprintGenerator

### Phase 1.5: Next Implementation (Planned)
1. **Clear All Filters button** - Reset all text and dropdown filters
2. **Multi-select checkboxes** - Dropdown filters become checkbox lists for multiple selection
3. **Fix NextNodes visual update** - Refresh display when adding/deleting nodes
4. **Delete re-parents children** - Default delete moves children to deleted node's parent
5. **Delete Branch button** - Cascade delete for entire branch
6. **Skippable column** - Yes/No for whether player can skip line
7. **Notes column** - Designer notes (not exported to game)
8. **Preview tooltip** - Hover on Text/OptionText to see full content when truncated

### Phase 2: UX Improvements
1. **Color coding** - Different colors for NPC/Player rows
3. **Keyboard shortcuts** - Delete, duplicate, move up/down
4. **Undo/Redo** - Transaction-based editing

### Phase 3: Advanced Features (Future)
1. **Alternative lines** - Multiple random greetings per node
2. **Events/Conditions** - NE_BeginQuest, NC_HasItem, etc.
3. **Audio/Montage paths** - Voice acting and animation references
4. **Quest integration** - start_quest, complete_branch shortcuts
5. **Preview panel** - Visual dialogue tree preview

---

## Technical Notes

### Tree Traversal Algorithm (for Flow Order)
```cpp
void CalculateSequences()
{
    // 1. Build node map: NodeID -> RowData
    // 2. Find root nodes (ParentNodeID is empty)
    // 3. For each root, depth-first traverse:
    //    - Assign sequence number
    //    - Calculate depth
    //    - Follow NextNodeIDs in order
    //    - Recurse for children
}

void TraverseNode(NodeID, Depth, Sequence)
{
    Row.Sequence = Sequence++;
    Row.Depth = Depth;
    for (ChildID : Row.NextNodeIDs)
    {
        TraverseNode(ChildID, Depth + 1, Sequence);
    }
}
```

### Smart Add Node Logic
```cpp
FReply OnAddRowClicked()
{
    // Get selected row
    auto Selected = ListView->GetSelectedItems();
    if (Selected.Num() > 0)
    {
        auto ParentRow = Selected[0]->Data;

        // Create new row
        FDialogueTableRow NewRow;
        NewRow.DialogueID = ParentRow->DialogueID;
        NewRow.ParentNodeID = ParentRow->NodeID;
        NewRow.NodeType = (ParentRow->NodeType == NPC) ? Player : NPC;
        NewRow.NodeID = GenerateUniqueNodeID();

        // Add to parent's NextNodeIDs
        ParentRow->NextNodeIDs.Add(NewRow.NodeID);

        // Insert after selected row
        InsertRowAfter(Selected[0], NewRow);
    }
    else
    {
        // No selection - add root node at end
        AddRootNode();
    }
}
```

### Generation Integration
```cpp
FReply OnGenerateClicked()
{
    // 1. Validate all rows
    auto ValidationResult = FDialogueTableValidator::Validate(AllRows);
    if (!ValidationResult.bSuccess) { ShowErrors(); return; }

    // 2. Convert to manifest definitions
    auto ManifestDefs = FDialogueTableConverter::ConvertRowsToManifest(AllRows);

    // 3. Generate each dialogue
    for (auto& Def : ManifestDefs)
    {
        FDialogueBlueprintGenerator::Generate(Def, OutputPath);
    }

    // 4. Show results
    ShowGenerationReport();
}
```

---

## Test Verification

After implementing Phase 1 fixes:

1. **Import CSV** - Load DialogueTable_Sample.csv
2. **Verify Flow Order** - Click Reset Flow Order, confirm tree traversal order
3. **Verify Speaker** - Player rows show "Player" in Speaker column
4. **Test Add Node** - Select row, click Add, confirm auto-populated fields
5. **Generate** - Click Generate, confirm DBP_Seth and DBP_Marco created
6. **Open in Editor** - Verify dialogue graph shows correct tree structure

---

## Session History

- v4.0: Initial implementation plan created
- v4.1: Basic table implemented (9 columns, filtering, CSV import/export)
- v4.2: Phase 1 Core Fixes completed:
  - Flow Order: Depth-first tree traversal following NextNodeIDs
  - Player Speaker: Shows "Player" for player nodes with empty speaker
  - Smart Add Node: Insert below selection with auto-populated fields
  - Orphan nodes marked with * in Seq column
- v4.2.1: UX Improvements:
  - Reduced indentation from 16px to 8px per level
  - Add/Delete no longer re-sorts the table
  - Delete shows confirmation prompt
  - Delete removes node from parent's NextNodeIDs
  - Add prepends to parent's NextNodeIDs (appears right after parent in flow)
  - NPC nodes auto-inherit speaker from nearest NPC ancestor

---

## Files Modified This Session

- `SDialogueTableEditor.h` - Added FDialogueTableRowEx, column definitions
- `SDialogueTableEditor.cpp` - Full implementation with filtering, CSV parsing
- `DialogueTable_Sample.csv` - Test data (Seth + Marco dialogues)

## Next Steps

1. Fix CalculateSequences() for proper tree traversal
2. Fix Player speaker display
3. Implement smart Add Node
4. Connect to FDialogueBlueprintGenerator
5. Test end-to-end generation
