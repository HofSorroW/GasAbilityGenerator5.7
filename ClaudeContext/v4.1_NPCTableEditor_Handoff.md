# NPC Table Editor - Handoff Document v4.1

**Date:** January 2026
**Status:** Implementation Complete - Ready for Testing
**Location:** `Plugins/GasAbilityGenerator/Source/GasAbilityGenerator/Private/NPCTableEditor/`

---

## Purpose

The NPC Table Editor is a **single visual dashboard for all NPC content** - an Excel-like spreadsheet inside Unreal Engine for managing NPCs.

### Problem Statement

Currently, to understand or create one NPC requires touching 6+ manifest sections:
- `npc_definitions:`
- `ability_configurations:`
- `activity_configurations:`
- `activity_schedules:`
- `dialogue_blueprints:`
- `npc_spawner_placements:`

There's no way to see "all NPCs in the game" at a glance. Designers must scroll through YAML or open multiple asset editors.

### Solution

One table view where:
- **Row = Complete NPC package**
- **Columns = All scattered references unified**
- **Generate = Creates all related assets in one click**
- **Sync = Pulls existing asset data back into the table**

The table becomes the **NPC authoring cockpit** and living documentation of "what NPCs exist in this game."

---

## Implementation Status

### Completed Features

| Feature | Status | Notes |
|---------|--------|-------|
| 18-column table structure | Done | All columns implemented |
| Sync from NPCDefinition assets | Done | Scans project and populates table |
| POI scanning from world | Done | Maps NPCSpawner -> nearest POI |
| Filter dropdowns (per-column) | Done | Shows values from current table data |
| Cell edit dropdowns | Done | Shows all available project assets |
| Confirmation prompts | Done | All edits require Yes/No confirmation |
| Schedule sync | Done | From NPCDefinition.ActivitySchedules[0] |
| Appearance sync | Done | From CharacterDefinition.DefaultAppearance |
| DefaultItems sync | Done | From DefaultItemLoadout.ItemCollectionsToGrant |
| CSV Export/Import | Done | Basic implementation |

### Pending Features

| Feature | Status | Notes |
|---------|--------|-------|
| Generate Assets action | Stub | Currently just marks rows, no actual generation |
| Apply to Assets action | Stub | Write changes back to NPCDefinition assets |
| Undo/Redo support | Not started | Transaction system |
| Row grouping | Not started | Group by Faction or POI |

---

## Finalized Column Structure (18 Columns)

### Core Identity (5)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 1 | **Status** | Enum | Auto-calculated |
| 2 | **NPC Name** | FString | AssetData.AssetName |
| 3 | **NPC ID** | FString | NPCDefinition.NPCID |
| 4 | **Display Name** | FString | NPCDefinition.NPCName |
| 5 | **Blueprint** | FSoftObjectPath | NPCDefinition.NPCClassPath |

### AI & Behavior (4)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 6 | **Ability Config** | FSoftObjectPath | NPCDefinition.AbilityConfiguration |
| 7 | **Activity Config** | FSoftObjectPath | NPCDefinition.ActivityConfiguration |
| 8 | **Schedule** | FSoftObjectPath | NPCDefinition.ActivitySchedules[0] |
| 9 | **Behavior Tree** | FSoftObjectPath | Manual (not on NPCDef) |

### Combat (3)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 10 | **Level Range** | int32 x2 | NPCDefinition.MinLevel/MaxLevel |
| 11 | **Factions** | FString | NPCDefinition.DefaultFactions (tags) |
| 12 | **Attack Priority** | float | NPCDefinition.AttackPriority |

### Vendor (2)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 13 | **Is Vendor** | bool | NPCDefinition.bIsVendor |
| 14 | **Shop Name** | FString | NPCDefinition.ShopFriendlyName |

### Items & Spawning (2)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 15 | **Default Items** | FString | DefaultItemLoadout.ItemCollectionsToGrant |
| 16 | **Spawner/POI** | FString | World scan: NPCSpawner -> nearest POI |

### Meta (2)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 17 | **Appearance** | FSoftObjectPath | CharacterDefinition.DefaultAppearance |
| 18 | **Notes** | FString | Manual (not on NPCDef) |

---

## Edit Behavior

### Confirmation Prompts

**All edits require confirmation** before applying changes:

| Cell Type | Prompt Message |
|-----------|---------------|
| Text fields | "Change '{Field}' from '{Old}' to '{New}'?" |
| Checkbox | "Enable/Disable 'Is Vendor'?" |
| Asset dropdown | "Change from '{Old}' to '{New}'?" |
| Factions | "Change Factions from '{Old}' to '{New}'?" |
| Items | "Change Default Items from '{Old}' to '{New}'?" |
| POI | "Change Spawner POI from '{Old}' to '{New}'?" |
| Notes | "Change Notes from '{Old}' to '{New}'?" |

**No confirmation (immediate feedback):**
- Level Range spinboxes
- Attack Priority slider

### Filter vs Edit Dropdowns

| Dropdown Type | Data Source | Purpose |
|---------------|-------------|---------|
| **Filter dropdown** | Current table rows (AllRows) | Filter visible rows |
| **Cell edit dropdown** | Asset Registry scan | Select from all project assets |

---

## Sync Workflow

```
[Click Sync Button]
       |
       v
[Scan Asset Registry for NPCDef_* assets]
       |
       v
[Scan Editor World for POI mapping]
       |
       +---> Collect APOIActor locations & tags
       +---> Collect ANPCSpawner -> NPCDefinition mappings
       +---> Map each NPCDef to nearest POI by distance
       |
       v
[For each NPCDefinition asset]
       |
       +---> Core Identity: Name, ID, DisplayName, Blueprint
       +---> AI: AbilityConfig, ActivityConfig, Schedule
       +---> Combat: MinLevel, MaxLevel, Factions, AttackPriority
       +---> Vendor: bIsVendor, ShopName
       +---> Items: DefaultItemLoadout -> IC_ names
       +---> Spawning: NPCSpawner -> nearest POI tag
       +---> Meta: DefaultAppearance
       |
       v
[Populate table, mark all as Synced]
```

### POI Scanning Details

The POI column is populated by:
1. Finding all `ANPCSpawner` actors in the loaded editor world
2. Getting each spawner's `UNPCSpawnComponent` children
3. For each component, checking `NPCToSpawn` (the NPCDefinition reference)
4. Finding the nearest `APOIActor` to the spawner location
5. Using that POI's `POITag` as the SpawnerPOI value

**Requirements:**
- A level must be loaded in the editor
- POI actors must be placed in the level
- NPC spawners must reference NPCDefinition assets

---

## File Structure

| File | Location | Purpose |
|------|----------|---------|
| `NPCTableEditorTypes.h` | `Public/NPCTableEditor/` | FNPCTableRow, UNPCTableData, enums |
| `SNPCTableEditor.h` | `Public/NPCTableEditor/` | Widget declarations, column definitions |
| `SNPCTableEditor.cpp` | `Private/NPCTableEditor/` | Full implementation (~1800 lines) |

### Key Classes

| Class | Purpose |
|-------|---------|
| `FNPCTableRow` | Single NPC row data (18 fields + helpers) |
| `UNPCTableData` | DataAsset container for all rows |
| `SNPCTableRow` | Row widget with cell generators |
| `SNPCTableEditor` | Main table widget with toolbar, filters, actions |
| `SNPCTableEditorWindow` | Tab/window host with menu bar |

---

## Dependencies

### Narrative Pro Headers
```cpp
#include "AI/NPCDefinition.h"
#include "GAS/AbilityConfiguration.h"
#include "AI/Activities/NPCActivityConfiguration.h"
#include "AI/Activities/NPCActivitySchedule.h"
#include "BehaviorTree/BehaviorTree.h"
#include "Spawners/NPCSpawner.h"
#include "Spawners/NPCSpawnComponent.h"
#include "Items/InventoryComponent.h"  // UItemCollection, FLootTableRoll
#include "Character/CharacterAppearance.h"  // UCharacterAppearanceBase
#include "Navigation/POIActor.h"
#include "UnrealFramework/NarrativeNPCCharacter.h"
```

### Unreal Headers
```cpp
#include "AssetRegistry/AssetRegistryModule.h"
#include "EngineUtils.h"  // TActorIterator
#include "Misc/MessageDialog.h"
#include "Widgets/Input/SComboButton.h"
#include "Framework/MultiBox/MultiBoxBuilder.h"
```

---

## Testing Checklist

- [ ] Open NPC Table Editor from menu
- [ ] Click Sync - verify all NPCDefinitions appear
- [ ] Verify POI column populated (requires level with spawners)
- [ ] Edit text field - confirm prompt appears
- [ ] Edit checkbox - confirm prompt appears
- [ ] Edit asset dropdown - confirm prompt appears, all assets shown
- [ ] Filter by column - verify only table values shown
- [ ] Export to CSV - verify file created
- [ ] Import from CSV - verify rows populated

---

## Known Limitations

1. **POI requires loaded level** - POI scanning only works if editor has a level with POI/Spawner actors loaded
2. **BehaviorTree not synced** - Not directly on NPCDefinition, must be set manually
3. **Generate Assets is stub** - Currently just marks rows, doesn't create assets
4. **No undo/redo** - Changes are immediate (with confirmation)

---

## Next Steps

1. **Implement Generate Assets** - Create/update NPCDefinition assets from table rows
2. **Implement Apply to Assets** - Write modified rows back to existing assets
3. **Add validation** - Warn on missing required fields before generation
4. **Add undo/redo** - Transaction support for edit operations
5. **Test with production data** - Verify with actual game NPCs
