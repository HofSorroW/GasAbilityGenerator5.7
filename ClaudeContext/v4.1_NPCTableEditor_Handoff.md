# NPC Table Editor - Handoff Document v4.1

**Date:** January 2026
**Status:** Implementation Complete - To Be Validated
**Location:** `Plugins/GasAbilityGenerator/Source/GasAbilityGenerator/Private/NPCTableEditor/`

---

## Purpose

The NPC Table Editor is a **single visual dashboard for all NPC content** - an Excel-like spreadsheet inside Unreal Engine for managing NPCs.

### Problem Statement

Currently, to understand or create one NPC requires touching 6+ manifest sections:
- `npc_definitions:`
- `ability_configurations:`
- `activity_configurations:`
- `activity_schedules:`
- `dialogue_blueprints:`
- `npc_spawner_placements:`

There's no way to see "all NPCs in the game" at a glance. Designers must scroll through YAML or open multiple asset editors.

### Solution

One table view where:
- **Row = Complete NPC package**
- **Columns = All scattered references unified**
- **Generate = Creates all related assets in one click**
- **Sync = Pulls existing asset data back into the table**

The table becomes the **NPC authoring cockpit** and living documentation of "what NPCs exist in this game."

---

## Implementation Status

### Completed Features

| Feature | Status | Notes |
|---------|--------|-------|
| 17-column table structure | Done | BT column removed (Activity provides context) |
| Sync from NPCDefinition assets | Done | Scans project and populates table |
| POI scanning from world | Done | Maps NPCSpawner -> nearest POI |
| Filter dropdowns (per-column) | Done | Checkbox style, shows values from current table data |
| Cell edit dropdowns | Done | Shows filtered project assets per type |
| Confirmation prompts | Done | ALL edits require Yes/No confirmation |
| Schedule sync | Done | From TriggerSets[0], fallback to ActivitySchedules[0] |
| Appearance sync | Done | From CharacterDefinition.DefaultAppearance |
| DefaultItems sync | Done | From DefaultItemLoadout.ItemCollectionsToGrant |
| Items multi-select | Done | Checkbox style dropdown with confirmation |
| Blueprint filter | Done | Only shows ANarrativeNPCCharacter subclasses |
| CSV Export/Import | Done | Basic implementation |

### Pending Features

| Feature | Status | Notes |
|---------|--------|-------|
| Generate Assets action | Stub | Currently just marks rows, no actual generation |
| Apply to Assets action | Stub | Write changes back to NPCDefinition assets |
| Undo/Redo support | Not started | Transaction system |
| Row grouping | Not started | Group by Faction or POI |

---

## Finalized Column Structure (17 Columns)

### Core Identity (5)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 1 | **Status** | Enum | Auto-calculated |
| 2 | **NPC Name** | FString | AssetData.AssetName |
| 3 | **NPC ID** | FString | NPCDefinition.NPCID |
| 4 | **Display Name** | FString | NPCDefinition.NPCName |
| 5 | **Blueprint** | FSoftObjectPath | NPCDefinition.NPCClassPath (filtered to NarrativeNPCCharacter) |

### AI & Behavior (3)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 6 | **Ability Config** | FSoftObjectPath | NPCDefinition.AbilityConfiguration |
| 7 | **Activity Config** | FSoftObjectPath | NPCDefinition.ActivityConfiguration |
| 8 | **Schedule** | FSoftObjectPath | TriggerSets[0] or ActivitySchedules[0] |

### Combat (3)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 9 | **Level Range** | int32 x2 | NPCDefinition.MinLevel/MaxLevel |
| 10 | **Factions** | FString | NPCDefinition.DefaultFactions (tags) |
| 11 | **Attack Priority** | float | NPCDefinition.AttackPriority |

### Vendor (2)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 12 | **Is Vendor** | bool | NPCDefinition.bIsVendor |
| 13 | **Shop Name** | FString | NPCDefinition.ShopFriendlyName |

### Items & Spawning (2)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 14 | **Default Items** | FString | DefaultItemLoadout.ItemCollectionsToGrant |
| 15 | **Spawner/POI** | FString | World scan: NPCSpawner -> nearest POI |

### Meta (2)
| # | Column | Type | Sync Source |
|---|--------|------|-------------|
| 16 | **Appearance** | FSoftObjectPath | CharacterDefinition.DefaultAppearance |
| 17 | **Notes** | FString | Manual (not on NPCDef) |

---

## Edit Behavior

### Confirmation Prompts

**ALL edits require confirmation** before applying changes:

| Cell Type | Prompt Message |
|-----------|---------------|
| Text fields | "Change '{Field}' from '{Old}' to '{New}'?" |
| Checkbox | "Enable/Disable 'Is Vendor'?" |
| Asset dropdown | "Change from '{Old}' to '{New}'?" |
| Factions | "Change Factions from '{Old}' to '{New}'?" |
| Items (checkbox) | "Add/Remove '{Item}' from Default Items?" |
| POI | "Change Spawner POI from '{Old}' to '{New}'?" |
| Notes | "Change Notes from '{Old}' to '{New}'?" |
| Level Range | "Change Min/Max Level from {Old} to {New}?" |
| Attack Priority | "Change Attack Priority from {Old} to {New}?" |

### Dropdown Styles

| Dropdown Type | Style | Purpose |
|---------------|-------|---------|
| **Header filter** | Checkbox list | Filter visible rows by selected values |
| **Items cell edit** | Checkbox list | Multi-select item collections |
| **Asset cell edit** | Menu list | Single-select from filtered assets |
| **Blueprint cell edit** | Menu list | Only NarrativeNPCCharacter subclasses |

---

## Sync Workflow

```
[Click Sync Button]
       |
       v
[Scan Asset Registry for NPCDef_* assets]
       |
       v
[Scan Editor World for POI mapping]
       |
       +---> Collect APOIActor locations & tags
       +---> Collect ANPCSpawner -> NPCDefinition mappings
       +---> Map each NPCDef to nearest POI by distance
       |
       v
[For each NPCDefinition asset]
       |
       +---> Core Identity: Name, ID, DisplayName, Blueprint
       +---> AI: AbilityConfig, ActivityConfig, Schedule (TriggerSets[0] or ActivitySchedules[0])
       +---> Combat: MinLevel, MaxLevel, Factions, AttackPriority
       +---> Vendor: bIsVendor, ShopName
       +---> Items: DefaultItemLoadout -> IC_ names
       +---> Spawning: NPCSpawner -> nearest POI tag
       +---> Meta: DefaultAppearance
       |
       v
[Populate table, mark all as Synced]
```

### POI Scanning Details

The POI column is populated by:
1. Finding all `ANPCSpawner` actors in the loaded editor world
2. Getting each spawner's `UNPCSpawnComponent` children
3. For each component, checking `NPCToSpawn` (the NPCDefinition reference)
4. Finding the nearest `APOIActor` to the spawner location
5. Using that POI's `POITag` as the SpawnerPOI value

**Requirements:**
- A level must be loaded in the editor
- POI actors must be placed in the level
- NPC spawners must reference NPCDefinition assets

---

## File Structure

| File | Location | Purpose |
|------|----------|---------|
| `NPCTableEditorTypes.h` | `Public/NPCTableEditor/` | FNPCTableRow, UNPCTableData, enums |
| `SNPCTableEditor.h` | `Public/NPCTableEditor/` | Widget declarations, column definitions |
| `SNPCTableEditor.cpp` | `Private/NPCTableEditor/` | Full implementation (~1900 lines) |

### Key Classes

| Class | Purpose |
|-------|---------|
| `FNPCTableRow` | Single NPC row data (17 fields + helpers) |
| `UNPCTableData` | DataAsset container for all rows |
| `SNPCTableRow` | Row widget with cell generators |
| `SNPCTableEditor` | Main table widget with toolbar, filters, actions |
| `SNPCTableEditorWindow` | Tab/window host with menu bar |

---

## Dependencies

### Narrative Pro Headers
```cpp
#include "AI/NPCDefinition.h"
#include "GAS/AbilityConfiguration.h"
#include "AI/Activities/NPCActivityConfiguration.h"
#include "AI/Activities/NPCActivitySchedule.h"
#include "Spawners/NPCSpawner.h"
#include "Spawners/NPCSpawnComponent.h"
#include "Items/InventoryComponent.h"  // UItemCollection, FLootTableRoll
#include "Character/CharacterAppearance.h"  // UCharacterAppearanceBase
#include "Navigation/POIActor.h"
#include "Tales/TriggerSet.h"  // UTriggerSet for schedule/triggers
#include "UnrealFramework/NarrativeNPCCharacter.h"
```

### Unreal Headers
```cpp
#include "AssetRegistry/AssetRegistryModule.h"
#include "EngineUtils.h"  // TActorIterator
#include "Misc/MessageDialog.h"
#include "Widgets/Input/SComboButton.h"
#include "Widgets/Input/SSpinBox.h"
#include "Widgets/Input/SCheckBox.h"
#include "Framework/MultiBox/MultiBoxBuilder.h"
#include "Engine/BlueprintCore.h"  // FBlueprintTags
```

---

## Testing Checklist

- [ ] Open NPC Table Editor from Tools menu
- [ ] Click Sync - verify all NPCDefinitions appear
- [ ] Verify Schedule column shows TriggerSets/ActivitySchedules
- [ ] Verify Blueprint dropdown only shows NPC character classes
- [ ] Verify Items dropdown uses checkbox multi-select style
- [ ] Verify POI column populated (requires level with spawners)
- [ ] Edit text field - confirm prompt appears
- [ ] Edit checkbox - confirm prompt appears
- [ ] Edit asset dropdown - confirm prompt appears
- [ ] Edit Level Range - confirm prompt appears on commit
- [ ] Edit Attack Priority - confirm prompt appears on commit
- [ ] Add/Remove item - confirm prompt appears per selection
- [ ] Filter by column - verify checkbox style, only table values shown
- [ ] Export to CSV - verify file created
- [ ] Import from CSV - verify rows populated

---

## Known Limitations

1. **POI requires loaded level** - POI scanning only works if editor has a level with POI/Spawner actors loaded
2. **Generate Assets is stub** - Currently just marks rows, doesn't create assets
3. **No undo/redo** - Changes are immediate (with confirmation)
4. **Blueprint filter string-based** - Uses ParentClassPath string matching for NarrativeNPCCharacter detection

---

## Next Steps

1. **Validate all features** - Test with production NPC data
2. **Implement Generate Assets** - Create/update NPCDefinition assets from table rows
3. **Implement Apply to Assets** - Write modified rows back to existing assets
4. **Add validation** - Warn on missing required fields before generation
5. **Add undo/redo** - Transaction support for edit operations
