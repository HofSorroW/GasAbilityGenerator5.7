# Father Companion System - Complete Manifest
# Version: 3.0.3
# Engine: Unreal Engine 5.7
# Plugin: Narrative Pro v2.2
# Total Tags: 216
# Total Assets: 166
# Event Graph Support: ENABLED
# NPC Systems: Warden Husk, Guard Formation, Possessed Exploder, Support Buffer, Biomechanical Detachment, Gatherer Scout, Stalker Random Aggression

# ============================================================================
# DISABLED/PLACEHOLDER ENTRIES TRACKER
# ============================================================================
# The following entries are disabled pending external dependencies (art assets).
#
# | Entry Name          | Status      | Issue                         | Fix When                      |
# |---------------------|-------------|-------------------------------|-------------------------------|
# | GA_FatherRifle      | ✅ FIXED    | item_class now EI_FatherRifleWeapon | v5.0                      |
# | GA_FatherSword      | ✅ FIXED    | item_class now EI_FatherSwordWeapon | v5.0                      |
# | animation_montages  | COMMENTED   | SK_FatherCompanion missing    | Uncomment after skeleton import |
# | animation_notifies  | COMMENTED   | Depends on AM_FatherAttack    | Uncomment after montages ready  |
#
# All code/logic items are now fully automated. Only art asset dependencies remain.
# ============================================================================

# ============================================================================
# FULL AUTOMATION STATUS (v5.0)
# ============================================================================
# ALL form ability features are now fully automated via manifest event_graph definitions:
#
# | Feature                    | Status        | Implementation                            |
# |----------------------------|---------------|-------------------------------------------|
# | 3-Layer Post-Delay Guards  | ✅ AUTOMATED  | NL-GUARD-IDENTITY L1 (v5.0)               |
# |   Guard 1: IsValid         |               | IsValid_FatherRef_Guard node              |
# |   Guard 2: Phase Tag       |               | HasMatchingGameplayTag(Transitioning)     |
# |   Guard 3: Identity Tag    |               | HasMatchingGameplayTag(FormState)         |
# | Transition Prelude         | ✅ AUTOMATED  | RemovePriorFormState + ApplyNewState      |
# | Detach/Attach Logic        | ✅ AUTOMATED  | K2_DetachFromActor, AttachActorToComponent|
# | VFX Spawning               | ✅ AUTOMATED  | SpawnSystemAttached nodes                 |
# | Speed/Jump Modifications   | ✅ AUTOMATED  | PropertyGet/PropertySet on MovementComp   |
# | EndAbility Cleanup         | ✅ AUTOMATED  | Event_EndAbility with bWasCancelled check |
# | Timer Callbacks            | ✅ AUTOMATED  | CustomEvent + SetTimer pattern            |
#
# Claude-GPT Audit (2026-01-24): All MEDIUM severity findings resolved.
# ============================================================================

# ============================================================================
# LOCKED RULE: NEVER SIMPLIFY ABILITIES (v7.8.0)
# ============================================================================
# Abilities MUST match their implementation guides exactly. The generator serves
# the design, not the other way around.
#
# If a generator limitation prevents implementing a feature:
#   1. STOP - Do not simplify or work around the limitation
#   2. ENHANCE - Add generator support for the required pattern/node type
#   3. VERIFY - Ensure the ability matches the guide's specified gameplay mechanics
#
# FORBIDDEN simplifications:
#   - Replacing damage-scaled values with fixed amounts
#   - Removing attribute tracking because FGameplayAttribute is complex
#   - Skipping validation steps to avoid adding new node types
#   - Using "close enough" alternatives that change gameplay behavior
#
# Example violation: GA_ProtectiveDome guide says "30% of damage becomes energy"
#   WRONG: Use fixed 50 energy per hit (changes gameplay)
#   RIGHT: Add AbilityAsync_WaitAttributeChanged support to get actual damage
#
# This rule is LOCKED and cannot be overridden without explicit user approval.
# ============================================================================

project_root: /Game/FatherCompanion
tags_ini_path: Config/DefaultGameplayTags.ini

# ============================================================================
# GAMEPLAY TAGS (202 total)
# ============================================================================
tags:
  # Ability Tags (25)
  - tag: Ability.Father.Armor
    comment: Form activation ability
  - tag: Ability.Father.Attack
    comment: Crawler melee attack
  - tag: Ability.Father.Crawler.Attack
    comment: Hierarchical child - crawler melee attack
  - tag: Ability.Father.Backstab
    comment: Passive backstab damage bonus
  - tag: Ability.Father.Crawler
    comment: Form activation ability
  - tag: Ability.Father.DomeBurst
    comment: Armor form active burst
  - tag: Ability.Father.ElectricTrap
    comment: Engineer electric web trap
  - tag: Ability.Father.Engineer
    comment: Form activation ability
  - tag: Ability.Father.Engineer.ElectricTrap
    comment: Hierarchical child - electric trap
  - tag: Ability.Father.Engineer.TurretShoot
    comment: Hierarchical child - turret shoot
  - tag: Ability.Father.Exoskeleton
    comment: Form activation ability
  - tag: Ability.Father.Exoskeleton.Dash
    comment: Hierarchical child - dash ability
  - tag: Ability.Father.Exoskeleton.Sprint
    comment: Hierarchical child - sprint ability
  - tag: Ability.Father.Exoskeleton.StealthField
    comment: Hierarchical child - stealth field ability (v7.8.50)
  - tag: Ability.Father.Crawler.LaserShot
    comment: Hierarchical child - Crawler ranged laser attack (Contract 27)
  - tag: Ability.Father.Mark
    comment: Enemy marking passive
  - tag: Ability.Father.ProtectiveDome
    comment: Armor dome passive
  - tag: Ability.Father.ProximityStrike
    comment: Symbiote proximity damage
  - tag: Ability.Father.Rifle
    comment: Rifle weapon form ability
  - tag: Ability.Father.Sacrifice
    comment: Emergency sacrifice passive
  - tag: Ability.Father.StealthField
    comment: Exoskeleton stealth ability
  - tag: Ability.Father.Sword
    comment: Sword weapon form ability
  - tag: Ability.Father.Symbiote
    comment: Form activation ability
  - tag: Ability.Father.Symbiote.ProximityStrike
    comment: Hierarchical child - proximity AOE damage
  - tag: Ability.Father.TurretShoot
    comment: Engineer turret auto-fire

  # Action Tags (1)
  - tag: Action.Attacking
    comment: Generic attacking state

  # AI Tags (8)
  - tag: AI.Action.MarkEnemy
    comment: AI behavior mark action
  - tag: AI.Action.MeleeAttack
    comment: AI behavior melee action
  - tag: AI.Action.ShootLaser
    comment: AI behavior laser action
  - tag: AI.Action.ThrowElectricWeb
    comment: AI behavior trap action
  - tag: AI.Action.TurretShoot
    comment: AI behavior turret action
  - tag: AI.State.HasElectricWebTarget
    comment: AI has valid trap target
  - tag: AI.State.HasTarget
    comment: AI has combat target
  - tag: AI.State.InCombat
    comment: AI is in combat state

  # Character Tags (4)
  - tag: Character.Enemy
    comment: Character is enemy faction
  - tag: Character.Marked
    comment: Character is marked by father
  - tag: Character.Player
    comment: Character is player
  - tag: Character.Father
    comment: Character is father companion

  # Companion Tags (7)
  - tag: Companion.Slot.1
    comment: Companion wheel slot 1
  - tag: Companion.Slot.2
    comment: Companion wheel slot 2
  - tag: Companion.Slot.3
    comment: Companion wheel slot 3
  - tag: Companion.Slot.4
    comment: Companion wheel slot 4
  - tag: Companion.State.Selected
    comment: Companion selected in wheel
  - tag: Companion.State.TimeDilated
    comment: Wheel time dilation active
  - tag: Companion.State.WheelOpen
    comment: Companion wheel is open

  # Cooldown Tags (10) - Contract 27: Hierarchical format Cooldown.Father.{Form}.{Ability}
  - tag: Cooldown.Father.Armor.DomeBurst
    comment: Dome burst cooldown - hierarchical
  - tag: Cooldown.Father.Crawler.Attack
    comment: Crawler attack cooldown - hierarchical
  - tag: Cooldown.Father.Crawler.LaserShot
    comment: Laser shot cooldown - hierarchical
  - tag: Cooldown.Father.Engineer.ElectricTrap
    comment: Electric trap cooldown - hierarchical
  - tag: Cooldown.Father.Engineer.TurretShoot
    comment: Turret shoot cooldown - hierarchical
  - tag: Cooldown.Father.Exoskeleton.Dash
    comment: Dash ability cooldown - hierarchical
  - tag: Cooldown.Father.Exoskeleton.StealthField
    comment: Stealth field cooldown - hierarchical
  - tag: Cooldown.Father.FormChange
    comment: Shared 15s form transition cooldown - flat exception
  - tag: Cooldown.Father.Symbiote.Sacrifice
    comment: Sacrifice ability cooldown - hierarchical

  # Data Tags - SetByCaller (4)
  - tag: Data.Mark.ArmorReduction
    comment: SetByCaller armor reduction on marked targets
  - tag: Data.Mark.Duration
    comment: SetByCaller mark duration
  - tag: Data.Sacrifice.DormantDuration
    comment: SetByCaller dormant time
  - tag: Data.Symbiote.Duration
    comment: SetByCaller symbiote duration

  # Effect Tags (38)
  - tag: Effect.Backstab
    comment: Backstab damage effect
  - tag: Effect.Backstab.Critical
    comment: Critical backstab effect
  - tag: Effect.Damage.Laser
    comment: Laser damage effect
  - tag: Effect.ElectricWeb.Damage
    comment: Electric web damage
  - tag: Effect.ElectricWeb.Root
    comment: Electric web root effect
  - tag: Effect.Knockback
    comment: Knockback effect
  - tag: Effect.Father.ArmorBoost
    comment: Armor stat boost effect
  - tag: Effect.Father.Damage
    comment: Base father damage effect
  - tag: Effect.Father.DashDamage
    comment: Dash collision damage
  # v4.13.5: Effect.Father.DashInvulnerability REMOVED per GAS Audit INV-1
  - tag: Effect.Father.DashKnockback
    comment: Dash knockback effect
  - tag: Effect.Father.DashSpeed
    comment: Dash speed boost
  - tag: Effect.Father.DomeAbsorption
    comment: Dome damage absorption
  - tag: Effect.Father.DomeBurst
    comment: Dome burst damage effect
  - tag: Effect.Father.DomeEnergy
    comment: Dome energy modification
  - tag: Effect.Father.FormState
    comment: Base asset tag for all form state gameplay effects
  - tag: Effect.Father.FormState.Armor
    comment: Asset tag for GE_ArmorState effect
  - tag: Effect.Father.FormState.Crawler
    comment: Asset tag for GE_CrawlerState effect
  - tag: Effect.Father.FormState.Engineer
    comment: Asset tag for GE_EngineerState effect
  - tag: Effect.Father.FormState.Exoskeleton
    comment: Asset tag for GE_ExoskeletonState effect
  - tag: Effect.Father.FormState.Symbiote
    comment: Asset tag for GE_SymbioteState effect
  - tag: Effect.Father.FormState.Rifle
    comment: Asset tag for GE_RifleState effect (weapon form)
  - tag: Effect.Father.FormState.Sword
    comment: Asset tag for GE_SwordState effect (weapon form)
  - tag: Effect.Father.Mark
    comment: Enemy mark effect
  - tag: Effect.Father.ProximityDamage
    comment: Proximity strike damage
  - tag: Effect.Father.Recruited
    comment: Asset tag for GE_GrantRecruitedTag effect
  - tag: Effect.Father.SacrificeInvulnerability
    comment: Sacrifice invulnerability effect
  - tag: Effect.Father.SpeedBoost
    comment: Generic speed boost
  - tag: Effect.Father.SprintJump
    comment: Sprint jump boost
  - tag: Effect.Father.SprintPush
    comment: Sprint enemy push
  - tag: Effect.Father.SprintSpeed
    comment: Sprint speed boost
  - tag: Effect.Father.Stealth
    comment: Stealth invisibility effect
  - tag: Effect.Father.StealthDamageBonus
    comment: Stealth damage bonus
  - tag: Effect.Father.StealthSpeedReduction
    comment: Stealth speed penalty
  - tag: Effect.Father.SymbioteActive
    comment: Symbiote form active effect
  - tag: Effect.Father.SymbioteDuration
    comment: Symbiote duration timer
  # v4.13.5: Effect.Father.TransitionInvulnerability REMOVED per GAS Audit INV-1
  - tag: Effect.Father.TurretDamage
    comment: Turret shot damage
  - tag: Effect.Father.TurretMode
    comment: Turret mode state effect
  - tag: Effect.Symbiote.StatBoost
    comment: Gameplay Effect providing Symbiote stat boosts

  # Event Tags (1)
  - tag: Event.Combat.Backstab
    comment: Backstab combat event

  # GameplayCue Tags (14)
  - tag: GameplayCue.Father.Backstab
    comment: Backstab VFX/SFX cue
  - tag: GameplayCue.Father.FormChange
    comment: Form change VFX/SFX cue
  - tag: GameplayCue.Father.Transition
    comment: Form transition VFX/SFX cue (5s transformation sequence)
  - tag: GameplayCue.Father.Mark
    comment: Enemy mark VFX/SFX cue
  - tag: GameplayCue.Father.Reactivate
    comment: Reactivation VFX/SFX cue
  - tag: GameplayCue.Father.Sacrifice
    comment: Sacrifice VFX/SFX cue
  - tag: GameplayCue.Father.Sacrifice.Dormant
    comment: Dormant state VFX - father dark/lifeless during 180s dormant period
  - tag: GameplayCue.Father.Sprint
    comment: VFX and SFX for Exoskeleton sprint ability
  - tag: GameplayCue.Father.Stealth
    comment: Stealth VFX/SFX cue
  - tag: GameplayCue.Father.TakeDamage
    comment: Base father damage feedback VFX
  - tag: GameplayCue.Father.Attack.Hit
    comment: Attack impact VFX/SFX
  - tag: GameplayCue.Father.ProximityStrike
    comment: Symbiote aura pulse VFX
  - tag: GameplayCue.Father.ElectricTrap
    comment: Engineer trap field VFX
  - tag: GameplayCue.Father.TurretFire
    comment: Engineer turret muzzle flash VFX
  - tag: GameplayCue.Father.Death
    comment: Death effect VFX/SFX
  # v7.8.50: Dome burst VFX cue (Contract 25 compliance - proper GAS pattern)
  - tag: GameplayCue.Father.DomeBurst
    comment: Armor dome burst expansion ring VFX

  # Form Tags (7)
  - tag: Father.Form.Armor
    comment: Father is in armor form (chest attachment)
  - tag: Father.Form.Crawler
    comment: Father is in crawler form (following)
  - tag: Father.Form.Engineer
    comment: Father is in engineer form (turret mode)
  - tag: Father.Form.Exoskeleton
    comment: Father is in exoskeleton form (back attachment)
  - tag: Father.Form.Rifle
    comment: Father is in rifle form (weapon)
  - tag: Father.Form.Sword
    comment: Father is in sword form (weapon)
  - tag: Father.Form.Symbiote
    comment: Father is in symbiote form (merged)

  # Input Tags - DEPRECATED (v6.5)
  # Per INV-INPUT-1: Father abilities now use Narrative Pro default input tags:
  # - Narrative.Input.Ability1 (Q) - shared by form-gated abilities
  # - Narrative.Input.Ability2 (E) - shared by form-gated abilities
  # - Narrative.Input.Ability3 (F) - reserved
  # Custom Narrative.Input.Father.* tags removed - caused HasTagExact mismatch
  - tag: Narrative.Input.Move
    comment: Generic move input tag

  # State Tags - Father (21)
  - tag: Father.State.Alive
    comment: Father is alive - required for form activation
  - tag: Father.State.Attached
    comment: Father is attached to player
  - tag: Father.State.Attacking
    comment: Father is attacking
  - tag: Father.State.Dashing
    comment: Father is dashing
  - tag: Father.State.Deployed
    comment: Father deployed as turret (INI canonical name)
  - tag: Father.State.Detached
    comment: Father is detached from player
  - tag: Father.State.Dormant
    comment: Father is dormant after sacrifice
  - tag: Father.State.Following
    comment: Father is following player
  - tag: Father.State.Marking
    comment: Father is marking enemy
  - tag: Father.State.Merged
    comment: Father merged with player (Symbiote form)
  - tag: Father.State.ProximityActive
    comment: Proximity strike is active
  - tag: Father.State.Recruited
    comment: Father is recruited by player
  - tag: Father.State.Sacrificing
    comment: Father is sacrificing
  - tag: Father.State.Sprinting
    comment: Father is sprinting
  - tag: Father.State.Stealthed
    comment: Father is stealthed
  - tag: Father.State.SymbioteLocked
    comment: Form changes locked during symbiote
  - tag: Father.State.Transitioning
    comment: Father is in form transition
  - tag: Father.State.TurretActive
    comment: Turret mode is active
  - tag: Father.State.TurretDeployed
    comment: Father deployed as turret (manifest alias for Deployed)
  - tag: Father.State.Wielded
    comment: Father weapon form is being wielded by player

  # Dome Tags (4)
  - tag: Father.Dome.Active
    comment: Protective dome is active
  - tag: Father.Dome.Charging
    comment: Dome is charging energy
  - tag: Father.Dome.FullyCharged
    comment: Dome at max energy
  - tag: Father.Dome.OnCooldown
    comment: Dome burst on cooldown

  # State Tags - General (4)
  - tag: State.BackstabReady
    comment: Backstab conditions met
  - tag: State.Rooted
    comment: Entity cannot move
  - tag: State.Invisible
    comment: Entity is invisible
  - tag: Player.State.Stealth
    comment: Player stealth state

  # Symbiote Tags (2)
  - tag: Symbiote.Charge.Ready
    comment: Symbiote charge at 100%
  - tag: Symbiote.State.Merged
    comment: Father merged with player

  # Faction Tags (3)
  - tag: Narrative.Factions.FatherCompanion
    comment: Father companion faction
  - tag: Narrative.Factions.Player
    comment: Player faction
  - tag: Narrative.Factions.Returned
    comment: Returned faction - hostile to player by default (configure via SetFactionAttitude)

  # Equipment Tags (1)
  - tag: Narrative.Equipment.Slot.FatherForm
    comment: Equipment slot for father form items

# ============================================================================
# INPUT ACTIONS (7)
# ============================================================================
input_actions:
  - name: IA_FatherFormWheel
    folder: Input
    value_type: Bool
    triggers:
      - Pressed

  - name: IA_FatherDomeBurst
    folder: Input
    value_type: Bool
    triggers:
      - Pressed

  - name: IA_FatherStealth
    folder: Input
    value_type: Bool
    triggers:
      - Pressed

  - name: IA_FatherSprint
    folder: Input
    value_type: Bool
    triggers:
      - Down

  - name: IA_FatherProximityStrike
    folder: Input
    value_type: Bool
    triggers:
      - Pressed

  - name: IA_FatherElectricTrap
    folder: Input
    value_type: Bool
    triggers:
      - Pressed

  - name: IA_FatherTurretShoot
    folder: Input
    value_type: Bool
    triggers:
      - Down

# ============================================================================
# INPUT MAPPING CONTEXT (1)
# ============================================================================
# v6.5 UPDATE (INV-INPUT-1): Father abilities now use Narrative Pro's default
# input system. NO custom DA_FatherInputMapping needed.
#
# Input Architecture:
#   - DA_DefaultAbilityInputs (Narrative Pro) maps IA_Ability1/2/3 to InputTags
#   - IMC_Default (Narrative Pro) maps Q/E/F keys to IA_Ability1/2/3
#   - Father abilities use input_tag: Narrative.Input.Ability{1|2|3}
#   - Per-form behavior gated via activation_required_tags
#
# Current Assignments:
#   - Q (Ability1): GA_DomeBurst (Armor), GA_ProximityStrike (Symbiote),
#                   GA_FatherExoskeletonSprint (Exoskeleton)
#   - E (Ability2): GA_StealthField (Exoskeleton)
#   - Father ASC abilities (GA_FatherElectricTrap, etc.): No input_tag, relay only
#
# NOTE: IMC_FatherCompanion below is for FormWheel (T key) only.
# ============================================================================
input_mapping_contexts:
  - name: IMC_FatherCompanion
    folder: Input
    mappings:
      - action: IA_FatherFormWheel
        key: T
      - action: IA_FatherDomeBurst
        key: Q
      - action: IA_FatherStealth
        key: E
      - action: IA_FatherSprint
        key: Q
        modifiers:
          - Hold
      - action: IA_FatherProximityStrike
        key: Q
      - action: IA_FatherElectricTrap
        key: Q
      - action: IA_FatherTurretShoot
        key: LeftMouseButton

# ============================================================================
# ENUMERATIONS (2)
# ============================================================================
enumerations:
  - name: E_FatherForm
    folder: Enums
    values:
      - Crawler
      - Armor
      - Exoskeleton
      - Symbiote
      - Engineer
      - Offline

  - name: E_DashDirection
    folder: Enums
    values:
      - Forward
      - Backward
      - Left
      - Right

  # v4.18.1: Ultimate charge system enumeration
  - name: E_FatherUltimate
    folder: Enums
    values:
      - Symbiote
      - Sword
      - Rifle
      - Bow

# ============================================================================
# FLOAT CURVES (1) - Level-based scaling
# ============================================================================
float_curves:
  # v4.18.1: Ultimate charge threshold scaling by player level
  # Level 1 → 5000, Level 10 → 10000, Level 25 → 20000, Level 50 → 40000, Level 100 → 80000
  - name: FC_UltimateThreshold
    folder: Curves
    extrapolation_before: Constant
    extrapolation_after: Linear
    keys:
      - time: 1.0
        value: 5000.0
        interp_mode: Linear
      - time: 10.0
        value: 10000.0
        interp_mode: Linear
      - time: 25.0
        value: 20000.0
        interp_mode: Linear
      - time: 50.0
        value: 40000.0
        interp_mode: Linear
      - time: 100.0
        value: 80000.0
        interp_mode: Linear

# ============================================================================
# FORM STATE EFFECTS (5) - Compact Preset (P1.1)
# Auto-expands to GE_*State with Effect.Father.FormState.{Form} tag
# Option B Architecture: Single Active Form State Invariant
# ============================================================================
form_state_effects:
  - form: Crawler
    invulnerable: false
  - form: Armor
    invulnerable: false    # v4.14.2: Removed per GAS Audit INV-1
  - form: Exoskeleton
    invulnerable: false
  - form: Symbiote
    invulnerable: false
  - form: Engineer
    invulnerable: false

# ============================================================================
# GAMEPLAY EFFECTS (30) - Stat/Damage/Cooldown effects
# ============================================================================
gameplay_effects:
  # ==========================================================================
  # FORM STATE EFFECTS (5) - Identity Tags Only (GE Split Rule)
  # Grants form identity tags ONLY - NO invulnerability per INV-1 locked rule
  # Per Form_State_Architecture_Audit_v1_0.md Option B (LOCKED)
  # v7.8.32: TAUD-01 fix - Removed Narrative.State.Invulnerable from all forms (INV-1)
  # ==========================================================================
  - name: GE_CrawlerState
    folder: Effects/FormState
    duration_policy: Infinite
    granted_tags:
      - Effect.Father.FormState.Crawler
    # INV-1: Father is vulnerable in all forms

  - name: GE_ArmorState
    folder: Effects/FormState
    duration_policy: Infinite
    granted_tags:
      - Effect.Father.FormState.Armor
    # INV-1: Father is vulnerable in all forms (armor provides damage reduction, not immunity)

  - name: GE_ExoskeletonState
    folder: Effects/FormState
    duration_policy: Infinite
    granted_tags:
      - Effect.Father.FormState.Exoskeleton
    # INV-1: Father is vulnerable in all forms

  - name: GE_SymbioteState
    folder: Effects/FormState
    duration_policy: Infinite
    granted_tags:
      - Effect.Father.FormState.Symbiote
    # INV-1: Father is vulnerable in all forms (merged with player but still mortal)

  - name: GE_EngineerState
    folder: Effects/FormState
    duration_policy: Infinite
    granted_tags:
      - Effect.Father.FormState.Engineer
    # INV-1: Father is vulnerable in all forms

  # Weapon Form States (Rifle/Sword modes per guides v1.7)
  - name: GE_RifleState
    folder: Effects/FormState
    duration_policy: Infinite
    granted_tags:
      - Effect.Father.FormState.Rifle
      - Father.State.Wielded

  - name: GE_SwordState
    folder: Effects/FormState
    duration_policy: Infinite
    granted_tags:
      - Effect.Father.FormState.Sword
      - Father.State.Wielded

  # ==========================================================================
  # FORM EQUIPMENT MODIFIER EFFECTS (7) - Stats Only (GE Split Rule)
  # Child GEs of GE_EquipmentModifier for stat modifications
  # Stats applied via SetByCaller from EquippableItem equipment_effect_values
  # ==========================================================================
  - name: GE_EquipmentModifier_FatherCrawler
    folder: Effects/Forms
    parent_class: GE_EquipmentModifier
    duration_policy: Infinite

  - name: GE_EquipmentModifier_FatherArmor
    folder: Effects/Forms
    parent_class: GE_EquipmentModifier
    duration_policy: Infinite

  - name: GE_EquipmentModifier_FatherExoskeleton
    folder: Effects/Forms
    parent_class: GE_EquipmentModifier
    duration_policy: Infinite

  # v4.26: Decision 1B - StaminaRegenRate via direct modifier (no SetByCaller.StaminaRegenRate in Narrative Pro)
  - name: GE_EquipmentModifier_FatherSymbiote
    folder: Effects/Forms
    parent_class: GE_EquipmentModifier
    duration_policy: Infinite
    modifiers:
      - attribute: NarrativeAttributeSetBase.StaminaRegenRate
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 10000.0

  - name: GE_EquipmentModifier_FatherEngineer
    folder: Effects/Forms
    parent_class: GE_EquipmentModifier
    duration_policy: Infinite

  - name: GE_EquipmentModifier_FatherRifle
    folder: Effects/Forms
    parent_class: GE_EquipmentModifier
    duration_policy: Infinite

  - name: GE_EquipmentModifier_FatherSword
    folder: Effects/Forms
    parent_class: GE_EquipmentModifier
    duration_policy: Infinite

  # Stat Boost Effects (1) - v4.26: Removed GE_ArmorBoost (Decision 2 - orphan, stats via EI + CharMov)
  - name: GE_ExoskeletonSpeed
    folder: Effects/Stats
    duration_policy: Infinite
    granted_tags:
      - Father.State.SpeedBoosted
    asset_tag: Effect.Father.SpeedBoost
  # v4.26: Removed GE_SymbioteBoost (Decision 3 - orphan, misconfigured, stats via EI + GE_EquipmentModifier_FatherSymbiote)

  # Cooldown Effects (8)
  # Contract 27: Cooldown GEs with hierarchical tags
  - name: GE_FormChangeCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 15.0
    # Exception: shared cooldown stays flat (no hierarchy)
    granted_tags:
      - Cooldown.Father.FormChange

  - name: GE_AttackCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 1.5
    granted_tags:
      - Cooldown.Father.Crawler.Attack

  - name: GE_LaserCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 3.0
    granted_tags:
      - Cooldown.Father.Crawler.LaserShot

  - name: GE_DomeBurstCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 12.0
    granted_tags:
      - Cooldown.Father.Armor.DomeBurst

  - name: GE_ExoskeletonDashCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 4.0
    granted_tags:
      - Cooldown.Father.Exoskeleton.Dash

  - name: GE_StealthCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 20.0
    granted_tags:
      - Cooldown.Father.Exoskeleton.StealthField

  - name: GE_ProximityStrikeCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 8.0
    granted_tags:
      - Cooldown.Father.Symbiote.ProximityStrike

  - name: GE_ElectricTrapCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 10.0
    granted_tags:
      - Cooldown.Father.Engineer.ElectricTrap

  - name: GE_TurretShootCooldown
    folder: Effects/Cooldowns
    duration_policy: HasDuration
    duration_magnitude: 0.5
    granted_tags:
      - Cooldown.Father.Engineer.TurretShoot

  # Damage Effects (5)
  - name: GE_FatherDamage
    folder: Effects/Damage
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc
    asset_tag: Effect.Father.Damage

  - name: GE_LaserDamage
    folder: Effects/Damage
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc
    asset_tag: Effect.Damage.Laser

  - name: GE_DomeBurstDamage
    folder: Effects/Damage
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc
    asset_tag: Effect.Father.DomeBurst

  - name: GE_ProximityDamage
    folder: Effects/Damage
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc
    asset_tag: Effect.Father.ProximityDamage

  - name: GE_ElectricTrapDamage
    folder: Effects/Damage
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc
    asset_tag: Effect.ElectricWeb.Damage

  # v7.8.50: Dash damage per Guide v3.10
  - name: GE_DashDamage
    folder: Effects/Damage
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc
    asset_tag: Effect.Father.DashDamage

  # Utility Effects (7)
  - name: GE_MarkEffect
    folder: Effects/Utility
    duration_policy: HasDuration
    duration_setbycaller: Data.Mark.Duration
    modifiers:
      # v7.3: Armor reduction on marked targets (-10 = ~10% more damage taken)
      - attribute: NarrativeAttributeSetBase.Armor
        modifier_op: Add
        magnitude_calculation_type: SetByCaller
        set_by_caller_tag: Data.Mark.ArmorReduction
    granted_tags:
      - Character.Marked
    asset_tag: Effect.Father.Mark

  # v4.13.5: GE_TransitionInvulnerability REMOVED per GAS Audit INV-1
  # Form transitions now use AddLooseGameplayTag(Father.State.Transitioning) directly

  # v4.13.5: GE_DashInvulnerability REMOVED per GAS Audit INV-1
  # Dash now uses Father.State.Dashing tag only (no invulnerability)

  - name: GE_SacrificeInvulnerability
    folder: Effects/Utility
    duration_policy: HasDuration
    duration_magnitude: 10.0
    granted_tags:
      - Narrative.State.Invulnerable

  - name: GE_FatherDormant
    folder: Effects/Utility
    duration_policy: HasDuration
    duration_setbycaller: Data.Sacrifice.DormantDuration
    granted_tags:
      - Father.State.Dormant

  - name: GE_GrantRecruitedTag
    folder: Effects/Utility
    duration_policy: Infinite
    granted_tags:
      - Father.State.Recruited

  - name: GE_SymbioteDuration
    folder: Effects/Utility
    duration_policy: HasDuration
    duration_setbycaller: Data.Symbiote.Duration
    granted_tags:
      - Father.State.SymbioteLocked

  - name: GE_StealthActive
    folder: Effects/Utility
    duration_policy: Infinite
    granted_tags:
      - Father.State.Stealthed
      - State.Invisible
      - Player.State.Stealth

  - name: GE_DomeAbsorption
    folder: Effects/Utility
    duration_policy: Infinite
    granted_tags:
      - Father.Dome.Active

  - name: GE_SprintSpeed
    folder: Effects/Utility
    duration_policy: Infinite
    granted_tags:
      - Father.State.Sprinting

  # v4.14: Backstab damage bonus effect per GA_Backstab_Implementation_Guide_v1_6.md
  # Instant effect that adds +25 to AttackRating for next attack
  - name: GE_BackstabBonus
    folder: Effects/Utility
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.AttackRating
        modifier_op: Add
        magnitude: 25.0
    granted_tags:
      - Effect.Backstab

  - name: GE_ElectricTrapRoot
    folder: Effects/Utility
    duration_policy: HasDuration
    duration_magnitude: 3.0
    granted_tags:
      - State.Rooted

# ============================================================================
# GAMEPLAY ABILITIES (18) - WITH EVENT GRAPH DEFINITIONS
# ============================================================================
gameplay_abilities:
  # ---------------------------------------------------------------------------
  # FORM ABILITIES (5)
  # ---------------------------------------------------------------------------
  
  # GA_FatherCrawler - Detach and Follow Mode (Option B Form Identity)
  # v4.13.5: GAS Audit compliant - NO invulnerability per INV-1
  - name: GA_FatherCrawler
    folder: Abilities/Forms
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_FormChangeCooldown
    tags:
      ability_tags:
        - Ability.Father.Crawler
      cancel_abilities_with_tag:
        - Ability.Father.Armor
        - Ability.Father.Exoskeleton
        - Ability.Father.Engineer
      # activation_owned_tags removed - form identity via GE_CrawlerState (Option B)
      activation_required_tags:
        - Father.State.Alive
        - Father.State.Recruited
      activation_blocked_tags:
        - Father.State.Dormant
        - Father.State.Transitioning
        - Father.State.SymbioteLocked
        - Cooldown.Father.FormChange
    # v7.7: Delegate bindings REMOVED - Track E audit. Use AbilityTasks instead.
    # See: ClaudeContext/Handoffs/Track_E_Removal_Audit_v7_7.md
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: bIsFirstActivation
        type: Bool
        default_value: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        - id: GetFirstActivation
          type: VariableGet
          properties:
            variable_name: bIsFirstActivation
          position: [1100, 100]
        - id: Branch_First
          type: Branch
          position: [1200, 0]
        - id: SetCurrentForm
          type: PropertySet
          properties:
            property_name: CurrentForm
            target_class: BP_FatherCompanion
          position: [1500, -100]
        - id: SetIsAttached
          type: PropertySet
          properties:
            property_name: IsAttached
            target_class: BP_FatherCompanion
          position: [1800, -100]
        - id: SetFirstFalse
          type: VariableSet
          properties:
            variable_name: bIsFirstActivation
          position: [2100, -100]
        - id: EndAbility_First
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2400, -100]
        # FULL TRANSITION FLOW (Option B + VFX, NO Invulnerability) - False branch (form switch)
        # v4.13.5: Using AddLooseGameplayTag instead of GE_TransitionInvulnerability per GAS Audit INV-1
        # Step 1: Add Transitioning tag
        - id: GetFatherASC_Transition
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1500, 300]
        - id: AddTransitioningTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1700, 200]
        - id: MakeTagContainer_AddTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [1600, 300]
        - id: MakeLiteralTag_AddTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [1500, 350]
        # Step 2: Spawn transition VFX
        - id: GetFatherMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [1700, 450]
        - id: SpawnTransitionVFX
          type: CallFunction
          properties:
            function: SpawnSystemAttached
            class: NiagaraFunctionLibrary
          position: [1900, 200]
        # Step 3: Wait 5 seconds for transition animation (v4.15: WaitDelay auto-terminates with ability)
        - id: TransitionDelay
          type: AbilityTaskWaitDelay
          properties:
            duration: 5.0
          position: [2100, 200]
        # Step 4: Remove prior form state (Option B prelude)
        - id: RemovePriorFormState
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [2300, 200]
        - id: MakeTagContainer_FormState
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2200, 350]
        - id: MakeLiteralTag_FormState
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2000, 350]
        # Step 5: Apply new form state
        - id: ApplyCrawlerState
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_CrawlerState
          position: [2500, 200]
        # Step 6: Remove Transitioning tag
        - id: RemoveTransitioningTag
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [2700, 200]
        - id: MakeTagContainer_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2600, 300]
        - id: MakeLiteralTag_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2500, 350]
        # Continue form switch flow after transition
        - id: DetachFromActor
          type: CallFunction
          properties:
            function: K2_DetachFromActor
          position: [2900, 200]
        - id: SetCurrentForm_Switch
          type: PropertySet
          properties:
            property_name: CurrentForm
            target_class: BP_FatherCompanion
          position: [3100, 200]
        - id: SetIsAttached_Switch
          type: PropertySet
          properties:
            property_name: IsAttached
            target_class: BP_FatherCompanion
          position: [3300, 200]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3500, 200]
        - id: EndAbility_Switch
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3700, 200]
        # === POST-DELAY GUARDS (GAS Audit CRIT-4 fix) ===
        # Guard 1: Validate FatherRef
        - id: GetFatherRef_Guard
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [2100, 400]
        - id: IsValid_FatherRef_Guard
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2200, 350]
        - id: Branch_FatherValid_Guard
          type: Branch
          position: [2350, 350]
        # Guard 2: Check Father.State.Transitioning tag (still in valid transition)
        - id: GetFatherASC_Guard
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [2400, 450]
        - id: HasTransitioningTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2550, 400]
        - id: MakeLiteralTag_Transitioning_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2400, 500]
        - id: Branch_TransitioningTag_Guard
          type: Branch
          position: [2700, 350]
        # Guard 3: Check Effect.Father.FormState tag (identity intact) - NL-GUARD-IDENTITY L1
        - id: HasFormStateTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2850, 400]
        - id: MakeLiteralTag_FormState_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2700, 500]
        - id: Branch_FormState_Guard
          type: Branch
          position: [3000, 350]
        # === EVENT_ENDABILITY (GAS Audit CRIT-4 fix) ===
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 600]
        - id: Branch_WasCancelled
          type: Branch
          position: [250, 600]
        # Cleanup path (only when cancelled) - remove Transitioning tag
        - id: GetFatherRef_End
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [400, 700]
        - id: IsValid_Father_End
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [500, 650]
        - id: Branch_FatherValid_End
          type: Branch
          position: [650, 600]
        - id: GetFatherASC_End
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [750, 700]
        - id: RemoveTransitioningTag_End
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [900, 600]
        - id: MakeTagContainer_End
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [800, 750]
        - id: MakeLiteralTag_End
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [700, 800]
      connections:
        # Exec flow (GetAvatarActor is pure - no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [Branch_First, Exec]
        # === FIRST ACTIVATION PATH (True branch) - Skip VFX/delay, merge into CommitCooldown ===
        # v4.26 (Rule 4): True path must merge into stateful setup chain, not early-terminate
        - from: [Branch_First, True]
          to: [SetCurrentForm, Exec]
        - from: [SetCurrentForm, Exec]
          to: [SetIsAttached, Exec]
        - from: [SetIsAttached, Exec]
          to: [SetFirstFalse, Exec]
        - from: [SetFirstFalse, Exec]
          to: [CommitCooldown, Exec]
        # === FORM SWITCH PATH (False branch) - v4.13.5: NO invulnerability ===
        - from: [Branch_First, False]
          to: [AddTransitioningTag, Exec]
        - from: [AddTransitioningTag, Exec]
          to: [SpawnTransitionVFX, Exec]
        - from: [SpawnTransitionVFX, Exec]
          to: [TransitionDelay, Exec]
        # v4.14: Route through guards after delay (GAS Audit CRIT-4)
        - from: [TransitionDelay, OnFinish]
          to: [Branch_FatherValid_Guard, Exec]
        - from: [Branch_FatherValid_Guard, True]
          to: [Branch_TransitioningTag_Guard, Exec]
        - from: [Branch_TransitioningTag_Guard, True]
          to: [Branch_FormState_Guard, Exec]
        # v5.0: Guard 3 (NL-GUARD-IDENTITY L1) - identity tag check
        - from: [Branch_FormState_Guard, True]
          to: [RemovePriorFormState, Exec]
        - from: [RemovePriorFormState, Exec]
          to: [ApplyCrawlerState, Exec]
        - from: [ApplyCrawlerState, Exec]
          to: [RemoveTransitioningTag, Exec]
        - from: [RemoveTransitioningTag, Exec]
          to: [DetachFromActor, Exec]
        - from: [DetachFromActor, Exec]
          to: [SetCurrentForm_Switch, Exec]
        - from: [SetCurrentForm_Switch, Exec]
          to: [SetIsAttached_Switch, Exec]
        - from: [SetIsAttached_Switch, Exec]
          to: [CommitCooldown, Exec]
        - from: [CommitCooldown, Exec]
          to: [EndAbility_Switch, Exec]
        # Data flow - Cast
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetCurrentForm, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetIsAttached, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [DetachFromActor, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetCurrentForm_Switch, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetIsAttached_Switch, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherASC_Transition, Actor]
        # Data flow - Branch condition
        - from: [GetFirstActivation, bIsFirstActivation]
          to: [Branch_First, Condition]
        # Data flow - Transitioning tag (v4.13.5)
        - from: [MakeLiteralTag_AddTransitioning, ReturnValue]
          to: [MakeTagContainer_AddTransitioning, Tag]
        - from: [MakeTagContainer_AddTransitioning, ReturnValue]
          to: [AddTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [AddTransitioningTag, Actor]
        - from: [MakeLiteralTag_RemoveTransitioning, ReturnValue]
          to: [MakeTagContainer_RemoveTransitioning, Tag]
        - from: [MakeTagContainer_RemoveTransitioning, ReturnValue]
          to: [RemoveTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [RemoveTransitioningTag, Actor]
        # Data flow - VFX spawn
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherMesh, Target]
        - from: [GetFatherMesh, Mesh]
          to: [SpawnTransitionVFX, AttachToComponent]
        # Data flow - Tag container for form state removal
        - from: [MakeLiteralTag_FormState, ReturnValue]
          to: [MakeTagContainer_FormState, Tag]
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState, WithGrantedTags]
        # === GUARD DATA FLOW (GAS Audit CRIT-4) ===
        # Guard 1: IsValid(FatherRef)
        - from: [GetFatherRef_Guard, FatherRef]
          to: [IsValid_FatherRef_Guard, Object]
        - from: [IsValid_FatherRef_Guard, ReturnValue]
          to: [Branch_FatherValid_Guard, Condition]
        - from: [GetFatherRef_Guard, FatherRef]
          to: [GetFatherASC_Guard, Actor]
        # Guard 2: HasMatchingGameplayTag(Father.State.Transitioning)
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Target]
        - from: [MakeLiteralTag_Transitioning_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Tag]
        - from: [HasTransitioningTag_Guard, ReturnValue]
          to: [Branch_TransitioningTag_Guard, Condition]
        # Guard 3: HasMatchingGameplayTag(Effect.Father.FormState) - NL-GUARD-IDENTITY L1
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Target]
        - from: [MakeLiteralTag_FormState_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Tag]
        - from: [HasFormStateTag_Guard, ReturnValue]
          to: [Branch_FormState_Guard, Condition]
        # === EVENT_ENDABILITY FLOW (GAS Audit CRIT-4) ===
        - from: [Event_EndAbility, Then]
          to: [Branch_WasCancelled, Exec]
        - from: [Event_EndAbility, bWasCancelled]
          to: [Branch_WasCancelled, Condition]
        - from: [Branch_WasCancelled, True]
          to: [Branch_FatherValid_End, Exec]
        - from: [GetFatherRef_End, FatherRef]
          to: [IsValid_Father_End, Object]
        - from: [IsValid_Father_End, ReturnValue]
          to: [Branch_FatherValid_End, Condition]
        - from: [Branch_FatherValid_End, True]
          to: [RemoveTransitioningTag_End, Exec]
        - from: [GetFatherRef_End, FatherRef]
          to: [GetFatherASC_End, Actor]
        - from: [GetFatherRef_End, FatherRef]
          to: [RemoveTransitioningTag_End, Actor]
        - from: [MakeLiteralTag_End, ReturnValue]
          to: [MakeTagContainer_End, Tag]
        - from: [MakeTagContainer_End, ReturnValue]
          to: [RemoveTransitioningTag_End, GameplayTags]

  # GA_FatherArmor - Attach to Player Chest (Option B Form Identity)
  # v4.13.5: GAS Audit compliant - NO invulnerability per INV-1
  - name: GA_FatherArmor
    folder: Abilities/Forms
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_FormChangeCooldown
    tags:
      ability_tags:
        - Ability.Father.Armor
      cancel_abilities_with_tag:
        - Ability.Father.Crawler
        - Ability.Father.Exoskeleton
        - Ability.Father.Engineer
      activation_owned_tags:
        # Father.Form.Armor removed - form identity via GE_ArmorState (Option B)
        - Father.State.Attached
      activation_required_tags:
        - Father.State.Alive
        - Father.State.Recruited
      activation_blocked_tags:
        - Father.State.Dormant
        - Father.State.Transitioning
        - Father.State.SymbioteLocked
        - Cooldown.Father.FormChange
    # v7.7: Delegate bindings REMOVED - Track E audit. Use AbilityTasks instead.
    # See: ClaudeContext/Handoffs/Track_E_Removal_Audit_v7_7.md
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: FatherASC
        type: Object
        class: NarrativeAbilitySystemComponent   # ASC variable for delegate binding source
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: OriginalWalkSpeed
        type: Float
        default_value: 0.0
        instance_editable: true
      - name: SpeedPenaltyMultiplier
        type: Float
        default_value: 0.85
        instance_editable: true
      - name: ChestSocketName
        type: Name
        default_value: FatherChestSocket
        instance_editable: true
      - name: bIsFirstActivation
        type: Bool
        default_value: true
    event_graph:
      nodes:
        # === ACTIVATION FLOW (Row Y=0 for exec, Y=-150 for pure getters) ===
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [400, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [800, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [1200, 0]
        # v4.14: First activation vs form switch branch
        - id: GetFirstActivation
          type: VariableGet
          properties:
            variable_name: bIsFirstActivation
          position: [1400, 100]
        - id: Branch_First
          type: Branch
          position: [1500, 0]
        # === FIRST ACTIVATION PATH (Row Y=-200) - Simple setup, no VFX/delay ===
        - id: RemovePriorFormState_First
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [1700, -200]
        - id: ApplyArmorState_First
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_ArmorState
          position: [2100, -200]
        - id: SetFirstFalse
          type: VariableSet
          properties:
            variable_name: bIsFirstActivation
          position: [2300, -200]
        - id: EndAbility_First
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2500, -200]
        # === FORM SWITCH PATH (Row Y=200) - Full transition with VFX/delay ===
        # v4.13.5: FULL TRANSITION FLOW (Option B + VFX, NO Invulnerability per GAS Audit INV-1)
        # Step 1: Add Transitioning tag
        - id: GetFatherASC_Transition
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1700, 300]
        - id: AddTransitioningTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1900, 200]
        - id: MakeTagContainer_AddTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [1800, 300]
        - id: MakeLiteralTag_AddTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [1700, 350]
        # Step 2: Spawn transition VFX
        - id: GetFatherMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [1900, 450]
        - id: SpawnTransitionVFX
          type: CallFunction
          properties:
            function: SpawnSystemAttached
            class: NiagaraFunctionLibrary
          position: [2100, 200]
        # Step 3: Wait 5 seconds (v4.15: WaitDelay auto-terminates with ability)
        - id: TransitionDelay
          type: AbilityTaskWaitDelay
          properties:
            duration: 5.0
          position: [2300, 200]
        # === POST-DELAY GUARDS (GAS Audit MED-1 - move guards BEFORE GE ops) ===
        # Guard 1: Validate FatherRef
        - id: GetFatherRef_Guard
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [2400, 350]
        - id: IsValid_FatherRef_Guard
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2450, 300]
        - id: Branch_FatherValid_Guard
          type: Branch
          position: [2550, 200]
        # Guard 2: Check Father.State.Transitioning tag
        - id: GetFatherASC_Guard
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [2600, 350]
        - id: HasTransitioningTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2700, 300]
        - id: MakeLiteralTag_Transitioning_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2600, 400]
        - id: Branch_TransitioningTag_Guard
          type: Branch
          position: [2850, 200]
        # Guard 3: Check Effect.Father.FormState tag (identity intact) - NL-GUARD-IDENTITY L1
        - id: HasFormStateTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [3000, 300]
        - id: MakeLiteralTag_FormState_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2850, 450]
        - id: Branch_FormState_Guard
          type: Branch
          position: [3150, 200]
        # Step 4: Remove prior form state (now guarded)
        - id: RemovePriorFormState
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [2500, 200]
        - id: MakeTagContainer_FormState
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2400, 350]
        - id: MakeLiteralTag_FormState
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2200, 350]
        # Step 5: Apply new form state
        - id: ApplyArmorState
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_ArmorState
          position: [2700, 200]
        # Step 6: Remove Transitioning tag
        - id: RemoveTransitioningTag
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [2900, 200]
        - id: MakeTagContainer_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2800, 300]
        - id: MakeLiteralTag_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2700, 350]
        # Pure nodes - below main exec flow
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [1200, -150]
        - id: IsValid_Player
          type: CallFunction
          properties:
            function: IsValid
          position: [1500, -150]
        - id: Branch_Valid
          type: Branch
          position: [1600, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [2000, 0]
        # Pure getters for CharacterMovement chain
        - id: GetCharMov
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [2000, -150]
        - id: GetMaxSpeed
          type: PropertyGet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [2300, -150]
        - id: SetOrigSpeed
          type: VariableSet
          properties:
            variable_name: OriginalWalkSpeed
          position: [2400, 0]
        - id: GetPenalty
          type: VariableGet
          properties:
            variable_name: SpeedPenaltyMultiplier
          position: [2600, -150]
        - id: MultiplySpeed
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [2800, -150]
        - id: SetMaxSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [2800, 0]
        # Pure getters for attach
        - id: GetMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [3000, -150]
        - id: GetSocket
          type: VariableGet
          properties:
            variable_name: ChestSocketName
          position: [3000, -280]
        - id: AttachToComponent
          type: CallFunction
          properties:
            function: K2_AttachToComponent
          position: [3200, 0]
        - id: SetCurrentForm
          type: PropertySet
          properties:
            property_name: CurrentForm
            target_class: BP_FatherCompanion
          position: [3600, 0]
        - id: SetIsAttached
          type: PropertySet
          properties:
            property_name: IsAttached
            target_class: BP_FatherCompanion
          position: [4000, 0]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [4400, 0]
        # === END ABILITY FLOW (Row Y=500) ===
        # v2.5.5: Added bWasCancelled check - cleanup only runs when cancelled by form switch
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 500]
        # Branch on bWasCancelled - only cleanup when cancelled by another form
        - id: Branch_WasCancelled
          type: Branch
          position: [300, 500]
        # Pure getters for end flow (only used in TRUE path)
        - id: GetPlayerRef_End
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [700, 350]
        - id: IsValid_End
          type: CallFunction
          properties:
            function: IsValid
          position: [1000, 350]
        - id: Branch_End
          type: Branch
          position: [700, 500]
        - id: GetCharMov_End
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [1100, 350]
        - id: GetOrigSpeed
          type: VariableGet
          properties:
            variable_name: OriginalWalkSpeed
          position: [1400, 350]
        - id: RestoreSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [1100, 500]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (GetAvatarActor is pure - no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [Branch_First, Exec]
        # === FIRST ACTIVATION PATH (True branch) - Skip VFX/delay, merge into setup chain ===
        # v4.26 (Rule 4): True path must merge into stateful setup chain, not early-terminate
        - from: [Branch_First, True]
          to: [RemovePriorFormState_First, Exec]
        - from: [RemovePriorFormState_First, Exec]
          to: [ApplyArmorState_First, Exec]
        - from: [ApplyArmorState_First, Exec]
          to: [SetFirstFalse, Exec]
        - from: [SetFirstFalse, Exec]
          to: [Branch_Valid, Exec]
        # === FORM SWITCH PATH (False branch) - v4.13.5: NO invulnerability ===
        - from: [Branch_First, False]
          to: [AddTransitioningTag, Exec]
        - from: [AddTransitioningTag, Exec]
          to: [SpawnTransitionVFX, Exec]
        - from: [SpawnTransitionVFX, Exec]
          to: [TransitionDelay, Exec]
        # v4.14: Route through guards after delay (GAS Audit MED-1)
        - from: [TransitionDelay, OnFinish]
          to: [Branch_FatherValid_Guard, Exec]
        - from: [Branch_FatherValid_Guard, True]
          to: [Branch_TransitioningTag_Guard, Exec]
        - from: [Branch_TransitioningTag_Guard, True]
          to: [Branch_FormState_Guard, Exec]
        # v5.0: Guard 3 (NL-GUARD-IDENTITY L1) - identity tag check
        - from: [Branch_FormState_Guard, True]
          to: [RemovePriorFormState, Exec]
        - from: [RemovePriorFormState, Exec]
          to: [ApplyArmorState, Exec]
        - from: [ApplyArmorState, Exec]
          to: [RemoveTransitioningTag, Exec]
        - from: [RemoveTransitioningTag, Exec]
          to: [Branch_Valid, Exec]
        - from: [Branch_Valid, then]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [SetOrigSpeed, Exec]
        - from: [SetOrigSpeed, Exec]
          to: [SetMaxSpeed, Exec]
        - from: [SetMaxSpeed, Exec]
          to: [AttachToComponent, Exec]
        - from: [AttachToComponent, Exec]
          to: [SetCurrentForm, Exec]
        - from: [SetCurrentForm, Exec]
          to: [SetIsAttached, Exec]
        - from: [SetIsAttached, Exec]
          to: [CommitCooldown, Exec]
        # Data flow - GetAvatarActor to Cast
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        # Data flow - Cast output to SetFatherRef INPUT and other destinations
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetOwnerPlayer, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [AttachToComponent, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetCurrentForm, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetIsAttached, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherASC_Transition, Actor]
        # Data flow - Branch condition
        - from: [GetFirstActivation, bIsFirstActivation]
          to: [Branch_First, Condition]
        # Data flow - First activation path (tag container for form state removal)
        - from: [MakeLiteralTag_FormState, ReturnValue]
          to: [MakeTagContainer_FormState, Tag]
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState_First, WithGrantedTags]
        # Data flow - Form switch path (tag containers)
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState, WithGrantedTags]
        # v4.13.5: Transitioning tag via AddLooseGameplayTag (not GE)
        - from: [MakeLiteralTag_AddTransitioning, ReturnValue]
          to: [MakeTagContainer_AddTransitioning, Tag]
        - from: [MakeTagContainer_AddTransitioning, ReturnValue]
          to: [AddTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [AddTransitioningTag, Actor]
        - from: [MakeLiteralTag_RemoveTransitioning, ReturnValue]
          to: [MakeTagContainer_RemoveTransitioning, Tag]
        - from: [MakeTagContainer_RemoveTransitioning, ReturnValue]
          to: [RemoveTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [RemoveTransitioningTag, Actor]
        # Data flow - VFX spawn
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherMesh, Target]
        - from: [GetFatherMesh, Mesh]
          to: [SpawnTransitionVFX, AttachToComponent]
        # === GUARD DATA FLOW (GAS Audit MED-1) ===
        # Guard 1: IsValid(FatherRef)
        - from: [GetFatherRef_Guard, FatherRef]
          to: [IsValid_FatherRef_Guard, Object]
        - from: [IsValid_FatherRef_Guard, ReturnValue]
          to: [Branch_FatherValid_Guard, Condition]
        - from: [GetFatherRef_Guard, FatherRef]
          to: [GetFatherASC_Guard, Actor]
        # Guard 2: HasMatchingGameplayTag(Father.State.Transitioning)
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Target]
        - from: [MakeLiteralTag_Transitioning_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Tag]
        - from: [HasTransitioningTag_Guard, ReturnValue]
          to: [Branch_TransitioningTag_Guard, Condition]
        # Guard 3: HasMatchingGameplayTag(Effect.Father.FormState) - NL-GUARD-IDENTITY L1
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Target]
        - from: [MakeLiteralTag_FormState_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Tag]
        - from: [HasFormStateTag_Guard, ReturnValue]
          to: [Branch_FormState_Guard, Condition]
        # Data flow - GetOwnerPlayer to IsValid
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [IsValid_Player, Object]
        # Data flow - IsValid result to Branch condition
        - from: [IsValid_Player, ReturnValue]
          to: [Branch_Valid, Condition]
        # Data flow - OwnerPlayer to SetPlayerRef INPUT and other destinations
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [GetCharMov, Target]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [GetMesh, Target]
        # Data flow - CharMov to GetMaxSpeed and SetMaxSpeed
        - from: [GetCharMov, CharacterMovement]
          to: [GetMaxSpeed, Target]
        - from: [GetCharMov, CharacterMovement]
          to: [SetMaxSpeed, Target]
        # Data flow - MaxSpeed to SetOrigSpeed value and multiply
        - from: [GetMaxSpeed, MaxWalkSpeed]
          to: [SetOrigSpeed, OriginalWalkSpeed]
        - from: [GetMaxSpeed, MaxWalkSpeed]
          to: [MultiplySpeed, A]
        # Data flow - Speed calculation
        - from: [GetPenalty, SpeedPenaltyMultiplier]
          to: [MultiplySpeed, B]
        - from: [MultiplySpeed, ReturnValue]
          to: [SetMaxSpeed, MaxWalkSpeed]
        # Data flow - AttachToComponent inputs
        - from: [GetMesh, Mesh]
          to: [AttachToComponent, Parent]
        - from: [GetSocket, ChestSocketName]
          to: [AttachToComponent, SocketName]
        # === END ABILITY FLOW ===
        # v2.5.5: First check bWasCancelled - only cleanup when cancelled by form switch
        - from: [Event_EndAbility, Then]
          to: [Branch_WasCancelled, Exec]
        - from: [Event_EndAbility, bWasCancelled]
          to: [Branch_WasCancelled, Condition]
        # TRUE path (was cancelled by form switch) - do cleanup
        - from: [Branch_WasCancelled, then]
          to: [Branch_End, Exec]
        - from: [Branch_End, then]
          to: [RestoreSpeed, Exec]
        # FALSE path (normal end after setup) - skip cleanup (no connection needed)
        # Data flow - PlayerRef to IsValid (pure nodes)
        - from: [GetPlayerRef_End, PlayerRef]
          to: [IsValid_End, Object]
        - from: [IsValid_End, ReturnValue]
          to: [Branch_End, Condition]
        # Data flow - PlayerRef to GetCharMov_End (pure node)
        - from: [GetPlayerRef_End, PlayerRef]
          to: [GetCharMov_End, Target]
        # Data flow - CharMov to RestoreSpeed target
        - from: [GetCharMov_End, CharacterMovement]
          to: [RestoreSpeed, Target]
        # Data flow - Original speed to restore
        - from: [GetOrigSpeed, OriginalWalkSpeed]
          to: [RestoreSpeed, NewMaxWalkSpeed]

  # GA_FatherExoskeleton - Attach to Player Back with Speed/Jump Boost (Option B Form Identity)
  # v4.14.3: GAS Audit FIX-3 - Added JumpZVelocity boost and restore; INV-1 compliant (no invulnerability)
  - name: GA_FatherExoskeleton
    folder: Abilities/Forms
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_FormChangeCooldown
    tags:
      ability_tags:
        - Ability.Father.Exoskeleton
      cancel_abilities_with_tag:
        - Ability.Father.Crawler
        - Ability.Father.Armor
        - Ability.Father.Engineer
      activation_owned_tags:
        - Father.State.Attached
      activation_required_tags:
        - Father.State.Alive
        - Father.State.Recruited
      activation_blocked_tags:
        - Father.State.Dormant
        - Father.State.Transitioning
        - Father.State.SymbioteLocked
        - Cooldown.Father.FormChange
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: OriginalWalkSpeed
        type: Float
        default_value: 0.0
        instance_editable: true
      - name: OriginalJumpZVelocity
        type: Float
        default_value: 0.0
        instance_editable: true
      - name: SpeedBoostMultiplier
        type: Float
        default_value: 1.25
        instance_editable: true
      - name: JumpBoostMultiplier
        type: Float
        default_value: 1.3
        instance_editable: true
      - name: BackSocketName
        type: Name
        default_value: FatherBackSocket
        instance_editable: true
      - name: bIsFirstActivation
        type: Bool
        default_value: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        # v4.14: First activation vs form switch branch
        - id: GetFirstActivation
          type: VariableGet
          properties:
            variable_name: bIsFirstActivation
          position: [1100, 100]
        - id: Branch_First
          type: Branch
          position: [1200, 0]
        # === FIRST ACTIVATION PATH (Row Y=-200) - Simple setup, no VFX/delay ===
        - id: RemovePriorFormState_First
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [1600, -200]
        - id: ApplyExoskeletonState_First
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_ExoskeletonState
          position: [1800, -200]
        - id: SetFirstFalse
          type: VariableSet
          properties:
            variable_name: bIsFirstActivation
          position: [2000, -200]
        - id: EndAbility_First
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2200, -200]
        # === FORM SWITCH PATH (Row Y=200) - Full transition with VFX/delay ===
        # v4.13.5: FULL TRANSITION FLOW (Option B + VFX, NO Invulnerability per GAS Audit INV-1)
        # Step 1: Add Transitioning tag (instead of GE_TransitionInvulnerability)
        - id: GetFatherASC_Transition
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1500, 300]
        - id: AddTransitioningTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1600, 200]
        - id: MakeTagContainer_AddTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [1500, 250]
        - id: MakeLiteralTag_AddTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [1400, 300]
        # Step 2: Spawn transition VFX
        - id: GetFatherMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [1600, 350]
        - id: SpawnTransitionVFX
          type: CallFunction
          properties:
            function: SpawnSystemAttached
            class: NiagaraFunctionLibrary
          position: [1800, 200]
        # Step 3: Wait 5 seconds (v4.15: WaitDelay auto-terminates with ability)
        - id: TransitionDelay
          type: AbilityTaskWaitDelay
          properties:
            duration: 5.0
          position: [2000, 200]
        # === POST-DELAY GUARDS (GAS Audit MED-2) ===
        # Guard 1: Validate FatherRef
        - id: GetFatherRef_Guard
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [2050, 350]
        - id: IsValid_FatherRef_Guard
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2100, 300]
        - id: Branch_FatherValid_Guard
          type: Branch
          position: [2200, 200]
        # Guard 2: Check Father.State.Transitioning tag
        - id: GetFatherASC_Guard
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [2250, 350]
        - id: HasTransitioningTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2350, 300]
        - id: MakeLiteralTag_Transitioning_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2250, 400]
        - id: Branch_TransitioningTag_Guard
          type: Branch
          position: [2500, 200]
        # Guard 3: Check Effect.Father.FormState tag (identity intact) - NL-GUARD-IDENTITY L1
        - id: HasFormStateTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2650, 300]
        - id: MakeLiteralTag_FormState_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2500, 450]
        - id: Branch_FormState_Guard
          type: Branch
          position: [2800, 200]
        # Step 4: Remove prior form state (now guarded)
        - id: RemovePriorFormState
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [2900, 200]
        - id: MakeTagContainer_FormState
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2600, 350]
        - id: MakeLiteralTag_FormState
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2400, 350]
        # Step 5: Apply new form state
        - id: ApplyExoskeletonState
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_ExoskeletonState
          position: [2400, 200]
        # Step 6: Remove Transitioning tag (v4.13.5: replaces GE removal)
        - id: RemoveTransitioningTag
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [2600, 200]
        - id: MakeTagContainer_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2550, 300]
        - id: MakeLiteralTag_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2500, 350]
        # Continue form switch flow after transition
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [1500, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1800, 0]
        - id: GetCharMov
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [1800, 0]
        - id: GetMaxSpeed
          type: PropertyGet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [2100, 0]
        - id: SetOrigSpeed
          type: VariableSet
          properties:
            variable_name: OriginalWalkSpeed
          position: [2400, 0]
        - id: GetSpeedBoost
          type: VariableGet
          properties:
            variable_name: SpeedBoostMultiplier
          position: [2400, 100]
        - id: MultiplySpeed
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [2700, 0]
        - id: SetMaxSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [3000, 0]
        # v4.14.3: Jump boost (FIX-3 per GAS Audit)
        - id: GetJumpZVelocity
          type: PropertyGet
          properties:
            property_name: JumpZVelocity
            target_class: CharacterMovementComponent
          position: [3000, -100]
        - id: SetOrigJump
          type: VariableSet
          properties:
            variable_name: OriginalJumpZVelocity
          position: [3200, 0]
        - id: GetJumpBoost
          type: VariableGet
          properties:
            variable_name: JumpBoostMultiplier
          position: [3200, 100]
        - id: MultiplyJump
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [3400, 0]
        - id: SetJumpVelocity
          type: PropertySet
          properties:
            property_name: JumpZVelocity
            target_class: CharacterMovementComponent
          position: [3600, 0]
        - id: GetMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [3000, 100]
        - id: GetBackSocket
          type: VariableGet
          properties:
            variable_name: BackSocketName
          position: [3000, 200]
        - id: AttachToComponent
          type: CallFunction
          properties:
            function: K2_AttachToComponent
          position: [3300, 0]
        - id: SetCurrentForm
          type: PropertySet
          properties:
            property_name: CurrentForm
            target_class: BP_FatherCompanion
          position: [3600, 0]
        - id: SetIsAttached
          type: PropertySet
          properties:
            property_name: IsAttached
            target_class: BP_FatherCompanion
          position: [3900, 0]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [4200, 0]
        # v2.5.5: Added bWasCancelled check - cleanup only runs when cancelled by form switch
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 400]
        - id: Branch_WasCancelled
          type: Branch
          position: [300, 400]
        - id: GetPlayerRef_End
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [600, 400]
        - id: GetCharMov_End
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [900, 400]
        - id: GetOrigSpeed_End
          type: VariableGet
          properties:
            variable_name: OriginalWalkSpeed
          position: [1200, 500]
        - id: RestoreSpeed_End
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [1200, 400]
        # v4.14.3: Jump restore (FIX-3 per GAS Audit)
        - id: GetOrigJump_End
          type: VariableGet
          properties:
            variable_name: OriginalJumpZVelocity
          position: [1500, 500]
        - id: RestoreJump_End
          type: PropertySet
          properties:
            property_name: JumpZVelocity
            target_class: CharacterMovementComponent
          position: [1500, 400]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (GetAvatarActor is pure - no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [Branch_First, Exec]
        # === FIRST ACTIVATION PATH (True branch) - Skip VFX/delay, merge into setup chain ===
        # v4.26 (Rule 4): True path must merge into stateful setup chain, not early-terminate
        - from: [Branch_First, True]
          to: [RemovePriorFormState_First, Exec]
        - from: [RemovePriorFormState_First, Exec]
          to: [ApplyExoskeletonState_First, Exec]
        - from: [ApplyExoskeletonState_First, Exec]
          to: [SetFirstFalse, Exec]
        - from: [SetFirstFalse, Exec]
          to: [SetPlayerRef, Exec]
        # === FORM SWITCH PATH (False branch) - Full transition with VFX/delay ===
        # v4.13.5: NO invulnerability - uses AddLooseGameplayTag/RemoveLooseGameplayTag
        - from: [Branch_First, False]
          to: [AddTransitioningTag, Exec]
        - from: [AddTransitioningTag, Exec]
          to: [SpawnTransitionVFX, Exec]
        - from: [SpawnTransitionVFX, Exec]
          to: [TransitionDelay, Exec]
        # v4.14: Route through guards after delay (GAS Audit MED-2)
        - from: [TransitionDelay, OnFinish]
          to: [Branch_FatherValid_Guard, Exec]
        - from: [Branch_FatherValid_Guard, True]
          to: [Branch_TransitioningTag_Guard, Exec]
        - from: [Branch_TransitioningTag_Guard, True]
          to: [Branch_FormState_Guard, Exec]
        # v5.0: Guard 3 (NL-GUARD-IDENTITY L1) - identity tag check
        - from: [Branch_FormState_Guard, True]
          to: [RemovePriorFormState, Exec]
        - from: [RemovePriorFormState, Exec]
          to: [ApplyExoskeletonState, Exec]
        - from: [ApplyExoskeletonState, Exec]
          to: [RemoveTransitioningTag, Exec]
        - from: [RemoveTransitioningTag, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [SetOrigSpeed, Exec]
        - from: [SetOrigSpeed, Exec]
          to: [SetMaxSpeed, Exec]
        - from: [SetMaxSpeed, Exec]
          to: [SetOrigJump, Exec]
        # v4.14.3: Jump boost exec flow (FIX-3 per GAS Audit)
        - from: [SetOrigJump, Exec]
          to: [SetJumpVelocity, Exec]
        - from: [SetJumpVelocity, Exec]
          to: [AttachToComponent, Exec]
        - from: [AttachToComponent, Exec]
          to: [SetCurrentForm, Exec]
        - from: [SetCurrentForm, Exec]
          to: [SetIsAttached, Exec]
        - from: [SetIsAttached, Exec]
          to: [CommitCooldown, Exec]
        # Data flow - GetAvatarActor to Cast
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        # Data flow - Cast output to SetFatherRef INPUT and other destinations
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetOwnerPlayer, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [AttachToComponent, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetCurrentForm, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetIsAttached, Target]
        # Data flow - Branch condition
        - from: [GetFirstActivation, bIsFirstActivation]
          to: [Branch_First, Condition]
        # Data flow - First activation path (tag container for form state removal)
        - from: [MakeLiteralTag_FormState, ReturnValue]
          to: [MakeTagContainer_FormState, Tag]
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState_First, WithGrantedTags]
        # Data flow - Form switch path (tag containers)
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState, WithGrantedTags]
        # v4.13.5: Data flow for Transitioning tag (AddLooseGameplayTag/RemoveLooseGameplayTag)
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherASC_Transition, Actor]
        - from: [CastToFather, AsBP Father Companion]
          to: [AddTransitioningTag, Actor]
        - from: [MakeLiteralTag_AddTransitioning, ReturnValue]
          to: [MakeTagContainer_AddTransitioning, Tag]
        - from: [MakeTagContainer_AddTransitioning, ReturnValue]
          to: [AddTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [RemoveTransitioningTag, Actor]
        - from: [MakeLiteralTag_RemoveTransitioning, ReturnValue]
          to: [MakeTagContainer_RemoveTransitioning, Tag]
        - from: [MakeTagContainer_RemoveTransitioning, ReturnValue]
          to: [RemoveTransitioningTag, GameplayTags]
        # === GUARD DATA FLOW (GAS Audit MED-2) ===
        # Guard 1: IsValid(FatherRef)
        - from: [GetFatherRef_Guard, FatherRef]
          to: [IsValid_FatherRef_Guard, Object]
        - from: [IsValid_FatherRef_Guard, ReturnValue]
          to: [Branch_FatherValid_Guard, Condition]
        - from: [GetFatherRef_Guard, FatherRef]
          to: [GetFatherASC_Guard, Actor]
        # Guard 2: HasMatchingGameplayTag(Father.State.Transitioning)
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Target]
        - from: [MakeLiteralTag_Transitioning_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Tag]
        - from: [HasTransitioningTag_Guard, ReturnValue]
          to: [Branch_TransitioningTag_Guard, Condition]
        # Guard 3: HasMatchingGameplayTag(Effect.Father.FormState) - NL-GUARD-IDENTITY L1
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Target]
        - from: [MakeLiteralTag_FormState_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Tag]
        - from: [HasFormStateTag_Guard, ReturnValue]
          to: [Branch_FormState_Guard, Condition]
        # Data flow - VFX spawn
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherMesh, Target]
        - from: [GetFatherMesh, Mesh]
          to: [SpawnTransitionVFX, AttachToComponent]
        # Data flow - Player
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [GetCharMov, Target]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [GetMesh, Target]
        # Data flow - CharMov
        - from: [GetCharMov, CharacterMovement]
          to: [GetMaxSpeed, Target]
        - from: [GetCharMov, CharacterMovement]
          to: [SetMaxSpeed, Target]
        # Data flow - Speed
        - from: [GetMaxSpeed, MaxWalkSpeed]
          to: [SetOrigSpeed, OriginalWalkSpeed]
        - from: [GetMaxSpeed, MaxWalkSpeed]
          to: [MultiplySpeed, A]
        - from: [GetSpeedBoost, SpeedBoostMultiplier]
          to: [MultiplySpeed, B]
        - from: [MultiplySpeed, ReturnValue]
          to: [SetMaxSpeed, NewMaxWalkSpeed]
        # v4.14.3: Data flow - Jump (FIX-3 per GAS Audit)
        - from: [GetCharMov, CharacterMovement]
          to: [GetJumpZVelocity, Target]
        - from: [GetJumpZVelocity, JumpZVelocity]
          to: [SetOrigJump, OriginalJumpZVelocity]
        - from: [GetJumpZVelocity, JumpZVelocity]
          to: [MultiplyJump, A]
        - from: [GetJumpBoost, JumpBoostMultiplier]
          to: [MultiplyJump, B]
        - from: [MultiplyJump, ReturnValue]
          to: [SetJumpVelocity, NewJumpZVelocity]
        - from: [GetCharMov, CharacterMovement]
          to: [SetJumpVelocity, Target]
        # Data flow - Attach
        - from: [GetMesh, Mesh]
          to: [AttachToComponent, Parent]
        - from: [GetBackSocket, BackSocketName]
          to: [AttachToComponent, SocketName]
        # === END ABILITY FLOW ===
        # v2.5.5: check bWasCancelled first
        - from: [Event_EndAbility, Then]
          to: [Branch_WasCancelled, Exec]
        - from: [Event_EndAbility, bWasCancelled]
          to: [Branch_WasCancelled, Condition]
        # TRUE path (was cancelled by form switch) - do cleanup
        - from: [Branch_WasCancelled, then]
          to: [RestoreSpeed_End, Exec]
        # v4.14.3: Chain jump restore after speed restore (FIX-3 per GAS Audit)
        - from: [RestoreSpeed_End, Exec]
          to: [RestoreJump_End, Exec]
        # FALSE path (normal end) - skip cleanup (no connection needed)
        - from: [GetPlayerRef_End, PlayerRef]
          to: [GetCharMov_End, Target]
        - from: [GetCharMov_End, CharacterMovement]
          to: [RestoreSpeed_End, Target]
        - from: [GetOrigSpeed_End, OriginalWalkSpeed]
          to: [RestoreSpeed_End, NewMaxWalkSpeed]
        # v4.14.3: Jump restore data flow (FIX-3 per GAS Audit)
        - from: [GetCharMov_End, CharacterMovement]
          to: [RestoreJump_End, Target]
        - from: [GetOrigJump_End, OriginalJumpZVelocity]
          to: [RestoreJump_End, NewJumpZVelocity]

  # GA_FatherSymbiote - Merge with Player (Timed) (Option B Form Identity)
  # v4.13.5: GAS Audit compliant - NO invulnerability, timer guards, Event_EndAbility
  - name: GA_FatherSymbiote
    folder: Abilities/Forms
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_FormChangeCooldown
    tags:
      ability_tags:
        - Ability.Father.Symbiote
      cancel_abilities_with_tag:
        - Ability.Father.Crawler
        - Ability.Father.Armor
        - Ability.Father.Exoskeleton
        - Ability.Father.Engineer
      activation_owned_tags:
        - Symbiote.State.Merged
      activation_required_tags:
        - Father.State.Alive
        - Father.State.Recruited
        - Symbiote.Charge.Ready
      activation_blocked_tags:
        - Father.State.Dormant
        - Father.State.Transitioning
        - Father.State.SymbioteLocked
        - Cooldown.Father.FormChange
    # v7.7: Delegate bindings REMOVED - Track E audit. Use AbilityTasks instead.
    # See: ClaudeContext/Handoffs/Track_E_Removal_Audit_v7_7.md
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: SymbioteDuration
        type: Float
        default_value: 30.0
        instance_editable: true
      - name: DurationTimerHandle
        type: TimerHandle
      - name: bIsFirstActivation
        type: Bool
        default_value: true
      # v4.13.5: Variables for speed/jump restoration (GAS Audit FIX-1)
      - name: OriginalMaxWalkSpeed
        type: Float
        default_value: 0.0
      - name: OriginalJumpZVelocity
        type: Float
        default_value: 0.0
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        # v4.28.2 (C_SYMBIOTE_STRICT_CANCEL): Apply GE_SymbioteDuration with SetByCaller at activation START
        # This grants Father.State.SymbioteLocked for 30s, blocking other form abilities
        - id: MakeSpec_SymbioteDuration
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_SymbioteDuration
          position: [50, -100]
        - id: GetSymbioteDuration_Spec
          type: VariableGet
          properties:
            variable_name: SymbioteDuration
          position: [50, -50]
        - id: MakeLiteralTag_DurationData
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Data.Symbiote.Duration
          position: [100, -50]
        - id: AssignSetByCaller_Duration
          type: CallFunction
          properties:
            function: AssignTagSetByCallerMagnitude
            class: AbilitySystemBlueprintLibrary
          position: [150, -100]
        - id: ApplySpec_SymbioteDuration
          type: CallFunction
          properties:
            function: ApplyGameplayEffectSpecToOwner
            target_self: true
          position: [200, -100]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        # v4.14: First activation vs form switch branch
        - id: GetFirstActivation
          type: VariableGet
          properties:
            variable_name: bIsFirstActivation
          position: [1100, 100]
        - id: Branch_First
          type: Branch
          position: [1200, 0]
        # === FIRST ACTIVATION PATH (Row Y=-200) - Simple setup, no VFX/delay ===
        - id: RemovePriorFormState_First
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [1600, -200]
        - id: ApplySymbioteState_First
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_SymbioteState
          position: [1800, -200]
        - id: SetFirstFalse
          type: VariableSet
          properties:
            variable_name: bIsFirstActivation
          position: [2000, -200]
        - id: EndAbility_First
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2200, -200]
        # === FORM SWITCH PATH (Row Y=200) - Full transition with VFX/delay ===
        # v4.13.5: FULL TRANSITION FLOW (Option B + VFX, NO Invulnerability per GAS Audit INV-1)
        # Step 1: Add Transitioning tag (instead of GE_TransitionInvulnerability)
        - id: GetFatherASC_Transition
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1500, 300]
        - id: AddTransitioningTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1700, 200]
        - id: MakeTagContainer_AddTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [1600, 300]
        - id: MakeLiteralTag_AddTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [1500, 350]
        # Step 2: Spawn transition VFX
        - id: GetFatherMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [1600, 450]
        - id: SpawnTransitionVFX
          type: CallFunction
          properties:
            function: SpawnSystemAttached
            class: NiagaraFunctionLibrary
          position: [1900, 200]
        # Step 3: Wait 5 seconds (v4.15: WaitDelay auto-terminates with ability)
        - id: TransitionDelay
          type: AbilityTaskWaitDelay
          properties:
            duration: 5.0
          position: [2100, 200]
        # === POST-DELAY GUARDS (v5.0 NL-GUARD-IDENTITY L1) ===
        # Guard 1: Validate FatherRef
        - id: GetFatherRef_Guard
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [2200, 350]
        - id: IsValid_FatherRef_Guard
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2300, 300]
        - id: Branch_FatherValid_Guard
          type: Branch
          position: [2400, 200]
        # Guard 2: Check Father.State.Transitioning tag
        - id: GetFatherASC_Guard
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [2450, 350]
        - id: HasTransitioningTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2550, 300]
        - id: MakeLiteralTag_Transitioning_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2450, 400]
        - id: Branch_TransitioningTag_Guard
          type: Branch
          position: [2700, 200]
        # Guard 3: Check Effect.Father.FormState tag (identity intact)
        - id: HasFormStateTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2850, 300]
        - id: MakeLiteralTag_FormState_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2700, 450]
        - id: Branch_FormState_Guard
          type: Branch
          position: [3000, 200]
        # Step 4: Remove prior form state (now guarded)
        - id: RemovePriorFormState
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [3200, 200]
        - id: MakeTagContainer_FormState
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2200, 350]
        - id: MakeLiteralTag_FormState
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2000, 350]
        # Step 5: Apply new form state
        - id: ApplySymbioteState
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_SymbioteState
          position: [2500, 200]
        # Step 6: Remove Transitioning tag (instead of GE removal)
        - id: RemoveTransitioningTag
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [2700, 200]
        - id: MakeTagContainer_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2600, 300]
        - id: MakeLiteralTag_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2500, 350]
        # Continue form switch flow after transition
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [1200, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1500, 0]
        - id: HideFather
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [1800, 0]
        - id: DisableCollision
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [2100, 0]
        - id: SetCurrentForm
          type: PropertySet
          properties:
            property_name: CurrentForm
            target_class: BP_FatherCompanion
          position: [2400, 0]
        - id: SetIsAttached
          type: PropertySet
          properties:
            property_name: IsAttached
            target_class: BP_FatherCompanion
          position: [2700, 0]
        - id: GetDuration
          type: VariableGet
          properties:
            variable_name: SymbioteDuration
          position: [3000, 100]
        - id: SetTimer
          type: CallFunction
          properties:
            function: K2_SetTimerDelegate
          position: [3000, 0]
        - id: SetTimerHandle
          type: VariableSet
          properties:
            variable_name: DurationTimerHandle
          position: [3300, 0]
        # v4.26 (VTF-7): CommitCooldown required when cooldown_gameplay_effect_class defined
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3500, 0]
        # === TIMER EXPIRED FLOW (with guards per GAS Audit FIX-2) ===
        - id: CustomEvent_TimerExpired
          type: CustomEvent
          properties:
            event_name: OnSymbioteTimerExpired
          position: [0, 400]
        # Guard 1: Validate FatherRef
        - id: GetFatherRef_Timer
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [100, 500]
        - id: IsValid_FatherRef
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [250, 400]
        - id: Branch_FatherValid
          type: Branch
          position: [400, 400]
        # Guard 2: Check CurrentForm == Symbiote
        - id: GetCurrentForm_Timer
          type: PropertyGet
          properties:
            property_name: CurrentForm
            target_class: BP_FatherCompanion
          position: [450, 550]
        - id: EqualEnum_Symbiote
          type: CallFunction
          properties:
            function: EqualEqual_ByteByte
          position: [600, 500]
        - id: Branch_FormCheck
          type: Branch
          position: [750, 400]
        # Guard 3: Check Symbiote.State.Merged tag (ability still active)
        - id: GetFatherASC_Timer
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [800, 550]
        - id: HasMergedTag
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [950, 500]
        - id: MakeLiteralTag_Merged
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Symbiote.State.Merged
          position: [800, 650]
        - id: Branch_MergedTag
          type: Branch
          position: [1100, 400]
        # Guarded timer callback logic
        - id: GetPlayerRef_Timer
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [1150, 550]
        - id: ShowFather
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [1250, 400]
        - id: EnableCollision
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1500, 400]
        - id: GetPlayerASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1550, 550]
        - id: TryActivateArmor
          type: CallFunction
          properties:
            function: TryActivateAbilityByClass
          position: [1750, 400]
        - id: EndAbility_Timer
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2000, 400]
        # === EVENT_ENDABILITY (with bWasCancelled check per GAS Audit FIX-1) ===
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 800]
        - id: Branch_WasCancelled
          type: Branch
          position: [250, 800]
        # Cleanup path (only when cancelled)
        - id: ClearTimer_End
          type: CallFunction
          properties:
            function: K2_ClearAndInvalidateTimerHandle
            class: KismetSystemLibrary
          position: [450, 800]
        - id: GetTimerHandle_End
          type: VariableGet
          properties:
            variable_name: DurationTimerHandle
          position: [300, 900]
        - id: GetFatherRef_End
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [500, 900]
        - id: IsValid_Father_End
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [650, 800]
        - id: Branch_FatherValid_End
          type: Branch
          position: [800, 800]
        - id: ShowFather_End
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [950, 800]
        - id: EnableCollision_End
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1150, 800]
        - id: TryActivateArmor_End
          type: CallFunction
          properties:
            function: TryActivateAbilityByClass
          position: [1350, 800]
        - id: GetFatherASC_End
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1200, 900]
      connections:
        # === ACTIVATION FLOW ===
        # v4.28.2 (C_SYMBIOTE_STRICT_CANCEL): Apply GE_SymbioteDuration at activation START
        # Exec flow: Event → MakeSpec → Assign → Apply → Cast → ...
        - from: [Event_Activate, Then]
          to: [MakeSpec_SymbioteDuration, Exec]
        - from: [MakeSpec_SymbioteDuration, Exec]
          to: [AssignSetByCaller_Duration, Exec]
        - from: [AssignSetByCaller_Duration, Exec]
          to: [ApplySpec_SymbioteDuration, Exec]
        - from: [ApplySpec_SymbioteDuration, Exec]
          to: [CastToFather, Exec]
        # Data flow for SetByCaller chain
        - from: [MakeSpec_SymbioteDuration, ReturnValue]
          to: [AssignSetByCaller_Duration, SpecHandle]
        - from: [GetSymbioteDuration_Spec, SymbioteDuration]
          to: [AssignSetByCaller_Duration, Magnitude]
        - from: [MakeLiteralTag_DurationData, ReturnValue]
          to: [AssignSetByCaller_Duration, DataTag]
        - from: [AssignSetByCaller_Duration, ReturnValue]
          to: [ApplySpec_SymbioteDuration, EffectSpecHandle]
        # Original flow continues
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [Branch_First, Exec]
        # === FIRST ACTIVATION PATH (True branch) - Skip VFX/delay, merge into setup chain ===
        # v4.26 (Rule 4): True path must merge into stateful setup chain, not early-terminate
        - from: [Branch_First, True]
          to: [RemovePriorFormState_First, Exec]
        - from: [RemovePriorFormState_First, Exec]
          to: [ApplySymbioteState_First, Exec]
        - from: [ApplySymbioteState_First, Exec]
          to: [SetFirstFalse, Exec]
        - from: [SetFirstFalse, Exec]
          to: [SetPlayerRef, Exec]
        # === FORM SWITCH PATH (False branch) - Full transition with VFX/delay ===
        # v4.13.5: No invulnerability - use AddLooseGameplayTag instead
        - from: [Branch_First, False]
          to: [AddTransitioningTag, Exec]
        - from: [AddTransitioningTag, Exec]
          to: [SpawnTransitionVFX, Exec]
        - from: [SpawnTransitionVFX, Exec]
          to: [TransitionDelay, Exec]
        # v5.0: Route through 3-layer guards after delay (NL-GUARD-IDENTITY L1)
        - from: [TransitionDelay, OnFinish]
          to: [Branch_FatherValid_Guard, Exec]
        - from: [Branch_FatherValid_Guard, True]
          to: [Branch_TransitioningTag_Guard, Exec]
        - from: [Branch_TransitioningTag_Guard, True]
          to: [Branch_FormState_Guard, Exec]
        - from: [Branch_FormState_Guard, True]
          to: [RemovePriorFormState, Exec]
        - from: [RemovePriorFormState, Exec]
          to: [ApplySymbioteState, Exec]
        - from: [ApplySymbioteState, Exec]
          to: [RemoveTransitioningTag, Exec]
        - from: [RemoveTransitioningTag, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [HideFather, Exec]
        - from: [HideFather, Exec]
          to: [DisableCollision, Exec]
        - from: [DisableCollision, Exec]
          to: [SetCurrentForm, Exec]
        - from: [SetCurrentForm, Exec]
          to: [SetIsAttached, Exec]
        - from: [SetIsAttached, Exec]
          to: [SetTimer, Exec]
        - from: [SetTimer, Exec]
          to: [SetTimerHandle, Exec]
        # v4.26 (VTF-7): CommitCooldown after setup complete
        - from: [SetTimerHandle, Exec]
          to: [CommitCooldown, Exec]
        # Data flow - GetAvatarActor to Cast
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        # Data flow - Cast output to SetFatherRef INPUT and other destinations
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetOwnerPlayer, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [HideFather, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [DisableCollision, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetCurrentForm, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetIsAttached, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherASC_Transition, Actor]
        # Data flow - Branch condition
        - from: [GetFirstActivation, bIsFirstActivation]
          to: [Branch_First, Condition]
        # Data flow - First activation path (tag container for form state removal)
        - from: [MakeLiteralTag_FormState, ReturnValue]
          to: [MakeTagContainer_FormState, Tag]
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState_First, WithGrantedTags]
        # Data flow - Form switch path (tag containers)
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState, WithGrantedTags]
        # v4.13.5: Transitioning tag via AddLooseGameplayTag (not GE)
        - from: [MakeLiteralTag_AddTransitioning, ReturnValue]
          to: [MakeTagContainer_AddTransitioning, Tag]
        - from: [MakeTagContainer_AddTransitioning, ReturnValue]
          to: [AddTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [AddTransitioningTag, Actor]
        - from: [MakeLiteralTag_RemoveTransitioning, ReturnValue]
          to: [MakeTagContainer_RemoveTransitioning, Tag]
        - from: [MakeTagContainer_RemoveTransitioning, ReturnValue]
          to: [RemoveTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [RemoveTransitioningTag, Actor]
        # === GUARD DATA FLOW (v5.0 NL-GUARD-IDENTITY L1) ===
        # Guard 1: IsValid(FatherRef)
        - from: [GetFatherRef_Guard, FatherRef]
          to: [IsValid_FatherRef_Guard, Object]
        - from: [IsValid_FatherRef_Guard, ReturnValue]
          to: [Branch_FatherValid_Guard, Condition]
        - from: [GetFatherRef_Guard, FatherRef]
          to: [GetFatherASC_Guard, Actor]
        # Guard 2: HasMatchingGameplayTag(Father.State.Transitioning)
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Target]
        - from: [MakeLiteralTag_Transitioning_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Tag]
        - from: [HasTransitioningTag_Guard, ReturnValue]
          to: [Branch_TransitioningTag_Guard, Condition]
        # Guard 3: HasMatchingGameplayTag(Effect.Father.FormState) - NL-GUARD-IDENTITY L1
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Target]
        - from: [MakeLiteralTag_FormState_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Tag]
        - from: [HasFormStateTag_Guard, ReturnValue]
          to: [Branch_FormState_Guard, Condition]
        # Data flow - VFX spawn
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherMesh, Target]
        - from: [GetFatherMesh, Mesh]
          to: [SpawnTransitionVFX, AttachToComponent]
        # Data flow - Player
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        # Data flow - Timer
        - from: [GetDuration, SymbioteDuration]
          to: [SetTimer, Time]
        - from: [SetTimer, ReturnValue]
          to: [SetTimerHandle, DurationTimerHandle]
        # === TIMER EXPIRED FLOW (with guards per GAS Audit FIX-2) ===
        # Guard 1: IsValid(FatherRef)
        - from: [CustomEvent_TimerExpired, Then]
          to: [IsValid_FatherRef, Exec]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [IsValid_FatherRef, Object]
        - from: [IsValid_FatherRef, ReturnValue]
          to: [Branch_FatherValid, Condition]
        - from: [IsValid_FatherRef, Exec]
          to: [Branch_FatherValid, Exec]
        # Guard 2: CurrentForm == Symbiote
        - from: [Branch_FatherValid, True]
          to: [EqualEnum_Symbiote, Exec]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [GetCurrentForm_Timer, Target]
        - from: [GetCurrentForm_Timer, CurrentForm]
          to: [EqualEnum_Symbiote, A]
        - from: [EqualEnum_Symbiote, ReturnValue]
          to: [Branch_FormCheck, Condition]
        - from: [EqualEnum_Symbiote, Exec]
          to: [Branch_FormCheck, Exec]
        # Guard 3: HasMatchingGameplayTag(Symbiote.State.Merged)
        - from: [Branch_FormCheck, True]
          to: [HasMergedTag, Exec]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [GetFatherASC_Timer, Actor]
        - from: [GetFatherASC_Timer, ReturnValue]
          to: [HasMergedTag, Target]
        - from: [MakeLiteralTag_Merged, ReturnValue]
          to: [HasMergedTag, Tag]
        - from: [HasMergedTag, ReturnValue]
          to: [Branch_MergedTag, Condition]
        - from: [HasMergedTag, Exec]
          to: [Branch_MergedTag, Exec]
        # All guards passed - proceed with cleanup
        - from: [Branch_MergedTag, True]
          to: [ShowFather, Exec]
        - from: [ShowFather, Exec]
          to: [EnableCollision, Exec]
        - from: [EnableCollision, Exec]
          to: [TryActivateArmor, Exec]
        - from: [TryActivateArmor, Exec]
          to: [EndAbility_Timer, Exec]
        # Timer data flow
        - from: [GetFatherRef_Timer, FatherRef]
          to: [ShowFather, Target]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [EnableCollision, Target]
        - from: [GetPlayerRef_Timer, PlayerRef]
          to: [GetPlayerASC, Actor]
        - from: [GetPlayerASC, ReturnValue]
          to: [TryActivateArmor, Target]
        # === EVENT_ENDABILITY FLOW (per GAS Audit FIX-1) ===
        # Check bWasCancelled - only cleanup when cancelled
        - from: [Event_EndAbility, Then]
          to: [Branch_WasCancelled, Exec]
        - from: [Event_EndAbility, bWasCancelled]
          to: [Branch_WasCancelled, Condition]
        # True path: Was cancelled - need cleanup
        - from: [Branch_WasCancelled, True]
          to: [ClearTimer_End, Exec]
        - from: [GetTimerHandle_End, DurationTimerHandle]
          to: [ClearTimer_End, Handle]
        - from: [ClearTimer_End, Exec]
          to: [IsValid_Father_End, Exec]
        - from: [GetFatherRef_End, FatherRef]
          to: [IsValid_Father_End, Object]
        - from: [IsValid_Father_End, ReturnValue]
          to: [Branch_FatherValid_End, Condition]
        - from: [IsValid_Father_End, Exec]
          to: [Branch_FatherValid_End, Exec]
        # Cleanup when father valid
        - from: [Branch_FatherValid_End, True]
          to: [ShowFather_End, Exec]
        - from: [GetFatherRef_End, FatherRef]
          to: [ShowFather_End, Target]
        - from: [ShowFather_End, Exec]
          to: [EnableCollision_End, Exec]
        - from: [GetFatherRef_End, FatherRef]
          to: [EnableCollision_End, Target]
        - from: [EnableCollision_End, Exec]
          to: [TryActivateArmor_End, Exec]
        - from: [GetFatherRef_End, FatherRef]
          to: [GetFatherASC_End, Actor]
        - from: [GetFatherASC_End, ReturnValue]
          to: [TryActivateArmor_End, Target]

  # GA_FatherEngineer - Deploy as Turret (Option B Form Identity)
  # v4.30: R-AI-1 Activity System Compatibility - StopCurrentActivity before RunBehaviorTree
  # v4.13.5: GAS Audit compliant - NO invulnerability per INV-1
  - name: GA_FatherEngineer
    folder: Abilities/Forms
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_FormChangeCooldown
    tags:
      ability_tags:
        - Ability.Father.Engineer
      cancel_abilities_with_tag:
        - Ability.Father.Crawler
        - Ability.Father.Armor
        - Ability.Father.Exoskeleton
      activation_owned_tags:
        - Father.State.TurretDeployed
      activation_required_tags:
        - Father.State.Alive
        - Father.State.Recruited
      activation_blocked_tags:
        - Father.State.Dormant
        - Father.State.Transitioning
        - Father.State.SymbioteLocked
        - Cooldown.Father.FormChange
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: DeployLocation
        type: Vector
      - name: bIsFirstActivation
        type: Bool
        default_value: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        # v4.14: First activation vs form switch branch
        - id: GetFirstActivation
          type: VariableGet
          properties:
            variable_name: bIsFirstActivation
          position: [1100, 100]
        - id: Branch_First
          type: Branch
          position: [1200, 0]
        # === FIRST ACTIVATION PATH (Row Y=-200) - Simple setup, no VFX/delay ===
        - id: RemovePriorFormState_First
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [1600, -200]
        - id: ApplyEngineerState_First
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_EngineerState
          position: [1800, -200]
        - id: SetFirstFalse
          type: VariableSet
          properties:
            variable_name: bIsFirstActivation
          position: [2000, -200]
        - id: EndAbility_First
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2200, -200]
        # === FORM SWITCH PATH (Row Y=200) - Full transition with VFX/delay ===
        # v4.13.5: FULL TRANSITION FLOW (Option B + VFX, NO Invulnerability per GAS Audit INV-1)
        # Step 1: Add Transitioning tag (instead of GE_TransitionInvulnerability)
        - id: GetFatherASC_Transition
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1500, 300]
        - id: AddTransitioningTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1600, 200]
        - id: MakeTagContainer_AddTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [1500, 250]
        - id: MakeLiteralTag_AddTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [1400, 300]
        # Step 2: Spawn transition VFX
        - id: GetFatherMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [1600, 350]
        - id: SpawnTransitionVFX
          type: CallFunction
          properties:
            function: SpawnSystemAttached
            class: NiagaraFunctionLibrary
          position: [1800, 200]
        # Step 3: Wait 5 seconds (v4.15: WaitDelay auto-terminates with ability)
        - id: TransitionDelay
          type: AbilityTaskWaitDelay
          properties:
            duration: 5.0
          position: [2000, 200]
        # === POST-DELAY GUARDS (GAS Audit MED-3) ===
        # Guard 1: Validate FatherRef
        - id: GetFatherRef_Guard
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [2050, 350]
        - id: IsValid_FatherRef_Guard
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2100, 300]
        - id: Branch_FatherValid_Guard
          type: Branch
          position: [2200, 200]
        # Guard 2: Check Father.State.Transitioning tag
        - id: GetFatherASC_Guard
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [2250, 350]
        - id: HasTransitioningTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2350, 300]
        - id: MakeLiteralTag_Transitioning_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2250, 400]
        - id: Branch_TransitioningTag_Guard
          type: Branch
          position: [2500, 200]
        # Guard 3: Check Effect.Father.FormState tag (identity intact) - NL-GUARD-IDENTITY L1
        - id: HasFormStateTag_Guard
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [2650, 300]
        - id: MakeLiteralTag_FormState_Guard
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2500, 450]
        - id: Branch_FormState_Guard
          type: Branch
          position: [2800, 200]
        # Step 4: Remove prior form state (now guarded)
        - id: RemovePriorFormState
          type: CallFunction
          properties:
            function: BP_RemoveGameplayEffectFromOwnerWithGrantedTags
            target_self: true
          position: [2700, 200]
        - id: MakeTagContainer_FormState
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2600, 350]
        - id: MakeLiteralTag_FormState
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Effect.Father.FormState
          position: [2400, 350]
        # Step 5: Apply new form state
        - id: ApplyEngineerState
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToOwner
            target_self: true
            param.GameplayEffectClass: GE_EngineerState
          position: [2400, 200]
        # Step 6: Remove Transitioning tag (v4.13.5: replaces GE removal)
        - id: RemoveTransitioningTag
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [2600, 200]
        - id: MakeTagContainer_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [2550, 300]
        - id: MakeLiteralTag_RemoveTransitioning
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.State.Transitioning
          position: [2500, 350]
        # Continue form switch flow after transition
        - id: GetFatherLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
          position: [1200, 0]
        - id: SetDeployLocation
          type: VariableSet
          properties:
            variable_name: DeployLocation
          position: [1500, 0]
        - id: SetCurrentForm
          type: PropertySet
          properties:
            property_name: CurrentForm
            target_class: BP_FatherCompanion
          position: [1800, 0]
        - id: SetIsAttached
          type: PropertySet
          properties:
            property_name: IsAttached
            target_class: BP_FatherCompanion
          position: [2100, 0]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [2400, 0]
        # === TURRET AI INITIALIZATION (v4.30 R-AI-1 Compliant) ===
        # Per LOCKED CONTRACT 12: NPCs with ActivityConfiguration must coordinate BT calls
        # Option B: StopCurrentActivity() before RunBehaviorTree
        - id: GetFatherController
          type: CallFunction
          properties:
            function: GetController
            class: Pawn
          position: [2700, 0]
        # v6.7: Use NarrativeNPCController - Narrative Pro's AI controller class
        - id: CastToAIController
          type: DynamicCast
          properties:
            target_class: NarrativeNPCController
          position: [3000, 0]
        - id: GetActivityComponent
          type: CallFunction
          properties:
            function: GetComponentByClass
            class: Actor
            param.ComponentClass: NPCActivityComponent
          position: [2700, 100]
        - id: CastToActivityComponent
          type: DynamicCast
          properties:
            target_class: NPCActivityComponent
          position: [2850, 100]
        - id: StopCurrentActivity
          type: CallFunction
          properties:
            function: StopCurrentActivity
            class: NPCActivityComponent
          position: [3000, 100]
        # v6.8: RunBehaviorTree resolves via WellKnownFunctions (no explicit class needed)
        - id: RunBehaviorTree
          type: CallFunction
          properties:
            function: RunBehaviorTree
            behavior_tree: BT_FatherEngineer
          position: [3300, 0]
        # === END ABILITY FLOW ===
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 500]
        # v2.5.5: Branch on bWasCancelled - only cleanup when cancelled by another form
        - id: Branch_WasCancelled
          type: Branch
          position: [300, 500]
        # Pure getters for end flow (only used in TRUE path)
        - id: GetFatherRef_End
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [600, 350]
        - id: IsValid_Father_End
          type: CallFunction
          properties:
            function: IsValid
          position: [900, 350]
        - id: Branch_Valid_End
          type: Branch
          position: [600, 500]
        - id: SetIsDeployed_End
          type: PropertySet
          properties:
            property_name: IsDeployed
            target_class: BP_FatherCompanion
          position: [900, 500]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (GetAvatarActor is pure - no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [Branch_First, Exec]
        # === FIRST ACTIVATION PATH (True branch) - Skip VFX/delay, merge into setup chain ===
        # v4.26 (Rule 4): True path must merge into stateful setup chain, not early-terminate
        - from: [Branch_First, True]
          to: [RemovePriorFormState_First, Exec]
        - from: [RemovePriorFormState_First, Exec]
          to: [ApplyEngineerState_First, Exec]
        - from: [ApplyEngineerState_First, Exec]
          to: [SetFirstFalse, Exec]
        - from: [SetFirstFalse, Exec]
          to: [GetFatherLocation, Exec]
        # === FORM SWITCH PATH (False branch) - Full transition with VFX/delay ===
        # v4.13.5: NO invulnerability - uses AddLooseGameplayTag/RemoveLooseGameplayTag
        - from: [Branch_First, False]
          to: [AddTransitioningTag, Exec]
        - from: [AddTransitioningTag, Exec]
          to: [SpawnTransitionVFX, Exec]
        - from: [SpawnTransitionVFX, Exec]
          to: [TransitionDelay, Exec]
        # v4.14: Route through guards after delay (GAS Audit MED-3)
        - from: [TransitionDelay, OnFinish]
          to: [Branch_FatherValid_Guard, Exec]
        - from: [Branch_FatherValid_Guard, True]
          to: [Branch_TransitioningTag_Guard, Exec]
        - from: [Branch_TransitioningTag_Guard, True]
          to: [Branch_FormState_Guard, Exec]
        # v5.0: Guard 3 (NL-GUARD-IDENTITY L1) - identity tag check
        - from: [Branch_FormState_Guard, True]
          to: [RemovePriorFormState, Exec]
        - from: [RemovePriorFormState, Exec]
          to: [ApplyEngineerState, Exec]
        - from: [ApplyEngineerState, Exec]
          to: [RemoveTransitioningTag, Exec]
        - from: [RemoveTransitioningTag, Exec]
          to: [GetFatherLocation, Exec]
        - from: [GetFatherLocation, Exec]
          to: [SetDeployLocation, Exec]
        - from: [SetDeployLocation, Exec]
          to: [SetCurrentForm, Exec]
        - from: [SetCurrentForm, Exec]
          to: [SetIsAttached, Exec]
        - from: [SetIsAttached, Exec]
          to: [CommitCooldown, Exec]
        # === v4.30 R-AI-1: Turret AI flow (after CommitCooldown) ===
        # v6.8: GetController and GetComponentByClass are pure functions (no exec pins)
        #       Exec flow goes directly to impure nodes (casts, function calls)
        - from: [CommitCooldown, Exec]
          to: [CastToAIController, Exec]
        - from: [CastToAIController, Exec]
          to: [CastToActivityComponent, Exec]
        - from: [CastToActivityComponent, Exec]
          to: [StopCurrentActivity, Exec]
        - from: [StopCurrentActivity, Exec]
          to: [RunBehaviorTree, Exec]
        # Data flow - GetAvatarActor to Cast
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        # Data flow - Cast output to SetFatherRef INPUT and other destinations
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherLocation, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetCurrentForm, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetIsAttached, Target]
        # Data flow - R-AI-1 turret AI (v4.30)
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherController, Target]
        - from: [GetFatherController, ReturnValue]
          to: [CastToAIController, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetActivityComponent, Target]
        - from: [GetActivityComponent, ReturnValue]
          to: [CastToActivityComponent, Object]
        - from: [CastToActivityComponent, AsNPCActivityComponent]
          to: [StopCurrentActivity, Target]
        - from: [CastToAIController, AsNarrativeNPCController]
          to: [RunBehaviorTree, Target]
        # Data flow - Branch condition
        - from: [GetFirstActivation, bIsFirstActivation]
          to: [Branch_First, Condition]
        # Data flow - First activation path (tag container for form state removal)
        - from: [MakeLiteralTag_FormState, ReturnValue]
          to: [MakeTagContainer_FormState, Tag]
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState_First, WithGrantedTags]
        # Data flow - Form switch path (tag containers)
        - from: [MakeTagContainer_FormState, ReturnValue]
          to: [RemovePriorFormState, WithGrantedTags]
        # === GUARD DATA FLOW (GAS Audit MED-3) ===
        # Guard 1: IsValid(FatherRef)
        - from: [GetFatherRef_Guard, FatherRef]
          to: [IsValid_FatherRef_Guard, Object]
        - from: [IsValid_FatherRef_Guard, ReturnValue]
          to: [Branch_FatherValid_Guard, Condition]
        - from: [GetFatherRef_Guard, FatherRef]
          to: [GetFatherASC_Guard, Actor]
        # Guard 2: HasMatchingGameplayTag(Father.State.Transitioning)
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Target]
        - from: [MakeLiteralTag_Transitioning_Guard, ReturnValue]
          to: [HasTransitioningTag_Guard, Tag]
        - from: [HasTransitioningTag_Guard, ReturnValue]
          to: [Branch_TransitioningTag_Guard, Condition]
        # Guard 3: HasMatchingGameplayTag(Effect.Father.FormState) - NL-GUARD-IDENTITY L1
        - from: [GetFatherASC_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Target]
        - from: [MakeLiteralTag_FormState_Guard, ReturnValue]
          to: [HasFormStateTag_Guard, Tag]
        - from: [HasFormStateTag_Guard, ReturnValue]
          to: [Branch_FormState_Guard, Condition]
        # v4.13.5: Data flow for Transitioning tag (AddLooseGameplayTag/RemoveLooseGameplayTag)
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherASC_Transition, Actor]
        - from: [CastToFather, AsBP Father Companion]
          to: [AddTransitioningTag, Actor]
        - from: [MakeLiteralTag_AddTransitioning, ReturnValue]
          to: [MakeTagContainer_AddTransitioning, Tag]
        - from: [MakeTagContainer_AddTransitioning, ReturnValue]
          to: [AddTransitioningTag, GameplayTags]
        - from: [CastToFather, AsBP Father Companion]
          to: [RemoveTransitioningTag, Actor]
        - from: [MakeLiteralTag_RemoveTransitioning, ReturnValue]
          to: [MakeTagContainer_RemoveTransitioning, Tag]
        - from: [MakeTagContainer_RemoveTransitioning, ReturnValue]
          to: [RemoveTransitioningTag, GameplayTags]
        # Data flow - VFX spawn
        - from: [CastToFather, AsBP Father Companion]
          to: [GetFatherMesh, Target]
        - from: [GetFatherMesh, Mesh]
          to: [SpawnTransitionVFX, AttachToComponent]
        # Data flow - Location
        - from: [GetFatherLocation, ReturnValue]
          to: [SetDeployLocation, DeployLocation]
        # === END ABILITY FLOW ===
        # v2.5.5: First check bWasCancelled - only cleanup when cancelled by form switch
        - from: [Event_EndAbility, Then]
          to: [Branch_WasCancelled, Exec]
        - from: [Event_EndAbility, bWasCancelled]
          to: [Branch_WasCancelled, Condition]
        # TRUE path (was cancelled by form switch) - do cleanup
        - from: [Branch_WasCancelled, True]
          to: [Branch_Valid_End, Exec]
        - from: [Branch_Valid_End, True]
          to: [SetIsDeployed_End, Exec]
        # FALSE path (normal end after setup) - skip cleanup (no connection needed)
        # Data flow - FatherRef to IsValid (pure nodes)
        - from: [GetFatherRef_End, FatherRef]
          to: [IsValid_Father_End, Object]
        - from: [IsValid_Father_End, ReturnValue]
          to: [Branch_Valid_End, Condition]
        - from: [IsValid_Father_End, ReturnValue]
          to: [Branch_Valid_End, Condition]
        # Data flow - FatherRef to SetIsDeployed target
        - from: [GetFatherRef_End, FatherRef]
          to: [SetIsDeployed_End, Target]

  # ---------------------------------------------------------------------------
  # COMBAT ABILITIES (4)
  # ---------------------------------------------------------------------------
  
  # GA_FatherAttack - Melee Attack (inherits socket tracing, warp, combo from parent)
  # v7.8.21: Generator enhanced to support Blueprint parent classes from NP plugin
  # - FindParentClass resolves /NarrativePro/Pro/Core/Abilities/... paths
  # - Event node reuse now breaks inherited Event→CallParent connections
  # GA_FatherAttack - Crawler Melee Multi-Hit Attack
  # Inherits motion warping, socket tracing, combo from GA_Melee_Unarmed
  # NOTE: Runs on Father ASC, only in Crawler form
  # v7.8.49: Contract 27 hierarchical cooldown tags + recruited gate + multi-hit
  - name: GA_FatherAttack
    folder: Abilities/Combat
    parent_class: GA_Melee_Unarmed
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_AttackCooldown
    tags:
      ability_tags:
        - Ability.Father.Attack
        - Ability.Father.Crawler.Attack  # v7.8.49: Hierarchical for blanket cancel
      activation_owned_tags:
        - Father.State.Attacking
      activation_required_tags:
        - Effect.Father.FormState.Crawler  # Uses GE-granted tag (Option B)
        - Father.State.Recruited  # v7.8.49: All Father abilities require recruited
      activation_blocked_tags:
        - Cooldown.Father.Crawler.Attack  # v7.8.49: Contract 27 hierarchical
        - Father.State.Transitioning
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: TargetEnemy
        type: Object
        class: Actor
      - name: AttackDamage
        type: Float
        default_value: 25.0
        instance_editable: true
      - name: AttackMontage
        type: Object
        class: AnimMontage
        instance_editable: true
      # v7.8.49: Multi-hit support per Narrative Pro WeaponVisual pattern
      - name: CachedHitActors
        type: Actor
        container: Array
    event_graph:
      nodes:
        # Activation flow
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        - id: GetMontage
          type: VariableGet
          properties:
            variable_name: AttackMontage
          position: [1200, 100]
        - id: PlayMontage
          type: CallFunction
          properties:
            function: PlayAnimMontage
          position: [1200, 0]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [1500, 0]
        # v7.8.51: Multi-hit HandleTargetData override
        # Fixed: Use GetActorsFromTargetData to get array of actors for ForEachLoop
        # [MANIFEST] Pattern from GA_FatherLaserShot:4123-4246
        - id: Event_HandleTargetData
          type: Event
          properties:
            event_name: HandleTargetData
          position: [0, 400]
        - id: GetActorsFromTargetData
          type: CallFunction
          properties:
            function: GetActorsFromTargetData
            class: AbilitySystemBlueprintLibrary
          position: [300, 400]
        - id: ForEachLoop
          type: ForEachLoop
          position: [600, 400]
        # ForEachLoop.ArrayElement is the hit actor directly
        - id: IsValid_HitActor
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [900, 400]
        - id: Branch_Valid
          type: Branch
          position: [1200, 400]
        - id: GetCachedHitActors
          type: VariableGet
          properties:
            variable_name: CachedHitActors
          position: [1500, 500]
        # v7.8.52: ArrayContains is a PURE function - no exec pins
        - id: ContainsActor
          type: ArrayContains
          position: [1500, 400]
        - id: Branch_NotCached
          type: Branch
          position: [1800, 400]
        # v7.8.52: ArrayAdd - adds item to array
        - id: AddToCachedHitActors
          type: ArrayAdd
          position: [2100, 400]
        - id: GetCachedHitActors_Add
          type: VariableGet
          properties:
            variable_name: CachedHitActors
          position: [2100, 500]
        - id: CallParentHandleTargetData
          type: CallFunction
          properties:
            function: HandleTargetData
            target_self: true
          position: [2400, 400]
        # v7.8.49: EndAbility cache clear
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 800]
        # v7.8.52: ArrayClear - clears all items from array
        - id: ClearCachedHitActors
          type: ArrayClear
          position: [300, 800]
        - id: GetCachedHitActors_End
          type: VariableGet
          properties:
            variable_name: CachedHitActors
          position: [300, 900]
      connections:
        # Activation exec flow
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP_FatherCompanion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [PlayMontage, Exec]
        - from: [SetFatherRef, FatherRef]
          to: [PlayMontage, Target]
        - from: [GetMontage, AttackMontage]
          to: [PlayMontage, AnimMontage]
        - from: [PlayMontage, Exec]
          to: [CommitCooldown, Exec]
        # v7.8.51: Multi-hit HandleTargetData flow
        # [MANIFEST] Pattern from GA_FatherLaserShot - GetActorsFromTargetData returns array
        - from: [Event_HandleTargetData, Then]
          to: [GetActorsFromTargetData, Exec]
        - from: [Event_HandleTargetData, TargetData]
          to: [GetActorsFromTargetData, TargetData]
        - from: [GetActorsFromTargetData, Exec]
          to: [ForEachLoop, Exec]
        - from: [GetActorsFromTargetData, ReturnValue]
          to: [ForEachLoop, Array]
        # ForEachLoop.ArrayElement is the hit actor directly
        - from: [ForEachLoop, LoopBody]
          to: [Branch_Valid, Exec]
        - from: [ForEachLoop, ArrayElement]
          to: [IsValid_HitActor, Object]
        - from: [IsValid_HitActor, ReturnValue]
          to: [Branch_Valid, Condition]
        # v7.8.52: ArrayContains is PURE (no exec) - exec goes directly to Branch_NotCached
        - from: [Branch_Valid, True]
          to: [Branch_NotCached, Exec]
        # ArrayContains data connections (pure function)
        - from: [GetCachedHitActors, CachedHitActors]
          to: [ContainsActor, TargetArray]
        - from: [ForEachLoop, ArrayElement]
          to: [ContainsActor, ItemToFind]
        - from: [ContainsActor, ReturnValue]
          to: [Branch_NotCached, Condition]
        # ArrayAdd exec and data connections
        - from: [Branch_NotCached, False]
          to: [AddToCachedHitActors, execute]
        - from: [GetCachedHitActors_Add, CachedHitActors]
          to: [AddToCachedHitActors, TargetArray]
        - from: [ForEachLoop, ArrayElement]
          to: [AddToCachedHitActors, NewItem]
        - from: [AddToCachedHitActors, then]
          to: [CallParentHandleTargetData, Exec]
        # EndAbility cache clear flow
        - from: [Event_EndAbility, Then]
          to: [ClearCachedHitActors, execute]
        - from: [GetCachedHitActors_End, CachedHitActors]
          to: [ClearCachedHitActors, TargetArray]

  # GA_FatherLaserShot - Ranged Laser Attack
  # NOTE: Runs on Father ASC, only in Crawler form
  # v7.8.46: Phase 7 remediation - AbilityTask_SpawnProjectile + OnTargetData/OnDestroyed handlers
  - name: GA_FatherLaserShot
    folder: Abilities/Combat
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_LaserCooldown
    tags:
      ability_tags:
        - Ability.Father.Crawler.LaserShot
      activation_owned_tags:
        - Father.State.ShootingLaser
      activation_required_tags:
        - Effect.Father.FormState.Crawler  # Uses GE-granted tag (Option B)
        - Father.State.Detached            # P1-LS.5: Guide requires detached state
        - Father.State.Recruited           # P1-LS.5: Guide requires recruited state
      activation_blocked_tags:
        - Cooldown.Father.Crawler.LaserShot  # v7.8.49: Contract 27 hierarchical
        - Father.State.Transitioning
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: ProjectileClass
        type: Class
        class: NarrativeProjectile
        instance_editable: true
      - name: MuzzleSocketName
        type: Name
        default_value: MuzzleSocket
        instance_editable: true
      # v7.8.51: Target from AI blackboard for range validation
      - name: TargetEnemy
        type: Object
        class: Actor
      - name: MaxRange
        type: Float
        default_value: 1500.0
        instance_editable: true
    event_graph:
      nodes:
        # Activation and Father Reference
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [200, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [400, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [600, 0]
        # Cast failure path - end ability
        - id: EndAbility_CastFail
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [600, 200]
        # Get spawn transform from muzzle socket
        - id: GetMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [800, 0]
        - id: GetSocketName
          type: VariableGet
          properties:
            variable_name: MuzzleSocketName
          position: [800, 100]
        - id: GetSocketLocation
          type: CallFunction
          properties:
            function: GetSocketLocation
          position: [1000, 0]
        - id: GetSocketRotation
          type: CallFunction
          properties:
            function: GetSocketRotation
          position: [1000, 100]
        - id: MakeSpawnTransform
          type: CallFunction
          properties:
            function: MakeTransform
          position: [1200, 50]
        # P1-LS.1: AbilityTask_SpawnProjectile replaces SpawnActor
        - id: GetProjectileClass
          type: VariableGet
          properties:
            variable_name: ProjectileClass
          position: [1400, 100]
        - id: SpawnProjectileTask
          type: AbilityTaskSpawnProjectile
          properties:
            task_instance_name: LaserProjectileTask
          position: [1400, 0]
        # P1-LS.2: OnTargetData handler chain (hit path)
        # Get hit actor from target data
        - id: GetActorsFromTargetData
          type: CallFunction
          properties:
            function: GetActorsFromTargetData
            class: AbilitySystemBlueprintLibrary
          position: [1700, 0]
        - id: GetHitActor
          type: GetArrayItem
          position: [1900, 0]
        - id: CastToCharacter
          type: DynamicCast
          properties:
            target_class: Character
          position: [2100, 0]
        # Get target ASC and apply damage
        - id: GetTargetASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [2300, 0]
        - id: GetOwnerASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponentFromActorInfo
            target_self: true
          position: [2300, 100]
        - id: MakeDamageSpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_LaserDamage
          position: [2500, 0]
        - id: ApplyDamage
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [2700, 0]
        # v7.8.48 P1-LS.X: Restore Mark integration (RF-1 fix)
        # Get FatherRef and call MarkEnemy(HitActor) after damage
        - id: GetFatherRefForMark
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [2900, 0]
        - id: CallMarkEnemy
          type: CallFunction
          properties:
            function: MarkEnemy
            class: BP_FatherCompanion
          position: [3100, 0]
        # P1-LS.4: Commit cooldown in success path (after mark)
        - id: CommitCooldown_Hit
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3100, 0]
        - id: EndAbility_Hit
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3300, 0]
        # P1-LS.3: OnDestroyed handler chain (miss/expire path)
        - id: CommitCooldown_Miss
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [1700, 300]
        - id: EndAbility_Miss
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [1900, 300]
      connections:
        # Exec flow - activation to spawn
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        # Cast failure - end ability
        - from: [CastToFather, CastFailed]
          to: [EndAbility_CastFail, Exec]
        # Get spawn transform
        - from: [SetFatherRef, Exec]
          to: [SpawnProjectileTask, Exec]
        - from: [SetFatherRef, FatherRef]
          to: [GetMesh, Target]
        - from: [GetMesh, Mesh]
          to: [GetSocketLocation, Target]
        - from: [GetSocketName, MuzzleSocketName]
          to: [GetSocketLocation, InSocketName]
        - from: [GetMesh, Mesh]
          to: [GetSocketRotation, Target]
        - from: [GetSocketName, MuzzleSocketName]
          to: [GetSocketRotation, InSocketName]
        - from: [GetSocketLocation, ReturnValue]
          to: [MakeSpawnTransform, Location]
        - from: [GetSocketRotation, ReturnValue]
          to: [MakeSpawnTransform, Rotation]
        # Spawn projectile task connections
        - from: [GetProjectileClass, ProjectileClass]
          to: [SpawnProjectileTask, Class]
        - from: [MakeSpawnTransform, ReturnValue]
          to: [SpawnProjectileTask, ProjectileSpawnTransform]
        # P1-LS.2: OnTargetData handler chain
        - from: [SpawnProjectileTask, OnTargetData]
          to: [GetActorsFromTargetData, Exec]
        - from: [SpawnProjectileTask, Data]
          to: [GetActorsFromTargetData, TargetData]
        - from: [GetActorsFromTargetData, ReturnValue]
          to: [GetHitActor, Array]
        - from: [GetActorsFromTargetData, Exec]
          to: [CastToCharacter, Exec]
        # v7.8.47: Fixed GetArrayItem output pin name (Output, not ReturnValue)
        - from: [GetHitActor, Output]
          to: [CastToCharacter, Object]
        - from: [CastToCharacter, Exec]
          to: [MakeDamageSpec, Exec]
        - from: [CastToCharacter, AsCharacter]
          to: [GetTargetASC, Actor]
        - from: [MakeDamageSpec, Exec]
          to: [ApplyDamage, Exec]
        - from: [MakeDamageSpec, ReturnValue]
          to: [ApplyDamage, Spec]
        - from: [GetOwnerASC, ReturnValue]
          to: [ApplyDamage, self]
        - from: [GetTargetASC, ReturnValue]
          to: [ApplyDamage, Target]
        # v7.8.48 P1-LS.X: Restore Mark integration (RF-1 fix)
        # Flow: ApplyDamage → CallMarkEnemy → CommitCooldown_Hit
        - from: [ApplyDamage, Exec]
          to: [CallMarkEnemy, Exec]
        - from: [GetFatherRefForMark, FatherRef]
          to: [CallMarkEnemy, Target]
        - from: [CastToCharacter, AsCharacter]
          to: [CallMarkEnemy, TargetActor]
        - from: [CallMarkEnemy, Exec]
          to: [CommitCooldown_Hit, Exec]
        - from: [CommitCooldown_Hit, Exec]
          to: [EndAbility_Hit, Exec]
        # P1-LS.3: OnDestroyed handler chain (miss path)
        - from: [SpawnProjectileTask, OnDestroyed]
          to: [CommitCooldown_Miss, Exec]
        - from: [CommitCooldown_Miss, Exec]
          to: [EndAbility_Miss, Exec]

  # GA_TurretShoot - Engineer Turret Auto-Fire
  # NOTE: Runs on Father ASC, only in Engineer form when deployed
  - name: GA_TurretShoot
    folder: Abilities/Combat
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_TurretShootCooldown
    tags:
      ability_tags:
        - Ability.Father.TurretShoot
        - Ability.Father.Engineer.TurretShoot
      activation_owned_tags:
        - Father.State.Attacking
      activation_required_tags:
        - Effect.Father.FormState.Engineer  # Uses GE-granted tag (Option B)
        - Father.State.TurretDeployed
        - Father.State.Recruited  # v7.8.49: All Father abilities require recruited
      activation_blocked_tags:
        - Cooldown.Father.Engineer.TurretShoot  # v7.8.49: Contract 27 hierarchical
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: ProjectileClass
        type: Class
        class: NarrativeProjectile
        instance_editable: true
      - name: TurretDamage
        type: Float
        default_value: 15.0
        instance_editable: true
      - name: MuzzleSocketName
        type: Name
        default_value: TurretMuzzle
        instance_editable: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        - id: GetMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [1200, 0]
        - id: GetSocketName
          type: VariableGet
          properties:
            variable_name: MuzzleSocketName
          position: [1200, 100]
        - id: GetSocketLocation
          type: CallFunction
          properties:
            function: GetSocketLocation
          position: [1500, 0]
        - id: GetSocketRotation
          type: CallFunction
          properties:
            function: GetSocketRotation
          position: [1500, 100]
        - id: MakeSpawnTransform
          type: CallFunction
          properties:
            function: MakeTransform
          position: [1650, 50]
        - id: GetProjectileClass
          type: VariableGet
          properties:
            variable_name: ProjectileClass
          position: [1800, 100]
        - id: SpawnProjectile
          type: SpawnActor
          properties:
            actor_class_variable: ProjectileClass
          position: [1800, 0]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [2100, 0]
        - id: EndAbility
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2400, 0]
      connections:
        # Exec flow (GetAvatarActor is pure - no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [GetMesh, Exec]
        - from: [SetFatherRef, FatherRef]
          to: [GetMesh, Target]
        - from: [GetMesh, Mesh]
          to: [GetSocketLocation, Target]
        - from: [GetSocketName, MuzzleSocketName]
          to: [GetSocketLocation, InSocketName]
        - from: [GetMesh, Mesh]
          to: [GetSocketRotation, Target]
        - from: [GetSocketName, MuzzleSocketName]
          to: [GetSocketRotation, InSocketName]
        - from: [GetMesh, Exec]
          to: [SpawnProjectile, Exec]
        - from: [GetProjectileClass, ProjectileClass]
          to: [SpawnProjectile, Class]
        - from: [GetSocketLocation, ReturnValue]
          to: [MakeSpawnTransform, Location]
        - from: [GetSocketRotation, ReturnValue]
          to: [MakeSpawnTransform, Rotation]
        - from: [MakeSpawnTransform, ReturnValue]
          to: [SpawnProjectile, SpawnTransform]
        - from: [SpawnProjectile, Exec]
          to: [CommitCooldown, Exec]
        - from: [CommitCooldown, Exec]
          to: [EndAbility, Exec]

  # GA_FatherElectricTrap - Engineer Electric Web Trap
  # NOTE: Runs on Father ASC, only in Engineer form when deployed
  # v7.8.46: Phase 7 remediation - AbilityTask_SpawnProjectile + OnTargetData handlers + deployed gate
  # Contract 24: Damage is attribute-based via NarrativeDamageExecCalc (no SetByCaller)
  - name: GA_FatherElectricTrap
    folder: Abilities/Combat
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_ElectricTrapCooldown
    tags:
      ability_tags:
        - Ability.Father.ElectricTrap
        - Ability.Father.Engineer.ElectricTrap
      activation_owned_tags:
        - Father.State.ThrowingWeb
      activation_required_tags:
        - Effect.Father.FormState.Engineer  # Uses GE-granted tag (Option B)
        - Father.State.TurretDeployed       # P1-ET.6: Consistent with GA_TurretShoot
        - Father.State.Recruited            # P1-ET.6: Guide requires recruited state
      activation_blocked_tags:
        - Cooldown.Father.Engineer.ElectricTrap
        - Narrative.State.IsDead            # Guide Section 4.2
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      # P1-ET.1: Fixed TrapClass type to NarrativeProjectile
      - name: TrapClass
        type: Class
        class: NarrativeProjectile
        instance_editable: true
      - name: RootDuration
        type: Float
        default_value: 5.0
        instance_editable: true
      - name: TargetEnemy
        type: Object
        class: Actor
    event_graph:
      nodes:
        # Activation and Father Reference
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [200, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [400, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [600, 0]
        # Cast failure path
        - id: EndAbility_CastFail
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [600, 200]
        # Calculate spawn transform from father location
        - id: GetActorLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
          position: [800, 0]
        - id: MakeSpawnTransform
          type: CallFunction
          properties:
            function: MakeTransform
          position: [1000, 0]
        # P1-ET.2: AbilityTask_SpawnProjectile replaces SpawnActor
        - id: GetTrapClass
          type: VariableGet
          properties:
            variable_name: TrapClass
          position: [1200, 100]
        - id: SpawnTrapTask
          type: AbilityTaskSpawnProjectile
          properties:
            task_instance_name: SpawnElectricWeb
          position: [1200, 0]
        # P1-ET.3: OnTargetData handler chain - apply effects
        # v7.8.47: Fixed to use GetActorsFromTargetData pattern (matching LaserShot)
        - id: GetActorsFromTargetData
          type: CallFunction
          properties:
            function: GetActorsFromTargetData
            class: AbilitySystemBlueprintLibrary
          position: [1500, 0]
        - id: GetHitActor
          type: GetArrayItem
          position: [1700, 0]
        - id: CastToCharacter
          type: DynamicCast
          properties:
            target_class: Character
          position: [1900, 0]
        # Get ASC references
        - id: GetTargetASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [1900, 0]
        - id: GetOwnerASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponentFromActorInfo
            target_self: true
          position: [1900, 100]
        # Apply GE_ElectricTrapRoot (CC/immobilize)
        - id: MakeRootSpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_ElectricTrapRoot
          position: [2100, 0]
        - id: GetRootDuration
          type: VariableGet
          properties:
            variable_name: RootDuration
          position: [2100, 150]
        - id: MakeRootDurationTag
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Data.Duration.ElectricTrapRoot
          position: [2100, 200]
        - id: SetRootDuration
          type: CallFunction
          properties:
            function: AssignTagSetByCallerMagnitude
            class: AbilitySystemBlueprintLibrary
          position: [2300, 0]
        - id: ApplyRootEffect
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [2500, 0]
        # Apply GE_ElectricTrapDamage (damage via NarrativeDamageExecCalc - attribute-based per Contract 24)
        - id: MakeDamageSpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_ElectricTrapDamage
          position: [2700, 0]
        - id: ApplyDamageEffect
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [2900, 0]
        # Commit cooldown and end (hit path)
        - id: CommitCooldown_Hit
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3100, 0]
        - id: EndAbility_Hit
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3300, 0]
        # P1-ET.3: OnDestroyed handler chain (miss/expire path)
        - id: CommitCooldown_Miss
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [1500, 300]
        - id: EndAbility_Miss
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [1700, 300]
      connections:
        # Exec flow - activation to spawn
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        # Cast failure - end ability
        - from: [CastToFather, CastFailed]
          to: [EndAbility_CastFail, Exec]
        # Get spawn transform
        - from: [SetFatherRef, Exec]
          to: [SpawnTrapTask, Exec]
        - from: [SetFatherRef, FatherRef]
          to: [GetActorLocation, Target]
        - from: [GetActorLocation, ReturnValue]
          to: [MakeSpawnTransform, Location]
        # Spawn trap task connections
        - from: [GetTrapClass, TrapClass]
          to: [SpawnTrapTask, Class]
        - from: [MakeSpawnTransform, ReturnValue]
          to: [SpawnTrapTask, ProjectileSpawnTransform]
        # OnTargetData handler chain
        # v7.8.47: Fixed to use GetActorsFromTargetData pattern
        - from: [SpawnTrapTask, OnTargetData]
          to: [GetActorsFromTargetData, Exec]
        - from: [SpawnTrapTask, Data]
          to: [GetActorsFromTargetData, TargetData]
        - from: [GetActorsFromTargetData, ReturnValue]
          to: [GetHitActor, Array]
        - from: [GetActorsFromTargetData, Exec]
          to: [CastToCharacter, Exec]
        - from: [GetHitActor, Output]
          to: [CastToCharacter, Object]
        - from: [CastToCharacter, AsCharacter]
          to: [GetTargetASC, Actor]
        # Apply root effect with SetByCaller duration
        - from: [CastToCharacter, Exec]
          to: [MakeRootSpec, Exec]
        - from: [MakeRootSpec, Exec]
          to: [SetRootDuration, Exec]
        - from: [MakeRootSpec, ReturnValue]
          to: [SetRootDuration, SpecHandle]
        - from: [GetRootDuration, RootDuration]
          to: [SetRootDuration, Magnitude]
        - from: [MakeRootDurationTag, ReturnValue]
          to: [SetRootDuration, DataTag]
        - from: [SetRootDuration, Exec]
          to: [ApplyRootEffect, Exec]
        - from: [SetRootDuration, ReturnValue]
          to: [ApplyRootEffect, Spec]
        - from: [GetOwnerASC, ReturnValue]
          to: [ApplyRootEffect, self]
        - from: [GetTargetASC, ReturnValue]
          to: [ApplyRootEffect, Target]
        # Apply damage effect (attribute-based via NarrativeDamageExecCalc)
        - from: [ApplyRootEffect, Exec]
          to: [MakeDamageSpec, Exec]
        - from: [MakeDamageSpec, Exec]
          to: [ApplyDamageEffect, Exec]
        - from: [MakeDamageSpec, ReturnValue]
          to: [ApplyDamageEffect, Spec]
        - from: [GetOwnerASC, ReturnValue]
          to: [ApplyDamageEffect, self]
        - from: [GetTargetASC, ReturnValue]
          to: [ApplyDamageEffect, Target]
        # Commit and end (hit path)
        - from: [ApplyDamageEffect, Exec]
          to: [CommitCooldown_Hit, Exec]
        - from: [CommitCooldown_Hit, Exec]
          to: [EndAbility_Hit, Exec]
        # OnDestroyed handler chain (miss path)
        - from: [SpawnTrapTask, OnDestroyed]
          to: [CommitCooldown_Miss, Exec]
        - from: [CommitCooldown_Miss, Exec]
          to: [EndAbility_Miss, Exec]

  # ---------------------------------------------------------------------------
  # ACTION ABILITIES (9)
  # ---------------------------------------------------------------------------
  
  # GA_DomeBurst - Armor Active AOE Damage (player-owned instant)
  # NOTE: Runs on Player ASC, granted via EI_FatherArmorForm - no cross-ASC gates
  # v6.5: Added input_tag for Q-key manual activation (Narrative Pro input system)
  # v7.8.50: Contract 24/24A compliance - removed SetByCaller (damage from AttackDamage attribute)
  # v7.8.50: Added knockback (1000 units), VFX spawn, energy reset, FullyCharged tag removal
  - name: GA_DomeBurst
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    # v6.5: Use Narrative Pro default input tag (INV-INPUT-1)
    input_tag: Narrative.Input.Ability1
    instancing_policy: InstancedPerActor
    net_execution_policy: LocalPredicted
    cooldown_gameplay_effect_class: GE_DomeBurstCooldown
    tags:
      ability_tags:
        - Ability.Father.DomeBurst
      activation_owned_tags:
        - Father.State.Attacking
      activation_required_tags:
        - Father.Dome.Active           # On Player ASC (from GA_ProtectiveDome)
        - Father.Dome.FullyCharged     # Only burst when dome is FULL (Decision 24)
        # Father.Form.Armor removed - cross-ASC gate, equipment granting handles this
      activation_blocked_tags:
        - Cooldown.Father.Armor.DomeBurst  # v7.8.49: Contract 27 hierarchical
    variables:
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: BurstRadius
        type: Float
        default_value: 500.0
        instance_editable: true
      # v7.8.50: BurstDamage removed - Contract 24/24A compliance
      # Damage now comes from player's AttackDamage attribute via NarrativeDamageExecCalc
      - name: KnockbackForce
        type: Float
        default_value: 1000.0
        instance_editable: true
      # v7.8.50: BurstVFX variable removed - using param.SystemTemplate directly (generator limitation)
    event_graph:
      nodes:
        # === SETUP ===
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetOwningActor
          type: CallFunction
          properties:
            function: GetOwningActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [900, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1200, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [1350, 0]
        - id: GetPlayerLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
          position: [1500, 0]
        # === SPHERE OVERLAP ===
        - id: GetRadius
          type: VariableGet
          properties:
            variable_name: BurstRadius
          position: [1800, 100]
        - id: MakeObjectTypes
          type: MakeArray
          properties:
            array_type: byte
            values:
              - ObjectTypeQuery3
          position: [1600, 150]
        - id: MakeActorsToIgnore
          type: MakeArray
          properties:
            array_type: object
            class: Actor
          position: [1600, 200]
        - id: SphereOverlap
          type: CallFunction
          properties:
            function: SphereOverlapActors
          position: [1800, 0]
        # === DAMAGE LOOP ===
        - id: ForEachActor
          type: ForEachLoop
          position: [2100, 0]
        - id: HasTag
          type: CallFunction
          properties:
            function: ActorHasTag
          position: [2400, 0]
        - id: Branch_Enemy
          type: Branch
          position: [2700, 0]
        - id: GetEnemyASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [3000, 0]
        - id: GetOwnASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponentFromActorInfo
            target_self: true
          position: [3000, 150]
        # v7.8.50: Contract 24/24A - NO SetByCaller, damage from AttackDamage attribute
        - id: MakeGESpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_DomeBurstDamage
          position: [3300, 0]
        - id: ApplyGE
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [3600, 0]
        # === KNOCKBACK (v7.8.50) ===
        - id: GetEnemyLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
          position: [3900, 0]
        - id: GetPlayerLocation_KB
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [3900, 100]
        - id: GetPlayerLoc_ForKB
          type: CallFunction
          properties:
            function: K2_GetActorLocation
          position: [4100, 100]
        - id: SubtractVectors
          type: CallFunction
          properties:
            function: Subtract_VectorVector
            class: KismetMathLibrary
          position: [4200, 0]
        - id: NormalizeVector
          type: CallFunction
          properties:
            function: Normal
            class: KismetMathLibrary
          position: [4400, 0]
        - id: GetKnockbackForce
          type: VariableGet
          properties:
            variable_name: KnockbackForce
          position: [4400, 100]
        - id: MultiplyVectorFloat
          type: CallFunction
          properties:
            function: Multiply_VectorFloat
            class: KismetMathLibrary
          position: [4600, 0]
        - id: CastToCharacter
          type: DynamicCast
          properties:
            target_class: Character
          position: [4800, 0]
        - id: LaunchCharacter
          type: CallFunction
          properties:
            function: LaunchCharacter
          position: [5000, 0]
        # === POST-LOOP: VFX + RESET (v7.8.50) ===
        # v7.8.50: Use GameplayCue (proper GAS pattern - generator doesn't support NiagaraSystem variables)
        - id: MakeCueTag
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: GameplayCue.Father.DomeBurst
          position: [1800, 300]
        - id: ExecuteBurstCue
          type: CallFunction
          properties:
            function: K2_ExecuteGameplayCue
            target_self: true
          position: [2100, 300]
        # === ENERGY RESET (v7.8.50: INC-DOME-6) ===
        - id: GetFatherRef_Reset
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [2400, 300]
        - id: MakeZeroEnergy
          type: CallFunction
          properties:
            function: MakeLiteralDouble
            class: KismetSystemLibrary
            literal_value: 0.0
          position: [2400, 400]
        - id: SetDomeEnergyZero
          type: PropertySet
          properties:
            property_name: DomeEnergy
            target_class: BP_FatherCompanion
          position: [2600, 300]
        # === CLEAR FULLYCHARGED TAG (v7.8.50: INC-DOME-7) ===
        - id: GetPlayerRef_Tag
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [2800, 400]
        # v7.8.50: GetPlayerASC_Tag removed - RemoveLooseGameplayTags takes Actor directly
        - id: MakeLiteralTag_Charged
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Father.Dome.FullyCharged
          position: [3000, 450]
        - id: MakeTagContainer_Charged
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
          position: [3200, 400]
        - id: RemoveChargedTag
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [3400, 300]
        # === COOLDOWN + END ===
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3600, 300]
        - id: EndAbility
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3800, 300]
      connections:
        # === ACTIVATION FLOW ===
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [SphereOverlap, Exec]
        - from: [SphereOverlap, Exec]
          to: [ForEachActor, Exec]
        # === DAMAGE LOOP ===
        - from: [ForEachActor, LoopBody]
          to: [Branch_Enemy, Exec]
        - from: [Branch_Enemy, then]
          to: [MakeGESpec, Exec]
        # v7.8.50: Contract 24/24A - MakeGESpec directly to ApplyGE (no SetByCaller)
        - from: [MakeGESpec, Exec]
          to: [ApplyGE, Exec]
        # === KNOCKBACK AFTER DAMAGE ===
        - from: [ApplyGE, Exec]
          to: [CastToCharacter, Exec]
        - from: [CastToCharacter, Exec]
          to: [LaunchCharacter, Exec]
        # === POST-LOOP FLOW ===
        - from: [ForEachActor, Completed]
          to: [ExecuteBurstCue, Exec]
        - from: [ExecuteBurstCue, Exec]
          to: [SetDomeEnergyZero, Exec]
        - from: [SetDomeEnergyZero, Exec]
          to: [RemoveChargedTag, Exec]
        - from: [RemoveChargedTag, Exec]
          to: [CommitCooldown, Exec]
        - from: [CommitCooldown, Exec]
          to: [EndAbility, Exec]
        # === DATA FLOW: SETUP ===
        - from: [GetOwningActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetOwnerPlayer, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [SetPlayerRef, PlayerRef]
          to: [GetPlayerLocation, Target]
        # === DATA FLOW: SPHERE OVERLAP ===
        - from: [GetPlayerLocation, ReturnValue]
          to: [SphereOverlap, SpherePos]
        - from: [GetRadius, BurstRadius]
          to: [SphereOverlap, SphereRadius]
        - from: [MakeObjectTypes, Array]
          to: [SphereOverlap, ObjectTypes]
        - from: [MakeActorsToIgnore, Array]
          to: [SphereOverlap, ActorsToIgnore]
        - from: [SphereOverlap, OutActors]
          to: [ForEachActor, Array]
        # === DATA FLOW: ENEMY CHECK ===
        - from: [ForEachActor, ArrayElement]
          to: [HasTag, Target]
        - from: [HasTag, ReturnValue]
          to: [Branch_Enemy, Condition]
        # === DATA FLOW: DAMAGE ===
        - from: [ForEachActor, ArrayElement]
          to: [GetEnemyASC, Actor]
        - from: [GetEnemyASC, ReturnValue]
          to: [ApplyGE, Target]
        - from: [GetOwnASC, ReturnValue]
          to: [ApplyGE, self]
        - from: [MakeGESpec, ReturnValue]
          to: [ApplyGE, Spec]
        # === DATA FLOW: KNOCKBACK ===
        - from: [ForEachActor, ArrayElement]
          to: [GetEnemyLocation, Target]
        - from: [GetEnemyLocation, ReturnValue]
          to: [SubtractVectors, A]
        - from: [GetPlayerLocation_KB, PlayerRef]
          to: [GetPlayerLoc_ForKB, Target]
        - from: [GetPlayerLoc_ForKB, ReturnValue]
          to: [SubtractVectors, B]
        - from: [SubtractVectors, ReturnValue]
          to: [NormalizeVector, A]
        - from: [NormalizeVector, ReturnValue]
          to: [MultiplyVectorFloat, A]
        - from: [GetKnockbackForce, KnockbackForce]
          to: [MultiplyVectorFloat, B]
        - from: [ForEachActor, ArrayElement]
          to: [CastToCharacter, Object]
        - from: [CastToCharacter, AsCharacter]
          to: [LaunchCharacter, Target]
        - from: [MultiplyVectorFloat, ReturnValue]
          to: [LaunchCharacter, LaunchVelocity]
        # === DATA FLOW: VFX ===
        # v7.8.50: Use GameplayCue (proper GAS pattern)
        - from: [MakeCueTag, ReturnValue]
          to: [ExecuteBurstCue, GameplayCueTag]
        # === DATA FLOW: ENERGY RESET ===
        - from: [GetFatherRef_Reset, FatherRef]
          to: [SetDomeEnergyZero, Target]
        - from: [MakeZeroEnergy, ReturnValue]
          to: [SetDomeEnergyZero, DomeEnergy]
        # === DATA FLOW: TAG REMOVAL ===
        # v7.8.50: RemoveLooseGameplayTags takes Actor directly (not ASC)
        - from: [GetPlayerRef_Tag, PlayerRef]
          to: [RemoveChargedTag, Actor]
        - from: [MakeLiteralTag_Charged, ReturnValue]
          to: [MakeTagContainer_Charged, Tag]
        - from: [MakeTagContainer_Charged, ReturnValue]
          to: [RemoveChargedTag, GameplayTags]


  # GA_ProtectiveDome - Armor Passive Damage Absorption (player-owned toggle)
  # NOTE: Runs on Player ASC, granted via EI_FatherArmorForm - no cross-ASC gates
  # v7.8.0: Contract 25 - PROPER damage-scaled absorption (30% of damage becomes energy)
  # Uses AbilityAsyncWaitAttributeChanged to track Health changes and calculate actual damage
  - name: GA_ProtectiveDome
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: LocalPredicted
    tags:
      ability_tags:
        - Ability.Father.ProtectiveDome
      activation_owned_tags:
        - Father.Dome.Active
      # activation_required_tags removed - Father.Form.Armor is on Father ASC, not Player ASC
      # Equipment granting already ensures this ability is only available in Armor form
    # v7.8.0: Contract 25 - Proper damage-scaled energy absorption
    # AbilityAsyncWaitAttributeChanged tracks Player Health changes:
    # - Changed delegate provides (Attribute, NewValue, OldValue)
    # - Damage = OldValue - NewValue (when positive)
    # - Energy = Damage * 0.3 (30% as per implementation guide)
    variables:
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: DomeAbsorptionHandle
        type: ActiveGameplayEffectHandle
      - name: DamageToEnergyRatio
        type: Float
        default_value: "0.3"
        instance_editable: true
        # Per implementation guide: 30% of damage absorbed becomes dome energy
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetOwningActor
          type: CallFunction
          properties:
            function: GetOwningActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [900, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1200, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [1350, 0]
        - id: GetPlayerASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [1500, 0]
        - id: MakeGESpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_DomeAbsorption
          position: [1800, 0]
        - id: ApplyGE
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToSelf
          position: [2100, 0]
        - id: SetDomeHandle
          type: VariableSet
          properties:
            variable_name: DomeAbsorptionHandle
          position: [2400, 0]
        # === v7.8.0: Contract 25 - PROPER DAMAGE TRACKING ===
        # AbilityAsyncWaitAttributeChanged: Tracks Health changes with actual values
        # Changed delegate provides (Attribute, NewValue, OldValue)
        - id: GetPlayerRef_ForAsync
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [2700, 0]
        - id: WaitHealthChange
          type: AbilityAsyncWaitAttributeChanged
          properties:
            attribute_set: NarrativeAttributeSetBase
            attribute: Health
            trigger_once: false
          position: [3000, 0]
        # WaitGameplayEvent: Fires when player dies (GameplayEvent.Death)
        - id: WaitDeathEvent
          type: AbilityTaskWaitGameplayEvent
          properties:
            event_tag: GameplayEvent.Death
            trigger_once: true
          position: [3000, 200]
        # === v7.8.0: Contract 25 - DAMAGE-SCALED ENERGY HANDLER ===
        # Step 1: Calculate damage from Health change
        # Damage = OldValue - NewValue (only process if positive)
        - id: CalcDamage
          type: CallFunction
          properties:
            function: Subtract_DoubleDouble
            class: KismetMathLibrary
          position: [200, 800]
        # Step 2: Check if damage is positive (Health decreased)
        - id: MakeZeroDamageCheck
          type: CallFunction
          properties:
            function: MakeLiteralDouble
            class: KismetSystemLibrary
            literal_value: 0.0
          position: [400, 900]
        - id: IsDamagePositive
          type: CallFunction
          properties:
            function: Greater_DoubleDouble
            class: KismetMathLibrary
          position: [600, 850]
        - id: Branch_DamagePositive
          type: Branch
          position: [800, 800]
        # Step 3: Validate Father reference
        - id: GetFatherRef_Absorb
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [1000, 900]
        - id: IsValid_Father_Absorb
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [1200, 950]
        - id: Branch_FatherValid_Absorb
          type: Branch
          position: [1400, 800]
        # Step 4: Calculate energy from damage (30% of damage)
        - id: GetDamageToEnergyRatio
          type: VariableGet
          properties:
            variable_name: DamageToEnergyRatio
          position: [1600, 900]
        - id: CalcEnergy
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            class: KismetMathLibrary
          position: [1800, 850]
        # Step 5: Get current energy and add calculated energy
        - id: GetCurrentEnergy
          type: PropertyGet
          properties:
            property_name: DomeEnergy
            target_class: BP_FatherCompanion
          position: [2000, 950]
        - id: AddEnergy
          type: CallFunction
          properties:
            function: Add_DoubleDouble
            class: KismetMathLibrary
          position: [2200, 800]
        # Step 6: Clamp to max energy
        - id: GetMaxEnergy
          type: PropertyGet
          properties:
            property_name: MaxDomeEnergy
            target_class: BP_FatherCompanion
          position: [2400, 900]
        - id: MakeZeroClamp
          type: CallFunction
          properties:
            function: MakeLiteralDouble
            class: KismetSystemLibrary
            literal_value: 0.0
          position: [2400, 1000]
        - id: ClampEnergy
          type: CallFunction
          properties:
            function: FClamp
            class: KismetMathLibrary
          position: [2600, 800]
        # Step 7: Set new dome energy
        - id: SetDomeEnergy
          type: PropertySet
          properties:
            property_name: DomeEnergy
            target_class: BP_FatherCompanion
          position: [2800, 800]
        # Step 8: Check if fully charged
        - id: CheckFullyCharged
          type: CallFunction
          properties:
            function: GreaterEqual_DoubleDouble
            class: KismetMathLibrary
          position: [3000, 850]
        - id: Branch_FullyCharged
          type: Branch
          position: [3200, 800]
        # Step 9: Grant FullyCharged tag to player
        - id: GetPlayerRef_Absorb
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [3400, 900]
        - id: MakeLiteralTag_FullyCharged
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Father.Dome.FullyCharged
          position: [3400, 1000]
        - id: MakeTagContainer_FullyCharged
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
          position: [3600, 950]
        - id: AddFullyChargedTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [3800, 800]
        # === END ABILITY - Form exit burst (v4.27: Decisions 22-24) ===
        # When ability ends (form unequipped), try to activate GA_DomeBurst
        # GA_DomeBurst requires Father.Dome.FullyCharged tag, so only fires if charged
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 400]
        - id: GetPlayerRef_End
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [200, 400]
        - id: GetPlayerASC_End
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [400, 400]
        # Step 1: Try to activate GA_DomeBurst (will only succeed if dome is charged)
        - id: TryActivateBurst
          type: CallFunction
          properties:
            function: TryActivateAbilityByClass
            class: AbilitySystemComponent
            parameters:
              InAbilityToActivate: /Game/FatherCompanion/Abilities/Actions/GA_DomeBurst.GA_DomeBurst_C
              bAllowRemoteActivation: false
          position: [600, 400]
        # Step 2: Clear Father.Dome.FullyCharged tag (reset state)
        - id: MakeLiteralTag_Charged
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.Dome.FullyCharged
          position: [600, 550]
        - id: MakeTagContainer_Charged
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [800, 500]
        - id: ClearChargedTag
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1000, 400]
        # Step 3: Remove dome absorption GE
        - id: GetDomeHandle
          type: VariableGet
          properties:
            variable_name: DomeAbsorptionHandle
          position: [1200, 500]
        - id: RemoveGE
          type: CallFunction
          properties:
            function: RemoveActiveGameplayEffect
          position: [1200, 400]
        # v7.8: DAMAGE ABSORPTION RESTORED via Path B AbilityTasks
        # WaitGEAppliedToSelf detects damage, handler adds fixed energy per hit
        # === PLAYER DEATH RESET HANDLER (v7.8: via WaitGameplayEvent) ===
        # Triggered by WaitDeathEvent.EventReceived - connects directly to handler flow
        # Per D-DEATH-RESET-2: Silent reset - DomeEnergy=0, remove FullyCharged, no burst/VFX
        # NOTE: No CustomEvent - WaitDeathEvent.EventReceived connects directly to handler flow
        # Step 1: Get Father reference and validate
        - id: GetFatherRef_Death
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [300, 1200]
        - id: IsValid_Father_Death
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [500, 1250]
        - id: Branch_Valid_Father_Death
          type: Branch
          position: [700, 1200]
        # Step 2: Set DomeEnergy = 0 on Father (silent reset)
        - id: MakeZero_Death
          type: CallFunction
          properties:
            function: MakeLiteralDouble
            class: KismetSystemLibrary
            literal_value: 0.0
          position: [900, 1300]
        - id: SetDomeEnergy_Death
          type: PropertySet
          properties:
            property_name: DomeEnergy
            target_class: BP_FatherCompanion
          position: [1100, 1200]
        # Step 3: Remove Father.Dome.FullyCharged tag from Player (if present)
        - id: GetPlayerRef_Death
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [1300, 1300]
        - id: MakeLiteralTag_Charged_Death
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
            literal_value: Father.Dome.FullyCharged
          position: [1300, 1400]
        - id: MakeTagContainer_Charged_Death
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            # class: BlueprintGameplayTagLibrary  # Commented out - let resolver find
          position: [1500, 1350]
        # v7.8.21: Step 3b: Set SymbioteCharge = 0 on Father (D-DEATH-RESET-2)
        - id: SetSymbioteCharge_Death
          type: PropertySet
          properties:
            property_name: SymbioteCharge
            target_class: BP_FatherCompanion
          position: [1300, 1200]
        # Step 4: Remove Father.Dome.FullyCharged tag from Player (if present)
        - id: ClearChargedTag_Death
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1700, 1200]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (impure nodes only - pure functions have no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]  # Direct - GetOwningActor is pure (no exec)
        - from: [CastToFather, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [MakeGESpec, Exec]
        - from: [MakeGESpec, Exec]
          to: [ApplyGE, Exec]
        - from: [ApplyGE, Exec]
          to: [SetDomeHandle, Exec]
        # v7.8.0: Continue to async Health tracking setup
        - from: [SetDomeHandle, Exec]
          to: [WaitDeathEvent, Exec]
        # Data flow
        - from: [GetOwningActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetOwnerPlayer, Target]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [SetPlayerRef, PlayerRef]
          to: [GetPlayerASC, Actor]
        # BP_ApplyGameplayEffectSpecToSelf is called on the player's ASC
        - from: [GetPlayerASC, ReturnValue]
          to: [ApplyGE, Target]
        - from: [MakeGESpec, ReturnValue]
          to: [ApplyGE, Spec]
        - from: [ApplyGE, ReturnValue]
          to: [SetDomeHandle, DomeAbsorptionHandle]
        # v7.8.0: AbilityAsync_WaitAttributeChanged - TargetActor connection
        - from: [GetPlayerRef_ForAsync, PlayerRef]
          to: [WaitHealthChange, TargetActor]
        # v7.8.0: Callback connections - Changed fires when Health attribute changes
        - from: [WaitHealthChange, Changed]
          to: [Branch_DamagePositive, Exec]
        - from: [WaitDeathEvent, EventReceived]
          to: [Branch_Valid_Father_Death, Exec]
        # === v7.8.0: Contract 25 - DAMAGE-SCALED ENERGY HANDLER FLOW ===
        # Step 1-2: Calculate damage and check if positive
        # Damage = OldValue - NewValue (from Changed delegate pins)
        - from: [WaitHealthChange, OldValue]
          to: [CalcDamage, A]
        - from: [WaitHealthChange, NewValue]
          to: [CalcDamage, B]
        - from: [CalcDamage, ReturnValue]
          to: [IsDamagePositive, A]
        - from: [MakeZeroDamageCheck, ReturnValue]
          to: [IsDamagePositive, B]
        - from: [IsDamagePositive, ReturnValue]
          to: [Branch_DamagePositive, Condition]
        # Step 3: Exec flow - check damage positive, then validate Father
        - from: [Branch_DamagePositive, True]
          to: [Branch_FatherValid_Absorb, Exec]
        # Step 3: Data - Validate Father
        - from: [GetFatherRef_Absorb, FatherRef]
          to: [IsValid_Father_Absorb, Object]
        - from: [IsValid_Father_Absorb, ReturnValue]
          to: [Branch_FatherValid_Absorb, Condition]
        # Step 4-7: Exec flow - Father valid → CalcEnergy → AddEnergy → SetDomeEnergy → CheckFullyCharged
        - from: [Branch_FatherValid_Absorb, True]
          to: [SetDomeEnergy, Exec]
        - from: [SetDomeEnergy, Exec]
          to: [Branch_FullyCharged, Exec]
        - from: [Branch_FullyCharged, True]
          to: [AddFullyChargedTag, Exec]
        # Step 4: Data - Calculate energy from damage (Damage * 0.3)
        - from: [CalcDamage, ReturnValue]
          to: [CalcEnergy, A]
        - from: [GetDamageToEnergyRatio, DamageToEnergyRatio]
          to: [CalcEnergy, B]
        # Step 5: Data - Get current energy and add calculated energy
        - from: [GetFatherRef_Absorb, FatherRef]
          to: [GetCurrentEnergy, Target]
        - from: [GetCurrentEnergy, DomeEnergy]
          to: [AddEnergy, A]
        - from: [CalcEnergy, ReturnValue]
          to: [AddEnergy, B]
        # Step 6: Data - Clamp to max
        - from: [AddEnergy, ReturnValue]
          to: [ClampEnergy, Value]
        - from: [MakeZeroClamp, ReturnValue]
          to: [ClampEnergy, Min]
        - from: [GetFatherRef_Absorb, FatherRef]
          to: [GetMaxEnergy, Target]
        - from: [GetMaxEnergy, MaxDomeEnergy]
          to: [ClampEnergy, Max]
        # Step 7: Data - Set dome energy
        - from: [GetFatherRef_Absorb, FatherRef]
          to: [SetDomeEnergy, Target]
        - from: [ClampEnergy, ReturnValue]
          to: [SetDomeEnergy, DomeEnergy]
        # Step 8: Data - Check if fully charged
        - from: [ClampEnergy, ReturnValue]
          to: [CheckFullyCharged, A]
        - from: [GetMaxEnergy, MaxDomeEnergy]
          to: [CheckFullyCharged, B]
        - from: [CheckFullyCharged, ReturnValue]
          to: [Branch_FullyCharged, Condition]
        # Step 9: Data - Grant FullyCharged tag
        - from: [GetPlayerRef_Absorb, PlayerRef]
          to: [AddFullyChargedTag, Actor]
        - from: [MakeLiteralTag_FullyCharged, ReturnValue]
          to: [MakeTagContainer_FullyCharged, Tag]
        - from: [MakeTagContainer_FullyCharged, ReturnValue]
          to: [AddFullyChargedTag, GameplayTags]
        # === END ABILITY FLOW (v4.27: Form exit burst) ===
        # Exec: EndAbility → TryActivateBurst → ClearChargedTag → RemoveGE
        - from: [Event_EndAbility, Then]
          to: [TryActivateBurst, Exec]
        - from: [TryActivateBurst, Exec]
          to: [ClearChargedTag, Exec]
        - from: [ClearChargedTag, Exec]
          to: [RemoveGE, Exec]
        # Data: Get player ASC
        - from: [GetPlayerRef_End, PlayerRef]
          to: [GetPlayerASC_End, Actor]
        # Data: TryActivateBurst target
        - from: [GetPlayerASC_End, ReturnValue]
          to: [TryActivateBurst, Target]
        # Data: ClearChargedTag (Actor + TagContainer)
        - from: [GetPlayerRef_End, PlayerRef]
          to: [ClearChargedTag, Actor]
        - from: [MakeLiteralTag_Charged, ReturnValue]
          to: [MakeTagContainer_Charged, Tag]
        - from: [MakeTagContainer_Charged, ReturnValue]
          to: [ClearChargedTag, GameplayTags]
        # Data: RemoveGE
        - from: [GetPlayerASC_End, ReturnValue]
          to: [RemoveGE, Target]
        - from: [GetDomeHandle, DomeAbsorptionHandle]
          to: [RemoveGE, Handle]
        # === PLAYER DEATH RESET HANDLER FLOW (v7.8.21: D-DEATH-RESET-2 complete) ===
        # Exec: WaitDeathEvent → Branch_Valid → SetDomeEnergy_Death → SetSymbioteCharge_Death → ClearChargedTag_Death
        # NOTE: WaitDeathEvent.EventReceived -> Branch_Valid_Father_Death is connected above in AbilityTask section
        - from: [Branch_Valid_Father_Death, True]
          to: [SetDomeEnergy_Death, Exec]
        - from: [SetDomeEnergy_Death, Exec]
          to: [SetSymbioteCharge_Death, Exec]
        - from: [SetSymbioteCharge_Death, Exec]
          to: [ClearChargedTag_Death, Exec]
        # Data: Father validation
        - from: [GetFatherRef_Death, FatherRef]
          to: [IsValid_Father_Death, Object]
        - from: [IsValid_Father_Death, ReturnValue]
          to: [Branch_Valid_Father_Death, Condition]
        # Data: Set DomeEnergy = 0
        - from: [GetFatherRef_Death, FatherRef]
          to: [SetDomeEnergy_Death, Target]
        - from: [MakeZero_Death, ReturnValue]
          to: [SetDomeEnergy_Death, DomeEnergy]
        # v7.8.21: Data: Set SymbioteCharge = 0
        - from: [GetFatherRef_Death, FatherRef]
          to: [SetSymbioteCharge_Death, Target]
        - from: [MakeZero_Death, ReturnValue]
          to: [SetSymbioteCharge_Death, SymbioteCharge]
        # Data: Clear FullyCharged tag
        - from: [GetPlayerRef_Death, PlayerRef]
          to: [ClearChargedTag_Death, Actor]
        - from: [MakeLiteralTag_Charged_Death, ReturnValue]
          to: [MakeTagContainer_Charged_Death, Tag]
        - from: [MakeTagContainer_Charged_Death, ReturnValue]
          to: [ClearChargedTag_Death, GameplayTags]

  # GA_FatherExoskeletonDash - Exoskeleton Dash with I-Frames
  # NOTE: Runs on Player ASC, granted via EI_FatherExoskeletonForm - no cross-ASC gates
  - name: GA_FatherExoskeletonDash
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: LocalPredicted
    cooldown_gameplay_effect_class: GE_ExoskeletonDashCooldown
    tags:
      ability_tags:
        - Ability.Father.Exoskeleton.Dash
      activation_owned_tags:
        - Father.State.Dashing
      # activation_required_tags removed - Father.Form.Exoskeleton is cross-ASC gate
      # Equipment granting already ensures this ability is only available in Exoskeleton form
      activation_blocked_tags:
        - Cooldown.Father.Exoskeleton.Dash
        - Father.State.Dashing  # On Player ASC (from this ability's activation_owned_tags)
    variables:
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: DashDistance
        type: Float
        default_value: 800.0
        instance_editable: true
      # v7.8.50: Dash Duration per Guide v3.10 (0.5s)
      - name: DashDuration
        type: Float
        default_value: 0.5
        instance_editable: true
      # v7.8.50: Dash Damage/Knockback per Guide v3.10
      - name: DashDamageRadius
        type: Float
        default_value: 200.0
        instance_editable: true
      - name: DashKnockbackForce
        type: Float
        default_value: 800.0
        instance_editable: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetOwningActor
          type: CallFunction
          properties:
            function: GetOwningActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [900, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1200, 0]
        # v4.14: Removed MakeInvulnSpec, ApplyInvuln, GetPlayerASC (dead nodes per GAS Audit CRIT-2)
        # GE_DashInvulnerability was removed per INV-1 - no invulnerability during dash
        - id: GetForwardVector
          type: CallFunction
          properties:
            function: GetActorForwardVector
          position: [2400, 0]
        - id: GetDistance
          type: VariableGet
          properties:
            variable_name: DashDistance
          position: [2400, 100]
        - id: MultiplyVector
          type: CallFunction
          properties:
            function: Multiply_VectorFloat
          position: [2700, 0]
        - id: LaunchCharacter
          type: CallFunction
          properties:
            function: LaunchCharacter
          position: [3000, 0]
        - id: GetDuration
          type: VariableGet
          properties:
            variable_name: DashDuration
          position: [3000, 100]
        # v4.15: WaitDelay auto-terminates with ability (Track B GAS Audit)
        - id: Delay
          type: AbilityTaskWaitDelay
          position: [3300, 0]
        # v7.8.50: Dash Damage/Knockback per Guide v3.10 - applied at dash end
        - id: GetDashLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
          position: [3600, 0]
        - id: GetDashRadius
          type: VariableGet
          properties:
            variable_name: DashDamageRadius
          position: [3600, 100]
        - id: MakeDashObjectTypes
          type: MakeArray
          properties:
            array_type: byte
            num_inputs: 1
          position: [3600, 150]
        - id: MakeDashIgnoreActors
          type: MakeArray
          properties:
            array_type: object
            class: Actor
            num_inputs: 1
          position: [3600, 200]
        - id: SphereDashOverlap
          type: CallFunction
          properties:
            function: SphereOverlapActors
          position: [3900, 0]
        - id: ForEachDashHit
          type: ForEachLoop
          position: [4200, 0]
        - id: HasEnemyTag
          type: CallFunction
          properties:
            function: ActorHasTag
          position: [4500, 0]
        - id: MakeLiteralName_Enemy
          type: CallFunction
          properties:
            function: MakeLiteralName
            param.Value: Enemy
          position: [4500, 100]
        - id: Branch_DashEnemy
          type: Branch
          position: [4800, 0]
        - id: GetEnemyASC_Dash
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [5100, 0]
        - id: GetOwnASC_Dash
          type: CallFunction
          properties:
            function: GetAbilitySystemComponentFromActorInfo
            target_self: true
          position: [5100, 150]
        # Contract 24: GE_DashDamage uses NarrativeDamageExecCalc - damage from AttackDamage attribute, NO SetByCaller
        - id: MakeDashGESpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_DashDamage
          position: [5400, 0]
        - id: ApplyDashGE
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [5700, 0]
        # Knockback
        - id: CastToDashChar
          type: DynamicCast
          properties:
            target_class: Character
          position: [6000, 0]
        - id: GetKnockbackForce
          type: VariableGet
          properties:
            variable_name: DashKnockbackForce
          position: [6000, 100]
        - id: GetKnockbackDir
          type: CallFunction
          properties:
            function: GetActorForwardVector
          position: [6000, 150]
        - id: MultiplyKnockback
          type: CallFunction
          properties:
            function: Multiply_VectorFloat
          position: [6300, 100]
        - id: MakeLiteralBool_KnockXY
          type: MakeLiteralBool
          properties:
            value: "true"
          position: [6300, 200]
        - id: MakeLiteralBool_KnockZ
          type: MakeLiteralBool
          properties:
            value: "false"
          position: [6300, 250]
        - id: LaunchKnockback
          type: CallFunction
          properties:
            function: LaunchCharacter
          position: [6600, 0]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3600, 0]
        - id: EndAbility
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3900, 0]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (impure nodes only - pure functions have no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]  # Direct - GetOwningActor is pure (no exec)
        - from: [CastToFather, Exec]
          to: [SetPlayerRef, Exec]
        # v4.14: Rewired to skip dead invuln nodes (GAS Audit CRIT-2)
        - from: [SetPlayerRef, Exec]
          to: [LaunchCharacter, Exec]
        - from: [LaunchCharacter, Exec]
          to: [Delay, Exec]
        # v7.8.50: Dash Damage/Knockback exec flow per Guide v3.10
        - from: [Delay, OnFinish]
          to: [SphereDashOverlap, Exec]
        - from: [SphereDashOverlap, Exec]
          to: [ForEachDashHit, Exec]
        - from: [ForEachDashHit, LoopBody]
          to: [Branch_DashEnemy, Exec]
        - from: [Branch_DashEnemy, True]
          to: [MakeDashGESpec, Exec]
        - from: [MakeDashGESpec, Exec]
          to: [ApplyDashGE, Exec]
        - from: [ApplyDashGE, Exec]
          to: [CastToDashChar, Exec]
        - from: [CastToDashChar, Exec]
          to: [LaunchKnockback, Exec]
        - from: [ForEachDashHit, Completed]
          to: [CommitCooldown, Exec]
        - from: [CommitCooldown, Exec]
          to: [EndAbility, Exec]
        # Data flow
        - from: [GetOwningActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetOwnerPlayer, Target]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        # v4.14: Removed GetPlayerASC, MakeInvulnSpec, ApplyInvuln data flow (dead nodes)
        - from: [SetPlayerRef, PlayerRef]
          to: [GetForwardVector, Target]
        - from: [SetPlayerRef, PlayerRef]
          to: [LaunchCharacter, Target]
        - from: [GetForwardVector, ReturnValue]
          to: [MultiplyVector, A]
        - from: [GetDistance, DashDistance]
          to: [MultiplyVector, B]
        - from: [MultiplyVector, ReturnValue]
          to: [LaunchCharacter, LaunchVelocity]
        - from: [GetDuration, DashDuration]
          to: [Delay, Time]
        # v7.8.50: Data flow - Dash Damage/Knockback per Guide v3.10
        - from: [SetPlayerRef, PlayerRef]
          to: [GetDashLocation, Target]
        - from: [GetDashLocation, ReturnValue]
          to: [SphereDashOverlap, SpherePos]
        - from: [GetDashRadius, DashDamageRadius]
          to: [SphereDashOverlap, SphereRadius]
        - from: [MakeDashObjectTypes, Array]
          to: [SphereDashOverlap, ObjectTypes]
        # Ignore player in overlap
        - from: [SetPlayerRef, PlayerRef]
          to: [MakeDashIgnoreActors, 0]
        - from: [MakeDashIgnoreActors, Array]
          to: [SphereDashOverlap, ActorsToIgnore]
        - from: [SphereDashOverlap, OutActors]
          to: [ForEachDashHit, Array]
        - from: [ForEachDashHit, ArrayElement]
          to: [HasEnemyTag, Target]
        - from: [MakeLiteralName_Enemy, ReturnValue]
          to: [HasEnemyTag, Tag]
        - from: [HasEnemyTag, ReturnValue]
          to: [Branch_DashEnemy, Condition]
        # GE application per GA_ProximityStrike pattern (Contract 24 compliant)
        - from: [ForEachDashHit, ArrayElement]
          to: [GetEnemyASC_Dash, Actor]
        - from: [GetOwnASC_Dash, ReturnValue]
          to: [ApplyDashGE, self]
        - from: [GetEnemyASC_Dash, ReturnValue]
          to: [ApplyDashGE, Target]
        - from: [MakeDashGESpec, ReturnValue]
          to: [ApplyDashGE, Spec]
        # Knockback wiring
        - from: [ForEachDashHit, ArrayElement]
          to: [CastToDashChar, Object]
        - from: [CastToDashChar, AsCharacter]
          to: [LaunchKnockback, Target]
        - from: [SetPlayerRef, PlayerRef]
          to: [GetKnockbackDir, Target]
        - from: [GetKnockbackDir, ReturnValue]
          to: [MultiplyKnockback, A]
        - from: [GetKnockbackForce, DashKnockbackForce]
          to: [MultiplyKnockback, B]
        - from: [MultiplyKnockback, ReturnValue]
          to: [LaunchKnockback, LaunchVelocity]
        # LaunchCharacter booleans (bXYOverride=true, bZOverride=false)
        - from: [MakeLiteralBool_KnockXY, ReturnValue]
          to: [LaunchKnockback, bXYOverride]
        - from: [MakeLiteralBool_KnockZ, ReturnValue]
          to: [LaunchKnockback, bZOverride]

  # GA_FatherExoskeletonSprint - Exoskeleton Sprint Speed Boost
  # NOTE: Runs on Player ASC, granted via EI_FatherExoskeletonForm - no cross-ASC gates
  - name: GA_FatherExoskeletonSprint
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    # v6.5: Use Narrative Pro default input tag (INV-INPUT-1) - Q key, Exoskeleton-gated
    input_tag: Narrative.Input.Ability1
    instancing_policy: InstancedPerActor
    net_execution_policy: LocalPredicted
    tags:
      ability_tags:
        - Ability.Father.Exoskeleton.Sprint
      activation_owned_tags:
        - Father.State.Sprinting
      # activation_required_tags removed - Father.Form.Exoskeleton is cross-ASC gate
      # Equipment granting already ensures this ability is only available in Exoskeleton form
      activation_blocked_tags:
        - Father.State.Dashing  # On Player ASC (from GA_FatherExoskeletonDash)
    variables:
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: OriginalMaxWalkSpeed
        type: Float
        default_value: 0.0
        instance_editable: true
      # v7.8.50: Sprint Speed per Guide v2.9 (1.75x = +75%)
      - name: SprintSpeedMultiplier
        type: Float
        default_value: 1.75
        instance_editable: true
      # v7.8.50: Sprint Jump Boost per Design Doc Section 2.3.3 (+50%)
      - name: OriginalJumpZVelocity
        type: Float
        default_value: 0.0
        instance_editable: true
      - name: JumpBoostMultiplier
        type: Float
        default_value: 1.5
        instance_editable: true
      # v7.8.50: Sprint Push Loop per Guide v2.9 - push nearby enemies
      - name: PushRadius
        type: Float
        default_value: 300.0
        instance_editable: true
      - name: PushForce
        type: Float
        default_value: 500.0
        instance_editable: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetOwningActor
          type: CallFunction
          properties:
            function: GetOwningActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [900, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1200, 0]
        - id: GetCharMov
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [1500, 0]
        - id: GetMaxSpeed
          type: PropertyGet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [1800, 0]
        - id: SetOrigSpeed
          type: VariableSet
          properties:
            variable_name: OriginalMaxWalkSpeed
          position: [2100, 0]
        - id: GetMultiplier
          type: VariableGet
          properties:
            variable_name: SprintSpeedMultiplier
          position: [2100, 100]
        - id: MultiplySpeed
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [2400, 0]
        - id: SetMaxSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [2700, 0]
        # v7.8.50: Sprint Jump Boost nodes (+50% per Design Doc)
        - id: GetJumpZ
          type: PropertyGet
          properties:
            property_name: JumpZVelocity
            target_class: CharacterMovementComponent
          position: [3000, 0]
        - id: SetOrigJump
          type: VariableSet
          properties:
            variable_name: OriginalJumpZVelocity
          position: [3300, 0]
        - id: GetJumpMultiplier
          type: VariableGet
          properties:
            variable_name: JumpBoostMultiplier
          position: [3300, 100]
        - id: MultiplyJump
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
          position: [3600, 0]
        - id: SetJumpZ
          type: PropertySet
          properties:
            property_name: JumpZVelocity
            target_class: CharacterMovementComponent
          position: [3900, 0]
        # v7.8.50: Sprint Push Loop - push nearby enemies every 0.25s
        - id: RepeatPush
          type: AbilityTaskRepeat
          properties:
            interval: "0.25"
            total_count: "-1"
          position: [4200, 0]
        - id: GetSprintLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
          position: [4500, 0]
        - id: GetPushRadius
          type: VariableGet
          properties:
            variable_name: PushRadius
          position: [4500, 100]
        - id: MakePushObjectTypes
          type: MakeArray
          properties:
            array_type: byte
            values:
              - ObjectTypeQuery3
          position: [4500, 150]
        - id: MakePushIgnoreActors
          type: MakeArray
          properties:
            array_type: object
            class: Actor
          position: [4500, 200]
        - id: SpherePushOverlap
          type: CallFunction
          properties:
            function: SphereOverlapActors
          position: [4800, 0]
        - id: ForEachPush
          type: ForEachLoop
          position: [5100, 0]
        - id: CastToCharPush
          type: DynamicCast
          properties:
            target_class: Character
          position: [5400, 0]
        - id: GetPushForce
          type: VariableGet
          properties:
            variable_name: PushForce
          position: [5400, 100]
        - id: GetPushDirection
          type: CallFunction
          properties:
            function: GetActorForwardVector
          position: [5400, 150]
        - id: MultiplyPushVector
          type: CallFunction
          properties:
            function: Multiply_VectorFloat
          position: [5700, 100]
        - id: MakeLiteralBool_PushXY
          type: MakeLiteralBool
          properties:
            value: "true"
          position: [5700, 200]
        - id: MakeLiteralBool_PushZ
          type: MakeLiteralBool
          properties:
            value: "false"
          position: [5700, 250]
        - id: LaunchPush
          type: CallFunction
          properties:
            function: LaunchCharacter
          position: [6000, 0]
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 400]
        - id: GetPlayerRef_End
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [300, 400]
        - id: GetCharMov_End
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [600, 400]
        - id: GetOrigSpeed
          type: VariableGet
          properties:
            variable_name: OriginalMaxWalkSpeed
          position: [900, 500]
        - id: RestoreSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [900, 400]
        # v7.8.50: Sprint Jump Boost restore nodes
        - id: GetOrigJump
          type: VariableGet
          properties:
            variable_name: OriginalJumpZVelocity
          position: [1200, 500]
        - id: RestoreJump
          type: PropertySet
          properties:
            property_name: JumpZVelocity
            target_class: CharacterMovementComponent
          position: [1200, 400]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (impure nodes only - pure functions have no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]  # Direct - GetOwningActor is pure (no exec)
        - from: [CastToFather, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [SetOrigSpeed, Exec]
        - from: [SetOrigSpeed, Exec]
          to: [SetMaxSpeed, Exec]
        # v7.8.50: Sprint Jump Boost exec flow
        - from: [SetMaxSpeed, Exec]
          to: [SetOrigJump, Exec]
        - from: [SetOrigJump, Exec]
          to: [SetJumpZ, Exec]
        # v7.8.50: Sprint Push Loop exec flow
        - from: [SetJumpZ, Exec]
          to: [RepeatPush, Exec]
        - from: [RepeatPush, OnPerformAction]
          to: [SpherePushOverlap, Exec]
        - from: [SpherePushOverlap, Exec]
          to: [ForEachPush, Exec]
        - from: [ForEachPush, LoopBody]
          to: [CastToCharPush, Exec]
        - from: [CastToCharPush, Exec]
          to: [LaunchPush, Exec]
        # Data flow - Cast
        - from: [GetOwningActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetOwnerPlayer, Target]
        # Data flow - PlayerRef
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [GetCharMov, Target]
        # Data flow - CharacterMovement
        - from: [GetCharMov, CharacterMovement]
          to: [GetMaxSpeed, Target]
        - from: [GetCharMov, CharacterMovement]
          to: [SetMaxSpeed, Target]
        # Data flow - Speed calculation
        - from: [GetMaxSpeed, MaxWalkSpeed]
          to: [SetOrigSpeed, OriginalMaxWalkSpeed]
        - from: [GetMaxSpeed, MaxWalkSpeed]
          to: [MultiplySpeed, A]
        - from: [GetMultiplier, SprintSpeedMultiplier]
          to: [MultiplySpeed, B]
        - from: [MultiplySpeed, ReturnValue]
          to: [SetMaxSpeed, NewMaxWalkSpeed]
        # v7.8.50: Data flow - Jump boost calculation
        - from: [GetCharMov, CharacterMovement]
          to: [GetJumpZ, Target]
        - from: [GetCharMov, CharacterMovement]
          to: [SetJumpZ, Target]
        - from: [GetJumpZ, JumpZVelocity]
          to: [SetOrigJump, OriginalJumpZVelocity]
        - from: [GetJumpZ, JumpZVelocity]
          to: [MultiplyJump, A]
        - from: [GetJumpMultiplier, JumpBoostMultiplier]
          to: [MultiplyJump, B]
        - from: [MultiplyJump, ReturnValue]
          to: [SetJumpZ, NewJumpZVelocity]
        # v7.8.50: Data flow - Sprint Push Loop
        - from: [SetPlayerRef, PlayerRef]
          to: [GetSprintLocation, Target]
        - from: [GetSprintLocation, ReturnValue]
          to: [SpherePushOverlap, SpherePos]
        - from: [GetPushRadius, PushRadius]
          to: [SpherePushOverlap, SphereRadius]
        - from: [MakePushObjectTypes, Array]
          to: [SpherePushOverlap, ObjectTypes]
        # GPT Correction: Ignore player in overlap - add PlayerRef to ignore array
        - from: [SetPlayerRef, PlayerRef]
          to: [MakePushIgnoreActors, 0]
        - from: [MakePushIgnoreActors, Array]
          to: [SpherePushOverlap, ActorsToIgnore]
        - from: [SpherePushOverlap, OutActors]
          to: [ForEachPush, Array]
        - from: [ForEachPush, ArrayElement]
          to: [CastToCharPush, Object]
        - from: [CastToCharPush, AsCharacter]
          to: [LaunchPush, Target]
        # Push direction and force
        - from: [SetPlayerRef, PlayerRef]
          to: [GetPushDirection, Target]
        - from: [GetPushDirection, ReturnValue]
          to: [MultiplyPushVector, A]
        - from: [GetPushForce, PushForce]
          to: [MultiplyPushVector, B]
        - from: [MultiplyPushVector, ReturnValue]
          to: [LaunchPush, LaunchVelocity]
        # LaunchCharacter boolean params (bXYOverride=true, bZOverride=false)
        - from: [MakeLiteralBool_PushXY, ReturnValue]
          to: [LaunchPush, bXYOverride]
        - from: [MakeLiteralBool_PushZ, ReturnValue]
          to: [LaunchPush, bZOverride]
        # === END ABILITY FLOW ===
        - from: [Event_EndAbility, Then]
          to: [RestoreSpeed, Exec]
        # v7.8.50: Chain jump restore after speed restore
        - from: [RestoreSpeed, Exec]
          to: [RestoreJump, Exec]
        # Data flow - End
        - from: [GetPlayerRef_End, PlayerRef]
          to: [GetCharMov_End, Target]
        - from: [GetCharMov_End, CharacterMovement]
          to: [RestoreSpeed, Target]
        - from: [GetOrigSpeed, OriginalMaxWalkSpeed]
          to: [RestoreSpeed, NewMaxWalkSpeed]
        # v7.8.50: Data flow - Jump restore
        - from: [GetCharMov_End, CharacterMovement]
          to: [RestoreJump, Target]
        - from: [GetOrigJump, OriginalJumpZVelocity]
          to: [RestoreJump, NewJumpZVelocity]

  # GA_StealthField - Exoskeleton Stealth Invisibility (player-owned toggle)
  # NOTE: Runs on Player ASC, granted via EI_FatherExoskeletonForm - no cross-ASC gates
  # v7.8: Path B - Break-on-damage restored via WaitGEAppliedToSelf AbilityTask
  # v7.8.50: Father invisibility restored - both Player AND Father become invisible
  - name: GA_StealthField
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    # v6.5: Use Narrative Pro default input tag (INV-INPUT-1) - E key, Exoskeleton-gated
    input_tag: Narrative.Input.Ability2
    instancing_policy: InstancedPerActor
    net_execution_policy: LocalPredicted
    cooldown_gameplay_effect_class: GE_StealthCooldown
    tags:
      ability_tags:
        - Ability.Father.Exoskeleton.StealthField  # v7.8.50: Hierarchical tag per locked design
      activation_owned_tags:
        - Father.State.Stealthed
      # activation_required_tags removed - Father.Form.Exoskeleton is cross-ASC gate
      # Equipment granting already ensures this ability is only available in Exoskeleton form
      activation_blocked_tags:
        - Cooldown.Father.Exoskeleton.StealthField  # v7.8.49: Contract 27 hierarchical
    # v7.8: AbilityTasks restore full functionality - stealth breaks on damage
    # v7.8.50: Added FatherRef and FatherStealthHandle for Father invisibility
    variables:
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: StealthEffectHandle
        type: ActiveGameplayEffectHandle
      - name: FatherStealthHandle
        type: ActiveGameplayEffectHandle
      - name: StealthDuration
        type: Float
        default_value: 8.0
        instance_editable: true
      - name: OriginalWalkSpeed
        type: Float
        default_value: 0.0
      # v7.8.51: Speed multiplier variable (MakeLiteralFloat doesn't exist in UE5)
      - name: StealthSpeedMultiplier
        type: Float
        default_value: 0.8
        instance_editable: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetOwningActor
          type: CallFunction
          properties:
            function: GetOwningActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [900, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1200, 0]
        - id: GetPlayerASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [1500, 0]
        - id: MakeGESpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_StealthActive
          position: [1800, 0]
        - id: ApplyGE
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToSelf
          position: [2100, 0]
        - id: SetStealthHandle
          type: VariableSet
          properties:
            variable_name: StealthEffectHandle
          position: [2400, 0]
        # v7.8.50: Store Father reference for invisibility
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [2400, 100]
        # v7.8.50: Apply invisibility to Father
        - id: GetFatherASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [2550, 100]
        - id: MakeGESpec_Father
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_StealthActive
          position: [2700, 100]
        - id: ApplyGE_Father
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [2850, 100]
        - id: SetFatherStealthHandle
          type: VariableSet
          properties:
            variable_name: FatherStealthHandle
          position: [3000, 100]
        # v7.8.51: [MANIFEST] Lines 1652-1660: Use PropertyGet for CharacterMovement chain
        - id: GetCharMov
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [3150, 0]
        - id: GetOriginalSpeed
          type: PropertyGet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [3300, 0]
        # [MANIFEST] Lines 1674-1679: Multiply_DoubleDouble, class commented out
        - id: MultiplySpeed
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [3450, 0]
        # v7.8.51: VariableGet for speed multiplier (MakeLiteralFloat doesn't exist)
        - id: GetSpeedMultiplier
          type: VariableGet
          properties:
            variable_name: StealthSpeedMultiplier
          position: [3300, 50]
        - id: SetOriginalWalkSpeed
          type: VariableSet
          properties:
            variable_name: OriginalWalkSpeed
          position: [3450, 50]
        # [MANIFEST] Lines 1680-1685: PropertySet for MaxWalkSpeed
        - id: SetReducedSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [3600, 0]
        # v7.8: Sequence for parallel AbilityTasks (duration timer + damage break)
        - id: Sequence_Tasks
          type: Sequence
          properties:
            num_outputs: 2
          position: [3750, 0]
        - id: GetDuration
          type: VariableGet
          properties:
            variable_name: StealthDuration
          position: [2700, 100]
        # v4.15: WaitDelay auto-terminates with ability (Track B GAS Audit)
        - id: Delay
          type: AbilityTaskWaitDelay
          position: [2700, 0]
        # v7.8: Path B - Break on damage via WaitGEAppliedToSelf
        # When ANY GE is applied to player (damage), stealth breaks immediately
        - id: WaitDamageGE_Stealth
          type: AbilityTaskWaitGEAppliedToSelf
          properties:
            trigger_once: true
          position: [2700, 200]
        # Stealth break handler - commits cooldown and ends ability
        - id: CommitCooldown_Break
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3000, 200]
        - id: EndAbility_Break
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3200, 200]
        # === POST-DELAY GUARDS (GAS Audit MED-4) ===
        # Guard: Validate PlayerRef still exists after 8s delay
        - id: GetPlayerRef_Guard
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [2850, 100]
        - id: IsValid_PlayerRef_Guard
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2900, 50]
        - id: Branch_PlayerValid_Guard
          type: Branch
          position: [3000, 0]
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [3200, 0]
        - id: EndAbility
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3300, 0]
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 400]
        # v7.8.50: Restore original walk speed
        - id: GetPlayerRef_End
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [200, 400]
        # [MANIFEST] Lines 1746-1751: PropertyGet for CharacterMovement
        - id: GetCharMov_End
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [400, 400]
        - id: GetOriginalWalkSpeed_End
          type: VariableGet
          properties:
            variable_name: OriginalWalkSpeed
          position: [600, 450]
        # [MANIFEST] Lines 1757-1762: PropertySet for MaxWalkSpeed
        - id: RestoreSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [600, 400]
        # Remove Player stealth GE
        - id: GetPlayerASC_End
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [800, 400]
        - id: GetStealthHandle
          type: VariableGet
          properties:
            variable_name: StealthEffectHandle
          position: [1000, 450]
        - id: RemoveGE
          type: CallFunction
          properties:
            function: RemoveActiveGameplayEffect
          position: [1000, 400]
        # v7.8.50: Remove Father stealth GE
        - id: GetFatherRef_End
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [1200, 400]
        - id: GetFatherASC_End
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [1400, 400]
        - id: GetFatherStealthHandle
          type: VariableGet
          properties:
            variable_name: FatherStealthHandle
          position: [1600, 450]
        - id: RemoveGE_Father
          type: CallFunction
          properties:
            function: RemoveActiveGameplayEffect
          position: [1600, 400]
        # v7.8: STEALTH BREAK RESTORED via Path B AbilityTasks
        # WaitDamageGE_Stealth triggers CommitCooldown_Break → EndAbility_Break when damage received
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (impure nodes only - pure functions have no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]  # Direct - GetOwningActor is pure (no exec)
        - from: [CastToFather, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [SetFatherRef, Exec]  # v7.8.50: Store Father reference
        - from: [SetFatherRef, Exec]
          to: [MakeGESpec, Exec]
        - from: [MakeGESpec, Exec]
          to: [ApplyGE, Exec]
        - from: [ApplyGE, Exec]
          to: [SetStealthHandle, Exec]
        # v7.8.50: Apply stealth to Father
        - from: [SetStealthHandle, Exec]
          to: [MakeGESpec_Father, Exec]
        - from: [MakeGESpec_Father, Exec]
          to: [ApplyGE_Father, Exec]
        - from: [ApplyGE_Father, Exec]
          to: [SetFatherStealthHandle, Exec]
        # v7.8.50: Store original speed and apply reduction
        - from: [SetFatherStealthHandle, Exec]
          to: [SetOriginalWalkSpeed, Exec]
        - from: [SetOriginalWalkSpeed, Exec]
          to: [SetReducedSpeed, Exec]
        - from: [SetReducedSpeed, Exec]
          to: [Sequence_Tasks, Exec]
        # v7.8: Sequence outputs - parallel AbilityTasks
        - from: [Sequence_Tasks, then_0]
          to: [Delay, Exec]
        - from: [Sequence_Tasks, then_1]
          to: [WaitDamageGE_Stealth, Exec]
        # v4.14: Route through guard after delay (GAS Audit MED-4)
        - from: [Delay, OnFinish]
          to: [Branch_PlayerValid_Guard, Exec]
        - from: [Branch_PlayerValid_Guard, True]
          to: [CommitCooldown, Exec]
        - from: [CommitCooldown, Exec]
          to: [EndAbility, Exec]
        # Guard data flow (GAS Audit MED-4)
        - from: [GetPlayerRef_Guard, PlayerRef]
          to: [IsValid_PlayerRef_Guard, Object]
        - from: [IsValid_PlayerRef_Guard, ReturnValue]
          to: [Branch_PlayerValid_Guard, Condition]
        # Data flow - Player references
        - from: [GetOwningActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP_FatherCompanion]
          to: [GetOwnerPlayer, Target]
        - from: [CastToFather, AsBP_FatherCompanion]
          to: [SetFatherRef, FatherRef]  # v7.8.50: Store Father ref
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [SetPlayerRef, PlayerRef]
          to: [GetPlayerASC, Actor]
        # Player stealth GE application
        - from: [GetPlayerASC, ReturnValue]
          to: [ApplyGE, Target]
        - from: [MakeGESpec, ReturnValue]
          to: [ApplyGE, Spec]
        - from: [ApplyGE, ReturnValue]
          to: [SetStealthHandle, StealthEffectHandle]
        # v7.8.50: Father stealth GE application
        - from: [SetFatherRef, FatherRef]
          to: [GetFatherASC, Actor]
        - from: [GetFatherASC, ReturnValue]
          to: [ApplyGE_Father, Target]
        - from: [MakeGESpec_Father, ReturnValue]
          to: [ApplyGE_Father, Spec]
        - from: [ApplyGE_Father, ReturnValue]
          to: [SetFatherStealthHandle, FatherStealthHandle]
        # v7.8.51: Speed reduction data flow - PropertyGet uses property names
        - from: [SetPlayerRef, PlayerRef]
          to: [GetCharMov, Target]
        - from: [GetCharMov, CharacterMovement]
          to: [GetOriginalSpeed, Target]
        - from: [GetOriginalSpeed, MaxWalkSpeed]
          to: [SetOriginalWalkSpeed, OriginalWalkSpeed]
        - from: [GetOriginalSpeed, MaxWalkSpeed]
          to: [MultiplySpeed, A]
        # v7.8.51: Changed from MakeLiteral_SpeedMult to GetSpeedMultiplier
        - from: [GetSpeedMultiplier, StealthSpeedMultiplier]
          to: [MultiplySpeed, B]
        # [MANIFEST] Line 1913: PropertySet value pin uses property name
        - from: [MultiplySpeed, ReturnValue]
          to: [SetReducedSpeed, MaxWalkSpeed]
        - from: [GetCharMov, CharacterMovement]
          to: [SetReducedSpeed, Target]
        - from: [GetDuration, StealthDuration]
          to: [Delay, Time]
        # === END ABILITY FLOW ===
        # v7.8.50: Restore speed first, then remove GEs
        - from: [Event_EndAbility, Then]
          to: [RestoreSpeed, Exec]
        - from: [RestoreSpeed, Exec]
          to: [RemoveGE, Exec]
        - from: [RemoveGE, Exec]
          to: [RemoveGE_Father, Exec]  # v7.8.50: Remove Father GE
        # Data flow - Speed restoration (PropertyGet uses property name)
        - from: [GetPlayerRef_End, PlayerRef]
          to: [GetCharMov_End, Target]
        - from: [GetCharMov_End, CharacterMovement]
          to: [RestoreSpeed, Target]
        # [MANIFEST] Line 1913: PropertySet value pin uses property name
        - from: [GetOriginalWalkSpeed_End, OriginalWalkSpeed]
          to: [RestoreSpeed, MaxWalkSpeed]
        # Data flow - Player GE removal
        - from: [GetPlayerRef_End, PlayerRef]
          to: [GetPlayerASC_End, Actor]
        - from: [GetPlayerASC_End, ReturnValue]
          to: [RemoveGE, Target]
        - from: [GetStealthHandle, StealthEffectHandle]
          to: [RemoveGE, Handle]
        # v7.8.50: Data flow - Father GE removal
        - from: [GetFatherRef_End, FatherRef]
          to: [GetFatherASC_End, Actor]
        - from: [GetFatherASC_End, ReturnValue]
          to: [RemoveGE_Father, Target]
        - from: [GetFatherStealthHandle, FatherStealthHandle]
          to: [RemoveGE_Father, Handle]
        # === v7.8: STEALTH BREAK FLOW (Path B) ===
        # When damage GE is applied, break stealth immediately
        - from: [WaitDamageGE_Stealth, OnApplied]
          to: [CommitCooldown_Break, Exec]
        - from: [CommitCooldown_Break, Exec]
          to: [EndAbility_Break, Exec]

  # GA_Backstab - Universal Player Active Backstab Damage (Input-Triggered)
  # v4.26 (Decision 4): Universal ability - add to player's Default Abilities array, NOT granted via equipment
  # NOTE: Runs on Player ASC - no cross-ASC gates needed
  # ACTIVE ABILITY (v2.1): Player presses F key (Narrative.Input.Ability3) → CheckBackstabCondition → Apply GE_BackstabBonus
  # Contains CheckBackstabCondition function for Goal_Attack query validation
  #
  # AUTOMATION STATUS (v5.1 - Goal_Attack Query Approach):
  # - custom_functions: ✅ FULLY AUTOMATED
  # - CheckBackstabCondition: Queries enemy's Goal_Attack via Narrative Pro's built-in goal system
  # - ApplyBackstabBonus: Uses BP_ApplyGameplayEffectToOwner
  #
  # HOW IT WORKS (Goal_Attack Query):
  # 1. Enemy NPCs use GoalGenerator_Attack which auto-creates Goal_Attack when they detect hostiles
  # 2. Goal_Attack stores TargetToAttack (the actor the enemy is attacking)
  # 3. CheckBackstabCondition queries: Does enemy have Goal_Attack targeting the player?
  # 4. If no Goal_Attack OR target != player → enemy is unaware/distracted → BACKSTAB VALID
  #
  # NO MANUAL INTEGRATION REQUIRED - Uses Narrative Pro's existing perception → goal system
  - name: GA_Backstab
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    # v7.8.21: INV-INPUT-1 compliant - uses Narrative.Input.Ability3 (F key)
    # Universal ability (no form gating) - internal CheckBackstabCondition handles validation
    input_tag: Narrative.Input.Ability3
    instancing_policy: InstancedPerActor
    net_execution_policy: LocalPredicted
    tags:
      ability_tags:
        - Ability.Father.Backstab
      activation_owned_tags:
        - State.BackstabReady
      # No activation_required_tags - universal ability, internal conditions handle gating
    variables:
      - name: TargetEnemy
        type: Object
        class: Actor
        instance_editable: true
    event_graph:
      # Option 1: Input triggers condition check → applies +25 AttackRating bonus via GE_BackstabBonus
      # Flow: Activate → CheckBackstabCondition → Branch → Apply GE_BackstabBonus → EndAbility
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetTarget
          type: VariableGet
          properties:
            variable_name: TargetEnemy
          position: [200, 0]
        - id: IsValidTarget
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [400, 0]
        - id: Branch_ValidTarget
          type: Branch
          position: [600, 0]
        - id: CallCheckBackstab
          type: CallFunction
          properties:
            function: CheckBackstabCondition
            target_self: true
          position: [800, 0]
        - id: Branch_CanBackstab
          type: Branch
          position: [1000, 0]
        # Apply GE_BackstabBonus to self (player) for next attack
        - id: MakeGESpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            class: UGameplayAbility
            target_self: true
            param.GameplayEffectClass: GE_BackstabBonus
          position: [1200, 0]
        - id: ApplyGEToSelf
          type: CallFunction
          properties:
            function: K2_ApplyGameplayEffectSpecToOwner
            target_self: true
          position: [1400, 0]
        - id: EndAbility_Success
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [1600, 0]
        - id: EndAbility_Fail
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [1000, 200]
      connections:
        - from: [Event_Activate, Then]
          to: [IsValidTarget, Exec]
        - from: [GetTarget, TargetEnemy]
          to: [IsValidTarget, Object]
        - from: [IsValidTarget, Exec]
          to: [Branch_ValidTarget, Exec]
        - from: [IsValidTarget, ReturnValue]
          to: [Branch_ValidTarget, Condition]
        # Valid target path
        - from: [Branch_ValidTarget, True]
          to: [CallCheckBackstab, Exec]
        - from: [GetTarget, TargetEnemy]
          to: [CallCheckBackstab, EnemyActor]
        - from: [CallCheckBackstab, Exec]
          to: [Branch_CanBackstab, Exec]
        - from: [CallCheckBackstab, CanBackstab]
          to: [Branch_CanBackstab, Condition]
        # Can backstab path - apply bonus
        - from: [Branch_CanBackstab, True]
          to: [MakeGESpec, Exec]
        - from: [MakeGESpec, Exec]
          to: [ApplyGEToSelf, Exec]
        - from: [MakeGESpec, ReturnValue]
          to: [ApplyGEToSelf, SpecHandle]
        - from: [ApplyGEToSelf, Exec]
          to: [EndAbility_Success, Exec]
        # Cannot backstab or invalid target - just end
        - from: [Branch_CanBackstab, False]
          to: [EndAbility_Fail, Exec]
        - from: [Branch_ValidTarget, False]
          to: [EndAbility_Fail, Exec]
    # v5.1: Custom functions using Goal_Attack query approach
    # Uses Narrative Pro's built-in goal system instead of custom perception binding
    custom_functions:
      # CheckBackstabCondition - v5.1: Goal_Attack Query Approach
      # Returns true if enemy has no Goal_Attack targeting the attacking player
      # Flow: Enemy → NPCActivityComponent → GetCurrentActivityGoal → Cast to Goal_Attack → Check target
      # Backstab valid when:
      # - Enemy has no NPCActivityComponent (not a goal-based NPC)
      # - Enemy has no current Goal_Attack (not attacking anyone)
      # - Enemy's Goal_Attack target is NOT the player (attacking someone else like Father)
      - function_name: CheckBackstabCondition
        pure: false
        inputs:
          - name: EnemyActor
            type: Actor
        outputs:
          - name: CanBackstab
            type: Boolean
        nodes:
          # Step 1: Get player (self) for comparison
          - id: GetPlayer
            type: CallFunction
            properties:
              function: GetAvatarActorFromActorInfo
              target_self: true
            position: [0, 100]
          # Step 2: Get NPCActivityComponent from enemy
          # NPCActivityComponent handles goal-based AI behavior in Narrative Pro
          - id: GetActivityComp
            type: CallFunction
            properties:
              function: GetComponentByClass
              class: Actor
              param.ComponentClass: NPCActivityComponent
            position: [200, 0]
          # v6.9: Cast GetComponentByClass result to NPCActivityComponent
          # GetComponentByClass returns UActorComponent*, need to cast for NPCActivityComponent methods
          - id: CastToActivityComp
            type: DynamicCast
            properties:
              target_class: NPCActivityComponent
            position: [350, 0]
          # Step 3: Check if cast succeeded (component exists and is correct type)
          - id: IsValidComp
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [500, 0]
          # Step 4: Get current activity goal (if component valid)
          # This returns the active goal from the NPC's activity system
          - id: GetCurrentGoal
            type: CallFunction
            properties:
              function: GetCurrentActivityGoal
              class: NPCActivityComponent
            position: [650, 0]
          # Step 5: Cast to Goal_Attack to check if enemy is in attack mode
          - id: CastToGoalAttack
            type: DynamicCast
            properties:
              target_class: Goal_Attack
            position: [800, 0]
          # Step 6: Get TargetToAttack property from Goal_Attack
          # This is the actor the enemy is currently attacking
          - id: GetAttackTarget
            type: PropertyGet
            properties:
              property_name: TargetToAttack
              target_class: Goal_Attack
            position: [1000, 0]
          # Step 7: Check if target equals player (NotEqual = can backstab)
          - id: NotEqualPlayer
            type: CallFunction
            properties:
              function: NotEqual_ObjectObject
              # class: KismetMathLibrary  # Commented out - let resolver find
            position: [1200, 0]
          # Step 8: Check if cast succeeded (Goal_Attack is valid)
          - id: IsValidGoal
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [1000, 100]
          # NOT IsValidGoal (no goal = can backstab)
          - id: NotValidGoal
            type: CallFunction
            properties:
              function: Not_PreBool
              # class: KismetMathLibrary  # Commented out - let resolver find
            position: [1200, 100]
          # Step 9: OR(NoGoal, TargetNotPlayer) - true if no goal OR attacking someone else
          - id: OrGoalCheck
            type: CallFunction
            properties:
              function: BooleanOR
              # class: KismetMathLibrary  # Commented out - let resolver find
            position: [1400, 0]
          # Step 10: Final OR: NoComponent OR GoalCheck = can backstab
          - id: OrNoComponent
            type: CallFunction
            properties:
              function: BooleanOR
              # class: KismetMathLibrary  # Commented out - let resolver find
            position: [1600, 0]
          # NOT IsValidComp (no component = can backstab)
          - id: NotValidComp
            type: CallFunction
            properties:
              function: Not_PreBool
              # class: KismetMathLibrary  # Commented out - let resolver find
            position: [500, 100]
        connections:
          # EnemyActor → GetComponentByClass target
          - from: [FunctionEntry, EnemyActor]
            to: [GetActivityComp, Target]
          # v6.9: GetActivityComp → CastToActivityComp → IsValidComp/GetCurrentGoal
          - from: [GetActivityComp, ReturnValue]
            to: [CastToActivityComp, Object]
          # Check if cast succeeded (component valid and correct type)
          - from: [CastToActivityComp, AsNPCActivityComponent]
            to: [IsValidComp, Object]
          # IsValidComp → NotValidComp (invert for OR logic)
          - from: [IsValidComp, ReturnValue]
            to: [NotValidComp, A]
          # Cast output → GetCurrentGoal target
          - from: [CastToActivityComp, AsNPCActivityComponent]
            to: [GetCurrentGoal, Target]
          # GetCurrentGoal → CastToGoalAttack
          - from: [GetCurrentGoal, ReturnValue]
            to: [CastToGoalAttack, Object]
          # CastToGoalAttack result → GetAttackTarget target
          - from: [CastToGoalAttack, AsGoal_Attack]
            to: [GetAttackTarget, Target]
          # CastToGoalAttack result → IsValidGoal
          - from: [CastToGoalAttack, AsGoal_Attack]
            to: [IsValidGoal, Object]
          # IsValidGoal → NotValidGoal (invert - no goal = can backstab)
          - from: [IsValidGoal, ReturnValue]
            to: [NotValidGoal, A]
          # GetAttackTarget → NotEqualPlayer A
          - from: [GetAttackTarget, TargetToAttack]
            to: [NotEqualPlayer, A]
          # GetPlayer → NotEqualPlayer B
          - from: [GetPlayer, ReturnValue]
            to: [NotEqualPlayer, B]
          # OR(NoGoal, TargetNotPlayer) - true if no goal OR target is not player
          - from: [NotValidGoal, ReturnValue]
            to: [OrGoalCheck, A]
          - from: [NotEqualPlayer, ReturnValue]
            to: [OrGoalCheck, B]
          # Final OR: NoComponent OR GoalCheck
          - from: [NotValidComp, ReturnValue]
            to: [OrNoComponent, A]
          - from: [OrGoalCheck, ReturnValue]
            to: [OrNoComponent, B]
          # Return final result
          - from: [OrNoComponent, ReturnValue]
            to: [FunctionResult, CanBackstab]
      # ApplyBackstabBonus - Applies GE_BackstabBonus effect to player
      # GE_BackstabBonus grants +25 AttackRating (instant effect)
      # Attack abilities call: if CheckBackstabCondition(Enemy) then ApplyBackstabBonus()
      # v4.14: Generator now supports TSubclassOf pin defaults via param.PinName syntax
      - function_name: ApplyBackstabBonus
        pure: false
        nodes:
          # BP_ApplyGameplayEffectToOwner applies GE to ability owner (player)
          # Per guide Section 15.2: Apply Gameplay Effect to Owner -> GE_BackstabBonus
          - id: ApplyGEToOwner
            type: CallFunction
            properties:
              # BP_ApplyGameplayEffectToOwner is the Blueprint-callable version on UGameplayAbility
              function: BP_ApplyGameplayEffectToOwner
              target_self: true
              # v4.14: Set TSubclassOf<UGameplayEffect> pin default to GE_BackstabBonus
              param.GameplayEffectClass: GE_BackstabBonus
              param.GameplayEffectLevel: 1
            position: [200, 0]
        connections:
          # Exec flow: Entry -> Apply GE to Owner
          - from: [FunctionEntry, Then]
            to: [ApplyGEToOwner, Exec]

  # GA_ProximityStrike - Symbiote AOE Damage (v7.8.50 Looping Timer Pattern)
  # Passive ability activated by GA_FatherSymbiote, runs for 30s Symbiote duration
  # Contract 24 compliant: NO SetByCaller - damage from Father's captured AttackDamage
  # v7.8.50: Changed from instant single-shot to looping timer (60 ticks, 3000 damage/enemy)
  - name: GA_ProximityStrike
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    # v7.8.50: No input tag - passive ability activated by GA_FatherSymbiote
    # v7.8.50: No cooldown - runs for Symbiote form duration (30s)
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    tags:
      ability_tags:
        - Ability.Father.Symbiote.ProximityStrike  # v7.8.51: Removed redundant flat tag per guide
      activation_required_tags:  # v7.8.55: Added per guide v2.11 - defense-in-depth
        - Effect.Father.FormState.Symbiote
        - Father.State.Merged
        - Father.State.Recruited
      activation_owned_tags:
        - Father.State.ProximityActive
      activation_blocked_tags:
        - Father.State.ProximityActive  # Prevent double activation
    variables:
      - name: PlayerRef
        type: Object
        class: Actor
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: FatherASC
        type: Object
        class: AbilitySystemComponent
      - name: DamageTimerHandle
        type: TimerHandle
      - name: IsActive
        type: Boolean
        default_value: false
      - name: ProximityRadius
        type: Float
        default_value: 400.0
        instance_editable: true
      - name: TickRate
        type: Float
        default_value: 0.5
        instance_editable: true
    event_graph:
      nodes:
        # === EVENT: ACTIVATE ABILITY ===
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
        - id: IsValid_Player
          type: CallFunction
          properties:
            function: IsValid
        - id: Branch_PlayerValid
          type: Branch
        - id: GetFatherASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
        - id: SetFatherASC
          type: VariableSet
          properties:
            variable_name: FatherASC
        - id: SetIsActive_True
          type: VariableSet
          properties:
            variable_name: IsActive
        # v7.8.51: Fixed - use MakeLiteralBool instead of MakeLiteral
        - id: MakeLiteral_True
          type: MakeLiteralBool
          properties:
            value: true
        - id: GetSelf
          type: Self
        - id: GetTickRate
          type: VariableGet
          properties:
            variable_name: TickRate
        # v7.8.51: Fixed - use MakeLiteralBool for looping flag
        - id: MakeLiteral_Looping
          type: MakeLiteralBool
          properties:
            value: true
        # v7.8.51: Fixed - set FunctionName as param (no MakeLiteralName node type)
        - id: SetTimerByFunctionName
          type: CallFunction
          properties:
            function: K2_SetTimer
            param.FunctionName: DealProximityDamage
        - id: SetDamageTimerHandle
          type: VariableSet
          properties:
            variable_name: DamageTimerHandle
        - id: EndAbility_CastFailed
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
        - id: EndAbility_PlayerInvalid
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
        # === CUSTOM EVENT: DEAL PROXIMITY DAMAGE (Called by timer) ===
        - id: Event_DealProximityDamage
          type: CustomEvent
          properties:
            event_name: DealProximityDamage
        - id: GetIsActive
          type: VariableGet
          properties:
            variable_name: IsActive
        - id: Branch_IsActive
          type: Branch
        - id: GetPlayerRef
          type: VariableGet
          properties:
            variable_name: PlayerRef
        - id: IsValid_PlayerRef
          type: CallFunction
          properties:
            function: IsValid
        - id: Branch_PlayerRefValid
          type: Branch
        - id: GetPlayerLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
        - id: GetRadius
          type: VariableGet
          properties:
            variable_name: ProximityRadius
        - id: GetSelf_Overlap
          type: Self
        - id: MakeObjectTypes
          type: MakeArray
          properties:
            array_type: byte
            values:
              - ObjectTypeQuery3
        - id: GetPlayerRef_Ignore
          type: VariableGet
          properties:
            variable_name: PlayerRef
        - id: GetFatherRef_Ignore
          type: VariableGet
          properties:
            variable_name: FatherRef
        # v7.8.51: Fixed - generator uses num_inputs, not num_elements
        - id: MakeIgnoreArray
          type: MakeArray
          properties:
            array_type: object
            class: Actor
            num_inputs: 2
        - id: SphereOverlap
          type: CallFunction
          properties:
            function: SphereOverlapActors
        - id: ForEachActor
          type: ForEachLoop
        - id: GetEnemyASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
        - id: IsValid_EnemyASC
          type: CallFunction
          properties:
            function: IsValid
        - id: Branch_EnemyASCValid
          type: Branch
        - id: GetFatherASC_ForSpec
          type: VariableGet
          properties:
            variable_name: FatherASC
        # Contract 24: MakeOutgoingSpec on Father ASC (source) - captures AttackDamage
        # v7.8.53: Use ASC's MakeOutgoingSpec function (not GA's version)
        # Connect FatherASC to Object pin to call on ASC instance
        - id: MakeGESpec
          type: CallFunction
          properties:
            function: MakeOutgoingSpec
            param.GameplayEffectClass: GE_ProximityDamage
        - id: ApplyGE
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
        # === EVENT: END ABILITY ===
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
        - id: SetIsActive_False
          type: VariableSet
          properties:
            variable_name: IsActive
        # v7.8.51: Fixed - use MakeLiteralBool instead of MakeLiteral
        - id: MakeLiteral_False
          type: MakeLiteralBool
          properties:
            value: false
        - id: GetTimerHandle
          type: VariableGet
          properties:
            variable_name: DamageTimerHandle
        - id: ClearTimer
          type: CallFunction
          properties:
            function: K2_ClearAndInvalidateTimerHandle
            target_self: true
        - id: ClearPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
        - id: ClearFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
        - id: ClearFatherASC
          type: VariableSet
          properties:
            variable_name: FatherASC
      connections:
        # === ACTIVATION EXEC FLOW ===
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, CastFailed]
          to: [EndAbility_CastFailed, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [Branch_PlayerValid, Exec]
        - from: [Branch_PlayerValid, False]
          to: [EndAbility_PlayerInvalid, Exec]
        - from: [Branch_PlayerValid, True]
          to: [SetFatherASC, Exec]
        - from: [SetFatherASC, Exec]
          to: [SetIsActive_True, Exec]
        - from: [SetIsActive_True, Exec]
          to: [SetTimerByFunctionName, Exec]
        - from: [SetTimerByFunctionName, Exec]
          to: [SetDamageTimerHandle, Exec]
        # === ACTIVATION DATA FLOW ===
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP_FatherCompanion]
          to: [SetFatherRef, FatherRef]
        - from: [CastToFather, AsBP_FatherCompanion]
          to: [GetOwnerPlayer, Target]
        # v7.8.51: Fixed - GetAbilitySystemComponent has Actor pin, not Target
        - from: [CastToFather, AsBP_FatherCompanion]
          to: [GetFatherASC, Actor]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [SetPlayerRef, PlayerRef]
          to: [IsValid_Player, Object]
        - from: [IsValid_Player, ReturnValue]
          to: [Branch_PlayerValid, Condition]
        - from: [GetFatherASC, ReturnValue]
          to: [SetFatherASC, FatherASC]
        - from: [MakeLiteral_True, ReturnValue]
          to: [SetIsActive_True, IsActive]
        - from: [GetSelf, self]
          to: [SetTimerByFunctionName, Object]
        # v7.8.51: FunctionName set via param.FunctionName, no connection needed
        - from: [GetTickRate, TickRate]
          to: [SetTimerByFunctionName, Time]
        - from: [MakeLiteral_Looping, ReturnValue]
          to: [SetTimerByFunctionName, bLooping]
        - from: [SetTimerByFunctionName, ReturnValue]
          to: [SetDamageTimerHandle, DamageTimerHandle]
        # === DEAL DAMAGE EXEC FLOW ===
        - from: [Event_DealProximityDamage, Then]
          to: [Branch_IsActive, Exec]
        - from: [Branch_IsActive, True]
          to: [Branch_PlayerRefValid, Exec]
        - from: [Branch_PlayerRefValid, True]
          to: [SphereOverlap, Exec]
        - from: [SphereOverlap, Exec]
          to: [ForEachActor, Exec]
        - from: [ForEachActor, LoopBody]
          to: [Branch_EnemyASCValid, Exec]
        - from: [Branch_EnemyASCValid, True]
          to: [MakeGESpec, Exec]
        - from: [MakeGESpec, Exec]
          to: [ApplyGE, Exec]
        # === DEAL DAMAGE DATA FLOW ===
        - from: [GetIsActive, IsActive]
          to: [Branch_IsActive, Condition]
        - from: [GetPlayerRef, PlayerRef]
          to: [IsValid_PlayerRef, Object]
        - from: [IsValid_PlayerRef, ReturnValue]
          to: [Branch_PlayerRefValid, Condition]
        - from: [GetPlayerRef, PlayerRef]
          to: [GetPlayerLocation, Target]
        - from: [GetPlayerLocation, ReturnValue]
          to: [SphereOverlap, SpherePos]
        - from: [GetRadius, ProximityRadius]
          to: [SphereOverlap, SphereRadius]
        - from: [GetSelf_Overlap, self]
          to: [SphereOverlap, WorldContextObject]
        - from: [MakeObjectTypes, Array]
          to: [SphereOverlap, ObjectTypes]
        - from: [GetPlayerRef_Ignore, PlayerRef]
          to: [MakeIgnoreArray, 0]
        - from: [GetFatherRef_Ignore, FatherRef]
          to: [MakeIgnoreArray, 1]
        - from: [MakeIgnoreArray, Array]
          to: [SphereOverlap, ActorsToIgnore]
        - from: [SphereOverlap, OutActors]
          to: [ForEachActor, Array]
        # v7.8.51: Fixed - GetAbilitySystemComponent has Actor pin, not Target
        - from: [ForEachActor, ArrayElement]
          to: [GetEnemyASC, Actor]
        - from: [GetEnemyASC, ReturnValue]
          to: [IsValid_EnemyASC, Object]
        - from: [IsValid_EnemyASC, ReturnValue]
          to: [Branch_EnemyASCValid, Condition]
        # v7.8.53: Connect FatherASC to MakeGESpec Target pin (call on ASC instance)
        # Contract 24 compliance - captures AttackDamage from Father's ASC
        - from: [GetFatherASC_ForSpec, FatherASC]
          to: [MakeGESpec, Target]
        - from: [MakeGESpec, ReturnValue]
          to: [ApplyGE, Spec]
        - from: [GetEnemyASC, ReturnValue]
          to: [ApplyGE, Target]
        # === END ABILITY EXEC FLOW ===
        - from: [Event_EndAbility, Then]
          to: [SetIsActive_False, Exec]
        - from: [SetIsActive_False, Exec]
          to: [ClearTimer, Exec]
        - from: [ClearTimer, Exec]
          to: [ClearPlayerRef, Exec]
        - from: [ClearPlayerRef, Exec]
          to: [ClearFatherRef, Exec]
        - from: [ClearFatherRef, Exec]
          to: [ClearFatherASC, Exec]
        # === END ABILITY DATA FLOW ===
        - from: [MakeLiteral_False, ReturnValue]
          to: [SetIsActive_False, IsActive]
        - from: [GetTimerHandle, DamageTimerHandle]
          to: [ClearTimer, Handle]

  # GA_FatherMark - Mark Enemy for Bonus Damage
  # NOTE: Runs on Father ASC, only in Crawler and Engineer forms
  # v7.8.48 P1-MK.X: Reads PendingMarkTarget from owner BP_FatherCompanion
  - name: GA_FatherMark
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    tags:
      ability_tags:
        - Ability.Father.Mark
      activation_owned_tags:
        - Father.State.Marking
      # Mark works in both Crawler and Engineer forms (ERDEM DECISION)
      # Called internally by attack abilities via BP_FatherCompanion.MarkEnemy()
      # P1-MK.1: Require Recruited state
      activation_required_tags:
        - Father.State.Recruited
      # P1-MK.2: Block if dead or in non-marking forms (Armor/Exo/Symbiote)
      # Crawler and Engineer are the only forms where marking is active
      activation_blocked_tags:
        - Father.State.Transitioning
        - Narrative.State.IsDead
        - Effect.Father.FormState.Armor
        - Effect.Father.FormState.Exoskeleton
        - Effect.Father.FormState.Symbiote
    variables:
      - name: TargetEnemy
        type: Object
        class: Actor
      - name: MarkDuration
        type: Float
        default_value: 5.0  # 5 seconds per guide
        instance_editable: true
      - name: MarkArmorReduction
        type: Float
        default_value: -10.0  # -10 Armor = ~10% more damage per guide
        instance_editable: true
    event_graph:
      nodes:
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        # v7.8.48 P1-MK.X: Get PendingMarkTarget from owner BP_FatherCompanion
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [200, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [400, 0]
        - id: GetPendingTarget
          type: PropertyGet
          properties:
            property_name: PendingMarkTarget
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetTargetEnemy
          type: VariableSet
          properties:
            variable_name: TargetEnemy
          position: [800, 0]
        # Original validation flow continues
        - id: GetTarget
          type: VariableGet
          properties:
            variable_name: TargetEnemy
          position: [1000, 0]
        - id: IsValid
          type: CallFunction
          properties:
            function: IsValid
          position: [1200, 0]
        - id: Branch_Valid
          type: Branch
          position: [1500, 0]
        - id: GetEnemyASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
          position: [1200, 0]
        - id: GetOwnASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponentFromActorInfo
            target_self: true
          position: [1200, 100]
        - id: MakeGESpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_MarkEffect
          position: [1500, 0]
        - id: GetDuration
          type: VariableGet
          properties:
            variable_name: MarkDuration
          position: [1800, 150]
        - id: MakeDurationTag
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Data.Mark.Duration
          position: [1800, 200]
        - id: SetDurationByCaller
          type: CallFunction
          properties:
            function: AssignTagSetByCallerMagnitude
            class: AbilitySystemBlueprintLibrary
          position: [1800, 0]
        # v7.3: Add armor reduction SetByCaller
        - id: GetArmorReduction
          type: VariableGet
          properties:
            variable_name: MarkArmorReduction
          position: [2100, 150]
        - id: MakeArmorTag
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Data.Mark.ArmorReduction
          position: [2100, 200]
        - id: SetArmorByCaller
          type: CallFunction
          properties:
            function: AssignTagSetByCallerMagnitude
            class: AbilitySystemBlueprintLibrary
          position: [2100, 0]
        - id: ApplyGE
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [2400, 0]
        - id: EndAbility
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [2400, 0]
        - id: EndAbility_Invalid
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [1200, 200]
      connections:
        # v7.8.48 P1-MK.X: Exec flow - Get PendingMarkTarget from owner first
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, Exec]
          to: [SetTargetEnemy, Exec]
        - from: [CastToFather, AsBP Father Companion]
          to: [GetPendingTarget, Target]
        - from: [GetPendingTarget, PendingMarkTarget]
          to: [SetTargetEnemy, TargetEnemy]
        - from: [SetTargetEnemy, Exec]
          to: [Branch_Valid, Exec]
        # Cast failure - end ability
        - from: [CastToFather, CastFailed]
          to: [EndAbility_Invalid, Exec]
        # Original exec flow continues
        - from: [Branch_Valid, True]
          to: [MakeGESpec, Exec]
        - from: [MakeGESpec, Exec]
          to: [SetDurationByCaller, Exec]
        - from: [SetDurationByCaller, Exec]
          to: [SetArmorByCaller, Exec]
        - from: [SetArmorByCaller, Exec]
          to: [ApplyGE, Exec]
        - from: [ApplyGE, Exec]
          to: [EndAbility, Exec]
        - from: [Branch_Valid, False]
          to: [EndAbility_Invalid, Exec]
        # Data flow
        - from: [GetTarget, TargetEnemy]
          to: [IsValid, Object]
        - from: [IsValid, ReturnValue]
          to: [Branch_Valid, Condition]
        - from: [GetTarget, TargetEnemy]
          to: [GetEnemyASC, Actor]
        - from: [MakeGESpec, ReturnValue]
          to: [SetDurationByCaller, SpecHandle]
        - from: [GetDuration, MarkDuration]
          to: [SetDurationByCaller, Magnitude]
        - from: [MakeDurationTag, ReturnValue]
          to: [SetDurationByCaller, DataTag]
        # v7.3: Chain spec through armor reduction SetByCaller
        - from: [SetDurationByCaller, ReturnValue]
          to: [SetArmorByCaller, SpecHandle]
        - from: [GetArmorReduction, MarkArmorReduction]
          to: [SetArmorByCaller, Magnitude]
        - from: [MakeArmorTag, ReturnValue]
          to: [SetArmorByCaller, DataTag]
        - from: [SetArmorByCaller, ReturnValue]
          to: [ApplyGE, Spec]
        - from: [GetEnemyASC, ReturnValue]
          to: [ApplyGE, Target]
        - from: [GetOwnASC, ReturnValue]
          to: [ApplyGE, self]

  # GA_FatherSacrifice - Emergency Save with Dormant Period
  # v7.8.55: Audit fixes - health monitoring, target invulnerability, cue trigger, Armor activation
  # Pattern: [MANIFEST] GA_ProtectiveDome AbilityAsyncWaitAttributeChanged for health monitoring
  - name: GA_FatherSacrifice
    folder: Abilities/Actions
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerInitiated
    tags:
      ability_tags:
        - Ability.Father.Sacrifice
      cancel_abilities_with_tag:
        - Ability.Father.Crawler
        - Ability.Father.Armor
        - Ability.Father.Exoskeleton
        - Ability.Father.Symbiote
        - Ability.Father.Engineer
      activation_owned_tags:
        - Father.State.Sacrificing
      activation_required_tags:
        - Father.State.Alive
        - Father.State.Recruited
      activation_blocked_tags:
        - Cooldown.Father.Symbiote.Sacrifice  # v7.8.49: Contract 27 hierarchical
        - Father.State.Dormant
        - Narrative.State.IsDead  # v7.8.55: Contract C_SACRIFICE_DEAD_GUARD_C - defense-in-depth
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: PlayerRef
        type: Object
        class: NarrativePlayerCharacter
      - name: PlayerASC
        type: Object
        class: AbilitySystemComponent
      - name: IsMonitoring
        type: Bool
        default_value: false
      - name: HealthThreshold
        type: Float
        default_value: 0.15
        instance_editable: true
        comment: Health percentage (0.15 = 15%) to trigger sacrifice
      - name: InvulnerabilityDuration
        type: Float
        default_value: 10.0
        instance_editable: true
      - name: DormantDuration
        type: Float
        default_value: 180.0  # v7.8.49: Fixed 180s per Erdem
        instance_editable: true
      - name: DormantTimerHandle
        type: TimerHandle
    event_graph:
      nodes:
        # === ACTIVATION FLOW (Setup references + start health monitoring) ===
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [1200, 0]
        - id: SetPlayerRef
          type: VariableSet
          properties:
            variable_name: PlayerRef
          position: [1500, 0]
        # Get and store Player ASC
        - id: GetPlayerASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1800, 0]
        - id: SetPlayerASC
          type: VariableSet
          properties:
            variable_name: PlayerASC
          position: [2100, 0]
        # Validate PlayerASC before monitoring
        - id: IsValid_PlayerASC
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2400, 50]
        - id: Branch_PlayerASC_Valid
          type: Branch
          position: [2550, 0]
        # === HEALTH MONITORING (AbilityAsyncWaitAttributeChanged) ===
        # [MANIFEST] Pattern from GA_ProtectiveDome lines 5168-5174
        - id: WaitHealthChange
          type: AbilityAsyncWaitAttributeChanged
          properties:
            attribute_set: NarrativeAttributeSetBase
            attribute: Health
            trigger_once: false
          position: [2700, 0]
        - id: SetIsMonitoring
          type: VariableSet
          properties:
            variable_name: IsMonitoring
          position: [3000, 0]
        # === ON HEALTH CHANGED - Check threshold ===
        # [ENGINE] NarrativeCharacter.h:472-475 - GetHealth() and GetMaxHealth() are BlueprintCallable
        - id: GetPlayerRef_Check
          type: VariableGet
          properties:
            variable_name: PlayerRef
          position: [3200, 100]
        - id: GetHealth
          type: CallFunction
          properties:
            function: GetHealth
            class: NarrativeCharacter
          position: [3400, 0]
        - id: GetMaxHealth
          type: CallFunction
          properties:
            function: GetMaxHealth
            class: NarrativeCharacter
          position: [3600, 0]
        - id: DivideHealth
          type: CallFunction
          properties:
            function: Divide_DoubleDouble
            class: KismetMathLibrary
          position: [3900, 0]
        - id: GetHealthThreshold
          type: VariableGet
          properties:
            variable_name: HealthThreshold
          position: [4100, 100]
        - id: LessThanThreshold
          type: CallFunction
          properties:
            function: Less_DoubleDouble
            class: KismetMathLibrary
          position: [4200, 0]
        - id: GetIsMonitoring
          type: VariableGet
          properties:
            variable_name: IsMonitoring
          position: [4350, 100]
        - id: And_MonitoringAndThreshold
          type: CallFunction
          properties:
            function: BooleanAND
            class: KismetMathLibrary
          position: [4500, 0]
        - id: Branch_ThresholdCheck
          type: Branch
          position: [4650, 0]
        # === EXECUTE SACRIFICE (Threshold breached) ===
        # Stop monitoring
        - id: SetIsMonitoring_False
          type: VariableSet
          properties:
            variable_name: IsMonitoring
          position: [4800, 0]
        # v7.8.55 Phase 3 FIX: Apply invulnerability to PLAYER (not Father)
        # Uses BP_ApplyGameplayEffectToTarget with PlayerASC
        - id: GetPlayerASC_Apply
          type: VariableGet
          properties:
            variable_name: PlayerASC
          position: [5000, 100]
        - id: ApplySacrificeInvuln
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToSelf
            class: AbilitySystemComponent
            param.GameplayEffectClass: GE_SacrificeInvulnerability
          position: [5100, 0]
        # v7.8.55 Phase 5: Play dormant cue before hide
        - id: GetFatherRef_Cue
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [5300, 100]
        - id: ExecuteGameplayCueDormant
          type: CallFunction
          properties:
            function: K2_ExecuteGameplayCueWithParams
            target_self: true
          position: [5400, 0]
        - id: MakeLiteralTag_DormantCue
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: GameplayCue.Father.Sacrifice.Dormant
          position: [5300, 200]
        # Hide Father actor
        - id: GetFatherRef_Hide
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [5600, 100]
        - id: HideFather
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [5700, 0]
        # Disable Father collision
        - id: DisableCollision
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [6000, 0]
        # Add Father.State.Dormant tag
        - id: GetFatherASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [6200, 100]
        - id: AddDormantTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [6300, 0]
        - id: MakeTagContainer_Dormant
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
          position: [6200, 200]
        - id: MakeLiteralTag_Dormant
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Father.State.Dormant
          position: [6100, 250]
        # Start dormant timer
        - id: GetDormantDuration
          type: VariableGet
          properties:
            variable_name: DormantDuration
          position: [6500, 100]
        - id: SetDormantTimer
          type: CallFunction
          properties:
            function: K2_SetTimerDelegate
          position: [6600, 0]
        - id: SetTimerHandle
          type: VariableSet
          properties:
            variable_name: DormantTimerHandle
          position: [6900, 0]
        # === TIMER CALLBACK (Dormant expired - reactivate) ===
        - id: CustomEvent_DormantExpired
          type: CustomEvent
          properties:
            event_name: OnDormantTimerExpired
          position: [0, 600]
        # Guard 1: Validate FatherRef
        - id: GetFatherRef_Timer
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [100, 700]
        - id: IsValid_FatherRef_Timer
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [250, 600]
        - id: Branch_FatherValid_Timer
          type: Branch
          position: [400, 600]
        # Guard 2: Check Father.State.Dormant tag
        - id: GetFatherASC_Timer
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [500, 750]
        - id: HasDormantTag_Timer
          type: CallFunction
          properties:
            function: HasMatchingGameplayTag
            class: AbilitySystemComponent
          position: [650, 700]
        - id: MakeLiteralTag_Dormant_Timer
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Father.State.Dormant
          position: [500, 800]
        - id: Branch_DormantTag_Timer
          type: Branch
          position: [800, 600]
        # Show Father
        - id: ShowFather_Timer
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [950, 600]
        - id: EnableCollision_Timer
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1200, 600]
        # Remove dormant tag
        - id: RemoveDormantTag_Timer
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1450, 600]
        - id: MakeTagContainer_RemoveDormant
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
          position: [1350, 750]
        - id: MakeLiteralTag_RemoveDormant
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Father.State.Dormant
          position: [1250, 800]
        # v7.8.55 Phase 5: Activate GA_FatherArmor on reactivation
        - id: TryActivateArmor
          type: CallFunction
          properties:
            function: TryActivateAbilityByClass
            class: AbilitySystemComponent
            param.InAbilityToActivate: GA_FatherArmor
          position: [1700, 600]
        # End ability
        - id: EndAbility_Timer
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [1950, 600]
        # === EVENT_ENDABILITY ===
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 1000]
        - id: Branch_WasCancelled
          type: Branch
          position: [250, 1000]
        # Cleanup path (only when cancelled)
        - id: ClearTimer
          type: CallFunction
          properties:
            function: K2_ClearAndInvalidateTimerHandle
            class: KismetSystemLibrary
          position: [450, 1000]
        - id: GetTimerHandle
          type: VariableGet
          properties:
            variable_name: DormantTimerHandle
          position: [300, 1100]
        - id: GetFatherRef_End
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [600, 1100]
        - id: IsValid_Father_End
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [700, 1050]
        - id: Branch_FatherValid_End
          type: Branch
          position: [850, 1000]
        - id: ShowFather_End
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [1000, 1000]
        - id: EnableCollision_End
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1250, 1000]
        - id: GetFatherASC_End
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [1350, 1150]
        - id: RemoveDormantTag_End
          type: CallFunction
          properties:
            function: RemoveLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1500, 1000]
        - id: MakeTagContainer_End
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
          position: [1400, 1150]
        - id: MakeLiteralTag_End
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Father.State.Dormant
          position: [1300, 1200]
      connections:
        # === ACTIVATION FLOW (Setup + start health monitoring) ===
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [SetPlayerRef, Exec]
        - from: [SetPlayerRef, Exec]
          to: [SetPlayerASC, Exec]
        - from: [SetPlayerASC, Exec]
          to: [Branch_PlayerASC_Valid, Exec]
        - from: [Branch_PlayerASC_Valid, True]
          to: [SetIsMonitoring, Exec]
        # Data flow - Activation
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP_FatherCompanion]
          to: [SetFatherRef, FatherRef]
        - from: [SetFatherRef, FatherRef]
          to: [GetOwnerPlayer, Target]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [SetPlayerRef, PlayerRef]
        - from: [SetPlayerRef, PlayerRef]
          to: [GetPlayerASC, Actor]
        - from: [GetPlayerASC, ReturnValue]
          to: [SetPlayerASC, PlayerASC]
        - from: [SetPlayerASC, PlayerASC]
          to: [IsValid_PlayerASC, Object]
        - from: [IsValid_PlayerASC, ReturnValue]
          to: [Branch_PlayerASC_Valid, Condition]
        # TargetActor connection for WaitHealthChange async task
        # [MANIFEST] Pattern from GA_ProtectiveDome line 5472
        - from: [SetPlayerRef, PlayerRef]
          to: [WaitHealthChange, TargetActor]
        # === HEALTH MONITORING FLOW (Changed delegate) ===
        # [MANIFEST] Pattern from GA_ProtectiveDome lines 5474 - delegate is 'Changed' not 'OnChanged'
        - from: [WaitHealthChange, Changed]
          to: [Branch_ThresholdCheck, Exec]
        # Data flow - Health check using NarrativeCharacter GetHealth/GetMaxHealth
        - from: [GetPlayerRef_Check, PlayerRef]
          to: [GetHealth, Target]
        - from: [GetPlayerRef_Check, PlayerRef]
          to: [GetMaxHealth, Target]
        - from: [GetHealth, ReturnValue]
          to: [DivideHealth, A]
        - from: [GetMaxHealth, ReturnValue]
          to: [DivideHealth, B]
        - from: [DivideHealth, ReturnValue]
          to: [LessThanThreshold, A]
        - from: [GetHealthThreshold, HealthThreshold]
          to: [LessThanThreshold, B]
        - from: [LessThanThreshold, ReturnValue]
          to: [And_MonitoringAndThreshold, A]
        - from: [GetIsMonitoring, IsMonitoring]
          to: [And_MonitoringAndThreshold, B]
        - from: [And_MonitoringAndThreshold, ReturnValue]
          to: [Branch_ThresholdCheck, Condition]
        # === SACRIFICE EXECUTION FLOW ===
        - from: [Branch_ThresholdCheck, True]
          to: [SetIsMonitoring_False, Exec]
        - from: [SetIsMonitoring_False, Exec]
          to: [ApplySacrificeInvuln, Exec]
        - from: [ApplySacrificeInvuln, Exec]
          to: [ExecuteGameplayCueDormant, Exec]
        - from: [ExecuteGameplayCueDormant, Exec]
          to: [HideFather, Exec]
        - from: [HideFather, Exec]
          to: [DisableCollision, Exec]
        - from: [DisableCollision, Exec]
          to: [AddDormantTag, Exec]
        - from: [AddDormantTag, Exec]
          to: [SetDormantTimer, Exec]
        - from: [SetDormantTimer, Exec]
          to: [SetTimerHandle, Exec]
        # Data flow - Sacrifice execution
        - from: [GetPlayerASC_Apply, PlayerASC]
          to: [ApplySacrificeInvuln, Target]
        # K2_ExecuteGameplayCueWithParams with target_self: true uses ability self, no Target connection needed
        - from: [MakeLiteralTag_DormantCue, ReturnValue]
          to: [ExecuteGameplayCueDormant, GameplayCueTag]
        - from: [GetFatherRef_Hide, FatherRef]
          to: [HideFather, Target]
        - from: [GetFatherRef_Hide, FatherRef]
          to: [DisableCollision, Target]
        - from: [GetFatherRef_Hide, FatherRef]
          to: [GetFatherASC, Actor]
        - from: [GetFatherRef_Hide, FatherRef]
          to: [AddDormantTag, Actor]
        - from: [MakeLiteralTag_Dormant, ReturnValue]
          to: [MakeTagContainer_Dormant, Tag]
        - from: [MakeTagContainer_Dormant, ReturnValue]
          to: [AddDormantTag, GameplayTags]
        - from: [GetDormantDuration, DormantDuration]
          to: [SetDormantTimer, Time]
        - from: [SetDormantTimer, ReturnValue]
          to: [SetTimerHandle, DormantTimerHandle]
        # === TIMER CALLBACK FLOW (with guards) ===
        - from: [CustomEvent_DormantExpired, Then]
          to: [Branch_FatherValid_Timer, Exec]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [IsValid_FatherRef_Timer, Object]
        - from: [IsValid_FatherRef_Timer, ReturnValue]
          to: [Branch_FatherValid_Timer, Condition]
        - from: [Branch_FatherValid_Timer, True]
          to: [Branch_DormantTag_Timer, Exec]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [GetFatherASC_Timer, Actor]
        - from: [GetFatherASC_Timer, ReturnValue]
          to: [HasDormantTag_Timer, Target]
        - from: [MakeLiteralTag_Dormant_Timer, ReturnValue]
          to: [HasDormantTag_Timer, Tag]
        - from: [HasDormantTag_Timer, ReturnValue]
          to: [Branch_DormantTag_Timer, Condition]
        - from: [Branch_DormantTag_Timer, True]
          to: [ShowFather_Timer, Exec]
        - from: [ShowFather_Timer, Exec]
          to: [EnableCollision_Timer, Exec]
        - from: [EnableCollision_Timer, Exec]
          to: [RemoveDormantTag_Timer, Exec]
        - from: [RemoveDormantTag_Timer, Exec]
          to: [TryActivateArmor, Exec]
        - from: [TryActivateArmor, Exec]
          to: [EndAbility_Timer, Exec]
        # Data flow - Timer callback
        - from: [GetFatherRef_Timer, FatherRef]
          to: [ShowFather_Timer, Target]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [EnableCollision_Timer, Target]
        - from: [GetFatherRef_Timer, FatherRef]
          to: [RemoveDormantTag_Timer, Actor]
        - from: [MakeLiteralTag_RemoveDormant, ReturnValue]
          to: [MakeTagContainer_RemoveDormant, Tag]
        - from: [MakeTagContainer_RemoveDormant, ReturnValue]
          to: [RemoveDormantTag_Timer, GameplayTags]
        - from: [GetFatherASC_Timer, ReturnValue]
          to: [TryActivateArmor, Target]
        # === EVENT_ENDABILITY FLOW ===
        - from: [Event_EndAbility, Then]
          to: [Branch_WasCancelled, Exec]
        - from: [Event_EndAbility, bWasCancelled]
          to: [Branch_WasCancelled, Condition]
        - from: [Branch_WasCancelled, True]
          to: [ClearTimer, Exec]
        - from: [GetTimerHandle, DormantTimerHandle]
          to: [ClearTimer, Handle]
        - from: [ClearTimer, Exec]
          to: [Branch_FatherValid_End, Exec]
        - from: [GetFatherRef_End, FatherRef]
          to: [IsValid_Father_End, Object]
        - from: [IsValid_Father_End, ReturnValue]
          to: [Branch_FatherValid_End, Condition]
        - from: [Branch_FatherValid_End, True]
          to: [ShowFather_End, Exec]
        - from: [ShowFather_End, Exec]
          to: [EnableCollision_End, Exec]
        - from: [EnableCollision_End, Exec]
          to: [RemoveDormantTag_End, Exec]
        # Data flow - EndAbility cleanup
        - from: [GetFatherRef_End, FatherRef]
          to: [ShowFather_End, Target]
        - from: [GetFatherRef_End, FatherRef]
          to: [EnableCollision_End, Target]
        - from: [GetFatherRef_End, FatherRef]
          to: [GetFatherASC_End, Actor]
        - from: [GetFatherRef_End, FatherRef]
          to: [RemoveDormantTag_End, Actor]
        - from: [MakeLiteralTag_End, ReturnValue]
          to: [MakeTagContainer_End, Tag]
        - from: [MakeTagContainer_End, ReturnValue]
          to: [RemoveDormantTag_End, GameplayTags]

  # GA_FatherRifle - Rifle Weapon Form (NPC-owned form ability)
  # v2.7.0: Full Narrative Pro item flow with BreakStruct/GetArrayItem
  # v5.0: Uses EI_FatherRifleWeapon (fully automated)
  - name: GA_FatherRifle
    folder: Abilities/Forms
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    tags:
      ability_tags:
        - Ability.Father.Rifle
      cancel_abilities_with_tag:
        - Ability.Father.Crawler
        - Ability.Father.Armor
        - Ability.Father.Exoskeleton
        - Ability.Father.Engineer
        - Ability.Father.Sword
      activation_owned_tags:
        - Father.Form.Rifle
        - Father.State.Wielded
      activation_required_tags:
        - Father.State.Recruited
      activation_blocked_tags:
        - Father.Form.Rifle
        - Father.State.Transitioning
        - Father.State.SymbioteLocked
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: WeaponRef
        type: Object
        class: WeaponItem
    event_graph:
      nodes:
        # === ACTIVATION NODES ===
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        - id: HideFather
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [1200, 0]
        - id: DisableCollision
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1500, 0]
        # Get player and inventory
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [1200, 150]
        - id: GetInventory
          type: CallFunction
          properties:
            function: GetComponentByClass
            class: Actor
            component_class: NarrativeInventoryComponent
          position: [1500, 150]
        - id: CastToInventory
          type: DynamicCast
          properties:
            target_class: NarrativeInventoryComponent
          position: [1800, 150]
        # Add weapon item to player inventory
        - id: TryAddWeapon
          type: CallFunction
          properties:
            function: TryAddItemFromClass
            class: NarrativeInventoryComponent
            # v5.0: Fixed - now uses actual weapon item class
            item_class: EI_FatherRifleWeapon
            quantity: 1
          position: [2100, 150]
        # Break FItemAddResult struct to get Stacks array
        - id: BreakItemResult
          type: BreakStruct
          properties:
            struct_type: FItemAddResult
          position: [2400, 150]
        # Get first item from Stacks array (index 0)
        - id: GetFirstStack
          type: GetArrayItem
          properties:
            index: 0
          position: [2700, 150]
        # Cast to WeaponItem and wield
        - id: CastToWeapon
          type: DynamicCast
          properties:
            target_class: WeaponItem
          position: [3000, 150]
        - id: SetWeaponRef
          type: VariableSet
          properties:
            variable_name: WeaponRef
          position: [3300, 150]
        - id: WieldWeapon
          type: CallFunction
          properties:
            function: WieldInSlot
            slot_tag: Narrative.Equipment.WieldSlot.MainHand
          position: [3600, 150]
        - id: EndAbility_Success
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3900, 150]
        # === END ABILITY NODES ===
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 500]
        - id: GetFatherRef_End
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [300, 500]
        # === GUARDS (GAS Audit MED-5) ===
        - id: IsValid_FatherRef_End
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [400, 450]
        - id: Branch_Valid_End
          type: Branch
          position: [500, 500]
        - id: ShowFather
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [700, 500]
        - id: EnableCollision
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1000, 500]
        # Remove weapon from player
        - id: GetWeaponRef_End
          type: VariableGet
          properties:
            variable_name: WeaponRef
          position: [300, 650]
        - id: GetPlayerEnd
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [600, 650]
        - id: GetInventoryEnd
          type: CallFunction
          properties:
            function: GetComponentByClass
            class: Actor
            component_class: NarrativeInventoryComponent
          position: [900, 650]
        - id: CastToInventoryEnd
          type: DynamicCast
          properties:
            target_class: NarrativeInventoryComponent
          position: [1200, 650]
        - id: RemoveWeapon
          type: CallFunction
          properties:
            function: RemoveItem
          position: [1500, 650]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (GetAvatarActor is pure - no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [HideFather, Exec]
        - from: [HideFather, Exec]
          to: [DisableCollision, Exec]
        - from: [DisableCollision, Exec]
          to: [GetInventory, Exec]
        - from: [GetInventory, Exec]
          to: [CastToInventory, Exec]
        - from: [CastToInventory, Exec]
          to: [TryAddWeapon, Exec]
        - from: [TryAddWeapon, Exec]
          to: [CastToWeapon, Exec]
        - from: [CastToWeapon, Exec]
          to: [SetWeaponRef, Exec]
        - from: [SetWeaponRef, Exec]
          to: [WieldWeapon, Exec]
        - from: [WieldWeapon, Exec]
          to: [EndAbility_Success, Exec]
        # Data flow - Activation
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [SetFatherRef, FatherRef]
          to: [HideFather, Target]
        - from: [SetFatherRef, FatherRef]
          to: [DisableCollision, Target]
        - from: [SetFatherRef, FatherRef]
          to: [GetOwnerPlayer, Target]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [GetInventory, Target]
        - from: [GetInventory, ReturnValue]
          to: [CastToInventory, Object]
        - from: [CastToInventory, AsNarrative Inventory]
          to: [TryAddWeapon, Target]
        - from: [TryAddWeapon, ReturnValue]
          to: [BreakItemResult, ItemAddResult]
        - from: [BreakItemResult, Stacks]
          to: [GetFirstStack, Array]
        - from: [GetFirstStack, Output]
          to: [CastToWeapon, Object]
        - from: [CastToWeapon, AsWeapon Item]
          to: [SetWeaponRef, WeaponRef]
        - from: [SetWeaponRef, WeaponRef]
          to: [WieldWeapon, Target]
        # === END ABILITY FLOW ===
        # v4.14: Route through guard (GAS Audit MED-5)
        - from: [Event_EndAbility, Then]
          to: [Branch_Valid_End, Exec]
        - from: [Branch_Valid_End, True]
          to: [ShowFather, Exec]
        - from: [ShowFather, Exec]
          to: [EnableCollision, Exec]
        - from: [EnableCollision, Exec]
          to: [GetInventoryEnd, Exec]
        - from: [GetInventoryEnd, Exec]
          to: [CastToInventoryEnd, Exec]
        - from: [CastToInventoryEnd, Exec]
          to: [RemoveWeapon, Exec]
        # Guard data flow (GAS Audit MED-5)
        - from: [GetFatherRef_End, FatherRef]
          to: [IsValid_FatherRef_End, Object]
        - from: [IsValid_FatherRef_End, ReturnValue]
          to: [Branch_Valid_End, Condition]
        # Data flow - End
        - from: [GetFatherRef_End, FatherRef]
          to: [ShowFather, Target]
        - from: [GetFatherRef_End, FatherRef]
          to: [EnableCollision, Target]
        - from: [GetFatherRef_End, FatherRef]
          to: [GetPlayerEnd, Target]
        - from: [GetPlayerEnd, OwnerPlayer]
          to: [GetInventoryEnd, Target]
        - from: [GetInventoryEnd, ReturnValue]
          to: [CastToInventoryEnd, Object]
        - from: [CastToInventoryEnd, AsNarrative Inventory]
          to: [RemoveWeapon, Target]
        - from: [GetWeaponRef_End, WeaponRef]
          to: [RemoveWeapon, Item]

  # GA_FatherSword - Sword Weapon Form (NPC-owned form ability)
  # v2.7.0: Full Narrative Pro item flow with BreakStruct/GetArrayItem
  # v5.0: Uses EI_FatherSwordWeapon (fully automated)
  - name: GA_FatherSword
    folder: Abilities/Forms
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    tags:
      ability_tags:
        - Ability.Father.Sword
      cancel_abilities_with_tag:
        - Ability.Father.Crawler
        - Ability.Father.Armor
        - Ability.Father.Exoskeleton
        - Ability.Father.Engineer
        - Ability.Father.Rifle
      activation_owned_tags:
        - Father.Form.Sword
        - Father.State.Wielded
      activation_required_tags:
        - Father.State.Recruited
      activation_blocked_tags:
        - Father.Form.Sword
        - Father.State.Transitioning
        - Father.State.SymbioteLocked
    variables:
      - name: FatherRef
        type: Object
        class: BP_FatherCompanion
      - name: WeaponRef
        type: Object
        class: WeaponItem
    event_graph:
      nodes:
        # === ACTIVATION NODES ===
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        - id: CastToFather
          type: DynamicCast
          properties:
            target_class: BP_FatherCompanion
          position: [600, 0]
        - id: SetFatherRef
          type: VariableSet
          properties:
            variable_name: FatherRef
          position: [900, 0]
        - id: HideFather
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [1200, 0]
        - id: DisableCollision
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1500, 0]
        # Get player and inventory
        - id: GetOwnerPlayer
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [1200, 150]
        - id: GetInventory
          type: CallFunction
          properties:
            function: GetComponentByClass
            class: Actor
            component_class: NarrativeInventoryComponent
          position: [1500, 150]
        - id: CastToInventory
          type: DynamicCast
          properties:
            target_class: NarrativeInventoryComponent
          position: [1800, 150]
        # Add weapon item to player inventory
        - id: TryAddWeapon
          type: CallFunction
          properties:
            function: TryAddItemFromClass
            class: NarrativeInventoryComponent
            # v5.0: Fixed - now uses actual weapon item class
            item_class: EI_FatherSwordWeapon
            quantity: 1
          position: [2100, 150]
        # Break FItemAddResult struct to get Stacks array
        - id: BreakItemResult
          type: BreakStruct
          properties:
            struct_type: FItemAddResult
          position: [2400, 150]
        # Get first item from Stacks array (index 0)
        - id: GetFirstStack
          type: GetArrayItem
          properties:
            index: 0
          position: [2700, 150]
        # Cast to WeaponItem and wield
        - id: CastToWeapon
          type: DynamicCast
          properties:
            target_class: WeaponItem
          position: [3000, 150]
        - id: SetWeaponRef
          type: VariableSet
          properties:
            variable_name: WeaponRef
          position: [3300, 150]
        - id: WieldWeapon
          type: CallFunction
          properties:
            function: WieldInSlot
            slot_tag: Narrative.Equipment.WieldSlot.MainHand
          position: [3600, 150]
        - id: EndAbility_Success
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3900, 150]
        # === END ABILITY NODES ===
        - id: Event_EndAbility
          type: Event
          properties:
            event_name: K2_OnEndAbility
          position: [0, 500]
        - id: GetFatherRef_End
          type: VariableGet
          properties:
            variable_name: FatherRef
          position: [300, 500]
        # === GUARDS (GAS Audit MED-6) ===
        - id: IsValid_FatherRef_End
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [400, 450]
        - id: Branch_Valid_End
          type: Branch
          position: [500, 500]
        - id: ShowFather
          type: CallFunction
          properties:
            function: SetActorHiddenInGame
          position: [700, 500]
        - id: EnableCollision
          type: CallFunction
          properties:
            function: SetActorEnableCollision
          position: [1000, 500]
        # Remove weapon from player
        - id: GetWeaponRef_End
          type: VariableGet
          properties:
            variable_name: WeaponRef
          position: [300, 650]
        - id: GetPlayerEnd
          type: PropertyGet
          properties:
            property_name: OwnerPlayer
            target_class: BP_FatherCompanion
          position: [600, 650]
        - id: GetInventoryEnd
          type: CallFunction
          properties:
            function: GetComponentByClass
            class: Actor
            component_class: NarrativeInventoryComponent
          position: [900, 650]
        - id: CastToInventoryEnd
          type: DynamicCast
          properties:
            target_class: NarrativeInventoryComponent
          position: [1200, 650]
        - id: RemoveWeapon
          type: CallFunction
          properties:
            function: RemoveItem
          position: [1500, 650]
      connections:
        # === ACTIVATION FLOW ===
        # Exec flow (GetAvatarActor is pure - no exec pins)
        - from: [Event_Activate, Then]
          to: [CastToFather, Exec]
        - from: [CastToFather, Exec]
          to: [SetFatherRef, Exec]
        - from: [SetFatherRef, Exec]
          to: [HideFather, Exec]
        - from: [HideFather, Exec]
          to: [DisableCollision, Exec]
        - from: [DisableCollision, Exec]
          to: [GetInventory, Exec]
        - from: [GetInventory, Exec]
          to: [CastToInventory, Exec]
        - from: [CastToInventory, Exec]
          to: [TryAddWeapon, Exec]
        - from: [TryAddWeapon, Exec]
          to: [CastToWeapon, Exec]
        - from: [CastToWeapon, Exec]
          to: [SetWeaponRef, Exec]
        - from: [SetWeaponRef, Exec]
          to: [WieldWeapon, Exec]
        - from: [WieldWeapon, Exec]
          to: [EndAbility_Success, Exec]
        # Data flow - Activation
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToFather, Object]
        - from: [CastToFather, AsBP Father Companion]
          to: [SetFatherRef, FatherRef]
        - from: [SetFatherRef, FatherRef]
          to: [HideFather, Target]
        - from: [SetFatherRef, FatherRef]
          to: [DisableCollision, Target]
        - from: [SetFatherRef, FatherRef]
          to: [GetOwnerPlayer, Target]
        - from: [GetOwnerPlayer, OwnerPlayer]
          to: [GetInventory, Target]
        - from: [GetInventory, ReturnValue]
          to: [CastToInventory, Object]
        - from: [CastToInventory, AsNarrative Inventory]
          to: [TryAddWeapon, Target]
        - from: [TryAddWeapon, ReturnValue]
          to: [BreakItemResult, ItemAddResult]
        - from: [BreakItemResult, Stacks]
          to: [GetFirstStack, Array]
        - from: [GetFirstStack, Output]
          to: [CastToWeapon, Object]
        - from: [CastToWeapon, AsWeapon Item]
          to: [SetWeaponRef, WeaponRef]
        - from: [SetWeaponRef, WeaponRef]
          to: [WieldWeapon, Target]
        # === END ABILITY FLOW ===
        # v4.14: Route through guard (GAS Audit MED-6)
        - from: [Event_EndAbility, Then]
          to: [Branch_Valid_End, Exec]
        - from: [Branch_Valid_End, True]
          to: [ShowFather, Exec]
        - from: [ShowFather, Exec]
          to: [EnableCollision, Exec]
        - from: [EnableCollision, Exec]
          to: [GetInventoryEnd, Exec]
        - from: [GetInventoryEnd, Exec]
          to: [CastToInventoryEnd, Exec]
        - from: [CastToInventoryEnd, Exec]
          to: [RemoveWeapon, Exec]
        # Guard data flow (GAS Audit MED-6)
        - from: [GetFatherRef_End, FatherRef]
          to: [IsValid_FatherRef_End, Object]
        - from: [IsValid_FatherRef_End, ReturnValue]
          to: [Branch_Valid_End, Condition]
        # Data flow - End
        - from: [GetFatherRef_End, FatherRef]
          to: [ShowFather, Target]
        - from: [GetFatherRef_End, FatherRef]
          to: [EnableCollision, Target]
        - from: [GetFatherRef_End, FatherRef]
          to: [GetPlayerEnd, Target]
        - from: [GetPlayerEnd, OwnerPlayer]
          to: [GetInventoryEnd, Target]
        - from: [GetInventoryEnd, ReturnValue]
          to: [CastToInventoryEnd, Object]
        - from: [CastToInventoryEnd, AsNarrative Inventory]
          to: [RemoveWeapon, Target]
        - from: [GetWeaponRef_End, WeaponRef]
          to: [RemoveWeapon, Item]

# ============================================================================
# EQUIPPABLE ITEMS (7) - Attached forms (3) + Weapons (2) + Rifle/Sword forms (2)
# ============================================================================
equippable_items:
  # Per Tech Doc Section 58.5, 58.10, 58.11: Dual Entry System + Activities to Grant
  # NOTE: Crawler/Engineer do NOT have EquippableItems - activated via GAS directly (Option B)
  # Only attached forms (Armor, Exoskeleton, Symbiote) and weapons (Rifle, Sword) use equipment

  - name: EI_FatherArmorForm
    folder: Items/Forms
    parent_class: EquippableItem
    equipment_slot: Narrative.Equipment.Slot.FatherForm
    abilities_to_grant:
      - GA_FatherArmor
      - GA_ProtectiveDome
      - GA_DomeBurst
    equipment_modifier_ge: GE_EquipmentModifier_FatherArmor
    # Per Section 58.5: Armor +50
    equipment_effect_values:
      SetByCaller.Armor: 50.0
      SetByCaller.AttackRating: 0.0
      SetByCaller.StealthRating: 0.0
    armor_rating: 50.0
    attack_rating: 0.0
    stealth_rating: 0.0
    # v4.27 NOTE: Form exit burst (Decisions 22-24) is implemented in GA_ProtectiveDome's EndAbility event.
    # When armor form is unequipped, GA_ProtectiveDome ends and tries to activate GA_DomeBurst.
    # GA_DomeBurst requires Father.Dome.FullyCharged tag, so it only fires if dome was fully charged.

  - name: EI_FatherExoskeletonForm
    folder: Items/Forms
    parent_class: EquippableItem
    equipment_slot: Narrative.Equipment.Slot.FatherForm
    # v4.26 (Decision 4): Removed GA_Backstab - universal ability, add to player's Default Abilities array
    abilities_to_grant:
      - GA_FatherExoskeleton
      - GA_FatherExoskeletonDash
      - GA_FatherExoskeletonSprint
      - GA_StealthField
    equipment_modifier_ge: GE_EquipmentModifier_FatherExoskeleton
    # Per Section 58.5: AttackRating +10 (speed/jump via CharacterMovement)
    equipment_effect_values:
      SetByCaller.Armor: 0.0
      SetByCaller.AttackRating: 10.0
      SetByCaller.StealthRating: 0.0
    armor_rating: 0.0
    attack_rating: 10.0
    stealth_rating: 0.0

  - name: EI_FatherSymbioteForm
    folder: Items/Forms
    parent_class: EquippableItem
    equipment_slot: Narrative.Equipment.Slot.FatherForm
    abilities_to_grant:
      - GA_FatherSymbiote
      - GA_ProximityStrike
    equipment_modifier_ge: GE_EquipmentModifier_FatherSymbiote
    # Per Section 58.5: AttackRating +100
    equipment_effect_values:
      SetByCaller.Armor: 0.0
      SetByCaller.AttackRating: 100.0
      SetByCaller.StealthRating: 0.0
    armor_rating: 0.0
    attack_rating: 100.0
    stealth_rating: 0.0

  - name: EI_FatherRifleForm
    folder: Items/Forms
    parent_class: EquippableItem
    equipment_slot: Narrative.Equipment.Slot.FatherForm
    abilities_to_grant:
      - GA_FatherRifle
    equipment_modifier_ge: GE_EquipmentModifier_FatherRifle
    equipment_effect_values:
      SetByCaller.Armor: 0.0
      SetByCaller.AttackRating: 15.0
      SetByCaller.StealthRating: 0.0
    armor_rating: 0.0
    attack_rating: 15.0
    stealth_rating: 0.0

  - name: EI_FatherSwordForm
    folder: Items/Forms
    parent_class: EquippableItem
    equipment_slot: Narrative.Equipment.Slot.FatherForm
    abilities_to_grant:
      - GA_FatherSword
    equipment_modifier_ge: GE_EquipmentModifier_FatherSword
    equipment_effect_values:
      SetByCaller.Armor: 0.0
      SetByCaller.AttackRating: 25.0
      SetByCaller.StealthRating: 0.0
    armor_rating: 0.0
    attack_rating: 25.0
    stealth_rating: 0.0

  # Weapon Items - use Narrative Pro weapon classes (v2.6.8)
  # v3.9.7: Fixed prefix from BP_ to EI_ (RangedWeaponItem/MeleeWeaponItem are UObject data assets, not Actors)
  - name: EI_FatherRifleWeapon
    folder: FatherCompanion/Weapons
    parent_class: RangedWeaponItem
    display_name: Father Rifle
    description: Transform your father companion into a bio-organic rifle. Fires high-energy projectiles with precision accuracy.
    equipment_slot: Narrative.Equipment.Slot.Weapon_Back
    # v4.15: Weapon properties
    weapon_hand: TwoHanded
    attack_damage: 10.0
    clip_size: 30
    allow_manual_reload: true
    bot_attack_range: 2000.0

  - name: EI_FatherSwordWeapon
    folder: FatherCompanion/Weapons
    parent_class: MeleeWeaponItem
    display_name: Father Sword
    description: Transform your father companion into a bio-organic blade. Devastating melee attacks with increased reach.
    equipment_slot: Narrative.Equipment.Slot.Weapon_Back

  # v7.8.14: Gatherer Scout placeholder loot items
  - name: EI_GatheredResource_Common
    folder: Items/Gatherer
    parent_class: NarrativeItem
    display_name: Common Resource
    description: A common resource gathered from the environment.
    stackable: true
    max_stack_size: 99
    base_value: 5
    weight: 0.1

  - name: EI_GatheredResource_Rare
    folder: Items/Gatherer
    parent_class: NarrativeItem
    display_name: Rare Resource
    description: A rare resource gathered from the environment.
    stackable: true
    max_stack_size: 50
    base_value: 25
    weight: 0.2

# ============================================================================
# BLACKBOARDS (2)
# ============================================================================
blackboards:
  - name: BB_FatherCompanion
    folder: AI/Blackboards
    keys:
      - key_name: SelfActor
        key_type: Object
        base_class: Actor
      - key_name: OwnerPlayer
        key_type: Object
        base_class: NarrativePlayerCharacter
      - key_name: TargetPlayer
        key_type: Object
        base_class: NarrativePlayerCharacter
      - key_name: AttackTarget
        key_type: Object
        base_class: Actor
      - key_name: CurrentTarget
        key_type: Object
        base_class: Actor
      - key_name: FollowDistance
        key_type: Float
        default_value: 300.0
      - key_name: AttackRange
        key_type: Float
        default_value: 200.0
      - key_name: IsInCombat
        key_type: Bool
      - key_name: CurrentForm
        key_type: Enum
        enum_type: E_FatherForm
      - key_name: HomeLocation
        key_type: Vector
      - key_name: TargetLocation
        key_type: Vector
      - key_name: MarkTarget
        key_type: Object
        base_class: Actor

  - name: BB_FatherEngineer
    folder: AI/Blackboards
    keys:
      - key_name: SelfActor
        key_type: Object
        base_class: Actor
      - key_name: TurretLocation
        key_type: Vector
      - key_name: AttackTarget
        key_type: Object
        base_class: Actor
      - key_name: CurrentTarget
        key_type: Object
        base_class: Actor
      - key_name: TrapTarget
        key_type: Object
        base_class: Actor
      - key_name: IsActive
        key_type: Bool

# ============================================================================
# BEHAVIOR TREES (2)
# ============================================================================
behavior_trees:
  - name: BT_FatherFollow
    folder: AI/BehaviorTrees
    blackboard: BB_FatherCompanion
    root_type: Selector
    description: Main father companion AI for following and combat
    nodes:
      # Root Selector - Chooses between combat and follow behaviors
      - id: root_selector
        type: Selector
        decorators:
          - class: BTDecorator_Blackboard
            blackboard_key: TargetPlayer
            key_query: IsSet
            flow_abort_mode: Both
        children:
          - combat_sequence
          - follow_sequence
      # Combat Sequence - Attack if enemy detected
      - id: combat_sequence
        type: Sequence
        decorators:
          - class: BTDecorator_Blackboard
            blackboard_key: AttackTarget
            key_query: IsSet
        children:
          - move_to_enemy
      - id: move_to_enemy
        type: Task
        task_class: BTTask_MoveTo
        blackboard_key: AttackTarget
        properties:
          AcceptableRadius: "100.0"
      # Follow Sequence - Follow player when no combat
      - id: follow_sequence
        type: Sequence
        children:
          - move_to_player
      - id: move_to_player
        type: Task
        task_class: BTTask_MoveTo
        blackboard_key: TargetPlayer
        properties:
          AcceptableRadius: "200.0"

  - name: BT_FatherEngineer
    folder: AI/BehaviorTrees
    blackboard: BB_FatherEngineer
    root_type: Selector
    description: Engineer turret mode AI for automated combat
    nodes:
      # Root Selector - Turret mode selects targets
      - id: root_selector
        type: Selector
        children:
          - attack_sequence
          - idle_wait
      # Attack Sequence - Shoot at detected targets
      # v7.8.12: Removed BTS_SetAIFocus (doesn't exist - AI perception handles focus)
      - id: attack_sequence
        type: Sequence
        decorators:
          - class: BTDecorator_Blackboard
            blackboard_key: AttackTarget
            key_query: IsSet
        children:
          - turret_wait
      - id: turret_wait
        type: Task
        task_class: BTTask_Wait
        properties:
          WaitTime: "1.0"
      # Idle - Wait when no targets
      - id: idle_wait
        type: Task
        task_class: BTTask_Wait
        properties:
          WaitTime: "0.5"

# ============================================================================
# ACTIVITIES (1)
# ============================================================================
activities:
  - name: BPA_FatherFollow
    folder: AI/Activities
    parent_class: NarrativeActivityBase
    behavior_tree: BT_FatherFollow

# ============================================================================
# ABILITY CONFIGURATIONS (1)
# ============================================================================
ability_configurations:
  # Per Tech Doc Section 57.7: AC_FatherCompanion_Default pattern (matches AC_NPC_Default)
  # Option B: startup_effects applies default form state at spawn
  - name: AC_FatherCompanion
    folder: Configs
    abilities:
      # Form abilities (5 forms)
      - GA_FatherCrawler
      - GA_FatherArmor
      - GA_FatherExoskeleton
      - GA_FatherSymbiote
      - GA_FatherEngineer
      # AI abilities - Crawler mode
      - GA_FatherAttack
      - GA_FatherLaserShot
      # AI abilities - Engineer mode (baseline, not equipment-granted)
      - GA_TurretShoot
      - GA_FatherElectricTrap
      # Passive/utility abilities
      - GA_FatherMark
      - GA_FatherSacrifice
      - GA_Death  # Per Tech Doc Section 57.1: "Same as AC_NPC_Default - ADD THIS"
    startup_effects:
      - GE_CrawlerState  # Default form state at spawn (Option B)

  # ============================================================================
  # GATHERER SCOUT SYSTEM
  # ============================================================================
  # v7.8.32: MAUD-01 fix - Added startup_effects for Scout attributes (non-combatant but needs Health)
  - name: AC_GathererScout
    folder: Configs
    abilities: []  # Non-combatant - flees, doesn't fight
    startup_effects:
      - GE_GathererScoutAttributes

  # v7.8.23: GS-1 fix - Added startup_effects for Reinforcement attributes
  - name: AC_Reinforcement
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_ReinforcementAttributes

  # ============================================================================
  # RETURNED STALKER SYSTEM
  # ============================================================================
  # v7.8.23: RS-2 fix - Added startup_effects for Returned Stalker attributes
  - name: AC_ReturnedStalker
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_ReturnedStalkerAttributes

  # ============================================================================
  # SUPPORT BUFFER SYSTEM
  # ============================================================================
  - name: AC_SupportBuffer
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_SupporterAttributes

  # ============================================================================
  # GUARD FORMATION SYSTEM
  # v7.8.23: GF-2 fix - Added startup_effects for attribute initialization
  # ============================================================================
  - name: AC_FormationGuard
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_FormationGuardAttributes

  # ============================================================================
  # POSSESSED EXPLODER SYSTEM
  # ============================================================================
  - name: AC_PossessedExploder
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_ExploderAttributes

  # ============================================================================
  # WARDEN HUSK SYSTEM (Two-Phase Boss)
  # ============================================================================
  - name: AC_WardenHusk
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_WardenHuskAttributes

  - name: AC_WardenCore
    folder: Configs
    abilities:
      - GA_CoreLaser
      - GA_Death
    startup_effects:
      - GE_WardenCoreAttributes

  # ============================================================================
  # BIOMECHANICAL DETACHMENT SYSTEM
  # ============================================================================
  - name: AC_BiomechHost
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_BiomechHostAttributes

  - name: AC_BiomechCreature
    folder: Configs
    abilities:
      - GA_Death
    startup_effects:
      - GE_BiomechCreatureAttributes

# ============================================================================
# ACTIVITY CONFIGURATIONS (11)
# ============================================================================
activity_configurations:
  # Per Tech Doc Section 57.8: AC_FatherBehavior pattern (matches AC_RunAndGun)
  - name: AC_FatherBehavior
    folder: Configs
    default_activity: BPA_FatherFollow
    request_interval: 0.5
    activities:
      - BPA_Attack_Melee              # Crawler melee combat (Narrative Pro built-in)
      - BPA_Attack_Ranged_Strafe      # Laser shot - mobile strafing (Narrative Pro built-in)
      - BPA_Attack_Ranged             # Turret shoot - stationary ranged (Narrative Pro built-in)
      - BPA_FollowCharacter           # Follow player (Narrative Pro built-in)
      - BPA_Idle                      # Default idle (Narrative Pro built-in)
      - BPA_FatherFollow              # Custom father follow (Section 55.15)
    goal_generators:
      - GoalGenerator_Attack          # Auto-target hostiles (Section 57.9)

  # ============================================================================
  # GATHERER SCOUT SYSTEM
  # ============================================================================
  # v7.8.21: Fixed activity paths for existing NP assets
  # - BPA_Wander -> BPA_Patrol (Wander doesn't exist in NP)
  # - BPA_Gather -> BPA_Interact (use NP interaction system)
  # Per guide: BPA_Flee, BPA_Patrol, BPA_Interact are existing NP assets
  - name: AC_GathererScoutBehavior
    folder: Configs
    activities:
      - BPA_Alert
      - BPA_Flee
      - BPA_Interact
      - BPA_Patrol
    goal_generators:
      - GoalGenerator_Alert

  # v7.8.14: AC_ReinforcementBehavior REMOVED - NPC_Reinforcement now uses AC_RunAndGun per guide

  # ============================================================================
  # RETURNED STALKER SYSTEM
  # ============================================================================
  - name: AC_ReturnedStalkerBehavior
    folder: Configs
    activities:
      - BPA_Patrol
      - BPA_FollowCharacter
      - BPA_Attack_Melee
    goal_generators:
      - GoalGenerator_RandomAggression
      - GoalGenerator_Attack

  # ============================================================================
  # SUPPORT BUFFER SYSTEM
  # ============================================================================
  - name: AC_SupportBufferBehavior
    folder: Configs
    activities:
      - BPA_SupportFollow
      - BPA_Idle

  # ============================================================================
  # GUARD FORMATION SYSTEM
  # v7.8.16: Fixed per Guard_Formation_Follow_System_Implementation_Guide_v2_6.md Phase 9
  # ============================================================================
  - name: AC_FormationGuardBehavior
    folder: Configs
    activities:
      - BPA_FormationFollow
      - BPA_Attack_Formation
      - BPA_Idle
    goal_generators:
      - GoalGenerator_Attack

  # ============================================================================
  # POSSESSED EXPLODER SYSTEM
  # ============================================================================
  # v7.8.23: PE-3 fix - Add GoalGenerator_Attack for perception → attack
  # v7.8.23: PE-2 fix - Added BPA_Idle per Possessed_Exploder_Enemy_Implementation_Guide_v2_2.md
  - name: AC_PossessedExploderBehavior
    folder: Configs
    activities:
      - BPA_Explode
      - BPA_Idle
    goal_generators:
      - GoalGenerator_Attack

  # ============================================================================
  # WARDEN HUSK SYSTEM (Two-Phase Boss)
  # ============================================================================
  # v7.8.23: WH-3 fix - Add GoalGenerator_Attack for perception → attack
  # v7.8.23: WH-2 fix - Added BPA_Patrol, BPA_Idle per Warden_Husk_System_Implementation_Guide_v1_4.md
  - name: AC_WardenHuskBehavior
    folder: Configs
    activities:
      - BPA_Attack_Melee
      - BPA_Patrol
      - BPA_Idle
    goal_generators:
      - GoalGenerator_Attack

  # v7.8.23: WH-3 fix - Add GoalGenerator_Attack for perception → attack
  - name: AC_WardenCoreBehavior
    folder: Configs
    activities:
      - BPA_Attack_Ranged
    goal_generators:
      - GoalGenerator_Attack

  # ============================================================================
  # BIOMECHANICAL DETACHMENT SYSTEM
  # v7.8.16: Fixed per Biomechanical_Detachment_System_Implementation_Guide_v1_2.md Phase 7
  # ============================================================================
  - name: AC_BiomechHostBehavior
    folder: Enemies/Biomech/Configurations
    activities:
      - BPA_Patrol
      - BPA_Attack_Melee
      - BPA_Idle
    goal_generators:
      - GoalGenerator_Attack

  - name: AC_BiomechCreatureBehavior
    folder: Enemies/Biomech/Configurations
    activities:
      - BPA_Attack_Melee
      - BPA_Idle
    goal_generators:
      - GoalGenerator_Attack

# ============================================================================
# NPC DEFINITIONS (11)
# ============================================================================
npc_definitions:
  - name: NPC_FatherCompanion
    folder: Configs
    npc_name: Father
    npc_blueprint: BP_FatherCompanion
    ability_configuration: AC_FatherCompanion
    activity_configuration: AC_FatherBehavior
    default_factions:
      - Narrative.Factions.FatherCompanion
      - Narrative.Factions.Player

  # ============================================================================
  # GATHERER SCOUT SYSTEM
  # ============================================================================
  - name: NPC_GathererScout
    folder: Enemies/Gatherer
    npc_id: GathererScout
    npc_name: Gatherer Scout
    npc_blueprint: BP_GathererScout
    ability_configuration: AC_GathererScout
    activity_configuration: AC_GathererScoutBehavior
    default_factions:
      - Narrative.Factions.Returned
    # v7.8.14: Item loadout for loot when killed
    default_item_loadout:
      - item_collections:
          - IC_GathererScout

  - name: NPC_Reinforcement
    folder: Enemies/Gatherer
    npc_id: Reinforcement
    npc_name: Gatherer Reinforcement
    npc_blueprint: BP_Reinforcement
    ability_configuration: AC_Reinforcement
    # v7.8.14: Changed to AC_RunAndGun per guide (existing NP asset)
    # v7.8.16: Full path for Narrative Pro content
    activity_configuration: /NarrativePro/Pro/Core/AI/Configs/AC_RunAndGun
    default_factions:
      - Narrative.Factions.Returned

  # ============================================================================
  # RETURNED STALKER SYSTEM
  # ============================================================================
  - name: NPC_ReturnedStalker
    folder: NPCs/Returned
    npc_id: ReturnedStalker
    npc_name: Returned
    npc_blueprint: BP_ReturnedStalker
    ability_configuration: AC_ReturnedStalker
    activity_configuration: AC_ReturnedStalkerBehavior
    tagged_dialogue_set: TaggedDialogueSet_Returned
    default_factions:
      - Narrative.Factions.Returned
    default_owned_tags:
      - State.NPC.ReturnedStalker

  # ============================================================================
  # SUPPORT BUFFER SYSTEM
  # v7.8.16: Fixed faction per Support_Buffer_Healer_NPC_Implementation_Guide_v1_2.md Phase 9.5
  # ============================================================================
  - name: NPC_SupportBuffer
    folder: NPCs/Support
    npc_id: SupportBuffer  # v7.8.15: Added per Audit SB-1
    npc_name: Support Buffer
    npc_blueprint: BP_SupportBuffer
    ability_configuration: AC_SupportBuffer
    activity_configuration: AC_SupportBufferBehavior
    default_factions:
      - Narrative.Factions.Returned
    default_owned_tags:
      - State.NPC.SupportBuffer  # v7.8.16: Faction tag matches game design

  # ============================================================================
  # GUARD FORMATION SYSTEM
  # ============================================================================
  - name: NPC_FormationGuard
    folder: NPCs/Formation
    npc_id: FormationGuard  # v7.8.15: Added per Audit GF-1
    npc_name: Formation Guard
    npc_blueprint: BP_FormationGuard
    ability_configuration: AC_FormationGuard
    activity_configuration: AC_FormationGuardBehavior
    default_factions:
      - Narrative.Factions.Returned  # v7.8.16: All NPCs use Returned faction

  # ============================================================================
  # POSSESSED EXPLODER SYSTEM
  # ============================================================================
  - name: NPC_PossessedExploder
    folder: Enemies/Possessed
    npc_id: PossessedExploder  # v7.8.15: Added per Audit
    npc_name: Possessed Exploder
    npc_blueprint: BP_PossessedExploder
    ability_configuration: AC_PossessedExploder
    activity_configuration: AC_PossessedExploderBehavior
    default_factions:
      - Narrative.Factions.Returned

  # ============================================================================
  # WARDEN HUSK SYSTEM (Two-Phase Boss)
  # ============================================================================
  - name: NPC_WardenHusk
    folder: Enemies/Warden
    npc_id: WardenHusk  # v7.8.15: Added per Audit
    npc_name: Warden Husk
    npc_blueprint: BP_WardenHusk
    ability_configuration: AC_WardenHusk
    activity_configuration: AC_WardenHuskBehavior
    default_factions:
      - Narrative.Factions.Returned

  - name: NPC_WardenCore
    folder: Enemies/Warden
    npc_id: WardenCore  # v7.8.15: Added per Audit
    npc_name: Warden Core
    npc_blueprint: BP_WardenCore
    ability_configuration: AC_WardenCore
    activity_configuration: AC_WardenCoreBehavior
    default_factions:
      - Narrative.Factions.Returned

  # ============================================================================
  # BIOMECHANICAL DETACHMENT SYSTEM
  # ============================================================================
  - name: NPC_BiomechHost
    folder: Enemies/Biomech
    npc_id: BiomechHost  # v7.8.15: Added per Audit
    npc_name: Biomech Host
    npc_blueprint: BP_BiomechHost
    ability_configuration: AC_BiomechHost
    activity_configuration: AC_BiomechHostBehavior
    default_factions:
      - Narrative.Factions.Returned
    default_owned_tags:
      - Faction.Enemy.Biomech  # v7.8.16: Added per Guide Phase 8.1.5

  - name: NPC_BiomechCreature
    folder: Enemies/Biomech
    npc_id: BiomechCreature  # v7.8.15: Added per Audit
    npc_name: Biomech Creature
    npc_blueprint: BP_BiomechCreature
    ability_configuration: AC_BiomechCreature
    activity_configuration: AC_BiomechCreatureBehavior
    default_factions:
      - Narrative.Factions.Returned
    default_owned_tags:
      - Faction.Enemy.Biomech  # v7.8.16: Added per Guide Phase 8.2.5

# ============================================================================
# CHARACTER DEFINITIONS (1)
# ============================================================================
character_definitions:
  - name: CD_FatherCompanion
    folder: Configs
    display_name: Father Companion
    npc_definition: NPC_FatherCompanion

# ============================================================================
# ITEM COLLECTIONS (2)
# ============================================================================
item_collections:
  - name: IC_FatherForms
    folder: Items
    # NOTE: Only forms with EquippableItems (attached forms + weapons)
    # Crawler/Engineer activate via GAS directly - no equipment needed
    items:
      - item: EI_FatherArmorForm
        quantity: 1
      - item: EI_FatherExoskeletonForm
        quantity: 1
      - item: EI_FatherSymbioteForm
        quantity: 1
      - item: EI_FatherRifleForm
        quantity: 1
      - item: EI_FatherSwordForm
        quantity: 1

  # v7.8.14: Gatherer Scout loot collection (placeholder items)
  - name: IC_GathererScout
    folder: Items/Gatherer
    # Placeholder resource items - replace with actual game items when available
    items:
      - item: EI_GatheredResource_Common
        quantity: 3
      - item: EI_GatheredResource_Rare
        quantity: 1

# ============================================================================
# NARRATIVE EVENTS (2)
# ============================================================================
narrative_events:
  - name: NE_FatherRecruited
    folder: Events
    parent_class: NarrativeEvent
    event_tag: GameplayEvent.Father.Reactivated

  - name: NE_FatherSacrificed
    folder: Events
    parent_class: NarrativeEvent
    event_tag: GameplayEvent.Father.Sacrificed

# ============================================================================
# NPC CONTROLLERS - REMOVED (v5.1 Goal_Attack Approach)
# ============================================================================
# BP_BackstabNPCController is NO LONGER NEEDED
#
# v5.1: Switched to Goal_Attack query approach which uses Narrative Pro's built-in
# perception → goal system. No custom controller or perception binding required.
#
# How it works:
# 1. GoalGenerator_Attack automatically creates Goal_Attack when NPCs detect hostiles
# 2. Goal_Attack stores TargetToAttack (who the enemy is attacking)
# 3. GA_Backstab.CheckBackstabCondition queries this via NPCActivityComponent
# 4. If no Goal_Attack targeting player → enemy is unaware → backstab valid
#
# See GA_Backstab custom_functions for implementation details.
# ============================================================================

# ============================================================================
# ACTOR BLUEPRINTS (4) - Characters (1) + Projectiles (2) + Traps (1)
# ============================================================================
actor_blueprints:
  - name: BP_FatherCompanion
    folder: Characters
    parent_class: NarrativeNPCCharacter
    components:
      - name: AbilitySystemComponent
        type: NarrativeAbilitySystemComponent
      - name: EquipmentComponent
        type: EquipmentComponent
      - name: InteractionComponent
        type: NPCInteractionComponent
    variables:
      - name: OwnerPlayer
        type: NarrativePlayerCharacter
        replicated: true
      - name: CurrentForm
        type: E_FatherForm
        default: Crawler
        replicated: true
      - name: IsAttached
        type: Bool
        default: false
        replicated: true
      - name: DomeEnergy
        type: Float
        default: 0.0
        replicated: true
      - name: MaxDomeEnergy
        type: Float
        default: 500.0
        replicated: false
      - name: AbsorptionPercentage
        type: Float
        default: 0.3
        replicated: false
      - name: SymbioteCharge
        type: Float
        default: 0.0
        replicated: true
      - name: IsDeployed
        type: Bool
        default: false
        replicated: true
      # v7.8.48 P1-BP.X: PendingMarkTarget for centralized Mark integration
      - name: PendingMarkTarget
        type: Object
        class: Actor
        replicated: false
      # v7.8.51: Mark tracking system variables
      - name: MarkedEnemies
        type: Array
        element_type: Actor
        replicated: true
        comment: "Array of currently marked enemies (max 3)"
      - name: MaxMarks
        type: Integer
        default: 3
        replicated: false
        comment: "Maximum concurrent marks allowed"
      - name: MarkWidgetMap
        type: Map
        key_type: Actor
        value_type: WidgetComponent
        replicated: false
        comment: "Maps marked enemies to their visual indicator widgets"
    # v7.8.48 P1-BP.X: MarkEnemy function for centralized Mark integration
    # Called by attack abilities (GA_FatherLaserShot, GA_TurretShoot, GA_FatherElectricTrap)
    # Sets PendingMarkTarget then activates GA_FatherMark
    custom_functions:
      - function_name: MarkEnemy
        pure: false
        inputs:
          - name: TargetActor
            type: Actor
        outputs:
          - name: MarkApplied
            type: Boolean
        nodes:
          # Step 1: Validate target is valid and not self
          - id: IsValidTarget
            type: CallFunction
            properties:
              function: IsValid
            position: [0, 0]
          - id: GetSelf
            type: Self
            position: [0, 100]
          - id: NotEqualSelf
            type: CallFunction
            properties:
              function: NotEqual_ObjectObject
              class: KismetMathLibrary
            position: [200, 50]
          - id: AndCheck
            type: CallFunction
            properties:
              function: BooleanAND
              class: KismetMathLibrary
            position: [400, 0]
          - id: Branch_Valid
            type: Branch
            position: [600, 0]
          # Step 2: Set PendingMarkTarget
          - id: SetPendingTarget
            type: VariableSet
            properties:
              variable_name: PendingMarkTarget
            position: [800, 0]
          # Step 3: Get ASC and activate GA_FatherMark
          - id: GetASC
            type: CallFunction
            properties:
              function: GetAbilitySystemComponent
              class: AbilitySystemBlueprintLibrary
            position: [1000, 0]
          # [MANIFEST] Line 7017: TSubclassOf can use asset name (generator resolves path)
          - id: TryActivateMark
            type: CallFunction
            properties:
              function: TryActivateAbilityByClass
              class: AbilitySystemComponent
              param.InAbilityToActivate: GA_FatherMark
              param.bAllowRemoteActivation: false
            position: [1200, 0]
          # Step 4: Set literal bool for output
          - id: MakeLiteralTrue
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
              param.Value: true
            position: [1400, 0]
          - id: MakeLiteralFalse
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
              param.Value: false
            position: [800, 200]
        connections:
          # Validation flow - use FunctionEntry for input parameters
          - from: [FunctionEntry, TargetActor]
            to: [IsValidTarget, Object]
          - from: [FunctionEntry, TargetActor]
            to: [NotEqualSelf, A]
          - from: [GetSelf, Self]
            to: [NotEqualSelf, B]
          - from: [IsValidTarget, ReturnValue]
            to: [AndCheck, A]
          - from: [NotEqualSelf, ReturnValue]
            to: [AndCheck, B]
          - from: [AndCheck, ReturnValue]
            to: [Branch_Valid, Condition]
          # Success path
          - from: [Branch_Valid, True]
            to: [SetPendingTarget, Exec]
          - from: [FunctionEntry, TargetActor]
            to: [SetPendingTarget, PendingMarkTarget]
          - from: [SetPendingTarget, Exec]
            to: [GetASC, Exec]
          - from: [GetSelf, Self]
            to: [GetASC, Actor]
          - from: [GetASC, Exec]
            to: [TryActivateMark, Exec]
          - from: [GetASC, ReturnValue]
            to: [TryActivateMark, Target]
          # Output true on success - use FunctionResult
          - from: [MakeLiteralTrue, ReturnValue]
            to: [FunctionResult, MarkApplied]
          # Failure path - output false
          - from: [MakeLiteralFalse, ReturnValue]
            to: [FunctionResult, MarkApplied]
    # v7.7: Delegate bindings REMOVED - Track E audit.
    # D-DEATH-RESET-2 will use alternative pattern (WaitGameplayEvent or HandleDeath override)
    # See: ClaudeContext/Handoffs/Track_E_Removal_Audit_v7_7.md
    event_graph:
      nodes:
        # BeginPlay - Spawn companion VFX
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        - id: SelfRef
          type: Self
          position: [200, 100]
        - id: GetMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [400, 0]
        - id: SpawnCompanionVFX
          type: CallFunction
          properties:
            function: SpawnSystemAttached
            class: NiagaraFunctionLibrary
          position: [700, 0]
        # EndPlay - Safety net cleanup
        - id: Event_EndPlay
          type: Event
          properties:
            event_name: ReceiveEndPlay
          position: [0, 400]
        - id: PrintCleanup
          type: CallFunction
          properties:
            function: PrintString
            class: KismetSystemLibrary
          position: [300, 400]
        # === PLAYER DEATH RESET (D-DEATH-RESET-2) ===
        # v7.8.21: Death resets handled in abilities via WaitGameplayEvent pattern
        # - DomeEnergy reset: IMPLEMENTED in GA_ProtectiveDome (uses WaitDeathEvent)
        # - SymbioteCharge reset: Handled alongside DomeEnergy in GA_ProtectiveDome death handler
        # See Track_E_Removal_Audit_v7_7.md - delegate bindings removed, WaitGameplayEvent is the pattern
      connections:
        # BeginPlay flow - Self -> GetMesh -> SpawnVFX
        - from: [Event_BeginPlay, Then]
          to: [SpawnCompanionVFX, Exec]
        - from: [SelfRef, Self]
          to: [GetMesh, Target]
        - from: [GetMesh, Mesh]
          to: [SpawnCompanionVFX, AttachToComponent]
        # EndPlay flow
        - from: [Event_EndPlay, Then]
          to: [PrintCleanup, Exec]

  # v7.8.51: Laser projectile with homing support
  # Homing target acquired from Father's AI Blackboard (TargetEnemy key)
  - name: BP_LaserProjectile
    folder: Projectiles
    parent_class: NarrativeProjectile
    components:
      - name: ProjectileMovement
        type: ProjectileMovementComponent
        properties:
          InitialSpeed: 5000.0
          MaxSpeed: 5000.0
          bRotationFollowsVelocity: true
          bShouldBounce: false
          ProjectileGravityScale: 0.0
          bIsHomingProjectile: true
          HomingAccelerationMagnitude: 10000.0
      - name: DamageCollision
        type: SphereComponent
        radius: 30.0
        collision_profile: OverlapAllDynamic
    variables:
      - name: Damage
        type: Float
        default: 25.0
      - name: Speed
        type: Float
        default: 5000.0
    # v7.8.51: BeginPlay gets homing target from Instigator's AI blackboard
    # Flow: GetInstigator → GetController → CastToAIController → GetBlackboard → GetValueAsObject(TargetEnemy)
    event_graph:
      nodes:
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        # Get target from Instigator (Father's) AI blackboard
        - id: GetInstigator
          type: CallFunction
          properties:
            function: GetInstigator
            target_self: true
          position: [200, 0]
        - id: CastToPawn
          type: DynamicCast
          properties:
            target_class: Pawn
          position: [400, 0]
        - id: GetController
          type: CallFunction
          properties:
            function: GetController
            class: Pawn
          position: [600, 0]
        - id: CastToAIController
          type: DynamicCast
          properties:
            target_class: AIController
          position: [800, 0]
        # v7.8.51: [MANIFEST] Line 11693 - Use PropertyGet (GetBlackboardComponent is C++ inline)
        - id: GetBlackboard
          type: PropertyGet
          properties:
            property_name: Blackboard
            target_class: AIController
          position: [1000, 0]
        # v7.8.51: MakeLiteralName for blackboard key lookup
        - id: MakeTargetKeyName
          type: CallFunction
          properties:
            function: MakeLiteralName
            class: KismetSystemLibrary
            param.Value: TargetEnemy
          position: [1100, 50]
        - id: GetTargetFromBB
          type: CallFunction
          properties:
            function: GetValueAsObject
            class: BlackboardComponent
          position: [1200, 0]
        - id: CastToActor
          type: DynamicCast
          properties:
            target_class: Actor
          position: [1400, 0]
        - id: IsValidTarget
          type: CallFunction
          properties:
            function: IsValid
          position: [1600, 0]
        - id: Branch_ValidTarget
          type: Branch
          position: [1800, 0]
        # Get root component from target for homing
        - id: GetRootComponent
          type: CallFunction
          properties:
            function: K2_GetRootComponent
            class: Actor
          position: [2000, 0]
        # v7.8.51: Get ProjectileMovement via component variable
        # Generator creates variable with same name as component from components: section
        - id: GetProjectileMovementVar
          type: VariableGet
          properties:
            variable_name: ProjectileMovement
          position: [2000, 100]
        # Set HomingTargetComponent on ProjectileMovement
        - id: SetHomingTarget
          type: PropertySet
          properties:
            property_name: HomingTargetComponent
            target_class: ProjectileMovementComponent
          position: [2200, 0]
      connections:
        # Chain: GetInstigator → CastToPawn → GetController → CastToAI → GetBlackboard → GetTarget
        - from: [Event_BeginPlay, Then]
          to: [CastToPawn, Exec]
        - from: [GetInstigator, ReturnValue]
          to: [CastToPawn, Object]
        - from: [CastToPawn, Exec]
          to: [CastToAIController, Exec]
        - from: [CastToPawn, AsPawn]
          to: [GetController, Target]
        - from: [GetController, ReturnValue]
          to: [CastToAIController, Object]
        - from: [CastToAIController, Exec]
          to: [CastToActor, Exec]
        - from: [CastToAIController, AsAIController]
          to: [GetBlackboard, Target]
        # PropertyGet output is property name
        - from: [GetBlackboard, Blackboard]
          to: [GetTargetFromBB, Target]
        # Connect MakeLiteralName to KeyName pin
        - from: [MakeTargetKeyName, ReturnValue]
          to: [GetTargetFromBB, KeyName]
        - from: [GetTargetFromBB, ReturnValue]
          to: [CastToActor, Object]
        - from: [CastToActor, Exec]
          to: [Branch_ValidTarget, Exec]
        - from: [CastToActor, AsActor]
          to: [IsValidTarget, Object]
        - from: [IsValidTarget, ReturnValue]
          to: [Branch_ValidTarget, Condition]
        # If valid, set homing target
        - from: [Branch_ValidTarget, True]
          to: [SetHomingTarget, Exec]
        - from: [CastToActor, AsActor]
          to: [GetRootComponent, Target]
        - from: [GetRootComponent, ReturnValue]
          to: [SetHomingTarget, HomingTargetComponent]
        # Use component variable for ProjectileMovement reference
        - from: [GetProjectileMovementVar, ProjectileMovement]
          to: [SetHomingTarget, Target]

  - name: BP_TurretProjectile
    folder: Projectiles
    parent_class: NarrativeProjectile
    variables:
      - name: Damage
        type: Float
        default: 15.0
      - name: Speed
        type: Float
        default: 3000.0

  - name: BP_ElectricTrap
    folder: Traps
    parent_class: Actor
    components:
      - name: TriggerSphere
        type: SphereComponent
        radius: 150.0
      - name: TrapMesh
        type: StaticMeshComponent
    variables:
      - name: Damage
        type: Float
        default: 30.0
      - name: RootDuration
        type: Float
        default: 3.0
      - name: Lifetime
        type: Float
        default: 15.0

# ============================================================================
# COMPONENT BLUEPRINTS (1)
# v7.8.50: BPC_DoublePressInput for double-tap W/A/S/D dash activation
# ============================================================================
component_blueprints:
  - name: BPC_DoublePressInput
    folder: Components
    parent_class: ActorComponent
    variables:
      - name: DoubleTapWindow
        type: Float
        default_value: "0.3"
        instance_editable: true
      - name: OwningCharacter
        type: Object
        class: NarrativePlayerCharacter
    event_dispatchers:
      - name: OnDoubleTapForward
        parameters: []
      - name: OnDoubleTapBackward
        parameters: []
      - name: OnDoubleTapLeft
        parameters: []
      - name: OnDoubleTapRight
        parameters: []
    tick:
      can_ever_tick: false

# ============================================================================
# WIDGET BLUEPRINTS (3)
# ============================================================================
widget_blueprints:
  - name: WBP_MarkIndicator
    folder: UI
    parent_class: UserWidget
    variables:
      - name: TargetActor
        type: Actor
        instance_editable: true
      - name: MarkDuration
        type: Float
        default: 5.0

  - name: WBP_UltimatePanel
    folder: UI
    parent_class: UserWidget
    variables:
      - name: CurrentCharge
        type: Float
        default: 0.0
        instance_editable: true
      - name: MaxCharge
        type: Float
        default: 100.0
    # v4.3: Widget tree layout automation - creates full widget hierarchy
    widget_tree:
      root_widget: RootCanvas
      widgets:
        - id: RootCanvas
          type: CanvasPanel
          name: RootCanvas
          children: [ContentBox]
        - id: ContentBox
          type: VerticalBox
          name: ContentBox
          is_variable: true
          slot:
            anchors: BottomCenter
            alignment: "0.5, 1.0"
            position: "0, -50"
          children: [ChargeLabel, ChargeBar]
        - id: ChargeLabel
          type: TextBlock
          name: UltimateLabel
          text: "ULTIMATE"
          slot:
            h_align: Center
            v_align: Center
          properties:
            Font.Size: 18
            ColorAndOpacity: "(R=1.0, G=0.8, B=0.2, A=1.0)"
        - id: ChargeBar
          type: ProgressBar
          name: ChargeProgressBar
          is_variable: true
          slot:
            h_align: Fill
            size_rule: Fill
            padding: "10, 5, 10, 5"
          properties:
            BarFillType: LeftToRight
            Percent: 0.0
            FillColorAndOpacity: "(R=1.0, G=0.6, B=0.0, A=1.0)"

  - name: WBP_FormWheel
    folder: UI
    parent_class: UserWidget
    variables:
      - name: SelectedSlot
        type: Int
        default: 0
      - name: IsOpen
        type: Bool
        default: false
    # v4.10: Widget tree for radial form selection wheel
    # Layout per System Design Document Section 5.2:
    # Armor (top), Symbiote (left), Engineer (right), Exoskeleton (bottom-left), Crawler (bottom-right)
    widget_tree:
      root_widget: RootCanvas
      widgets:
        - id: RootCanvas
          type: CanvasPanel
          name: RootCanvas
          children: [WheelBackground, Slot_Armor, Slot_Symbiote, Slot_Engineer, Slot_Exoskeleton, Slot_Crawler, CenterIcon, SelectionIndicator]
        - id: WheelBackground
          type: Image
          name: WheelBackground
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "0, 0"
            size: "400, 400"
          properties:
            ColorAndOpacity: "(R=0.02, G=0.02, B=0.05, A=0.85)"
        - id: Slot_Armor
          type: Button
          name: Slot_Armor
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "0, -120"
            size: "70, 70"
        - id: Slot_Symbiote
          type: Button
          name: Slot_Symbiote
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "-120, 0"
            size: "70, 70"
        - id: Slot_Engineer
          type: Button
          name: Slot_Engineer
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "120, 0"
            size: "70, 70"
        - id: Slot_Exoskeleton
          type: Button
          name: Slot_Exoskeleton
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "-74, 97"
            size: "70, 70"
        - id: Slot_Crawler
          type: Button
          name: Slot_Crawler
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "74, 97"
            size: "70, 70"
        - id: CenterIcon
          type: Image
          name: CenterIcon
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "0, 0"
            size: "80, 80"
          properties:
            ColorAndOpacity: "(R=1.0, G=0.8, B=0.4, A=1.0)"
        - id: SelectionIndicator
          type: Image
          name: SelectionIndicator
          is_variable: true
          slot:
            anchors: Center
            alignment: "0.5, 0.5"
            position: "0, 0"
            size: "70, 70"
          properties:
            ColorAndOpacity: "(R=1.0, G=0.6, B=0.0, A=0.0)"

# ============================================================================
# NIAGARA SYSTEMS (7) - v2.6.11 Enhanced with user parameters
# ============================================================================
# v2.9.0: Niagara Systems now support data-driven FX architecture
# Two modes:
#   1. user_parameters: - Define custom User.* params (current method)
#   2. fx_descriptor: + template_system: - Use template duplication with standard params
#
# For fx_descriptor mode, artist must first create NS_FatherFXTemplate with Uber-Emitters
# See: guides/Niagara_Uber_Emitter_Setup_Guide_v1_0.md
# ============================================================================

# ============================================================================
# FX PRESETS (v4.9) - Reusable VFX parameter configurations with inheritance
# ============================================================================
fx_presets:
  # Base preset for all Father VFX - common parameters
  - name: FX_FatherBase
    folder: VFX/Presets
    parameters:
      SpawnRate: "50.0"
      ParticleLifetime: "2.0"
      BaseColor: "(0.8, 0.6, 0.2, 1.0)"
      EmissiveIntensity: "3.0"

  # Energy burst preset - inherits from base, overrides for burst effects
  - name: FX_EnergyBurst
    folder: VFX/Presets
    base_preset: FX_FatherBase
    parameters:
      SpawnRate: "200.0"
      ParticleLifetime: "0.5"
      EmissiveIntensity: "8.0"

  # Ambient glow preset - inherits from base, lower intensity for ambient
  - name: FX_AmbientGlow
    folder: VFX/Presets
    base_preset: FX_FatherBase
    parameters:
      SpawnRate: "25.0"
      ParticleLifetime: "4.0"
      EmissiveIntensity: "2.0"

  # Laser/beam preset - high intensity, short lifetime
  - name: FX_LaserBeam
    folder: VFX/Presets
    parameters:
      SpawnRate: "100.0"
      ParticleLifetime: "0.2"
      BaseColor: "(1.0, 0.3, 0.1, 1.0)"
      EmissiveIntensity: "15.0"
      BeamWidth: "5.0"

  # Electric/trap preset - blue-white sparks
  - name: FX_Electric
    folder: VFX/Presets
    parameters:
      SpawnRate: "150.0"
      ParticleLifetime: "0.3"
      BaseColor: "(0.4, 0.7, 1.0, 1.0)"
      EmissiveIntensity: "10.0"
      SparkIntensity: "5.0"

niagara_systems:
  # v4.11 NOTE: From-scratch Niagara systems (no template_system) require editor mode with
  # real RHI to generate. Headless -nullrhi mode only supports template-based systems.
  # To test template-based generation, use:
  #   template_system: "/Niagara/DefaultAssets/Templates/Systems/MinimalLightweight.MinimalLightweight"

  # Main Father companion floating energy orb VFX
  # Composed of: NE_FatherCore, NE_FatherShell, NE_FatherParticles, NE_FatherAura, NE_FatherTrail
  - name: NS_FatherCompanion
    folder: VFX
    effect_type: ambient
    preset: FX_AmbientGlow  # v4.9: FX Preset reference
    fixed_bounds: true
    bounds_min: -100, -100, -100
    bounds_max: 100, 100, 100
    warmup_time: 0.0
    pooling: AutoRelease
    max_pool_size: 5
    # v4.9: LOD/Scalability settings
    cull_distance_low: 500
    cull_distance_medium: 1000
    cull_distance_high: 2000
    cull_distance_epic: 5000
    cull_distance_cinematic: 0
    cull_max_distance: 10000
    significance_distance: 1500
    max_particle_budget: 500
    scalability_mode: Self
    allow_culling_for_local_players: false
    user_parameters:
      - name: CoreScale
        type: float
        default: 1.0
      - name: ShellScale
        type: float
        default: 1.0
      - name: ParticleSpawnRate
        type: float
        default: 15.0
      - name: AlertLevel
        type: float
        default: 0.0
      - name: EmotionColor
        type: linear_color
        default: 1.0, 0.8, 0.4, 1.0
    # v4.9: Per-emitter parameter overrides
    # NOTE: emitter_overrides requires template_system or emitters: array to provide the emitters
    # These overrides reference emitters that would exist in a custom template system.
    # Commented out until a proper template is created with CoreEmitter/ShellEmitter/TrailEmitter.
    # emitter_overrides:
    #   - emitter: CoreEmitter
    #     enabled: true
    #     parameters:
    #       CoreGlowIntensity: "5.0"
    #       CorePulseRate: "1.5"
    #   - emitter: ShellEmitter
    #     enabled: true
    #     parameters:
    #       ShellOpacity: "0.3"
    #   - emitter: TrailEmitter
    #     enabled: false  # Disable trail in base config

  # Form transition burst VFX - used during 5s form change animation
  - name: NS_FatherFormTransition
    folder: VFX
    effect_type: burst
    preset: FX_EnergyBurst  # v4.9: FX Preset reference
    warmup_time: 0.0
    pooling: AutoRelease
    max_pool_size: 3
    # v4.9: LOD settings for burst effects
    cull_distance_low: 1000
    cull_distance_medium: 2000
    cull_distance_high: 4000
    max_particle_budget: 1000
    user_parameters:
      - name: TransitionIntensity
        type: float
        default: 1.0
      - name: BurstColor
        type: linear_color
        default: 0.5, 0.8, 1.0, 1.0

  # Laser beam VFX for GA_FatherLaserShot
  - name: NS_LaserBeam
    folder: VFX
    effect_type: beam
    preset: FX_LaserBeam  # v4.9: FX Preset reference
    determinism: true
    random_seed: 42
    fixed_bounds: true
    bounds_min: -500, -50, -50
    bounds_max: 500, 50, 50
    # v4.9: LOD for beam effects
    cull_distance_low: 2000
    cull_distance_high: 5000
    max_particle_budget: 200
    user_parameters:
      - name: BeamWidth
        type: float
        default: 5.0
      - name: BeamLength
        type: float
        default: 1500.0
      - name: BeamColor
        type: linear_color
        default: 1.0, 0.2, 0.2, 1.0
      - name: BeamIntensity
        type: float
        default: 10.0

  # Electric trap VFX for GA_FatherElectricTrap
  - name: NS_ElectricTrap
    folder: VFX
    effect_type: ambient
    preset: FX_Electric  # v4.9: FX Preset reference
    fixed_bounds: true
    bounds_min: -200, -200, -50
    bounds_max: 200, 200, 50
    warmup_time: 0.5
    # v4.9: LOD for trap effects
    cull_distance_low: 1500
    cull_distance_high: 4000
    max_particle_budget: 300
    user_parameters:
      - name: TrapRadius
        type: float
        default: 150.0
      - name: ArcCount
        type: int
        default: 8
      - name: ElectricColor
        type: linear_color
        default: 0.3, 0.6, 1.0, 1.0
      - name: ArcIntensity
        type: float
        default: 5.0
    # NOTE: emitter_overrides require template_system - commented out until custom template exists
    # emitter_overrides:
    #   - emitter: ArcEmitter
    #     enabled: true
    #     parameters:
    #       ArcFrequency: "10.0"
    #       ArcJitter: "2.0"

  # Dome shield VFX for GA_ProtectiveDome (spherical particle shield)
  - name: NS_DomeShield
    folder: VFX
    effect_type: ambient
    fixed_bounds: true
    bounds_min: -300, -300, -300
    bounds_max: 300, 300, 300
    user_parameters:
      - name: DomeRadius
        type: float
        default: 250.0
      - name: ShieldOpacity
        type: float
        default: 0.5
      - name: ShieldColor
        type: linear_color
        default: 0.2, 0.6, 1.0, 0.8
      - name: PulseSpeed
        type: float
        default: 1.0

  # Dome burst VFX for GA_DomeBurst (expansion ring burst effect)
  - name: NS_DomeBurst
    folder: VFX
    effect_type: burst
    pooling: AutoRelease
    max_pool_size: 5
    user_parameters:
      - name: BurstRadius
        type: float
        default: 500.0
      - name: BurstSpeed
        type: float
        default: 1000.0
      - name: BurstColor
        type: linear_color
        default: 1.0, 0.8, 0.2, 1.0
      - name: BurstDamageIntensity
        type: float
        default: 1.0

  # Legacy dome VFX (renamed for clarity)
  - name: NS_ProtectiveDome
    folder: VFX
    effect_type: ambient
    fixed_bounds: true
    bounds_min: -300, -300, -300
    bounds_max: 300, 300, 300

  # v2.9.0 EXAMPLE: Data-driven FX using fx_descriptor
  # Requires NS_FatherFXTemplate to be created by artist first
  # Uncomment when template is ready:
  #
  # - name: NS_ImpactFX_Fire
  #   folder: VFX/Impacts
  #   template_system: /Game/FatherCompanion/VFX/Systems/NS_FatherFXTemplate
  #   fx_descriptor:
  #     # Enable specific emitters
  #     particles_enabled: true
  #     burst_enabled: true
  #     light_enabled: true
  #     smoke_enabled: true
  #     # Core emission
  #     spawn_rate: 200.0
  #     lifetime: [0.3, 0.8]
  #     max_particles: 300
  #     # Appearance (Fire orange)
  #     color: [1.0, 0.4, 0.1, 1.0]
  #     size: [8.0, 20.0]
  #     opacity: 1.0
  #     emissive: 5.0
  #     # Motion
  #     initial_velocity: [0, 0, 150]
  #     noise_strength: 2.0
  #     gravity_scale: -0.3
  #     # Light
  #     light_intensity: 8000.0
  #     light_radius: 300.0

# ============================================================================
# ANIMATION ASSETS (7) - DISABLED: Blocked by SK_FatherCompanion (R1)
# Re-enable when skeleton mesh is imported
# ============================================================================
# animation_montages:
#   - name: AM_FatherAttack
#     folder: Animations
#     skeleton: SK_FatherCompanion
#
#   - name: AM_FatherThrowWeb
#     folder: Animations
#     skeleton: SK_FatherCompanion
#
#   - name: AM_FatherSacrifice
#     folder: Animations
#     skeleton: SK_FatherCompanion
#
#   - name: AM_FatherReactivate
#     folder: Animations
#     skeleton: SK_FatherCompanion
#
#   - name: AM_FatherDetach
#     folder: Animations
#     skeleton: SK_FatherCompanion
#
#   - name: AM_FatherAttach
#     folder: Animations
#     skeleton: SK_FatherCompanion
#
# animation_notifies:
#   - name: NAS_FatherAttack
#     folder: Animations
#     montage: AM_FatherAttack

# ============================================================================
# GAMEPLAY CUES - v7.8.50 VFX/SFX triggers via GAS Gameplay Cue system
# ============================================================================
gameplay_cues:
  # v7.8.50: Dome burst expansion ring VFX (Contract 25 compliance - proper GAS pattern)
  # NOTE: particle_system requires NS_DomeBurst which needs editor mode (real RHI) to generate
  # Link VFX manually in editor: BurstEffects.BurstParticles -> NS_DomeBurst
  - name: GC_DomeBurst
    folder: FX/GameplayCues
    cue_type: Burst
    gameplay_cue_tag: GameplayCue.Father.DomeBurst

  # v7.8.55: Sacrifice dormant state VFX (father dark/lifeless during 180s dormant period)
  # Placeholder cue - link VFX manually in editor for dormant visual state
  - name: GC_FatherSacrificeDormant
    folder: FX/GameplayCues
    cue_type: BurstLatent
    gameplay_cue_tag: GameplayCue.Father.Sacrifice.Dormant

# ============================================================================
# MATERIAL FUNCTIONS (3) - v2.6.12 VFX helper functions
# NOTE: Moved before Materials section for manifest hygiene (phase order fix requires code change)
# ============================================================================
material_functions:
  # Animated energy pulse effect
  - name: MF_EnergyPulse
    folder: Materials/Functions
    description: Generates animated energy pulse effect
    expose_to_library: true
    inputs:
      - name: Speed
        type: float
        default: 1.0
        sort_priority: 0
      - name: Amplitude
        type: float
        default: 0.5
        sort_priority: 1
    outputs:
      - name: Pulse
        type: float
        sort_priority: 0
    expressions:
      - id: time
        type: Time
        pos_x: -300
        pos_y: 0
      - id: speedMul
        type: Multiply
        pos_x: -150
        pos_y: 0
      - id: sine
        type: Sine
        pos_x: 0
        pos_y: 0
      - id: ampMul
        type: Multiply
        pos_x: 150
        pos_y: 0
    connections:
      - from: time
        to: speedMul
        to_input: A
      - from: Speed
        to: speedMul
        to_input: B
      - from: speedMul
        to: sine
        to_input: Input
      - from: sine
        to: ampMul
        to_input: A
      - from: Amplitude
        to: ampMul
        to_input: B
      - from: ampMul
        to: Pulse
        to_input: A

  # Fresnel-based glow effect
  - name: MF_FresnelGlow
    folder: Materials/Functions
    description: Fresnel-based edge glow effect
    expose_to_library: true
    inputs:
      - name: Exponent
        type: float
        default: 3.0
        sort_priority: 0
      - name: GlowColor
        type: float3
        default: 1.0, 0.8, 0.4
        sort_priority: 1
    outputs:
      - name: GlowResult
        type: float3
        sort_priority: 0
    expressions:
      - id: fresnel
        type: Fresnel
        pos_x: -100
        pos_y: 0
        properties:
          exponent: 3.0
      - id: mul
        type: Multiply
        pos_x: 100
        pos_y: 0
    connections:
      - from: Exponent
        to: fresnel
        to_input: ExponentIn
      - from: fresnel
        to: mul
        to_input: A
      - from: GlowColor
        to: mul
        to_input: B
      - from: mul
        to: GlowResult
        to_input: A

  # Radial gradient for dome/sphere effects
  - name: MF_RadialGradient
    folder: Materials/Functions
    description: Radial gradient for spherical effects
    expose_to_library: true
    inputs:
      - name: Center
        type: float2
        default: 0.5, 0.5
        sort_priority: 0
      - name: Falloff
        type: float
        default: 1.0
        sort_priority: 1
    outputs:
      - name: Gradient
        type: float
        sort_priority: 0
    expressions:
      - id: texcoord
        type: TexCoord
        pos_x: -300
        pos_y: 0
      - id: dist
        type: Distance
        pos_x: -100
        pos_y: 0
      - id: falloffMul
        type: Multiply
        pos_x: 50
        pos_y: 0
      - id: invert
        type: OneMinus
        pos_x: 200
        pos_y: 0
      - id: clampResult
        type: Clamp
        pos_x: 350
        pos_y: 0
    connections:
      - from: texcoord
        to: dist
        to_input: A
      - from: Center
        to: dist
        to_input: B
      - from: dist
        to: falloffMul
        to_input: A
      - from: Falloff
        to: falloffMul
        to_input: B
      - from: falloffMul
        to: invert
        to_input: Input
      - from: invert
        to: clampResult
        to_input: Input
      - from: clampResult
        to: Gradient
        to_input: A

# ============================================================================
# MATERIALS (4) - v2.6.12 Enhanced with expression graphs
# ============================================================================
materials:
  # Core energy orb material for Father companion
  - name: M_FatherCore
    folder: Materials/VFX
    blend_mode: Additive
    shading_model: Unlit
    two_sided: true
    expressions:
      - id: core_color
        type: VectorParam
        name: CoreColor
        default: 1.0, 0.8, 0.4, 1.0
        pos_x: -400
        pos_y: 0
      - id: intensity
        type: ScalarParam
        name: EmissiveIntensity
        default: 100.0
        pos_x: -400
        pos_y: 100
      - id: fresnel
        type: Fresnel
        pos_x: -200
        pos_y: 200
        properties:
          exponent: 3.0
      - id: mul_fresnel
        type: Multiply
        pos_x: 0
        pos_y: 0
      - id: mul_intensity
        type: Multiply
        pos_x: 200
        pos_y: 0
    connections:
      - from: core_color
        from_output: RGB
        to: mul_fresnel
        to_input: A
      - from: fresnel
        from_output: Result
        to: mul_fresnel
        to_input: B
      - from: mul_fresnel
        from_output: Result
        to: mul_intensity
        to_input: A
      - from: intensity
        from_output: Result
        to: mul_intensity
        to_input: B
      - from: mul_intensity
        from_output: Result
        to: Material
        to_input: EmissiveColor

  # Outer shell material for Father companion
  - name: M_FatherShell
    folder: Materials/VFX
    blend_mode: Translucent
    shading_model: Unlit
    two_sided: true
    expressions:
      - id: edge_color
        type: VectorParam
        name: EdgeColor
        default: 0.4, 0.6, 1.0, 1.0
        pos_x: -400
        pos_y: 0
      - id: shell_intensity
        type: ScalarParam
        name: ShellIntensity
        default: 20.0
        pos_x: -400
        pos_y: 100
      - id: fresnel_power
        type: ScalarParam
        name: FresnelPower
        default: 3.0
        pos_x: -400
        pos_y: 200
      - id: base_opacity
        type: ScalarParam
        name: BaseOpacity
        default: 0.3
        pos_x: -400
        pos_y: 300
      - id: fresnel
        type: Fresnel
        pos_x: -200
        pos_y: 200
      - id: mul_color_intensity
        type: Multiply
        pos_x: -100
        pos_y: 50
      - id: mul_fresnel_color
        type: Multiply
        pos_x: 100
        pos_y: 100
    connections:
      # FresnelPower controls fresnel exponent (connected internally)
      - from: fresnel_power
        from_output: Result
        to: fresnel
        to_input: ExponentIn
      # EdgeColor * ShellIntensity = base emissive
      - from: edge_color
        from_output: RGB
        to: mul_color_intensity
        to_input: A
      - from: shell_intensity
        from_output: Result
        to: mul_color_intensity
        to_input: B
      # Fresnel * color_intensity = final emissive with edge glow
      - from: fresnel
        from_output: Result
        to: mul_fresnel_color
        to_input: A
      - from: mul_color_intensity
        from_output: Result
        to: mul_fresnel_color
        to_input: B
      - from: mul_fresnel_color
        from_output: Result
        to: Material
        to_input: EmissiveColor
      # BaseOpacity controls overall transparency
      - from: base_opacity
        from_output: Result
        to: Material
        to_input: Opacity

  # Particle trail material
  - name: M_FatherParticle
    folder: Materials/VFX
    blend_mode: Additive
    shading_model: Unlit
    two_sided: true
    expressions:
      - id: particle_color
        type: VectorParam
        name: ParticleColor
        default: 1.0, 0.9, 0.5, 1.0
        pos_x: -300
        pos_y: 0
      - id: intensity
        type: ScalarParam
        name: ParticleIntensity
        default: 2.0
        pos_x: -300
        pos_y: 100
      - id: mul
        type: Multiply
        pos_x: 0
        pos_y: 0
    connections:
      - from: particle_color
        from_output: RGB
        to: mul
        to_input: A
      - from: intensity
        from_output: Result
        to: mul
        to_input: B
      - from: mul
        from_output: Result
        to: Material
        to_input: EmissiveColor

  # Laser beam material
  - name: M_LaserGlow
    folder: Materials/VFX
    blend_mode: Additive
    shading_model: Unlit
    expressions:
      - id: laser_color
        type: VectorParam
        name: LaserColor
        default: 1.0, 0.2, 0.2, 1.0
        pos_x: -400
        pos_y: 0
      - id: glow_intensity
        type: ScalarParam
        name: GlowIntensity
        default: 10.0
        pos_x: -400
        pos_y: 100
      - id: mul
        type: Multiply
        pos_x: -100
        pos_y: 0
    connections:
      - from: laser_color
        from_output: RGB
        to: mul
        to_input: A
      - from: glow_intensity
        from_output: Result
        to: mul
        to_input: B
      - from: mul
        from_output: Result
        to: Material
        to_input: EmissiveColor

# ============================================================================
# MATERIAL INSTANCES (v4.9) - Material Instance Constants for VFX variation
# ============================================================================
material_instances:
  # Core glow variant - high intensity orange for alert state
  - name: MIC_FatherCore_Alert
    folder: Materials/VFX/Instances
    parent_material: M_FatherCore
    scalar_parameters:
      EmissiveIntensity: 150.0
    vector_parameters:
      CoreColor: "(1.0, 0.4, 0.1, 1.0)"

  # Core glow variant - calm blue for idle state
  - name: MIC_FatherCore_Calm
    folder: Materials/VFX/Instances
    parent_material: M_FatherCore
    scalar_parameters:
      EmissiveIntensity: 50.0
    vector_parameters:
      CoreColor: "(0.4, 0.6, 1.0, 1.0)"

  # Core glow variant - green for healing/support state
  - name: MIC_FatherCore_Support
    folder: Materials/VFX/Instances
    parent_material: M_FatherCore
    scalar_parameters:
      EmissiveIntensity: 80.0
    vector_parameters:
      CoreColor: "(0.3, 1.0, 0.5, 1.0)"

  # Shell variant - high opacity for combat
  - name: MIC_FatherShell_Combat
    folder: Materials/VFX/Instances
    parent_material: M_FatherShell
    scalar_parameters:
      BaseOpacity: 0.6
      ShellIntensity: 30.0
    vector_parameters:
      EdgeColor: "(1.0, 0.3, 0.3, 1.0)"

  # Laser glow variant - red for damage beam
  - name: MIC_LaserGlow_Red
    folder: Materials/VFX/Instances
    parent_material: M_LaserGlow
    scalar_parameters:
      GlowIntensity: 15.0
    vector_parameters:
      GlowColor: "(1.0, 0.2, 0.1, 1.0)"

  # Laser glow variant - blue for utility beam
  - name: MIC_LaserGlow_Blue
    folder: Materials/VFX/Instances
    parent_material: M_LaserGlow
    scalar_parameters:
      GlowIntensity: 12.0
    vector_parameters:
      GlowColor: "(0.2, 0.5, 1.0, 1.0)"

# ============================================================================
# DIALOGUE BLUEPRINTS (1)
# ============================================================================
dialogue_blueprints:
  - name: DBP_FatherCompanion
    folder: Dialogue
    parent_class: Dialogue

# ============================================================================
# NPC SYSTEMS - WARDEN HUSK (Two-Phase Enemy)
# ============================================================================
tags:  # WARDEN SYSTEM
  - tag: State.Warden.Husk
    comment: Applied to husk entity
  - tag: State.Warden.Core
    comment: Applied to flying core
  - tag: State.Warden.Ejecting
    comment: During transition phase
  - tag: State.Warden.Attacking
    comment: Warden Core is attacking
  - tag: Faction.Enemy.Warden
    comment: Warden faction identifier
  - tag: Ability.Warden.CoreLaser
    comment: Laser attack ability
  - tag: Cooldown.Warden.CoreLaser
    comment: Laser cooldown tag
  - tag: Effect.Damage.WardenLaser
    comment: Laser damage type

gameplay_effects:  # WARDEN SYSTEM
  # v7.3: Unified damage system - uses NarrativeDamageExecCalc like all other damage GEs
  # Damage comes from WardenCore's AttackDamage attribute (set by GE_WardenCoreAttributes: 50.0)
  - name: GE_CoreLaserDamage
    folder: Enemies/Warden/Effects
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc

  - name: GE_CoreLaserCooldown
    folder: Enemies/Warden/Effects
    duration_policy: HasDuration
    duration_magnitude: 1.5
    granted_tags:
      - Cooldown.Warden.CoreLaser

  # v7.5: GE_WardenHuskAttributes - Phase 12 from Implementation Guide
  # Husk is slow, armored, high health melee enemy
  - name: GE_WardenHuskAttributes
    folder: Enemies/Warden/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 500.0
      - attribute: NarrativeAttributeSetBase.Health
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 500.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 35.0
      - attribute: NarrativeAttributeSetBase.Armor
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 25.0

  # v7.5: GE_WardenCoreAttributes - Phase 13 from Implementation Guide
  # Core is fragile (low health, no armor) but high damage flying enemy
  - name: GE_WardenCoreAttributes
    folder: Enemies/Warden/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 75.0
      - attribute: NarrativeAttributeSetBase.Health
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 75.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 50.0
      - attribute: NarrativeAttributeSetBase.Armor
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 0.0

actor_blueprints:  # WARDEN SYSTEM
  # v4.34: SpawnNPC for proper NPC initialization on phase transition
  # v7.8.16: Added missing variables per Warden_Husk_System_Implementation_Guide_v1_4.md Phase 3
  - name: BP_WardenHusk
    folder: Enemies/Warden
    parent_class: NarrativeNPCCharacter
    variables:
      # NPCDefinition for spawning WardenCore on death via SpawnNPC
      - name: PhaseSpawnDefinition
        type: Object
        class: NPCDefinition
        instance_editable: true
      # v7.8.16: Guide Phase 3.1.1 - Spawn offset for Core ejection
      - name: SpawnOffset
        type: Vector
        default_value: "(X=0, Y=0, Z=100)"
        instance_editable: true
      # v7.8.16: Guide Phase 3.1.2 - Ejection animation montage
      - name: EjectionMontage
        type: Object
        class: AnimMontage
        instance_editable: true
      # v7.8.16: Guide Phase 3.1.3 - Whether to spawn corpse mesh
      - name: bSpawnCorpse
        type: Boolean
        default_value: "false"
        instance_editable: true
      # v7.8.16: Guide Phase 3.1.4 - Corpse mesh to spawn
      - name: CorpseMesh
        type: Object
        class: StaticMesh
        instance_editable: true
    # v7.8.29: Removed empty BeginPlay event - all logic is in HandleDeath override
    # v7.8.30: Full guide compliance - added definition/montage validity checks + corpse mesh spawning
    # Reference: Warden_Husk_System_Implementation_Guide_v1_5.md Phase 6 Steps 25-34
    # [MANIFEST] Pattern source: BP_BiomechHost HandleDeath (100% guide compliant)
    function_overrides:
      - function: HandleDeath
        nodes:
          # ============================================================================
          # Guide Step 26: Authority check - only server executes death logic
          # ============================================================================
          - id: HasAuth
            type: CallFunction
            properties:
              function: HasAuthority
              class: Actor
              target_self: true
            position: [200, 0]
          - id: AuthBranch
            type: Branch
            position: [400, 0]
          # ============================================================================
          # Guide Step 28: Validate PhaseSpawnDefinition before spawning
          # ============================================================================
          - id: GetSpawnDefinition
            type: VariableGet
            properties:
              variable_name: PhaseSpawnDefinition
            position: [600, 100]
          - id: CheckDefinitionValid
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [600, 0]
          - id: DefinitionBranch
            type: Branch
            position: [800, 0]
          # ============================================================================
          # Guide Step 29: Play ejection montage if valid
          # ============================================================================
          - id: GetEjectionMontage
            type: VariableGet
            properties:
              variable_name: EjectionMontage
            position: [1000, 100]
          - id: CheckMontageValid
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [1000, 0]
          - id: MontageBranch
            type: Branch
            position: [1200, 0]
          - id: SelfForMontage
            type: Self
            position: [1200, 100]
          - id: PlayMontage
            type: CallFunction
            properties:
              function: PlayAnimMontage
              class: Character
            position: [1400, 0]
          # ============================================================================
          # Guide Step 30: Calculate spawn transform with offset
          # ============================================================================
          - id: GetActorLocation
            type: CallFunction
            properties:
              function: K2_GetActorLocation
              class: Actor
              target_self: true
            position: [1600, 0]
          - id: GetSpawnOffset
            type: VariableGet
            properties:
              variable_name: SpawnOffset
            position: [1600, 100]
          - id: AddOffset
            type: CallFunction
            properties:
              function: Add_VectorVector
              class: KismetMathLibrary
            position: [1800, 0]
          - id: GetActorRotation
            type: CallFunction
            properties:
              function: K2_GetActorRotation
              class: Actor
              target_self: true
            position: [1600, 200]
          - id: MakeSpawnTransform
            type: CallFunction
            properties:
              function: MakeTransform
              class: KismetMathLibrary
            position: [2000, 0]
          # ============================================================================
          # Guide Step 31: Spawn WardenCore via SpawnNPC
          # ============================================================================
          - id: SpawnCore
            type: SpawnNPC
            properties:
              npc_definition_variable: PhaseSpawnDefinition
            position: [2200, 0]
          # ============================================================================
          # Guide Step 32: Spawn corpse mesh if bSpawnCorpse
          # ============================================================================
          - id: GetSpawnCorpseFlag
            type: VariableGet
            properties:
              variable_name: bSpawnCorpse
            position: [2400, 100]
          - id: SpawnCorpseBranch
            type: Branch
            position: [2400, 0]
          - id: GetCorpseMesh
            type: VariableGet
            properties:
              variable_name: CorpseMesh
            position: [2600, 100]
          - id: CheckCorpseMeshValid
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [2600, 0]
          - id: CorpseMeshBranch
            type: Branch
            position: [2800, 0]
          - id: GetCorpseTransform
            type: CallFunction
            properties:
              function: GetTransform
              class: Actor
              target_self: true
            position: [2800, 150]
          # Spawn StaticMeshActor for corpse
          - id: SpawnCorpseActor
            type: SpawnActor
            properties:
              actor_class: StaticMeshActor
            position: [3000, 0]
          # Configure corpse mesh component
          - id: CastToSMA
            type: DynamicCast
            properties:
              target_class: StaticMeshActor
            position: [3200, 0]
          # [MANIFEST] BP_BiomechHost line 12276: GetComponentByClass + Cast pattern
          - id: GetStaticMeshComp
            type: CallFunction
            properties:
              function: GetComponentByClass
              class: Actor
              param.ComponentClass: StaticMeshComponent
            position: [3400, 0]
          - id: CastToStaticMeshComp
            type: DynamicCast
            properties:
              target_class: StaticMeshComponent
            position: [3500, 0]
          - id: SetCorpseMesh
            type: CallFunction
            properties:
              function: SetStaticMesh
              class: StaticMeshComponent
            position: [3600, 0]
          - id: MakeTrueLiteral
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
            data:
              bool_value: true
            position: [3600, 150]
          - id: SetSimulatePhysics
            type: CallFunction
            properties:
              function: SetSimulatePhysics
              class: PrimitiveComponent
            position: [3800, 0]
          # ============================================================================
          # Guide Step 33: Call parent HandleDeath (all paths converge)
          # ============================================================================
          - id: CallParentDeath
            type: CallParent
            position: [4000, 0]
        connections:
          # Authority check
          - from: [FunctionEntry, Then]
            to: [HasAuth, Exec]
          - from: [HasAuth, ReturnValue]
            to: [AuthBranch, Condition]
          - from: [HasAuth, Exec]
            to: [AuthBranch, Exec]
          # Non-authority goes straight to parent
          - from: [AuthBranch, False]
            to: [CallParentDeath, Exec]
          # Check definition valid (Guide Step 28)
          - from: [AuthBranch, True]
            to: [CheckDefinitionValid, Exec]
          - from: [GetSpawnDefinition, PhaseSpawnDefinition]
            to: [CheckDefinitionValid, Object]
          - from: [CheckDefinitionValid, ReturnValue]
            to: [DefinitionBranch, Condition]
          - from: [CheckDefinitionValid, Exec]
            to: [DefinitionBranch, Exec]
          # Invalid definition goes to parent (skip spawn)
          - from: [DefinitionBranch, False]
            to: [CallParentDeath, Exec]
          # Check montage valid (Guide Step 29)
          - from: [DefinitionBranch, True]
            to: [CheckMontageValid, Exec]
          - from: [GetEjectionMontage, EjectionMontage]
            to: [CheckMontageValid, Object]
          - from: [CheckMontageValid, ReturnValue]
            to: [MontageBranch, Condition]
          - from: [CheckMontageValid, Exec]
            to: [MontageBranch, Exec]
          # Play montage if valid (True), skip if not (False)
          - from: [MontageBranch, True]
            to: [PlayMontage, Exec]
          - from: [SelfForMontage, self]
            to: [PlayMontage, Target]
          - from: [GetEjectionMontage, EjectionMontage]
            to: [PlayMontage, AnimMontage]
          # Both branches continue to spawn location calculation
          - from: [PlayMontage, Exec]
            to: [GetActorLocation, Exec]
          - from: [MontageBranch, False]
            to: [GetActorLocation, Exec]
          # Calculate spawn location with offset (Guide Step 30)
          - from: [GetActorLocation, ReturnValue]
            to: [AddOffset, A]
          - from: [GetSpawnOffset, SpawnOffset]
            to: [AddOffset, B]
          # Make spawn transform
          - from: [AddOffset, ReturnValue]
            to: [MakeSpawnTransform, Location]
          - from: [GetActorRotation, ReturnValue]
            to: [MakeSpawnTransform, Rotation]
          - from: [GetActorLocation, Exec]
            to: [MakeSpawnTransform, Exec]
          # Spawn core (Guide Step 31)
          - from: [MakeSpawnTransform, Exec]
            to: [SpawnCore, Exec]
          - from: [GetSpawnDefinition, PhaseSpawnDefinition]
            to: [SpawnCore, NPCData]
          - from: [MakeSpawnTransform, ReturnValue]
            to: [SpawnCore, Transform]
          # Check if should spawn corpse (Guide Step 32)
          - from: [SpawnCore, Then]
            to: [SpawnCorpseBranch, Exec]
          - from: [GetSpawnCorpseFlag, bSpawnCorpse]
            to: [SpawnCorpseBranch, Condition]
          # If should spawn corpse, check mesh valid
          - from: [SpawnCorpseBranch, True]
            to: [CheckCorpseMeshValid, Exec]
          - from: [GetCorpseMesh, CorpseMesh]
            to: [CheckCorpseMeshValid, Object]
          - from: [CheckCorpseMeshValid, ReturnValue]
            to: [CorpseMeshBranch, Condition]
          - from: [CheckCorpseMeshValid, Exec]
            to: [CorpseMeshBranch, Exec]
          # If mesh valid, spawn corpse actor
          - from: [CorpseMeshBranch, True]
            to: [SpawnCorpseActor, Exec]
          - from: [GetCorpseTransform, ReturnValue]
            to: [SpawnCorpseActor, SpawnTransform]
          # Cast to StaticMeshActor and configure
          - from: [SpawnCorpseActor, Exec]
            to: [CastToSMA, Exec]
          - from: [SpawnCorpseActor, ReturnValue]
            to: [CastToSMA, Object]
          # [MANIFEST] BP_BiomechHost pattern: GetComponentByClass + Cast
          - from: [CastToSMA, Then]
            to: [GetStaticMeshComp, Exec]
          - from: [CastToSMA, AsStaticMeshActor]
            to: [GetStaticMeshComp, Target]
          - from: [GetStaticMeshComp, ReturnValue]
            to: [CastToStaticMeshComp, Object]
          - from: [GetStaticMeshComp, Exec]
            to: [CastToStaticMeshComp, Exec]
          - from: [CastToStaticMeshComp, Then]
            to: [SetCorpseMesh, Exec]
          - from: [CastToStaticMeshComp, AsStaticMeshComponent]
            to: [SetCorpseMesh, Target]
          - from: [GetCorpseMesh, CorpseMesh]
            to: [SetCorpseMesh, NewMesh]
          - from: [SetCorpseMesh, Exec]
            to: [SetSimulatePhysics, Exec]
          - from: [CastToStaticMeshComp, AsStaticMeshComponent]
            to: [SetSimulatePhysics, Target]
          - from: [MakeTrueLiteral, ReturnValue]
            to: [SetSimulatePhysics, bSimulate]
          # All paths converge to CallParentDeath
          - from: [SetSimulatePhysics, Exec]
            to: [CallParentDeath, Exec]
          - from: [CorpseMeshBranch, False]
            to: [CallParentDeath, Exec]
          - from: [SpawnCorpseBranch, False]
            to: [CallParentDeath, Exec]

  # v7.8.16: Added missing variables per Warden_Husk_System_Implementation_Guide_v1_4.md Phase 4
  - name: BP_WardenCore
    folder: Enemies/Warden
    parent_class: NarrativeNPCCharacter
    variables:
      # Guide Phase 4.1.1 - Flight movement speed
      - name: FlightSpeed
        type: Float
        default_value: "600.0"
        instance_editable: true
      # Guide Phase 4.1.2 - Altitude to maintain above ground
      - name: FlightAltitude
        type: Float
        default_value: "300.0"
        instance_editable: true
      # Guide Phase 4.1.3 - Damage per laser hit
      - name: LaserDamage
        type: Float
        default_value: "50.0"
        instance_editable: true
      # Guide Phase 4.1.4 - Cooldown between laser shots
      - name: LaserCooldown
        type: Float
        default_value: "1.5"
        instance_editable: true
      # Guide Phase 4.1.5 - Maximum laser engagement range
      - name: LaserRange
        type: Float
        default_value: "2000.0"
        instance_editable: true
      # Guide Phase 4.1.6 - Projectile class for laser
      - name: ProjectileClass
        type: Class
        class: NarrativeProjectile
        instance_editable: true
      # Guide Phase 4.1.7 - Offset from core center for laser spawn
      - name: LaserSpawnOffset
        type: Vector
        default_value: "(X=50, Y=0, Z=0)"
        instance_editable: true
    event_graph:
      nodes:
        # BeginPlay - Set Flying movement mode for hovering behavior
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        - id: SelfRef
          type: Self
          position: [100, 100]
        - id: GetCharMovement
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [300, 0]
        - id: SetMovementMode
          type: CallFunction
          properties:
            function: SetMovementMode
            class: CharacterMovementComponent
            parameters:
              NewMovementMode: Flying
          position: [600, 0]
      connections:
        - from: [Event_BeginPlay, Then]
          to: [SetMovementMode, Exec]
        - from: [SelfRef, Self]
          to: [GetCharMovement, Target]
        - from: [GetCharMovement, CharacterMovement]
          to: [SetMovementMode, Target]

  - name: BP_CoreLaserProjectile
    folder: Enemies/Warden
    parent_class: NarrativeProjectile

materials:  # WARDEN SYSTEM
  - name: M_CoreLaserGlow
    folder: Enemies/Warden/Materials
    blend_mode: Additive
    shading_model: Unlit

gameplay_abilities:  # WARDEN SYSTEM (NOT Father Companion - see Warden_Husk_System_Implementation_Guide_v1_2.md)
  # GA_CoreLaser - Warden Core Laser Attack
  # v7.1: INC-WARDEN-CORELASER-1 FIXED - Added input_tag and full implementation
  # R-INPUTTAG-1: NPC combat abilities used by BPA_Attack_* MUST have valid input_tag
  - name: GA_CoreLaser
    folder: Enemies/Warden/Abilities
    parent_class: NarrativeGameplayAbility
    instancing_policy: InstancedPerActor
    net_execution_policy: ServerOnly
    cooldown_gameplay_effect_class: GE_CoreLaserCooldown
    # v7.1: CRITICAL - Required for BPA_Attack_Ranged activation via AbilityInputTagPressed
    input_tag: Narrative.Input.Attack
    # v7.1: Bot tuning properties for AI attack behavior
    bot_attack_frequency: 2.0
    bot_attack_range: 1500.0
    tags:
      ability_tags:
        - Ability.Warden.CoreLaser
      activation_owned_tags:
        - State.Warden.Attacking
      activation_blocked_tags:
        - Cooldown.Warden.CoreLaser
    variables:
      # v7.3: LaserDamage variable removed - damage now from AttackDamage attribute via NarrativeDamageExecCalc
      - name: TargetActor
        type: Object
        class: Actor
      # v7.8.16: Guide missing variables - ProjectileClass for spawning laser projectile
      - name: ProjectileClass
        type: Class
        class: NarrativeProjectile
        default_value: BP_CoreLaserProjectile
        instance_editable: true
      # v7.8.16: Maximum engagement range
      - name: MaxRange
        type: Float
        default_value: "2000.0"
        instance_editable: true
      # v7.8.16: Offset from owner for projectile spawn location
      - name: LaserSpawnOffset
        type: Vector
        default_value: "(X=50, Y=0, Z=0)"
        instance_editable: true
    event_graph:
      nodes:
        # Activation - Get target from AI blackboard and apply damage
        - id: Event_Activate
          type: Event
          properties:
            event_name: K2_ActivateAbility
          position: [0, 0]
        # Get avatar actor (the Warden Core NPC)
        - id: GetAvatarActor
          type: CallFunction
          properties:
            function: GetAvatarActorFromActorInfo
            target_self: true
          position: [300, 0]
        # Cast to NarrativeNPCCharacter to get AI controller
        - id: CastToNPC
          type: DynamicCast
          properties:
            target_class: NarrativeNPCCharacter
          position: [600, 0]
        # Get AI Controller from NPC (v7.4: Use function, not property - Controller not BP-visible)
        - id: GetAIController
          type: CallFunction
          properties:
            function: GetController
            class: Pawn
          position: [900, 0]
        # Cast controller to AIController to access blackboard
        - id: CastToAIController
          type: DynamicCast
          properties:
            target_class: AIController
          position: [1200, 0]
        # Get Blackboard component from AI Controller
        - id: GetBlackboard
          type: PropertyGet
          properties:
            property_name: Blackboard
            target_class: AIController
          position: [1500, 0]
        # Get NarrativeProSettings for canonical BB key access (P-BB-KEY-2)
        - id: GetNarrativeProSettings
          type: CallFunction
          properties:
            function: GetNarrativeProSettings
            class: ArsenalStatics
          position: [1500, 100]
        # Get BBKey_AttackTarget from settings
        - id: GetBBKeyAttackTarget
          type: PropertyGet
          properties:
            property_name: BBKey_AttackTarget
            target_class: ArsenalSettings
          position: [1800, 100]
        # Get attack target from blackboard (AI sets this)
        - id: GetAttackTarget
          type: CallFunction
          properties:
            function: GetValueAsObject
            class: BlackboardComponent
          position: [2100, 0]
        # Validate target exists
        - id: IsValid
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [2400, 0]
        - id: BranchValid
          type: Branch
          position: [2700, 0]
        # v7.2: Cast UObject to Actor for ASC lookup (GetAbilitySystemComponent requires AActor*)
        - id: CastToActor
          type: DynamicCast
          properties:
            target_class: Actor
          position: [2850, 0]
        # Store target for later use
        - id: SetTargetActor
          type: VariableSet
          properties:
            variable_name: TargetActor
          position: [3000, 0]
        # v7.5: Get OWNING ASC (ability's ASC) - this is the source that applies the effect
        - id: GetOwnASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponentFromActorInfo
            target_self: true
          position: [3300, 80]
        # v7.5: Get TARGET ASC - the ASC to receive the effect
        - id: GetTargetASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [3300, 160]
        # Make damage GE spec (v7.3: uses NarrativeDamageExecCalc - damage from AttackDamage attribute)
        - id: MakeDamageSpec
          type: CallFunction
          properties:
            function: MakeOutgoingGameplayEffectSpec
            target_self: true
            param.GameplayEffectClass: GE_CoreLaserDamage
          position: [3600, 0]
        # Apply damage GE to target (v7.3: simplified - no SetByCaller needed)
        - id: ApplyDamageGE
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectSpecToTarget
          position: [4200, 0]
        # Commit cooldown after successful damage
        - id: CommitCooldown
          type: CallFunction
          properties:
            function: K2_CommitAbilityCooldown
            target_self: true
          position: [4500, 0]
        # End ability (success path)
        - id: EndAbility
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [4800, 0]
        # End ability (no target path)
        - id: EndAbility_NoTarget
          type: CallFunction
          properties:
            function: K2_EndAbility
            target_self: true
          position: [3000, 200]
      connections:
        # Main execution flow
        - from: [Event_Activate, Then]
          to: [CastToNPC, Exec]
        - from: [GetAvatarActor, ReturnValue]
          to: [CastToNPC, Object]
        - from: [CastToNPC, Then]
          to: [CastToAIController, Exec]
        - from: [CastToNPC, As Narrative NPCCharacter]
          to: [GetAIController, Target]
        # v7.4: ReturnValue for CallFunction (not Controller from PropertyGet)
        - from: [GetAIController, ReturnValue]
          to: [CastToAIController, Object]
        # v7.2: Direct exec connection - GetAttackTarget/IsValid are pure (no exec pins)
        - from: [CastToAIController, Then]
          to: [BranchValid, Exec]
        # v7.4: Pin name fix - AsAIController (no space)
        - from: [CastToAIController, AsAIController]
          to: [GetBlackboard, Target]
        - from: [GetBlackboard, Blackboard]
          to: [GetAttackTarget, Target]
        # P-BB-KEY-2: Use NarrativeProSettings for BB key name
        - from: [GetNarrativeProSettings, ReturnValue]
          to: [GetBBKeyAttackTarget, Target]
        - from: [GetBBKeyAttackTarget, BBKey_AttackTarget]
          to: [GetAttackTarget, KeyName]
        # Target validation (data connections only - pure nodes)
        - from: [GetAttackTarget, ReturnValue]
          to: [IsValid, Object]
        - from: [IsValid, ReturnValue]
          to: [BranchValid, Condition]
        # Valid target path - v7.2: Route through CastToActor for type safety
        - from: [BranchValid, True]
          to: [CastToActor, Exec]
        - from: [GetAttackTarget, ReturnValue]
          to: [CastToActor, Object]
        - from: [CastToActor, Then]
          to: [SetTargetActor, Exec]
        - from: [CastToActor, AsActor]
          to: [SetTargetActor, TargetActor]
        # v7.3: Simplified - direct to ApplyDamageGE (no SetByCaller)
        - from: [SetTargetActor, Then]
          to: [ApplyDamageGE, Exec]
        # v7.5: ASC version - OwnASC.self calls the function, TargetASC.Target receives the effect
        - from: [CastToActor, AsActor]
          to: [GetTargetASC, Actor]
        - from: [GetOwnASC, ReturnValue]
          to: [ApplyDamageGE, self]
        - from: [GetTargetASC, ReturnValue]
          to: [ApplyDamageGE, Target]
        # v7.3: Direct spec connection (damage from AttackDamage attribute via NarrativeDamageExecCalc)
        - from: [MakeDamageSpec, ReturnValue]
          to: [ApplyDamageGE, Spec]
        # Commit cooldown and end
        - from: [ApplyDamageGE, Exec]
          to: [CommitCooldown, Exec]
        - from: [CommitCooldown, Exec]
          to: [EndAbility, Exec]
        # No target path - end immediately
        - from: [BranchValid, False]
          to: [EndAbility_NoTarget, Exec]
        # Cast fail paths - end ability (v7.4: pin name fix - CastFailed, no space)
        - from: [CastToNPC, CastFailed]
          to: [EndAbility_NoTarget, Exec]
        - from: [CastToAIController, CastFailed]
          to: [EndAbility_NoTarget, Exec]
        - from: [CastToActor, CastFailed]
          to: [EndAbility_NoTarget, Exec]

# ============================================================================
# NPC SYSTEMS - GUARD FORMATION
# ============================================================================
tags:  # GUARD FORMATION
  - tag: Narrative.State.NPC.Activity.FormationFollow
    comment: NPC is following in formation

gameplay_effects:  # GUARD FORMATION
  # v7.8.23: GF-2 fix - Guard attributes per Guard_Formation_Follow_System_Implementation_Guide_v2_6.md
  # Formation Guards are balanced defensive NPCs (150 HP, 20 ATK, 15 Armor)
  - name: GE_FormationGuardAttributes
    folder: Enemies/Formation/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 150.0
      - attribute: NarrativeAttributeSetBase.Health
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 150.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 20.0
      - attribute: NarrativeAttributeSetBase.Armor
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 15.0

blackboards:  # GUARD FORMATION
  - name: BB_FormationFollow
    folder: AI/Blackboards
    keys:
      - key_name: SelfActor
        key_type: Object
        base_class: Actor
      - key_name: FollowTarget
        key_type: Object
        base_class: Actor
      # NOTE: TargetCharacter removed in v4.37.2 - use FollowTarget per Narrative Pro BBKey_FollowTarget standard
      - key_name: FormationOffset
        key_type: Vector
      - key_name: TargetLocation
        key_type: Vector

behavior_trees:  # GUARD FORMATION
  - name: BT_FormationFollow
    folder: AI/BehaviorTrees
    blackboard: BB_FormationFollow
    root_type: Selector
    description: Formation follow behavior
    nodes:
      # Root Selector - Formation follow with position calculation
      - id: root_selector
        type: Selector
        decorators:
          - class: BTDecorator_Blackboard
            blackboard_key: FollowTarget
            key_query: IsSet
        children:
          - formation_sequence
      # Formation Sequence - Calculate position and move
      - id: formation_sequence
        type: Sequence
        services:
          - class: BTS_CalculateFormationPosition
            interval: 0.25
          - class: BTS_AdjustFormationSpeed
            interval: 0.1
        children:
          - move_to_formation
      - id: move_to_formation
        type: Task
        task_class: BTTask_MoveTo
        blackboard_key: TargetLocation
        properties:
          AcceptableRadius: "50.0"

actor_blueprints:  # GUARD FORMATION GOALS (must come before activities that reference them)
  # v7.8.36: Goal_FormationFollow moved here so it's generated BEFORE BPA_FormationFollow
  # Guard_Formation_Follow_System_Implementation_Guide_v2_6.md Phase 3
  # v7.8.17: Use simple class name - generator resolves via search paths
  - name: Goal_FormationFollow
    folder: AI/Goals
    parent_class: Goal_FollowCharacter
    # v7.8.35: CDO properties for NPCGoalItem
    default_score: 50.0
    goal_lifetime: -1.0
    remove_on_succeeded: false
    save_goal: false
    owned_tags:
      - State.NPC.FormationFollow
    variables:
      # Phase 3.1: Vector offset from leader for formation positioning
      - name: FormationOffset
        type: Vector
        instance_editable: true
        expose_on_spawn: true
      # Phase 3.2: Index in formation array for slot assignment
      - name: FormationIndex
        type: Integer
        instance_editable: true
        expose_on_spawn: true

actor_blueprints:  # GUARD FORMATION ACTIVITIES
  # v7.8.35: Moved to actor_blueprints for variables/function_overrides support
  # v7.8.17: Full implementation per Guard_Formation_Follow_System_Implementation_Guide_v2_6.md Phase 7
  # v7.8.17: P-BB-KEY-2 compliant - uses GetNarrativeProSettings for BBKey_FollowTarget
  - name: BPA_FormationFollow
    folder: AI/Activities
    parent_class: NPCActivity
    # v7.8.35: CDO properties for NPCActivity
    activity_name: "Formation Follow"
    behavior_tree: BT_FormationFollow
    supported_goal_type: Goal_FormationFollow
    is_interruptable: false
    owned_tags:
      - State.NPC.FormationFollow
    variables:
      # Guide Phase 7 Step 3.1: Store cast goal reference
      - name: FormationGoal
        type: Object
        class: Goal_FormationFollow
        category: Formation
      # v7.8.17: Only FormationOffset is custom - FollowTarget uses P-BB-KEY-2
      - name: BBKey_FormationOffset
        type: Name
        default_value: "FormationOffset"
    # SetupBlackboard override - Guide Phase 7 Steps 5.1-5.11
    function_overrides:
      - function: SetupBlackboard
        return_type: Boolean
        nodes:
          # v7.8.17: P-BB-KEY-2 - Get NarrativeProSettings for canonical BB keys
          - id: GetNarrativeProSettings
            type: CallFunction
            properties:
              function: GetNarrativeProSettings
              class: ArsenalStatics
            position: [50, -100]
          - id: GetBBKey_FollowTarget
            type: PropertyGet
            properties:
              property_name: BBKey_FollowTarget
              target_class: ArsenalSettings
            position: [250, -100]
          # v7.8.39: Self reference for PropertyGet in function override
          - id: SelfRef
            type: Self
            position: [50, 0]
          # v7.8.35: ActivityGoal is a PROPERTY on NPCActivity, not a function parameter
          - id: GetActivityGoal
            type: PropertyGet
            properties:
              property_name: ActivityGoal
              target_class: NPCActivity
            position: [100, 0]
          # Cast ActivityGoal to Goal_FormationFollow (Guide 5.2)
          - id: CastToFormationGoal
            type: DynamicCast
            properties:
              target_class: Goal_FormationFollow
            position: [200, 0]
          # Store cast result (Guide 5.3)
          - id: SetFormationGoal
            type: VariableSet
            properties:
              variable_name: FormationGoal
            position: [400, 0]
          # Get Target to Follow from goal (Guide 5.4)
          # v7.8.37: Changed to PropertyGet - TargetToFollow is a property on Goal_FollowCharacter
          - id: GetTargetToFollow
            type: PropertyGet
            properties:
              property_name: TargetToFollow
              target_class: /NarrativePro/Pro/Core/AI/Activities/FollowCharacter/Goal_FollowCharacter.Goal_FollowCharacter_C
            position: [600, 0]
          # IsValid check on target (Guide 5.5)
          - id: IsValidTarget
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [800, 0]
          - id: ValidBranch
            type: Branch
            position: [950, 0]
          # === VALID PATH: Set FollowTarget directly (Guide 5.7) ===
          # v7.8.17: GetBBKeyFollow_Valid removed - using P-BB-KEY-2 PropertyGet at top
          - id: SetFollowTarget_Valid
            type: CallFunction
            properties:
              function: SetValueAsObject
              class: BlackboardComponent
            position: [1250, 0]
          # Set FormationOffset on blackboard (Guide 5.9 - Valid path)
          - id: GetBBKeyOffset_Valid
            type: VariableGet
            properties:
              variable_name: BBKey_FormationOffset
            position: [1450, -50]
          # v7.8.37: Changed to PropertyGet - FormationOffset is a variable on Goal_FormationFollow
          - id: GetFormationOffset_Valid
            type: PropertyGet
            properties:
              property_name: FormationOffset
              target_class: Goal_FormationFollow
            position: [1450, 50]
          - id: SetFormationOffset_Valid
            type: CallFunction
            properties:
              function: SetValueAsVector
              class: BlackboardComponent
            position: [1600, 0]
          # === INVALID PATH: Find character via subsystem (Guide 5.6, 5.8) ===
          # Get Target to Follow Asset (CharacterDefinition)
          # v7.8.37: Changed to PropertyGet - TargetToFollowAsset is a property on Goal_FollowCharacter
          - id: GetTargetAsset
            type: PropertyGet
            properties:
              property_name: TargetToFollowAsset
              target_class: /NarrativePro/Pro/Core/AI/Activities/FollowCharacter/Goal_FollowCharacter.Goal_FollowCharacter_C
            position: [1100, 200]
          # v7.8.40: FindCharacterFromSubsystem composite node
          # [ENGINE] NarrativeCharacterSubsystem::FindCharacter is BlueprintCallable (line 154-155)
          # [MANIFEST] Uses same internal-connection pattern as SpawnNPC (connections survive compilation)
          # Internally creates: GetWorldSubsystem<NarrativeCharacterSubsystem>() -> FindCharacter()
          - id: FindCharacter
            type: FindCharacterFromSubsystem
            position: [1200, 300]
          # v7.8.17: GetBBKeyFollow_Invalid removed - using P-BB-KEY-2 PropertyGet at top
          - id: SetFollowTarget_Invalid
            type: CallFunction
            properties:
              function: SetValueAsObject
              class: BlackboardComponent
            position: [1600, 200]
          # Set FormationOffset on blackboard (Guide 5.10 - Invalid path)
          - id: GetBBKeyOffset_Invalid
            type: VariableGet
            properties:
              variable_name: BBKey_FormationOffset
            position: [1800, 150]
          # v7.8.37: Changed to PropertyGet - FormationOffset is a variable on Goal_FormationFollow
          - id: GetFormationOffset_Invalid
            type: PropertyGet
            properties:
              property_name: FormationOffset
              target_class: Goal_FormationFollow
            position: [1800, 250]
          - id: SetFormationOffset_Invalid
            type: CallFunction
            properties:
              function: SetValueAsVector
              class: BlackboardComponent
            position: [1950, 200]
          # Return true (Guide 5.11)
          - id: ReturnTrue
            type: Return
            position: [2150, 100]
          - id: MakeTrue
            type: MakeLiteralBool
            properties:
              value: "true"
            position: [2000, 100]
        connections:
          # v7.8.17: P-BB-KEY-2 - NarrativeProSettings BB Key Access
          - from: [GetNarrativeProSettings, ReturnValue]
            to: [GetBBKey_FollowTarget, Target]
          # Entry -> Cast
          - from: [FunctionEntry, Then]
            to: [CastToFormationGoal, Exec]
          # v7.8.39: Self -> ActivityGoal PropertyGet
          - from: [SelfRef, self]
            to: [GetActivityGoal, Target]
          # v7.8.35: ActivityGoal is accessed via PropertyGet, not function parameter
          - from: [GetActivityGoal, ActivityGoal]
            to: [CastToFormationGoal, Object]
          # Cast -> Set FormationGoal
          - from: [CastToFormationGoal, Then]
            to: [SetFormationGoal, Exec]
          - from: [CastToFormationGoal, AsGoal_FormationFollow]
            to: [SetFormationGoal, FormationGoal]
          # Get Target to Follow (pure)
          - from: [SetFormationGoal, FormationGoal]
            to: [GetTargetToFollow, Target]
          - from: [GetTargetToFollow, ReturnValue]
            to: [IsValidTarget, Object]
          # Set -> IsValid -> Branch
          - from: [SetFormationGoal, Then]
            to: [ValidBranch, Exec]
          - from: [IsValidTarget, ReturnValue]
            to: [ValidBranch, Condition]
          # === VALID PATH ===
          - from: [ValidBranch, True]
            to: [SetFollowTarget_Valid, Exec]
          - from: [FunctionEntry, BB]
            to: [SetFollowTarget_Valid, Target]
          # v7.8.17: P-BB-KEY-2 - Use PropertyGet from ArsenalSettings
          - from: [GetBBKey_FollowTarget, BBKey_FollowTarget]
            to: [SetFollowTarget_Valid, KeyName]
          - from: [GetTargetToFollow, ReturnValue]
            to: [SetFollowTarget_Valid, ObjectValue]
          # Set FormationOffset (Valid path)
          - from: [SetFollowTarget_Valid, Then]
            to: [SetFormationOffset_Valid, Exec]
          - from: [FunctionEntry, BB]
            to: [SetFormationOffset_Valid, Target]
          - from: [GetBBKeyOffset_Valid, BBKey_FormationOffset]
            to: [SetFormationOffset_Valid, KeyName]
          - from: [SetFormationGoal, FormationGoal]
            to: [GetFormationOffset_Valid, Target]
          - from: [GetFormationOffset_Valid, ReturnValue]
            to: [SetFormationOffset_Valid, VectorValue]
          # Valid path -> Return
          - from: [SetFormationOffset_Valid, Then]
            to: [ReturnTrue, Exec]
          # === INVALID PATH ===
          - from: [ValidBranch, False]
            to: [SetFollowTarget_Invalid, Exec]
          # Find character via subsystem
          - from: [SetFormationGoal, FormationGoal]
            to: [GetTargetAsset, Target]
          # v7.8.40: FindCharacterFromSubsystem composite node handles GetSubsystem->FindCharacter internally
          # Only need to provide CharacterDefinition input - Target/self connection is made during node creation
          - from: [GetTargetAsset, ReturnValue]
            to: [FindCharacter, CharacterDefinition]
          # Set FollowTarget from FindCharacter
          - from: [FunctionEntry, BB]
            to: [SetFollowTarget_Invalid, Target]
          # v7.8.17: P-BB-KEY-2 - Use PropertyGet from ArsenalSettings
          - from: [GetBBKey_FollowTarget, BBKey_FollowTarget]
            to: [SetFollowTarget_Invalid, KeyName]
          - from: [FindCharacter, ReturnValue]
            to: [SetFollowTarget_Invalid, ObjectValue]
          # Set FormationOffset (Invalid path)
          - from: [SetFollowTarget_Invalid, Then]
            to: [SetFormationOffset_Invalid, Exec]
          - from: [FunctionEntry, BB]
            to: [SetFormationOffset_Invalid, Target]
          - from: [GetBBKeyOffset_Invalid, BBKey_FormationOffset]
            to: [SetFormationOffset_Invalid, KeyName]
          - from: [SetFormationGoal, FormationGoal]
            to: [GetFormationOffset_Invalid, Target]
          - from: [GetFormationOffset_Invalid, ReturnValue]
            to: [SetFormationOffset_Invalid, VectorValue]
          # Invalid path -> Return
          - from: [SetFormationOffset_Invalid, Then]
            to: [ReturnTrue, Exec]
          # Return value
          - from: [MakeTrue, ReturnValue]
            to: [ReturnTrue, ReturnValue]

  # v7.8.17: Full implementation per Guard_Formation_Follow_System_Implementation_Guide_v2_6.md Phase 8
  # v7.8.17: P-BB-KEY-2 compliant - uses GetNarrativeProSettings for BBKey_TargetLocation
  # BPA_Attack_Formation - Leash attack behavior for formation guards
  - name: BPA_Attack_Formation
    folder: AI/Activities
    parent_class: /NarrativePro/Pro/Core/AI/Activities/Attacks/MeleeAttack/BPA_Attack_Melee.BPA_Attack_Melee_C
    variables:
      # Guide Phase 8 Step 3.1: LeashRadius - max distance from formation position to attack
      - name: LeashRadius
        type: Float
        default_value: "400.0"
        instance_editable: true
        category: Formation
      # v7.8.17: BBKey_TargetLocation removed - using P-BB-KEY-2 pattern instead
    # ScoreGoalItem override - Guide Phase 8 Steps 4-6
    function_overrides:
      - function: ScoreGoalItem
        # Returns parent score if enemy within LeashRadius, 0 if outside
        nodes:
          # v7.8.17: P-BB-KEY-2 - Get NarrativeProSettings for canonical BB keys
          - id: GetNarrativeProSettings
            type: CallFunction
            properties:
              function: GetNarrativeProSettings
              class: ArsenalStatics
            position: [50, 300]
          - id: GetBBKey_TargetLocation
            type: PropertyGet
            properties:
              property_name: BBKey_TargetLocation
              target_class: ArsenalSettings
            position: [250, 300]
          # Cast GoalItem to Goal_Attack (Guide 5.1)
          - id: CastToGoalAttack
            type: DynamicCast
            properties:
              target_class: Goal_Attack
            position: [200, 0]
          # Get Target Actor from Goal_Attack (Guide 5.1.4-5.1.5)
          # v7.8.37: Changed to PropertyGet - TargetToAttack is the property on Goal_Attack
          - id: GetTargetActor
            type: PropertyGet
            properties:
              property_name: TargetToAttack
              target_class: Goal_Attack
            position: [400, 0]
          # Get enemy location (Guide 5.1.7)
          - id: GetEnemyLocation
            type: CallFunction
            properties:
              function: K2_GetActorLocation
              class: Actor
            position: [600, 0]
          # v7.8.39: Self reference for PropertyGet in function override
          - id: SelfRef
            type: Self
            position: [100, 150]
          # Get Owner Controller (Guide 5.2.1)
          # v7.8.37: Changed to PropertyGet - OwnerController is a property on NPCActivity
          - id: GetOwnerController
            type: PropertyGet
            properties:
              property_name: OwnerController
              target_class: NPCActivity
            position: [200, 150]
          # Get Blackboard Component (Guide 5.2.2-5.2.3)
          - id: GetBlackboard
            type: PropertyGet
            properties:
              property_name: Blackboard
              target_class: AIController
            position: [400, 150]
          # v7.8.17: GetBBKeyVar removed - using P-BB-KEY-2 PropertyGet at top
          # Get formation position from blackboard (Guide 5.2.4-5.2.6)
          - id: GetFormationPosition
            type: CallFunction
            properties:
              function: GetValueAsVector
              class: BlackboardComponent
            position: [600, 150]
          # Subtract vectors to get direction (Guide 5.3.1-5.3.3)
          - id: SubtractVectors
            type: CallFunction
            properties:
              function: Subtract_VectorVector
              class: KismetMathLibrary
            position: [800, 0]
          # Get vector length (Guide 5.3.4-5.3.5)
          - id: VectorLength
            type: CallFunction
            properties:
              function: VSize
              class: KismetMathLibrary
            position: [1000, 0]
          # Get LeashRadius variable
          - id: GetLeashRadius
            type: VariableGet
            properties:
              variable_name: LeashRadius
            position: [1000, 100]
          # Compare distance <= LeashRadius (Guide 5.4.1-5.4.3)
          - id: LessOrEqual
            type: CallFunction
            properties:
              function: LessEqual_FloatFloat
              class: KismetMathLibrary
            position: [1200, 0]
          # Branch on leash check (Guide 5.4.5-5.4.6)
          - id: LeashBranch
            type: Branch
            position: [1400, 0]
          # True path: Call parent ScoreGoalItem (Guide 5.5.1-5.5.4)
          - id: CallParentScore
            type: CallParent
            properties:
              function: ScoreGoalItem
            position: [1600, 0]
          # Return parent score
          - id: ReturnParentScore
            type: Return
            position: [1800, 0]
          # False path: Return 0.0 (Guide 5.5.7-5.5.9)
          - id: MakeZero
            type: MakeLiteralFloat
            properties:
              value: "0.0"
            position: [1600, 150]
          - id: ReturnZero
            type: Return
            position: [1800, 150]
        connections:
          # v7.8.17: P-BB-KEY-2 - NarrativeProSettings BB Key Access
          - from: [GetNarrativeProSettings, ReturnValue]
            to: [GetBBKey_TargetLocation, Target]
          # Entry -> Cast to Goal_Attack
          - from: [FunctionEntry, Then]
            to: [CastToGoalAttack, Exec]
          - from: [FunctionEntry, GoalItem]
            to: [CastToGoalAttack, Object]
          # Cast -> Get Target Actor (pure chain)
          - from: [CastToGoalAttack, AsGoal_Attack]
            to: [GetTargetActor, Target]
          - from: [GetTargetActor, ReturnValue]
            to: [GetEnemyLocation, Target]
          # v7.8.39: Self -> Owner Controller -> Blackboard -> Formation Position (pure chain)
          - from: [SelfRef, self]
            to: [GetOwnerController, Target]
          - from: [GetOwnerController, ReturnValue]
            to: [GetBlackboard, Target]
          - from: [GetBlackboard, Blackboard]
            to: [GetFormationPosition, Target]
          # v7.8.17: P-BB-KEY-2 - Use PropertyGet from ArsenalSettings
          - from: [GetBBKey_TargetLocation, BBKey_TargetLocation]
            to: [GetFormationPosition, KeyName]
          # Calculate distance
          - from: [GetEnemyLocation, ReturnValue]
            to: [SubtractVectors, A]
          - from: [GetFormationPosition, ReturnValue]
            to: [SubtractVectors, B]
          - from: [SubtractVectors, ReturnValue]
            to: [VectorLength, A]
          # Compare with LeashRadius
          - from: [VectorLength, ReturnValue]
            to: [LessOrEqual, A]
          - from: [GetLeashRadius, LeashRadius]
            to: [LessOrEqual, B]
          - from: [LessOrEqual, ReturnValue]
            to: [LeashBranch, Condition]
          # Exec flow: Cast -> Branch
          - from: [CastToGoalAttack, Then]
            to: [LeashBranch, Exec]
          # True: Call parent and return
          - from: [LeashBranch, True]
            to: [CallParentScore, Exec]
          - from: [FunctionEntry, GoalItem]
            to: [CallParentScore, GoalItem]
          - from: [CallParentScore, Then]
            to: [ReturnParentScore, Exec]
          - from: [CallParentScore, ReturnValue]
            to: [ReturnParentScore, ReturnValue]
          # False: Return 0.0
          - from: [LeashBranch, False]
            to: [ReturnZero, Exec]
          - from: [MakeZero, ReturnValue]
            to: [ReturnZero, ReturnValue]

actor_blueprints:  # GUARD FORMATION BT SERVICES
  # v7.8.17: P-BB-KEY-2 compliant - uses GetNarrativeProSettings for canonical BB keys
  # v4.39.6: Full implementation per Guide v2.6 Phase 4 - vector offset with rotation
  # Uses FormationOffset (Vector) from blackboard, rotates by target rotation via RotateVector
  # Reference: Guard_Formation_Follow_System_Implementation_Guide_v2_6.md Phase 4 Node Connection Summary
  - name: BTS_CalculateFormationPosition
    folder: AI/Services
    parent_class: BTService_BlueprintBase
    variables:
      # v7.8.17: Only FormationOffset is custom - FollowTarget/TargetLocation use P-BB-KEY-2
      - name: BBKey_FormationOffset
        type: Name
        default_value: "FormationOffset"
    event_graph:
      nodes:
        # Step 4.1: Event Receive Tick AI - Called by BT Service on tick
        - id: Event_ReceiveTickAI
          type: Event
          properties:
            event_name: ReceiveTickAI
          position: [0, 0]
        # v7.8.17: P-BB-KEY-2 - Get NarrativeProSettings for canonical BB keys
        - id: GetNarrativeProSettings
          type: CallFunction
          properties:
            function: GetNarrativeProSettings
            class: ArsenalStatics
          position: [100, 150]
        - id: GetBBKey_FollowTarget
          type: PropertyGet
          properties:
            property_name: BBKey_FollowTarget
            target_class: ArsenalSettings
          position: [300, 100]
        - id: GetBBKey_TargetLocation
          type: PropertyGet
          properties:
            property_name: BBKey_TargetLocation
            target_class: ArsenalSettings
          position: [300, 200]
        # Step 4.2: Get Blackboard Component from OwnerController
        # v4.40.4: Use PropertyGet for Blackboard (GetBlackboardComponent is C++ inline, not UFUNCTION)
        - id: GetBlackboard
          type: PropertyGet
          properties:
            property_name: Blackboard
            target_class: AIController
          position: [200, 0]
        # Step 4.3: Get FollowTarget (Object) from blackboard
        - id: GetFollowTarget
          type: CallFunction
          properties:
            function: GetValueAsObject
            class: BlackboardComponent
          position: [400, 0]
        # Step 4.4: Cast to Actor
        - id: CastToActor
          type: DynamicCast
          properties:
            target_class: Actor
          position: [600, 0]
        # Step 4.5: Validate Follow Target - IsValid check with Branch
        - id: IsValidTarget
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [800, 0]
        - id: BranchValid
          type: Branch
          position: [950, 0]
        # Step 4.6: Get Follow Target Location
        - id: GetTargetLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
            class: Actor
          position: [1100, 0]
        # Step 4.7: Get Follow Target Rotation
        - id: GetTargetRotation
          type: CallFunction
          properties:
            function: K2_GetActorRotation
            class: Actor
          position: [1100, 100]
        # Step 4.8: Get FormationOffset (Vector) from blackboard
        - id: GetBBKey_FormationOffset
          type: VariableGet
          properties:
            variable_name: BBKey_FormationOffset
          position: [1100, 200]
        - id: GetFormationOffset
          type: CallFunction
          properties:
            function: GetValueAsVector
            class: BlackboardComponent
          position: [1300, 150]
        # Step 4.9: Rotate Offset by Target Rotation (per Guide v2.6 step 4.9)
        # v4.40.4: Use >> operator (GreaterGreater_VectorRotator) to rotate vector by rotator
        - id: RotateVector
          type: CallFunction
          properties:
            function: GreaterGreater_VectorRotator
            class: KismetMathLibrary
          position: [1500, 0]
        # Step 4.10: Calculate World Position = TargetLocation + RotatedOffset
        - id: AddVectors
          type: CallFunction
          properties:
            function: Add_VectorVector
            class: KismetMathLibrary
          position: [1700, 0]
        # Step 4.11: Set TargetLocation on Blackboard
        # v7.8.17: GetBBKey_TargetLocation moved to top of graph (P-BB-KEY-2 PropertyGet)
        - id: SetTargetLocation
          type: CallFunction
          properties:
            function: SetValueAsVector
            class: BlackboardComponent
          position: [1900, 0]
      connections:
        # === EXEC FLOW (Guide Steps 1, 6, 8) ===
        # Step 1: Event Receive Tick AI → Cast To Actor
        - from: [Event_ReceiveTickAI, Then]
          to: [CastToActor, Exec]
        # Step 6: Cast To Actor → Branch (via IsValid check)
        - from: [CastToActor, Exec]
          to: [BranchValid, Exec]
        # Step 8: Branch True → Set Value as Vector
        - from: [BranchValid, True]
          to: [SetTargetLocation, Exec]
        # === v7.8.17: P-BB-KEY-2 - NarrativeProSettings BB Key Access ===
        - from: [GetNarrativeProSettings, ReturnValue]
          to: [GetBBKey_FollowTarget, Target]
        - from: [GetNarrativeProSettings, ReturnValue]
          to: [GetBBKey_TargetLocation, Target]
        # === DATA FLOW - Blackboard Access (Guide Steps 2-5) ===
        # Step 2: Event Receive Tick AI OwnerController → Get Blackboard Component Target
        - from: [Event_ReceiveTickAI, OwnerController]
          to: [GetBlackboard, Target]
        # Step 3: Get Blackboard Component Return Value → Get Value as Object Target
        - from: [GetBlackboard, ReturnValue]
          to: [GetFollowTarget, Target]
        # Step 4: v7.8.17: P-BB-KEY-2 - BBKey_FollowTarget from ArsenalSettings PropertyGet
        - from: [GetBBKey_FollowTarget, BBKey_FollowTarget]
          to: [GetFollowTarget, KeyName]
        # Step 5: Get Value as Object Return Value → Cast To Actor Object
        - from: [GetFollowTarget, ReturnValue]
          to: [CastToActor, Object]
        # === DATA FLOW - Validation (Guide Step 7) ===
        # Step 7: Cast To Actor As Actor → Is Valid Input Object
        - from: [CastToActor, AsActor]
          to: [IsValidTarget, Object]
        - from: [IsValidTarget, ReturnValue]
          to: [BranchValid, Condition]
        # === DATA FLOW - Location and Rotation (Guide Steps 9-10) ===
        # Step 9: Cast To Actor As Actor → Get Actor Location Target
        - from: [CastToActor, AsActor]
          to: [GetTargetLocation, Target]
        # Step 10: Cast To Actor As Actor → Get Actor Rotation Target
        - from: [CastToActor, AsActor]
          to: [GetTargetRotation, Target]
        # === DATA FLOW - Formation Offset (Guide Steps 11-12) ===
        # Step 11: Get Blackboard Component Return Value → Get Value as Vector Target
        - from: [GetBlackboard, ReturnValue]
          to: [GetFormationOffset, Target]
        # Step 12: BBKey_FormationOffset Value → Get Value as Vector Key Name
        - from: [GetBBKey_FormationOffset, BBKey_FormationOffset]
          to: [GetFormationOffset, KeyName]
        # === DATA FLOW - Rotate Offset (Guide Steps 13-14) ===
        # Step 13: Get Actor Rotation Return Value → Rotate Vector B (Rotator)
        - from: [GetTargetRotation, ReturnValue]
          to: [RotateVector, B]
        # Step 14: Get Value as Vector Return Value → Rotate Vector A (Vector)
        - from: [GetFormationOffset, ReturnValue]
          to: [RotateVector, A]
        # === DATA FLOW - Calculate World Position (Guide Steps 15-16) ===
        # Step 15: Get Actor Location Return Value → Vector + Vector First Input
        - from: [GetTargetLocation, ReturnValue]
          to: [AddVectors, A]
        # Step 16: Rotate Vector Return Value → Vector + Vector Second Input
        - from: [RotateVector, ReturnValue]
          to: [AddVectors, B]
        # === DATA FLOW - Set Blackboard Value (Guide Steps 17-19) ===
        # Step 17: Get Blackboard Component Return Value → Set Value as Vector Target
        - from: [GetBlackboard, ReturnValue]
          to: [SetTargetLocation, Target]
        # Step 18: v7.8.17: P-BB-KEY-2 - BBKey_TargetLocation from ArsenalSettings PropertyGet
        - from: [GetBBKey_TargetLocation, BBKey_TargetLocation]
          to: [SetTargetLocation, KeyName]
        # Step 19: Vector + Vector Return Value → Set Value as Vector Vector Value
        - from: [AddVectors, ReturnValue]
          to: [SetTargetLocation, VectorValue]

  # v4.37.2: Enhanced with ReceiveActivationAI/DeactivationAI for P-MOVE-1 compliance
  - name: BTS_AdjustFormationSpeed
    folder: AI/Services
    parent_class: BTService_BlueprintBase
    variables:
      # Base walk speed for this guard
      - name: BaseWalkSpeed
        type: Float
        default_value: "400.0"
        instance_editable: true
      # v4.37.2: Store original speed for P-MOVE-1 restore pattern
      - name: OriginalWalkSpeed
        type: Float
        default_value: "0.0"
    event_graph:
      nodes:
        # ReceiveActivationAI - Store original speed (P-MOVE-1 pattern)
        - id: Event_ReceiveActivationAI
          type: Event
          properties:
            event_name: ReceiveActivationAI
          position: [0, -300]
        - id: CastToChar_Activate
          type: DynamicCast
          properties:
            target_class: Character
          position: [200, -300]
        - id: GetMovement_Activate
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [400, -300]
        - id: GetOriginalSpeed
          type: PropertyGet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [600, -300]
        - id: SetOriginalSpeed
          type: VariableSet
          properties:
            variable_name: OriginalWalkSpeed
          position: [800, -300]
        # ReceiveDeactivationAI - Restore original speed (P-MOVE-1 pattern)
        - id: Event_ReceiveDeactivationAI
          type: Event
          properties:
            event_name: ReceiveDeactivationAI
          position: [0, -500]
        - id: CastToChar_Deactivate
          type: DynamicCast
          properties:
            target_class: Character
          position: [200, -500]
        - id: GetMovement_Deactivate
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [400, -500]
        - id: GetStoredSpeed
          type: VariableGet
          properties:
            variable_name: OriginalWalkSpeed
          position: [600, -500]
        - id: RestoreSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [800, -500]
        # ReceiveTickAI - Adjust speed to match leader
        - id: Event_ReceiveTickAI
          type: Event
          properties:
            event_name: ReceiveTickAI
          position: [0, 0]
        # Get controlled pawn's movement component
        - id: GetMovementComp
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [300, 0]
        # Cast controlled pawn to character
        - id: CastToCharacter
          type: DynamicCast
          properties:
            target_class: Character
          position: [150, 100]
        # Get blackboard for leader info
        - id: GetBlackboard
          type: PropertyGet
          properties:
            property_name: Blackboard
            target_class: AIController
          position: [300, 200]
        # v4.38: P-BB-KEY-2 - Use Get Narrative Pro Settings for canonical BB keys
        - id: GetNarrativeProSettings
          type: CallFunction
          properties:
            function: GetNarrativeProSettings
            class: ArsenalStatics
          position: [400, 350]
        - id: GetBBKeyFollowTarget
          type: PropertyGet
          properties:
            property_name: BBKey_FollowTarget
            target_class: ArsenalSettings
          position: [550, 300]
        # Get FollowTarget (leader) - per Narrative Pro BBKey_FollowTarget
        - id: GetLeader
          type: CallFunction
          properties:
            function: GetValueAsObject
            class: BlackboardComponent
          position: [600, 200]
        # v4.32.2: Cast Object to Actor for GetVelocity call
        - id: CastToActor
          type: DynamicCast
          properties:
            target_class: Actor
          position: [750, 200]
        # Get leader's velocity magnitude
        - id: GetLeaderVelocity
          type: CallFunction
          properties:
            function: GetVelocity
            class: Actor
          position: [900, 200]
        - id: VectorLength
          type: CallFunction
          properties:
            function: VSize
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [1200, 200]
        # Set max walk speed to match (with minimum of BaseWalkSpeed)
        - id: ClampSpeed
          type: CallFunction
          properties:
            function: FMax
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [1500, 200]
        - id: GetBaseSpeed
          type: VariableGet
          properties:
            variable_name: BaseWalkSpeed
          position: [1350, 300]
        - id: SetMaxWalkSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [1800, 0]
      connections:
        # ReceiveActivationAI connections - Store original speed
        - from: [Event_ReceiveActivationAI, Then]
          to: [CastToChar_Activate, Exec]
        - from: [Event_ReceiveActivationAI, ControlledPawn]
          to: [CastToChar_Activate, Object]
        - from: [CastToChar_Activate, Exec]
          to: [SetOriginalSpeed, Exec]
        - from: [CastToChar_Activate, AsCharacter]
          to: [GetMovement_Activate, Target]
        - from: [GetMovement_Activate, CharacterMovement]
          to: [GetOriginalSpeed, Target]
        - from: [GetOriginalSpeed, MaxWalkSpeed]
          to: [SetOriginalSpeed, OriginalWalkSpeed]
        # ReceiveDeactivationAI connections - Restore original speed
        - from: [Event_ReceiveDeactivationAI, Then]
          to: [CastToChar_Deactivate, Exec]
        - from: [Event_ReceiveDeactivationAI, ControlledPawn]
          to: [CastToChar_Deactivate, Object]
        - from: [CastToChar_Deactivate, Exec]
          to: [RestoreSpeed, Exec]
        - from: [CastToChar_Deactivate, AsCharacter]
          to: [GetMovement_Deactivate, Target]
        - from: [GetMovement_Deactivate, CharacterMovement]
          to: [RestoreSpeed, Target]
        - from: [GetStoredSpeed, OriginalWalkSpeed]
          to: [RestoreSpeed, MaxWalkSpeed]
        # ReceiveTickAI connections - Adjust speed
        - from: [Event_ReceiveTickAI, Then]
          to: [CastToCharacter, Exec]
        - from: [Event_ReceiveTickAI, ControlledPawn]
          to: [CastToCharacter, Object]
        - from: [CastToCharacter, AsCharacter]
          to: [GetMovementComp, Target]
        - from: [Event_ReceiveTickAI, OwnerController]
          to: [GetBlackboard, Target]
        - from: [CastToCharacter, Exec]
          to: [GetBlackboard, Exec]
        - from: [GetBlackboard, ReturnValue]
          to: [GetLeader, Target]
        - from: [GetBlackboard, Exec]
          to: [GetLeader, Exec]
        # v4.38: P-BB-KEY-2 - Connect NarrativeProSettings BB key
        - from: [GetNarrativeProSettings, ReturnValue]
          to: [GetBBKeyFollowTarget, Target]
        - from: [GetBBKeyFollowTarget, BBKey_FollowTarget]
          to: [GetLeader, KeyName]
        - from: [GetLeader, ReturnValue]
          to: [CastToActor, Object]
        - from: [GetLeader, Exec]
          to: [CastToActor, Exec]
        - from: [CastToActor, AsActor]
          to: [GetLeaderVelocity, Target]
        - from: [GetLeaderVelocity, ReturnValue]
          to: [VectorLength, A]
        - from: [VectorLength, ReturnValue]
          to: [ClampSpeed, A]
        - from: [GetBaseSpeed, BaseWalkSpeed]
          to: [ClampSpeed, B]
        - from: [ClampSpeed, ReturnValue]
          to: [SetMaxWalkSpeed, MaxWalkSpeed]
        - from: [GetMovementComp, CharacterMovement]
          to: [SetMaxWalkSpeed, Target]
        - from: [CastToActor, Exec]
          to: [SetMaxWalkSpeed, Exec]

# v7.8.15: Goal_FormationFollow moved to actor_blueprints section (requires variables per Guide Phase 3)
# See Guard_Formation_Follow_System_Implementation_Guide_v2_6.md

# ============================================================================
# NPC SYSTEMS - POSSESSED EXPLODER
# ============================================================================
tags:  # POSSESSED EXPLODER
  - tag: State.Enemy.PossessedExploder
    comment: NPC identifier
  - tag: State.Enemy.Exploder.Alert
    comment: Applied during alert state
  - tag: Faction.Enemy.Possessed
    comment: Possessed faction identifier
  - tag: Effect.Enemy.ExplosionDamage
    comment: Explosion damage effect tag
  - tag: GameplayCue.Enemy.Exploder.Alert
    comment: Alert VFX/SFX trigger
  - tag: GameplayCue.Enemy.Exploder.Explosion
    comment: Explosion VFX/SFX trigger

gameplay_effects:  # POSSESSED EXPLODER
  # v7.8.4: Added modifiers per Possessed_Exploder_Enemy_Implementation_Guide_v2_2.md Phase 2
  - name: GE_ExploderAttributes
    folder: Enemies/Possessed/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 50.0
      - attribute: NarrativeAttributeSetBase.Health
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 50.0
      - attribute: NarrativeAttributeSetBase.Armor
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 0.0

  # v7.8.4: Added execution_calculations per guide Phase 2
  - name: GE_ExplosionDamage
    folder: Enemies/Possessed/Effects
    duration_policy: Instant
    execution_calculations:
      - class: NarrativeDamageExecCalc
    asset_tag: Effect.Enemy.ExplosionDamage
    gameplay_cues:
      - GameplayCue.Enemy.Exploder.Explosion

actor_blueprints:  # POSSESSED EXPLODER
  # v7.8.4: Added variables per Possessed_Exploder_Enemy_Implementation_Guide_v2_2.md
  - name: BP_PossessedExploder
    folder: Enemies/Possessed
    parent_class: NarrativeNPCCharacter
    variables:
      # Explosion parameters - used by BTS_CheckExplosionProximity
      - name: ExplosionRadius
        type: Float
        default_value: "300.0"
        instance_editable: true
        comment: Radius to trigger explosion
      - name: ExplosionDamage
        type: Float
        default_value: "150.0"
        instance_editable: true
        comment: Damage dealt on explosion
      # State tracking
      - name: bHasExploded
        type: Bool
        default_value: "false"
        comment: Prevents double explosion
      - name: bIsAlerted
        type: Bool
        default_value: "false"
        comment: True when player detected
    event_graph:
      nodes:
        # BeginPlay - Set Flying movement mode for hovering behavior
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        - id: SelfRef
          type: Self
          position: [100, 100]
        - id: GetCharMovement
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [300, 0]
        - id: SetMovementMode
          type: CallFunction
          properties:
            function: SetMovementMode
            class: CharacterMovementComponent
            parameters:
              NewMovementMode: Flying
          position: [600, 0]
        # Debug print
        - id: PrintReady
          type: CallFunction
          properties:
            function: PrintString
            class: KismetSystemLibrary
            parameters:
              InString: "PossessedExploder Active - Hover mode"
          position: [800, 0]
      connections:
        - from: [Event_BeginPlay, Then]
          to: [SetMovementMode, Exec]
        - from: [SelfRef, Self]
          to: [GetCharMovement, Target]
        - from: [GetCharMovement, CharacterMovement]
          to: [SetMovementMode, Target]
        - from: [SetMovementMode, Then]
          to: [PrintReady, Exec]
    # v7.8.5: Full custom functions per guide Phase 3 (sections 5, 6, 7)
    custom_functions:
      # TriggerAlert - Sets alert state, executes GameplayCue, adds State tag
      - name: TriggerAlert
        inputs: []
        outputs: []
        nodes:
          # Check if already alerted
          - id: GetAlerted
            type: VariableGet
            properties:
              variable_name: bIsAlerted
          - id: AlreadyAlertedBranch
            type: Branch
          # If not alerted, set it
          - id: SetAlertedTrue
            type: VariableSet
            properties:
              variable_name: bIsAlerted
          - id: MakeTrueAlert
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
            data:
              bool_value: true
          # Add alert state tag (GameplayCue executed via GE when tag is applied)
          - id: SelfForCue
            type: Self
          - id: MakeAlertStateTag
            type: CallFunction
            properties:
              function: MakeLiteralGameplayTag
              class: KismetGameplayTagLibrary
            data:
              tag_value: State.Enemy.Exploder.Alert
          - id: MakeAlertTagContainer
            type: CallFunction
            properties:
              function: MakeGameplayTagContainerFromTag
              class: BlueprintGameplayTagLibrary
          - id: AddAlertTag
            type: CallFunction
            properties:
              function: AddLooseGameplayTags
              class: AbilitySystemBlueprintLibrary
        connections:
          - from: [FunctionEntry, Then]
            to: [AlreadyAlertedBranch, Exec]
          - from: [GetAlerted, bIsAlerted]
            to: [AlreadyAlertedBranch, Condition]
          # False = not alerted yet, proceed
          - from: [AlreadyAlertedBranch, False]
            to: [SetAlertedTrue, Exec]
          - from: [MakeTrueAlert, ReturnValue]
            to: [SetAlertedTrue, bIsAlerted]
          - from: [SetAlertedTrue, Then]
            to: [AddAlertTag, Exec]
          - from: [SelfForCue, self]
            to: [AddAlertTag, Actor]
          - from: [MakeAlertStateTag, ReturnValue]
            to: [MakeAlertTagContainer, SingleTag]
          - from: [MakeAlertTagContainer, ReturnValue]
            to: [AddAlertTag, GameplayTags]

      # CheckExplosionProximity - Returns true if target is within ExplosionRadius
      # Uses AND for: IsValid(Target) AND (Distance <= Radius) - single Return node
      - name: CheckExplosionProximity
        inputs:
          - name: TargetActor
            type: Actor
        outputs:
          - name: bShouldExplode
            type: Bool
        nodes:
          # Validate target
          - id: ValidTarget
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
          # Get distance to target
          - id: SelfForDist
            type: Self
          - id: GetDistanceTo
            type: CallFunction
            properties:
              function: GetDistanceTo
              class: Actor
          # Compare to radius
          - id: GetRadius
            type: VariableGet
            properties:
              variable_name: ExplosionRadius
          - id: LessEqual
            type: CallFunction
            properties:
              function: LessEqual_DoubleDouble
          # AND: valid target AND within radius
          - id: AndBool
            type: CallFunction
            properties:
              function: BooleanAND
              class: KismetMathLibrary
          # Single return
          - id: ReturnResult
            type: Return
        connections:
          - from: [FunctionEntry, Then]
            to: [ReturnResult, Exec]
          - from: [FunctionEntry, TargetActor]
            to: [ValidTarget, Object]
          - from: [SelfForDist, self]
            to: [GetDistanceTo, Target]
          - from: [FunctionEntry, TargetActor]
            to: [GetDistanceTo, OtherActor]
          - from: [GetDistanceTo, ReturnValue]
            to: [LessEqual, A]
          - from: [GetRadius, ExplosionRadius]
            to: [LessEqual, B]
          - from: [ValidTarget, ReturnValue]
            to: [AndBool, A]
          - from: [LessEqual, ReturnValue]
            to: [AndBool, B]
          - from: [AndBool, ReturnValue]
            to: [ReturnResult, bShouldExplode]

      # TriggerExplosion - Simplified AOE damage (no ForEachLoop in custom functions)
      # Uses ApplyRadialDamage for immediate AOE, then destroys self
      - name: TriggerExplosion
        inputs: []
        outputs: []
        nodes:
          # Authority check
          - id: HasAuth
            type: CallFunction
            properties:
              function: HasAuthority
              class: Actor
          - id: AuthBranch
            type: Branch
          # Explosion guard
          - id: GetExploded
            type: VariableGet
            properties:
              variable_name: bHasExploded
          - id: ExplodedBranch
            type: Branch
          # Set exploded flag
          - id: SetExplodedTrue
            type: VariableSet
            properties:
              variable_name: bHasExploded
          - id: MakeTrueExploded
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
            data:
              bool_value: true
          # Get location for damage
          - id: SelfForLoc
            type: Self
          - id: GetActorLoc
            type: CallFunction
            properties:
              function: K2_GetActorLocation
              class: Actor
          # Get radius and damage values
          - id: GetRadius
            type: VariableGet
            properties:
              variable_name: ExplosionRadius
          - id: GetDamage
            type: VariableGet
            properties:
              variable_name: ExplosionDamage
          # Apply radial damage (GameplayStatics)
          - id: ApplyRadialDamage
            type: CallFunction
            properties:
              function: ApplyRadialDamage
              class: GameplayStatics
          # Destroy self
          - id: DestroySelf
            type: CallFunction
            properties:
              function: K2_DestroyActor
              class: Actor
        connections:
          # Authority check
          - from: [FunctionEntry, Then]
            to: [AuthBranch, Exec]
          - from: [HasAuth, ReturnValue]
            to: [AuthBranch, Condition]
          # If authority, check explosion guard
          - from: [AuthBranch, True]
            to: [ExplodedBranch, Exec]
          - from: [GetExploded, bHasExploded]
            to: [ExplodedBranch, Condition]
          # If not exploded, set flag and apply damage
          - from: [ExplodedBranch, False]
            to: [SetExplodedTrue, Exec]
          - from: [MakeTrueExploded, ReturnValue]
            to: [SetExplodedTrue, bHasExploded]
          # Apply radial damage
          - from: [SetExplodedTrue, Then]
            to: [ApplyRadialDamage, Exec]
          - from: [GetDamage, ExplosionDamage]
            to: [ApplyRadialDamage, BaseDamage]
          - from: [SelfForLoc, self]
            to: [GetActorLoc, Target]
          - from: [GetActorLoc, ReturnValue]
            to: [ApplyRadialDamage, Origin]
          - from: [GetRadius, ExplosionRadius]
            to: [ApplyRadialDamage, DamageRadius]
          - from: [SelfForLoc, self]
            to: [ApplyRadialDamage, DamageCauser]
          # Destroy after damage
          - from: [ApplyRadialDamage, Exec]
            to: [DestroySelf, Exec]
          - from: [SelfForLoc, self]
            to: [DestroySelf, Target]

actor_blueprints:  # POSSESSED EXPLODER BT SERVICES
  # v4.32: Enhanced with ReceiveTickAI event graph for explosion proximity check
  - name: BTS_CheckExplosionProximity
    folder: AI/Services
    parent_class: BTService_BlueprintBase
    variables:
      # Distance threshold to trigger explosion
      - name: ExplosionRadius
        type: Float
        default_value: "150.0"
        instance_editable: true
      # Track if already exploding to prevent double-trigger
      - name: bHasExploded
        type: Boolean
        default_value: "false"
    event_graph:
      nodes:
        # ReceiveTickAI - Check distance to target
        - id: Event_ReceiveTickAI
          type: Event
          properties:
            event_name: ReceiveTickAI
          position: [0, 0]
        # Check if already exploded
        - id: GetHasExploded
          type: VariableGet
          properties:
            variable_name: bHasExploded
          position: [200, 100]
        - id: AlreadyExplodedBranch
          type: Branch
          position: [400, 0]
        # Get blackboard for AttackTarget
        - id: GetBlackboard
          type: PropertyGet
          properties:
            property_name: Blackboard
            target_class: AIController
          position: [600, 0]
        # v4.38: P-BB-KEY-2 - Use Get Narrative Pro Settings for canonical BB keys
        - id: GetNarrativeProSettings
          type: CallFunction
          properties:
            function: GetNarrativeProSettings
            class: ArsenalStatics
          position: [700, 150]
        - id: GetBBKeyAttackTarget
          type: PropertyGet
          properties:
            property_name: BBKey_AttackTarget
            target_class: ArsenalSettings
          position: [850, 100]
        - id: GetAttackTarget
          type: CallFunction
          properties:
            function: GetValueAsObject
            class: BlackboardComponent
          position: [900, 0]
        # Cast to Actor
        - id: CastToActor
          type: DynamicCast
          properties:
            target_class: Actor
          position: [1200, 0]
        # Get distance between pawn and target
        - id: GetPawnLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
            class: Actor
          position: [1500, 0]
        - id: GetTargetLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
            class: Actor
          position: [1500, 100]
        - id: GetDistance
          type: CallFunction
          properties:
            function: Vector_Distance
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [1800, 50]
        # Check if within explosion radius
        - id: GetExplosionRadius
          type: VariableGet
          properties:
            variable_name: ExplosionRadius
          position: [1800, 150]
        - id: LessOrEqual
          type: CallFunction
          properties:
            function: LessEqual_FloatFloat
            # class: KismetMathLibrary  # Commented out - let resolver find
          position: [2100, 50]
        - id: ProximityBranch
          type: Branch
          position: [2300, 0]
        # Set exploded flag
        - id: SetExploded
          type: VariableSet
          properties:
            variable_name: bHasExploded
          position: [2500, 0]
        # v4.32: Get target's ASC for damage application
        - id: GetTargetASC
          type: CallFunction
          properties:
            function: GetAbilitySystemComponent
            class: AbilitySystemBlueprintLibrary
          position: [2700, 0]
        # Apply GE_ExplosionDamage to target (self-apply on target's ASC)
        - id: ApplyExplosionDamage
          type: CallFunction
          properties:
            function: BP_ApplyGameplayEffectToSelf
            class: AbilitySystemComponent
            param.GameplayEffectClass: /Game/FatherCompanion/Enemies/Possessed/Effects/GE_ExplosionDamage
          position: [2900, 0]
        # Kill the exploder (suicide explosion) - destroy the pawn
        - id: DestroyExploder
          type: CallFunction
          properties:
            function: K2_DestroyActor
            class: Actor
          position: [3100, 0]
      connections:
        - from: [Event_ReceiveTickAI, Then]
          to: [AlreadyExplodedBranch, Exec]
        - from: [GetHasExploded, bHasExploded]
          to: [AlreadyExplodedBranch, Condition]
        # If NOT exploded, check proximity
        - from: [AlreadyExplodedBranch, False]
          to: [GetBlackboard, Exec]
        - from: [Event_ReceiveTickAI, OwnerController]
          to: [GetBlackboard, Target]
        - from: [GetBlackboard, ReturnValue]
          to: [GetAttackTarget, Target]
        - from: [GetBlackboard, Exec]
          to: [GetAttackTarget, Exec]
        # v4.38: P-BB-KEY-2 - Connect NarrativeProSettings BB key
        - from: [GetNarrativeProSettings, ReturnValue]
          to: [GetBBKeyAttackTarget, Target]
        - from: [GetBBKeyAttackTarget, BBKey_AttackTarget]
          to: [GetAttackTarget, KeyName]
        - from: [GetAttackTarget, ReturnValue]
          to: [CastToActor, Object]
        - from: [GetAttackTarget, Exec]
          to: [CastToActor, Exec]
        - from: [Event_ReceiveTickAI, ControlledPawn]
          to: [GetPawnLocation, Target]
        - from: [CastToActor, AsActor]
          to: [GetTargetLocation, Target]
        - from: [GetPawnLocation, ReturnValue]
          to: [GetDistance, V1]
        - from: [GetTargetLocation, ReturnValue]
          to: [GetDistance, V2]
        - from: [GetDistance, ReturnValue]
          to: [LessOrEqual, A]
        - from: [GetExplosionRadius, ExplosionRadius]
          to: [LessOrEqual, B]
        - from: [LessOrEqual, ReturnValue]
          to: [ProximityBranch, Condition]
        - from: [CastToActor, Exec]
          to: [ProximityBranch, Exec]
        - from: [ProximityBranch, True]
          to: [SetExploded, Exec]
        - from: [SetExploded, Then]
          to: [GetTargetASC, Exec]
        # Connect target actor to ASC getter
        - from: [CastToActor, AsActor]
          to: [GetTargetASC, Actor]
        - from: [GetTargetASC, ReturnValue]
          to: [ApplyExplosionDamage, Target]
        - from: [GetTargetASC, Exec]
          to: [ApplyExplosionDamage, Exec]
        # Destroy the exploder pawn
        - from: [ApplyExplosionDamage, Exec]
          to: [DestroyExploder, Exec]
        - from: [Event_ReceiveTickAI, ControlledPawn]
          to: [DestroyExploder, Target]

behavior_trees:  # POSSESSED EXPLODER
# NOTE: Uses NarrativePro's BB_Attack at /NarrativePro/Pro/Core/AI/Activities/Attacks/
  - name: BT_Explode
    folder: AI/BehaviorTrees
    blackboard: BB_Attack
    root_type: Selector
    description: Suicide explosion behavior
    nodes:
      # Selector - Only run if AttackTarget is set
      - id: root_selector
        type: Selector
        decorators:
          - class: BTDecorator_Blackboard
            blackboard_key: AttackTarget
            key_query: IsSet
            notify_observer: OnResultChange
        children:
          - pursuit_sequence
      # Sequence - Pursue target with proximity check service
      - id: pursuit_sequence
        type: Sequence
        services:
          - class: BTS_CheckExplosionProximity
            interval: 0.1
        children:
          - move_to_target
      # Move To - Chase the attack target
      - id: move_to_target
        type: Task
        task_class: BTTask_MoveTo
        blackboard_key: AttackTarget
        properties:
          AcceptableRadius: "50.0"
          bAllowStrafe: "false"
          bReachTestIncludesAgentRadius: "true"
          bTrackMovingGoal: "true"

activities:  # POSSESSED EXPLODER
  - name: BPA_Explode
    folder: AI/Activities
    parent_class: NarrativeActivityBase
    behavior_tree: BT_Explode

# ============================================================================
# NPC SYSTEMS - SUPPORT BUFFER
# ============================================================================
tags:  # SUPPORT BUFFER
  - tag: State.NPC.SupportBuffer
    comment: NPC identifier
  - tag: State.NPC.Support.Healing
    comment: Applied during heal action
  - tag: Faction.Friendly.Support
    comment: Support faction identifier
  - tag: Effect.Support.Heal
    comment: Heal effect tag
  - tag: Effect.Support.SpeedBoost
    comment: Speed boost effect tag
  - tag: GameplayCue.Support.Heal
    comment: Heal VFX/SFX trigger

gameplay_effects:  # SUPPORT BUFFER
  # v7.8.4: Added modifiers per Support_Buffer_Healer_NPC_Implementation_Guide_v1_2.md Phase 2
  - name: GE_SupporterAttributes
    folder: NPCs/Support/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 150.0
      - attribute: NarrativeAttributeSetBase.Health
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 150.0
      - attribute: NarrativeAttributeSetBase.Armor
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 20.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        modifier_op: Override
        magnitude_type: ScalableFloat
        magnitude_value: 0.0

  # v4.39.1: Heal meta-attribute modifier pattern (Generator doesn't support execution_calculations)
  # PostGameplayEffectExecute processes Heal attribute → HealedBy delegate → Health increase
  # This is the correct Narrative Pro pattern per NarrativeAttributeSetBase.cpp:162-173
  - name: GE_SupportHeal
    folder: NPCs/Support/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.Heal
        operation: Additive
        magnitude_type: SetByCaller
        set_by_caller_tag: SetByCaller.Heal
    asset_tag: Effect.Support.Heal
    gameplay_cues:
      - GameplayCue.Support.Heal

actor_blueprints:  # SUPPORT BUFFER
  # v4.39: Full guide implementation (INC-SB-3 fix) - all variables and functions
  - name: BP_SupportBuffer
    folder: NPCs/Support
    parent_class: NarrativeNPCCharacter
    variables:
      # Healing parameters
      - name: HealRadius
        type: Float
        default_value: "500.0"
        instance_editable: true
      - name: HealAmount
        type: Float
        default_value: "50.0"
        instance_editable: true
      - name: HealCooldown
        type: Float
        default_value: "3.0"
        instance_editable: true
      # Speed boost parameters
      - name: SpeedBoostPercent
        type: Float
        default_value: "30.0"
        instance_editable: true
      - name: SpeedBoostDuration
        type: Float
        default_value: "5.0"
        instance_editable: true
      # Cooldown tracking
      - name: bCanHeal
        type: Bool
        default_value: "true"
      # Track original speed for restoration (single target simplified)
      - name: LastBoostedActor
        type: Actor
      - name: OriginalWalkSpeed
        type: Float
        default_value: "0.0"
    custom_functions:
      # ResetHealCooldown - Called by timer to reset bCanHeal
      - name: ResetHealCooldown
        inputs: []
        outputs: []
        nodes:
          # v4.39.3: Use CallFunction for MakeLiteralBool
          - id: MakeTrue
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
            data:
              bool_value: true
          - id: SetCanHeal
            type: VariableSet
            properties:
              variable_name: bCanHeal
        connections:
          - from: [FunctionEntry, Then]
            to: [SetCanHeal, Exec]
          - from: [MakeTrue, ReturnValue]
            to: [SetCanHeal, bCanHeal]
      # NOTE: RestoreSpeed removed - PropertySet not supported in custom_functions
      # Logic moved to OnSpeedBoostExpired event in event_graph (v7.8.6)
      # ApplyHealToTarget - Main healing function called by BTS_HealNearbyAllies
      - name: ApplyHealToTarget
        inputs:
          - name: TargetCharacter
            type: NarrativeCharacter
        outputs: []
        nodes:
          # Authority check (multiplayer safety)
          - id: HasAuthority
            type: CallFunction
            properties:
              function: HasAuthority
              class: Actor
          - id: AuthBranch
            type: Branch
          # Cooldown check
          - id: GetCanHeal
            type: VariableGet
            properties:
              variable_name: bCanHeal
          - id: CooldownBranch
            type: Branch
          # Set cooldown
          - id: SetCooldown
            type: VariableSet
            properties:
              variable_name: bCanHeal
          # v4.39.3: Use CallFunction for MakeLiteralBool
          - id: SetCooldownFalse
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
            data:
              bool_value: false
          # Start cooldown timer (calls ResetHealCooldown after HealCooldown seconds)
          - id: GetCooldownDuration
            type: VariableGet
            properties:
              variable_name: HealCooldown
          - id: SelfForTimer
            type: Self
          - id: StartCooldownTimer
            type: CallFunction
            properties:
              function: K2_SetTimer
              class: KismetSystemLibrary
          # v4.39.3: K2_SetTimer.FunctionName is string type in UE5.7
          - id: MakeTimerFunctionName
            type: CallFunction
            properties:
              function: MakeLiteralString
              class: KismetSystemLibrary
            data:
              string_value: ResetHealCooldown
          # Get target ASC
          - id: GetTargetASC
            type: CallFunction
            properties:
              function: GetAbilitySystemComponent
              class: AbilitySystemBlueprintLibrary
          # v4.39.3: IsValid needs to be CallFunction type
          - id: ValidASC
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
          - id: ASCBranch
            type: Branch
          # Get source ASC (self)
          - id: GetSelfASC
            type: CallFunction
            properties:
              function: GetAbilitySystemComponent
              class: AbilitySystemBlueprintLibrary
          - id: SelfRef
            type: Self
          # Make outgoing spec from Source ASC (not GameplayAbility)
          # v4.39.3: Use full path for TSubclassOf resolution
          - id: MakeSpec
            type: CallFunction
            properties:
              function: MakeOutgoingSpec
              class: AbilitySystemComponent
              param.GameplayEffectClass: /Game/FatherCompanion/NPCs/Support/Effects/GE_SupportHeal
          # Get heal amount
          - id: GetHealAmount
            type: VariableGet
            properties:
              variable_name: HealAmount
          # Assign SetByCaller magnitude
          - id: AssignMagnitude
            type: CallFunction
            properties:
              function: AssignTagSetByCallerMagnitude
              class: AbilitySystemBlueprintLibrary
          - id: MakeHealTag
            type: CallFunction
            properties:
              function: MakeLiteralGameplayTag
              class: KismetGameplayTagLibrary
            data:
              tag_value: SetByCaller.Heal
          # Apply to target
          - id: ApplyToTarget
            type: CallFunction
            properties:
              function: BP_ApplyGameplayEffectSpecToTarget
              class: AbilitySystemComponent
          # v7.8.7: Speed boost via event_graph pattern (PropertySet works in event_graph, not custom_functions)
          # Store target in LastBoostedActor, then trigger ApplySpeedBoostNow event via 0-delay timer
          - id: StoreTargetForBoost
            type: VariableSet
            properties:
              variable_name: LastBoostedActor
          - id: SelfForBoostTrigger
            type: Self
          - id: TriggerSpeedBoost
            type: CallFunction
            properties:
              function: K2_SetTimer
              class: KismetSystemLibrary
          - id: MakeBoostTriggerName
            type: CallFunction
            properties:
              function: MakeLiteralString
              class: KismetSystemLibrary
            data:
              string_value: ApplySpeedBoostNow
          # 0-delay timer to trigger the event immediately (next tick)
          - id: MakeZeroDelay
            type: CallFunction
            properties:
              function: MakeLiteralDouble
              class: KismetMathLibrary
            data:
              double_value: 0.01
        connections:
          # Authority check
          # v4.39.3: FunctionEntry is the entry point for custom functions (not Entry)
          - from: [FunctionEntry, Then]
            to: [HasAuthority, Exec]
          - from: [HasAuthority, ReturnValue]
            to: [AuthBranch, Condition]
          - from: [HasAuthority, Exec]
            to: [AuthBranch, Exec]
          # Cooldown check (if authorized)
          - from: [AuthBranch, True]
            to: [GetCanHeal, Exec]
          - from: [GetCanHeal, bCanHeal]
            to: [CooldownBranch, Condition]
          - from: [GetCanHeal, Exec]
            to: [CooldownBranch, Exec]
          # Set cooldown (if can heal)
          - from: [CooldownBranch, True]
            to: [SetCooldown, Exec]
          - from: [SetCooldownFalse, ReturnValue]
            to: [SetCooldown, bCanHeal]
          # Start timer (K2_SetTimer with function name)
          - from: [SetCooldown, Then]
            to: [StartCooldownTimer, Exec]
          # v4.39.3: Self node output pin is 'self' (lowercase)
          - from: [SelfForTimer, self]
            to: [StartCooldownTimer, Object]
          - from: [MakeTimerFunctionName, ReturnValue]
            to: [StartCooldownTimer, FunctionName]
          - from: [GetCooldownDuration, HealCooldown]
            to: [StartCooldownTimer, Time]
          # Get target ASC
          - from: [StartCooldownTimer, Exec]
            to: [GetTargetASC, Exec]
          # v4.39.3: FunctionEntry has the function input pins
          - from: [FunctionEntry, TargetCharacter]
            to: [GetTargetASC, Actor]
          - from: [GetTargetASC, ReturnValue]
            to: [ValidASC, Object]
          - from: [ValidASC, ReturnValue]
            to: [ASCBranch, Condition]
          - from: [GetTargetASC, Exec]
            to: [ASCBranch, Exec]
          # Get self ASC and make spec
          - from: [ASCBranch, True]
            to: [GetSelfASC, Exec]
          # v4.39.3: Self node output pin is 'self' (lowercase)
          - from: [SelfRef, self]
            to: [GetSelfASC, Actor]
          - from: [GetSelfASC, ReturnValue]
            to: [MakeSpec, Target]
          - from: [GetSelfASC, Exec]
            to: [MakeSpec, Exec]
          # Assign magnitude
          - from: [MakeSpec, ReturnValue]
            to: [AssignMagnitude, SpecHandle]
          - from: [MakeHealTag, ReturnValue]
            to: [AssignMagnitude, DataTag]
          - from: [GetHealAmount, HealAmount]
            to: [AssignMagnitude, Magnitude]
          - from: [MakeSpec, Exec]
            to: [AssignMagnitude, Exec]
          # Apply to target
          - from: [AssignMagnitude, ReturnValue]
            to: [ApplyToTarget, SpecHandle]
          - from: [GetTargetASC, ReturnValue]
            to: [ApplyToTarget, Target]
          - from: [AssignMagnitude, Exec]
            to: [ApplyToTarget, Exec]
          # ============================================================================
          # v7.8.7: Speed Boost Trigger (stores target, triggers event_graph via 0-delay timer)
          # ============================================================================
          - from: [ApplyToTarget, Exec]
            to: [StoreTargetForBoost, Exec]
          - from: [FunctionEntry, TargetCharacter]
            to: [StoreTargetForBoost, LastBoostedActor]
          - from: [StoreTargetForBoost, Then]
            to: [TriggerSpeedBoost, Exec]
          - from: [SelfForBoostTrigger, self]
            to: [TriggerSpeedBoost, Object]
          - from: [MakeBoostTriggerName, ReturnValue]
            to: [TriggerSpeedBoost, FunctionName]
          - from: [MakeZeroDelay, ReturnValue]
            to: [TriggerSpeedBoost, Time]
    event_graph:
      nodes:
        # BeginPlay - Log spawn
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        - id: PrintReady
          type: CallFunction
          properties:
            function: PrintString
            class: KismetSystemLibrary
            parameters:
              InString: "SupportBuffer Active - Full healing support"
          position: [300, 0]
        # ============================================================================
        # v7.8.7: ApplySpeedBoostNow CustomEvent (Phase 3, 5.9-5.15 per guide)
        # Called via timer from ApplyHealToTarget to apply speed boost
        # PropertySet works in event_graph context
        # ============================================================================
        - id: Event_ApplySpeedBoostNow
          type: CustomEvent
          properties:
            event_name: ApplySpeedBoostNow
          position: [0, 400]
        # Get LastBoostedActor (set by ApplyHealToTarget)
        - id: GetTargetForBoost
          type: VariableGet
          properties:
            variable_name: LastBoostedActor
          position: [200, 400]
        # Check valid
        - id: CheckTargetValid
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [400, 400]
        - id: TargetValidBranch
          type: Branch
          position: [600, 400]
        # Cast to Character
        - id: CastToCharacter_Boost
          type: DynamicCast
          properties:
            target_class: Character
          position: [800, 400]
        # Get CharacterMovement
        - id: GetCharMov_Boost
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [1000, 400]
        # Get current MaxWalkSpeed
        - id: GetCurrentWalkSpeed
          type: PropertyGet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [1200, 400]
        # Store original speed
        - id: StoreOriginalSpeed
          type: VariableSet
          properties:
            variable_name: OriginalWalkSpeed
          position: [1400, 400]
        # Get SpeedBoostPercent
        - id: GetBoostPercent
          type: VariableGet
          properties:
            variable_name: SpeedBoostPercent
          position: [1400, 550]
        # Calculate boost: (speed * percent) / 100
        - id: MultiplyPercent
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            class: KismetMathLibrary
          position: [1600, 400]
        - id: MakeLiteral100_Boost
          type: CallFunction
          properties:
            function: MakeLiteralDouble
            class: KismetMathLibrary
          data:
            double_value: 100.0
          position: [1600, 600]
        - id: DivideByHundred
          type: CallFunction
          properties:
            function: Divide_DoubleDouble
            class: KismetMathLibrary
          position: [1800, 400]
        # Calculate new speed: original + boost
        - id: AddBoost
          type: CallFunction
          properties:
            function: Add_DoubleDouble
            class: KismetMathLibrary
          position: [2000, 400]
        # Apply boosted speed (PropertySet works in event_graph)
        - id: SetBoostedWalkSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [2200, 400]
        # Get SpeedBoostDuration
        - id: GetBoostDuration
          type: VariableGet
          properties:
            variable_name: SpeedBoostDuration
          position: [2200, 550]
        # Self for restore timer
        - id: SelfForRestoreTimer
          type: Self
          position: [2200, 650]
        # Start timer to restore speed
        - id: StartRestoreTimer
          type: CallFunction
          properties:
            function: K2_SetTimer
            class: KismetSystemLibrary
          position: [2400, 400]
        - id: MakeRestoreFuncName
          type: CallFunction
          properties:
            function: MakeLiteralString
            class: KismetSystemLibrary
          data:
            string_value: OnSpeedBoostExpired
          position: [2400, 600]
        # ============================================================================
        # v7.8.7: OnSpeedBoostExpired CustomEvent (Phase 3, 5.23-5.27 per guide)
        # Called by timer when speed boost duration expires - restores original speed
        # ============================================================================
        - id: Event_SpeedBoostExpired
          type: CustomEvent
          properties:
            event_name: OnSpeedBoostExpired
          position: [0, 800]
        # Get LastBoostedActor to restore
        - id: GetBoostedActor_Restore
          type: VariableGet
          properties:
            variable_name: LastBoostedActor
          position: [200, 800]
        # Check valid
        - id: CheckBoostedValid
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [400, 800]
        - id: BoostedValidBranch
          type: Branch
          position: [600, 800]
        # Cast to Character
        - id: CastToCharacter_Restore
          type: DynamicCast
          properties:
            target_class: Character
          position: [800, 800]
        # Get CharacterMovement
        - id: GetCharMov_Restore
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [1000, 800]
        # Get stored original speed
        - id: GetOriginalSpeed_Restore
          type: VariableGet
          properties:
            variable_name: OriginalWalkSpeed
          position: [1000, 950]
        # Set MaxWalkSpeed back to original
        - id: SetWalkSpeed_Restore
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [1200, 800]
        # Clear LastBoostedActor
        - id: ClearLastBoostedActor
          type: VariableSet
          properties:
            variable_name: LastBoostedActor
          position: [1400, 800]
      connections:
        - from: [Event_BeginPlay, Then]
          to: [PrintReady, Exec]
        # ============================================================================
        # ApplySpeedBoostNow connections
        # ============================================================================
        - from: [Event_ApplySpeedBoostNow, Then]
          to: [CheckTargetValid, Exec]
        - from: [GetTargetForBoost, LastBoostedActor]
          to: [CheckTargetValid, Object]
        - from: [CheckTargetValid, ReturnValue]
          to: [TargetValidBranch, Condition]
        - from: [CheckTargetValid, Exec]
          to: [TargetValidBranch, Exec]
        - from: [TargetValidBranch, True]
          to: [CastToCharacter_Boost, Exec]
        - from: [GetTargetForBoost, LastBoostedActor]
          to: [CastToCharacter_Boost, Object]
        - from: [CastToCharacter_Boost, Then]
          to: [GetCharMov_Boost, Exec]
        - from: [CastToCharacter_Boost, AsCharacter]
          to: [GetCharMov_Boost, Target]
        - from: [GetCharMov_Boost, CharacterMovement]
          to: [GetCurrentWalkSpeed, Target]
        - from: [GetCharMov_Boost, Exec]
          to: [StoreOriginalSpeed, Exec]
        - from: [GetCurrentWalkSpeed, MaxWalkSpeed]
          to: [StoreOriginalSpeed, OriginalWalkSpeed]
        # Calculate boost
        - from: [GetCurrentWalkSpeed, MaxWalkSpeed]
          to: [MultiplyPercent, A]
        - from: [GetBoostPercent, SpeedBoostPercent]
          to: [MultiplyPercent, B]
        - from: [MultiplyPercent, ReturnValue]
          to: [DivideByHundred, A]
        - from: [MakeLiteral100_Boost, ReturnValue]
          to: [DivideByHundred, B]
        - from: [GetCurrentWalkSpeed, MaxWalkSpeed]
          to: [AddBoost, A]
        - from: [DivideByHundred, ReturnValue]
          to: [AddBoost, B]
        # Apply boost
        - from: [StoreOriginalSpeed, Then]
          to: [SetBoostedWalkSpeed, Exec]
        - from: [GetCharMov_Boost, CharacterMovement]
          to: [SetBoostedWalkSpeed, Target]
        - from: [AddBoost, ReturnValue]
          to: [SetBoostedWalkSpeed, MaxWalkSpeed]
        # Start restore timer
        - from: [SetBoostedWalkSpeed, Then]
          to: [StartRestoreTimer, Exec]
        - from: [SelfForRestoreTimer, self]
          to: [StartRestoreTimer, Object]
        - from: [MakeRestoreFuncName, ReturnValue]
          to: [StartRestoreTimer, FunctionName]
        - from: [GetBoostDuration, SpeedBoostDuration]
          to: [StartRestoreTimer, Time]
        # ============================================================================
        # OnSpeedBoostExpired connections
        # ============================================================================
        - from: [Event_SpeedBoostExpired, Then]
          to: [CheckBoostedValid, Exec]
        - from: [GetBoostedActor_Restore, LastBoostedActor]
          to: [CheckBoostedValid, Object]
        - from: [CheckBoostedValid, ReturnValue]
          to: [BoostedValidBranch, Condition]
        - from: [CheckBoostedValid, Exec]
          to: [BoostedValidBranch, Exec]
        - from: [BoostedValidBranch, True]
          to: [CastToCharacter_Restore, Exec]
        - from: [GetBoostedActor_Restore, LastBoostedActor]
          to: [CastToCharacter_Restore, Object]
        - from: [CastToCharacter_Restore, Then]
          to: [GetCharMov_Restore, Exec]
        - from: [CastToCharacter_Restore, AsCharacter]
          to: [GetCharMov_Restore, Target]
        - from: [GetCharMov_Restore, Exec]
          to: [SetWalkSpeed_Restore, Exec]
        - from: [GetCharMov_Restore, CharacterMovement]
          to: [SetWalkSpeed_Restore, Target]
        - from: [GetOriginalSpeed_Restore, OriginalWalkSpeed]
          to: [SetWalkSpeed_Restore, MaxWalkSpeed]
        - from: [SetWalkSpeed_Restore, Then]
          to: [ClearLastBoostedActor, Exec]

actor_blueprints:  # SUPPORT BUFFER BT SERVICES
  # v4.39: Full guide implementation (INC-SB-2, INC-SB-5, INC-SB-6 fixes)
  # - Faction check via GetAttitude (ArsenalStatics)
  # - DamageThreshold for health ratio check
  # - Calls BP_SupportBuffer.ApplyHealToTarget instead of direct GE
  - name: BTS_HealNearbyAllies
    folder: AI/Services
    parent_class: BTService_BlueprintBase
    variables:
      # Heal radius for finding allies
      - name: HealRadius
        type: Float
        default_value: "500.0"
        instance_editable: true
      # Damage threshold - heal if Health/MaxHealth < this value
      - name: DamageThreshold
        type: Float
        default_value: "0.9"
        instance_editable: true
    event_graph:
      nodes:
        # ReceiveTickAI - Find damaged friendlies and heal them
        - id: Event_ReceiveTickAI
          type: Event
          properties:
            event_name: ReceiveTickAI
          position: [0, 0]
        # Cast pawn to BP_SupportBuffer
        - id: CastToSupport
          type: DynamicCast
          properties:
            target_class: BP_SupportBuffer
          position: [200, 0]
        # Get pawn location for sphere overlap center
        - id: GetPawnLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
            class: Actor
          position: [400, 0]
        # Get heal radius variable
        - id: GetRadius
          type: VariableGet
          properties:
            variable_name: HealRadius
          position: [400, 100]
        # Make object types array for Pawn detection
        - id: MakeObjectTypes
          type: MakeArray
          properties:
            element_type: ObjectTypeQuery
            num_elements: 1
          position: [600, 200]
        # Make actors to ignore array (ignore self)
        - id: MakeActorsToIgnore
          type: MakeArray
          properties:
            element_type: Actor
            num_elements: 1
          position: [600, 300]
        # SphereOverlapActors to find nearby characters
        - id: SphereOverlap
          type: CallFunction
          properties:
            function: SphereOverlapActors
          position: [800, 0]
        # ForEach loop to process each found actor
        - id: ForEachActor
          type: ForEachLoop
          position: [1000, 0]
        # Cast to NarrativeCharacter
        - id: CastToNarrativeChar
          type: DynamicCast
          properties:
            target_class: NarrativeCharacter
          position: [1200, 0]
        # Faction check - GetAttitude
        - id: GetAttitude
          type: CallFunction
          properties:
            function: GetAttitude
            class: ArsenalStatics
          position: [1400, 0]
        # Check if Friendly
        - id: IsFriendly
          type: CallFunction
          properties:
            function: EqualEqual_ByteByte
          position: [1600, 0]
        - id: FriendlyBranch
          type: Branch
          position: [1800, 0]
        # v4.39.3: Use NarrativeCharacter.GetHealth/GetMaxHealth (simpler than attribute system)
        # Get Health from NarrativeCharacter (cast already done above)
        - id: GetHealth
          type: CallFunction
          properties:
            function: GetHealth
            class: NarrativeCharacter
          position: [2000, 0]
        # Get MaxHealth from NarrativeCharacter
        - id: GetMaxHealth
          type: CallFunction
          properties:
            function: GetMaxHealth
            class: NarrativeCharacter
          position: [2200, 0]
        # Calculate health ratio
        - id: DivideHealth
          type: CallFunction
          properties:
            function: Divide_FloatFloat
          position: [2400, 0]
        # Get damage threshold
        - id: GetThreshold
          type: VariableGet
          properties:
            variable_name: DamageThreshold
          position: [2400, 100]
        # Check if needs healing (Health/MaxHealth < Threshold)
        - id: NeedsHealCheck
          type: CallFunction
          properties:
            function: Less_FloatFloat
          position: [2600, 0]
        - id: NeedsHealBranch
          type: Branch
          position: [2800, 0]
        # Call ApplyHealToTarget on the casted BP_SupportBuffer reference
        # v4.40.1: Added class specification for function resolution
        - id: CallApplyHeal
          type: CallFunction
          properties:
            function: ApplyHealToTarget
            class: BP_SupportBuffer
          position: [3000, 0]
        # v4.39.3: Removed BreakLoop - cooldown in ApplyHealToTarget prevents multiple heals
        # ForEach will continue but only first ally healed per tick interval
      connections:
        # Cast pawn to BP_SupportBuffer
        - from: [Event_ReceiveTickAI, Then]
          to: [CastToSupport, Exec]
        - from: [Event_ReceiveTickAI, ControlledPawn]
          to: [CastToSupport, Object]
        # Get location for sphere overlap
        - from: [CastToSupport, Then]
          to: [GetPawnLocation, Exec]
        - from: [CastToSupport, AsBP_SupportBuffer]
          to: [GetPawnLocation, Target]
        - from: [CastToSupport, AsBP_SupportBuffer]
          to: [MakeActorsToIgnore, [0]]
        # Sphere overlap
        - from: [GetPawnLocation, Exec]
          to: [SphereOverlap, Exec]
        - from: [GetPawnLocation, ReturnValue]
          to: [SphereOverlap, SpherePos]
        - from: [GetRadius, HealRadius]
          to: [SphereOverlap, SphereRadius]
        - from: [MakeObjectTypes, Array]
          to: [SphereOverlap, ObjectTypes]
        - from: [MakeActorsToIgnore, Array]
          to: [SphereOverlap, ActorsToIgnore]
        # ForEach loop
        - from: [SphereOverlap, Exec]
          to: [ForEachActor, Exec]
        - from: [SphereOverlap, OutActors]
          to: [ForEachActor, Array]
        # Cast to NarrativeCharacter
        - from: [ForEachActor, LoopBody]
          to: [CastToNarrativeChar, Exec]
        - from: [ForEachActor, ArrayElement]
          to: [CastToNarrativeChar, Object]
        # Faction check
        - from: [CastToNarrativeChar, Then]
          to: [GetAttitude, Exec]
        # v4.39.3: ArsenalStatics::GetAttitude uses TestActor and Target pins
        - from: [CastToSupport, AsBP_SupportBuffer]
          to: [GetAttitude, TestActor]
        - from: [CastToNarrativeChar, AsNarrativeCharacter]
          to: [GetAttitude, Target]
        # Check if Friendly (ETeamAttitude::Friendly = 0)
        - from: [GetAttitude, ReturnValue]
          to: [IsFriendly, A]
        - from: [GetAttitude, Exec]
          to: [FriendlyBranch, Exec]
        - from: [IsFriendly, ReturnValue]
          to: [FriendlyBranch, Condition]
        # v4.39.3: Get Health/MaxHealth directly from NarrativeCharacter (simpler)
        - from: [FriendlyBranch, True]
          to: [GetHealth, Exec]
        - from: [CastToNarrativeChar, AsNarrativeCharacter]
          to: [GetHealth, Target]
        # Get MaxHealth
        - from: [GetHealth, Exec]
          to: [GetMaxHealth, Exec]
        - from: [CastToNarrativeChar, AsNarrativeCharacter]
          to: [GetMaxHealth, Target]
        # Calculate ratio
        - from: [GetHealth, ReturnValue]
          to: [DivideHealth, A]
        - from: [GetMaxHealth, ReturnValue]
          to: [DivideHealth, B]
        # Check if needs healing
        - from: [DivideHealth, ReturnValue]
          to: [NeedsHealCheck, A]
        - from: [GetThreshold, DamageThreshold]
          to: [NeedsHealCheck, B]
        - from: [NeedsHealCheck, ReturnValue]
          to: [NeedsHealBranch, Condition]
        - from: [GetMaxHealth, Exec]
          to: [NeedsHealBranch, Exec]
        # Call ApplyHealToTarget if needs healing
        - from: [NeedsHealBranch, True]
          to: [CallApplyHeal, Exec]
        - from: [CastToSupport, AsBP_SupportBuffer]
          to: [CallApplyHeal, Target]
        - from: [CastToNarrativeChar, AsNarrativeCharacter]
          to: [CallApplyHeal, TargetCharacter]
        # v4.39.3: Removed BreakLoop connection - cooldown prevents multiple heals per tick

behavior_trees:  # SUPPORT BUFFER
# NOTE: Uses NarrativePro's BB_FollowCharacter at /NarrativePro/Pro/Core/AI/Activities/FollowCharacter/
# v7.8.12: Removed BTS_SetAIFocus and BTS_AdjustFollowSpeed (don't exist)
# - BTS_HealNearbyAllies is the only custom service (heals nearby allies)
  - name: BT_SupportFollow
    folder: AI/BehaviorTrees
    blackboard: BB_FollowCharacter
    root_type: Selector
    description: Support follow with healing behavior
    nodes:
      # Root Selector - Follow target while healing allies
      - id: root_selector
        type: Selector
        decorators:
          - class: BTDecorator_Blackboard
            blackboard_key: FollowTarget
            key_query: IsSet
        children:
          - follow_heal_sequence
      # Follow Sequence - Move to target while healing nearby allies
      # v7.8.12: Removed BTS_SetAIFocus and BTS_AdjustFollowSpeed (don't exist)
      # AI perception handles focus, movement speed is default
      - id: follow_heal_sequence
        type: Sequence
        services:
          - class: BTS_HealNearbyAllies
            interval: 0.5
            random_deviation: 0.1
        children:
          - move_to_target
      - id: move_to_target
        type: Task
        task_class: BTTask_MoveTo
        blackboard_key: FollowTarget
        properties:
          AcceptableRadius: "200.0"

activities:  # SUPPORT BUFFER
  - name: BPA_SupportFollow
    folder: AI/Activities
    parent_class: BPA_FollowCharacter
    behavior_tree: BT_SupportFollow

# ============================================================================
# NPC SYSTEMS - BIOMECHANICAL DETACHMENT
# ============================================================================
tags:  # BIOMECH
  - tag: State.Biomech.Host
    comment: Applied to combined host entity
  - tag: State.Biomech.Creature
    comment: Applied to detached creature
  - tag: State.Biomech.Detaching
    comment: During transition phase
  - tag: Faction.Enemy.Biomech
    comment: Biomech faction identifier

gameplay_effects:  # BIOMECH
  # v7.8.23: BM-2 fix - Add modifiers per Guide v1.2 (250 HP, 28 ATK, 12 Armor)
  - name: GE_BiomechHostAttributes
    folder: Enemies/Biomech/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 250.0
      - attribute: NarrativeAttributeSetBase.Health
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 250.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 28.0
      - attribute: NarrativeAttributeSetBase.Armor
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 12.0

  # v7.8.23: BM-2 fix - Add modifiers per Guide v1.2 (85 HP, 38 ATK, 0 Armor)
  - name: GE_BiomechCreatureAttributes
    folder: Enemies/Biomech/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 85.0
      - attribute: NarrativeAttributeSetBase.Health
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 85.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 38.0
      - attribute: NarrativeAttributeSetBase.Armor
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 0.0

gameplay_effects:  # GATHERER SCOUT
  # v7.8.32: MAUD-01 fix - Gatherer Scout attributes (passive, lootable, non-combatant)
  # Fragile profile (75 HP, 0 ATK, 0 Armor) - easy to kill for resources, flees when spotted
  - name: GE_GathererScoutAttributes
    folder: Enemies/Gatherer/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 75.0
      - attribute: NarrativeAttributeSetBase.Health
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 75.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 0.0
      - attribute: NarrativeAttributeSetBase.Armor
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 0.0

  # v7.8.23: GS-1 fix - Reinforcement attributes per Gatherer_Scout_Alert_System_Implementation_Guide_v1_2.md
  # Combat-capable reinforcements (120 HP, 25 ATK, 5 Armor) - moderate fighter
  - name: GE_ReinforcementAttributes
    folder: Enemies/Gatherer/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 120.0
      - attribute: NarrativeAttributeSetBase.Health
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 120.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 25.0
      - attribute: NarrativeAttributeSetBase.Armor
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 5.0

gameplay_effects:  # RETURNED STALKER
  # v7.8.23: RS-2 fix - Returned Stalker attributes per Random_Aggression_Stalker_System_Implementation_Guide_v2_3.md
  # Glass cannon profile (100 HP, 30 ATK, 0 Armor) - high damage but fragile
  - name: GE_ReturnedStalkerAttributes
    folder: NPCs/Returned/Effects
    duration_policy: Instant
    modifiers:
      - attribute: NarrativeAttributeSetBase.MaxHealth
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 100.0
      - attribute: NarrativeAttributeSetBase.Health
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 100.0
      - attribute: NarrativeAttributeSetBase.AttackDamage
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 30.0
      - attribute: NarrativeAttributeSetBase.Armor
        operation: Override
        magnitude_type: ScalableFloat
        scalable_float_magnitude: 0.0

actor_blueprints:  # BIOMECH
  # v7.8.5: Enhanced per Biomechanical_Detachment_System_Implementation_Guide_v1_2.md (Phase 4-5)
  # SpawnNPC for proper NPC initialization + detaching state + montage + corpse spawn
  - name: BP_BiomechHost
    folder: Enemies/Biomech
    parent_class: NarrativeNPCCharacter
    variables:
      # NPCDefinition for spawning BiomechCreature on death via SpawnNPC (renamed from PhaseSpawnDefinition)
      - name: CreatureDefinition
        type: Object
        class: NPCDefinition
        instance_editable: true
      # v7.8.5: Static mesh for corpse left behind (Phase 4, section 3)
      - name: CorpseMesh
        type: Object
        class: StaticMesh
        instance_editable: true
      # v7.8.5: Spawn offset for creature (Phase 4, section 3)
      - name: SpawnOffset
        type: Vector
        default_value: "(X=0.0, Y=0.0, Z=50.0)"
        instance_editable: true
      # v7.8.5: Whether to spawn corpse on death (Phase 4, section 3)
      - name: bSpawnCorpse
        type: Bool
        default_value: "true"
        instance_editable: true
      # v7.8.5: Animation montage for detachment sequence (Phase 4, section 3)
      - name: DetachmentMontage
        type: Object
        class: AnimMontage
        instance_editable: true
    # v7.8.29: Removed empty BeginPlay event - all logic is in HandleDeath override
    # v7.8.5: Enhanced HandleDeath per guide Phase 5 (detaching tag, montage, offset, corpse)
    function_overrides:
      - function: HandleDeath
        nodes:
          # ============================================================================
          # Phase 5.2: Authority check - only server executes death logic
          # ============================================================================
          - id: HasAuth
            type: CallFunction
            properties:
              function: HasAuthority
              class: Actor
              target_self: true
            position: [200, 0]
          - id: AuthBranch
            type: Branch
            position: [400, 0]
          # ============================================================================
          # Phase 5.3: Add State.Biomech.Detaching tag during transition
          # v7.8.6: Use AddLooseGameplayTags (plural) with AbilitySystemBlueprintLibrary
          # ============================================================================
          - id: SelfRefForTag
            type: Self
            position: [550, 80]
          - id: MakeDetachingTag
            type: CallFunction
            properties:
              function: MakeLiteralGameplayTag
              class: KismetGameplayTagLibrary
            data:
              tag_value: State.Biomech.Detaching
            position: [600, 150]
          - id: MakeTagContainer_Detaching
            type: CallFunction
            properties:
              function: MakeGameplayTagContainerFromTag
              class: KismetGameplayTagLibrary
            position: [700, 100]
          - id: AddDetachingTag
            type: CallFunction
            properties:
              function: AddLooseGameplayTags
              class: AbilitySystemBlueprintLibrary
            position: [800, 0]
          # ============================================================================
          # Phase 5.4: Play detachment montage if valid
          # ============================================================================
          - id: GetDetachMontage
            type: VariableGet
            properties:
              variable_name: DetachmentMontage
            position: [1000, 100]
          - id: CheckMontageValid
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [1000, 0]
          - id: MontageBranch
            type: Branch
            position: [1200, 0]
          - id: SelfForMontage
            type: Self
            position: [1200, 100]
          - id: PlayMontage
            type: CallFunction
            properties:
              function: PlayAnimMontage
              class: Character
            position: [1400, 0]
          # ============================================================================
          # Phase 5.6-5.7: Calculate spawn transform with offset
          # ============================================================================
          - id: GetActorLocation
            type: CallFunction
            properties:
              function: K2_GetActorLocation
              class: Actor
              target_self: true
            position: [1600, 0]
          - id: GetSpawnOffset
            type: VariableGet
            properties:
              variable_name: SpawnOffset
            position: [1600, 100]
          - id: AddOffset
            type: CallFunction
            properties:
              function: Add_VectorVector
              class: KismetMathLibrary
            position: [1800, 0]
          - id: GetActorRotation
            type: CallFunction
            properties:
              function: K2_GetActorRotation
              class: Actor
              target_self: true
            position: [1600, 200]
          - id: MakeSpawnTransform
            type: CallFunction
            properties:
              function: MakeTransform
              class: KismetMathLibrary
            position: [2000, 0]
          # ============================================================================
          # Phase 5.7: Spawn BiomechCreature via SpawnNPC
          # ============================================================================
          - id: GetCreatureDefinition
            type: VariableGet
            properties:
              variable_name: CreatureDefinition
            position: [2000, 150]
          - id: SpawnCreature
            type: SpawnNPC
            properties:
              npc_definition_variable: CreatureDefinition
            position: [2200, 0]
          # ============================================================================
          # Phase 5.8: Spawn corpse mesh if bSpawnCorpse
          # ============================================================================
          - id: GetSpawnCorpseFlag
            type: VariableGet
            properties:
              variable_name: bSpawnCorpse
            position: [2400, 100]
          - id: SpawnCorpseBranch
            type: Branch
            position: [2400, 0]
          - id: GetCorpseMesh
            type: VariableGet
            properties:
              variable_name: CorpseMesh
            position: [2600, 100]
          - id: CheckCorpseMeshValid
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [2600, 0]
          - id: CorpseMeshBranch
            type: Branch
            position: [2800, 0]
          - id: GetCorpseTransform
            type: CallFunction
            properties:
              function: GetTransform
              class: Actor
              target_self: true
            position: [2800, 150]
          # Spawn StaticMeshActor for corpse
          - id: SpawnCorpseActor
            type: SpawnActor
            properties:
              actor_class: StaticMeshActor
            position: [3000, 0]
          # Configure corpse mesh component
          - id: CastToSMA
            type: DynamicCast
            properties:
              target_class: StaticMeshActor
            position: [3200, 0]
          # v7.8.8: Use GetComponentByClass + Cast pattern (PropertyGet doesn't work in function_overrides)
          - id: GetStaticMeshComp
            type: CallFunction
            properties:
              function: GetComponentByClass
              class: Actor
              param.ComponentClass: StaticMeshComponent
            position: [3400, 0]
          # Cast GetComponentByClass result to StaticMeshComponent
          - id: CastToStaticMeshComp
            type: DynamicCast
            properties:
              target_class: StaticMeshComponent
            position: [3500, 0]
          - id: SetCorpseMesh
            type: CallFunction
            properties:
              function: SetStaticMesh
              class: StaticMeshComponent
            position: [3600, 0]
          - id: MakeTrueLiteral
            type: CallFunction
            properties:
              function: MakeLiteralBool
              class: KismetSystemLibrary
            data:
              bool_value: true
            position: [3600, 150]
          - id: SetSimulatePhysics
            type: CallFunction
            properties:
              function: SetSimulatePhysics
              class: PrimitiveComponent
            position: [3800, 0]
          # ============================================================================
          # Phase 5.9: Call parent HandleDeath (all paths converge)
          # ============================================================================
          - id: CallParentDeath
            type: CallParent
            position: [4000, 0]
        connections:
          # Authority check
          - from: [FunctionEntry, Then]
            to: [HasAuth, Exec]
          - from: [HasAuth, ReturnValue]
            to: [AuthBranch, Condition]
          - from: [HasAuth, Exec]
            to: [AuthBranch, Exec]
          # Non-authority goes straight to parent
          - from: [AuthBranch, False]
            to: [CallParentDeath, Exec]
          # Add detaching tag (v7.8.6: AddLooseGameplayTags takes Actor + GameplayTagContainer)
          - from: [AuthBranch, True]
            to: [AddDetachingTag, Exec]
          - from: [SelfRefForTag, self]
            to: [AddDetachingTag, Actor]
          - from: [MakeDetachingTag, ReturnValue]
            to: [MakeTagContainer_Detaching, Tag]
          - from: [MakeTagContainer_Detaching, ReturnValue]
            to: [AddDetachingTag, GameplayTags]
          # Check montage valid
          - from: [AddDetachingTag, Exec]
            to: [CheckMontageValid, Exec]
          - from: [GetDetachMontage, DetachmentMontage]
            to: [CheckMontageValid, Object]
          - from: [CheckMontageValid, ReturnValue]
            to: [MontageBranch, Condition]
          - from: [CheckMontageValid, Exec]
            to: [MontageBranch, Exec]
          # Play montage if valid (True), skip if not (False)
          - from: [MontageBranch, True]
            to: [PlayMontage, Exec]
          - from: [SelfForMontage, self]
            to: [PlayMontage, Target]
          - from: [GetDetachMontage, DetachmentMontage]
            to: [PlayMontage, AnimMontage]
          # Both branches continue to spawn location calculation
          - from: [PlayMontage, Exec]
            to: [GetActorLocation, Exec]
          - from: [MontageBranch, False]
            to: [GetActorLocation, Exec]
          # Calculate spawn location with offset
          - from: [GetActorLocation, ReturnValue]
            to: [AddOffset, A]
          - from: [GetSpawnOffset, SpawnOffset]
            to: [AddOffset, B]
          # Make spawn transform
          - from: [AddOffset, ReturnValue]
            to: [MakeSpawnTransform, Location]
          - from: [GetActorRotation, ReturnValue]
            to: [MakeSpawnTransform, Rotation]
          - from: [GetActorLocation, Exec]
            to: [MakeSpawnTransform, Exec]
          # Spawn creature
          - from: [MakeSpawnTransform, Exec]
            to: [SpawnCreature, Exec]
          - from: [GetCreatureDefinition, CreatureDefinition]
            to: [SpawnCreature, NPCData]
          - from: [MakeSpawnTransform, ReturnValue]
            to: [SpawnCreature, Transform]
          # Check if should spawn corpse
          - from: [SpawnCreature, Then]
            to: [SpawnCorpseBranch, Exec]
          - from: [GetSpawnCorpseFlag, bSpawnCorpse]
            to: [SpawnCorpseBranch, Condition]
          # If should spawn corpse, check mesh valid
          - from: [SpawnCorpseBranch, True]
            to: [CheckCorpseMeshValid, Exec]
          - from: [GetCorpseMesh, CorpseMesh]
            to: [CheckCorpseMeshValid, Object]
          - from: [CheckCorpseMeshValid, ReturnValue]
            to: [CorpseMeshBranch, Condition]
          - from: [CheckCorpseMeshValid, Exec]
            to: [CorpseMeshBranch, Exec]
          # If mesh valid, spawn corpse actor
          - from: [CorpseMeshBranch, True]
            to: [SpawnCorpseActor, Exec]
          - from: [GetCorpseTransform, ReturnValue]
            to: [SpawnCorpseActor, SpawnTransform]
          # Cast to StaticMeshActor and configure
          - from: [SpawnCorpseActor, Exec]
            to: [CastToSMA, Exec]
          - from: [SpawnCorpseActor, ReturnValue]
            to: [CastToSMA, Object]
          # v7.8.8: GetComponentByClass + Cast pattern
          - from: [CastToSMA, Then]
            to: [GetStaticMeshComp, Exec]
          - from: [CastToSMA, AsStaticMeshActor]
            to: [GetStaticMeshComp, Target]
          - from: [GetStaticMeshComp, ReturnValue]
            to: [CastToStaticMeshComp, Object]
          - from: [GetStaticMeshComp, Exec]
            to: [CastToStaticMeshComp, Exec]
          - from: [CastToStaticMeshComp, Then]
            to: [SetCorpseMesh, Exec]
          - from: [CastToStaticMeshComp, AsStaticMeshComponent]
            to: [SetCorpseMesh, Target]
          - from: [GetCorpseMesh, CorpseMesh]
            to: [SetCorpseMesh, NewMesh]
          - from: [SetCorpseMesh, Exec]
            to: [SetSimulatePhysics, Exec]
          - from: [CastToStaticMeshComp, AsStaticMeshComponent]
            to: [SetSimulatePhysics, Target]
          - from: [MakeTrueLiteral, ReturnValue]
            to: [SetSimulatePhysics, bSimulate]
          # All paths converge to CallParentDeath
          - from: [SetSimulatePhysics, Exec]
            to: [CallParentDeath, Exec]
          - from: [CorpseMeshBranch, False]
            to: [CallParentDeath, Exec]
          - from: [SpawnCorpseBranch, False]
            to: [CallParentDeath, Exec]

  # v7.8.4: Enhanced per Biomechanical_Detachment_System_Implementation_Guide_v1_2.md
  # BiomechCreature is a fast, agile melee attacker spawned from BiomechHost death
  # Combat behavior handled by Narrative Pro's default NPC AI via GoalGenerator_Attack
  - name: BP_BiomechCreature
    folder: Enemies/Biomech
    parent_class: NarrativeNPCCharacter
    variables:
      # Movement speed boost for agile creature
      - name: CreatureSpeedMultiplier
        type: Float
        default_value: "1.5"
        instance_editable: true
    event_graph:
      nodes:
        # BeginPlay - Configure fast movement for detached creature
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        - id: SelfRef
          type: Self
          position: [100, 100]
        # Get CharacterMovement component
        - id: GetCharMovement
          type: PropertyGet
          properties:
            property_name: CharacterMovement
            target_class: Character
          position: [300, 0]
        # Get current max walk speed
        - id: GetMaxWalkSpeed
          type: PropertyGet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [500, 0]
        # Get speed multiplier
        - id: GetSpeedMult
          type: VariableGet
          properties:
            variable_name: CreatureSpeedMultiplier
          position: [500, 150]
        # Multiply for boosted speed
        - id: MultiplySpeed
          type: CallFunction
          properties:
            function: Multiply_DoubleDouble
            # class: KismetMathLibrary  # Let resolver find
          position: [700, 0]
        # Set boosted max walk speed via PropertySet
        - id: SetMaxWalkSpeed
          type: PropertySet
          properties:
            property_name: MaxWalkSpeed
            target_class: CharacterMovementComponent
          position: [900, 0]
        # Debug print
        - id: PrintReady
          type: CallFunction
          properties:
            function: PrintString
            class: KismetSystemLibrary
            parameters:
              InString: "BiomechCreature Detached - Fast melee mode"
          position: [1100, 0]
      connections:
        # Data flow - Self to CharacterMovement
        - from: [SelfRef, Self]
          to: [GetCharMovement, Target]
        - from: [GetCharMovement, CharacterMovement]
          to: [GetMaxWalkSpeed, Target]
        - from: [GetCharMovement, CharacterMovement]
          to: [SetMaxWalkSpeed, Target]
        # Data flow - Calculate boosted speed
        - from: [GetMaxWalkSpeed, MaxWalkSpeed]
          to: [MultiplySpeed, A]
        - from: [GetSpeedMult, CreatureSpeedMultiplier]
          to: [MultiplySpeed, B]
        - from: [MultiplySpeed, ReturnValue]
          to: [SetMaxWalkSpeed, MaxWalkSpeed]
        # Exec flow - BeginPlay directly to SetMaxWalkSpeed (PropertyGet nodes are pure)
        - from: [Event_BeginPlay, Then]
          to: [SetMaxWalkSpeed, Exec]
        - from: [SetMaxWalkSpeed, Then]
          to: [PrintReady, Exec]

# ============================================================================
# NPC SYSTEMS - GATHERER SCOUT
# ============================================================================
tags:  # GATHERER
  - tag: State.NPC.Alert.Signaling
    comment: Applied during alert animation
  - tag: Faction.Enemy.Gatherer
    comment: Gatherer faction identifier
  - tag: Faction.Enemy.Reinforcement
    comment: Reinforcement faction identifier
  - tag: Goal.Alert
    comment: Goal type identifier

actor_blueprints:  # GATHERER
  # v7.8.22: BP_GathererScoutController - Custom AIController with AIPerception configured
  # Per Guide v1.2 Phase 1.3: Configure AIPerception for enemy detection
  - name: BP_GathererScoutController
    folder: Enemies/Gatherer
    parent_class: NarrativeNPCController
    ai_perception:
      senses:
        - type: Sight
          sight_radius: 800.0
          lose_sight_radius: 1000.0
          peripheral_vision_angle: 90.0
          detect_enemies: true
          detect_neutrals: false
          detect_friendlies: false
      dominant_sense: Sight

  # v7.8.14: BP_GathererScout NPC Blueprint
  # v7.8.22: AIPerception now configured via BP_GathererScoutController (generator automated)
  - name: BP_GathererScout
    folder: Enemies/Gatherer
    parent_class: NarrativeNPCCharacter
    event_graph:
      nodes:
        # BeginPlay - Log spawn (alert behavior via GoalGenerator_Alert)
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        - id: PrintReady
          type: CallFunction
          properties:
            function: PrintString
            class: KismetSystemLibrary
            parameters:
              InString: "GathererScout Active - Alert via GoalGenerator"
          position: [300, 0]
      connections:
        - from: [Event_BeginPlay, Then]
          to: [PrintReady, Exec]

  - name: BP_Reinforcement
    folder: Enemies/Gatherer
    parent_class: NarrativeNPCCharacter
    event_graph:
      nodes:
        # BeginPlay - Log spawn (spawned by GathererScout alert)
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        - id: PrintReady
          type: CallFunction
          properties:
            function: PrintString
            class: KismetSystemLibrary
            parameters:
              InString: "Reinforcement Deployed - Moving to alert location"
          position: [300, 0]
      connections:
        - from: [Event_BeginPlay, Then]
          to: [PrintReady, Exec]

actor_blueprints:  # GATHERER GOALS AND GOAL GENERATORS
  # v7.8.15: Goal_Alert moved to actor_blueprints because it has variables and function_overrides
  # Complete Goal_Alert per Guide v1.2 Phase 2
  - name: Goal_Alert
    folder: AI/Goals
    parent_class: NPCGoalItem
    # v7.8.35: CDO properties for NPCGoalItem
    default_score: 5.0
    goal_lifetime: -1.0
    remove_on_succeeded: true
    save_goal: true
    owned_tags:
      - State.Enemy.Alert
    variables:
      # Guide 2.1: Location where hostile was spotted
      - name: AlertLocation
        type: Vector
        default_value: "(0.0, 0.0, 0.0)"
        save_game: true
      # Guide 2.2: Actor that triggered the alert
      - name: SpottedTarget
        type: Object
        class: Actor
      # Guide 2.3: DefaultScore as Blueprint variable (CDO won't work for goals with function_overrides)
      - name: DefaultScore
        type: Float
        default_value: "5.0"
    # Guide Phase 2, Step 4: GetGoalKey returns SpottedTarget for deduplication
    function_overrides:
      - function: GetGoalKey
        nodes:
          - id: GetSpottedTarget
            type: VariableGet
            properties:
              variable_name: SpottedTarget
            position: [200, 0]
          - id: ReturnKey
            type: Return
            position: [400, 0]
        connections:
          - from: [FunctionEntry, Then]
            to: [ReturnKey, Exec]
          - from: [GetSpottedTarget, SpottedTarget]
            to: [ReturnKey, ReturnValue]
  # v7.8.14: GoalGenerator_Alert per Guide v1.2 Phase 3 and Tech Doc Section 65.5
  # Full implementation with OnPerceptionUpdated binding - NO SIMPLIFICATION per Contract 25
  - name: GoalGenerator_Alert
    folder: AI/GoalGenerators
    parent_class: NPCGoalGenerator
    variables:
      # Guide 2.1: The goal item class to add when alerting
      - name: AlertGoalClass
        type: Class
        class: NPCGoalItem
        default_value: Goal_Alert
        instance_editable: true
      # Guide 2.2: Base score for alert goals
      - name: AlertGoalBaseScore
        type: Float
        default_value: "5.0"
        instance_editable: true
    # Guide 3: Override InitializeGoalGenerator - Bind OnPerceptionUpdated per Tech Doc 65.5
    function_overrides:
      - function: InitializeGoalGenerator
        nodes:
          # v7.8.18: Self node for PropertyGet
          - id: SelfRef_Init
            type: Self
            position: [100, 0]
          # v7.8.18: Get OwnerController via PropertyGet (NPCGoalGenerator has property, not function)
          - id: GetOwnerController
            type: PropertyGet
            properties:
              property_name: OwnerController
              target_class: NPCGoalGenerator
            position: [200, 0]
          # Guide 3.2.2: Get AI Perception Component from AIController
          # [MANIFEST] GetComponentByClass pattern (common NP pattern)
          # AIController.PerceptionComponent not Blueprint-visible, use GetComponentByClass
          - id: GetAIPerception
            type: CallFunction
            properties:
              function: GetComponentByClass
              class: Actor
              param.ComponentClass: AIPerceptionComponent
            position: [400, 0]
          # Guide 3.2.3: Is Valid check
          - id: IsValidPerception
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [600, 0]
          # Guide 3.2.4: Branch on validity
          - id: BranchValid
            type: Branch
            position: [800, 0]
          # v7.8.19: Cast GetComponentByClass result to AIPerceptionComponent
          # [MANIFEST] Pattern from line 12022: DynamicCast after GetComponentByClass
          - id: CastToAIPerception
            type: DynamicCast
            properties:
              target_class: AIPerceptionComponent
            position: [900, 0]
          # Guide 3.2.5: Bind to OnPerceptionUpdated delegate
          # [PLUGIN] Tech Doc 65.5: Bind Event to On Perception Updated
          # v7.8.19: AddDelegate node type with source_class for delegate property lookup
          - id: BindPerception
            type: AddDelegate
            properties:
              delegate_name: OnPerceptionUpdated
              event_name: OnPerceptionUpdated_Handler
              source_class: AIPerceptionComponent
            position: [1100, 0]
        connections:
          # v7.8.19: GetComponentByClass has exec pins (not pure)
          - from: [FunctionEntry, Then]
            to: [GetAIPerception, Exec]
          - from: [GetAIPerception, Then]
            to: [BranchValid, Exec]
          # v7.8.18: Self -> PropertyGet for OwnerController
          - from: [SelfRef_Init, self]
            to: [GetOwnerController, self]
          # v7.8.19: OwnerController -> GetComponentByClass Target
          - from: [GetOwnerController, ReturnValue]
            to: [GetAIPerception, Target]
          # v7.8.19: GetComponentByClass output -> IsValid and BindPerception
          - from: [GetAIPerception, ReturnValue]
            to: [IsValidPerception, Object]
          - from: [IsValidPerception, ReturnValue]
            to: [BranchValid, Condition]
          # v7.8.19: Cast before binding - exec flow through DynamicCast
          - from: [BranchValid, True]
            to: [CastToAIPerception, Exec]
          - from: [CastToAIPerception, Then]
            to: [BindPerception, Exec]
          # v7.8.19: GetComponentByClass result -> Cast input
          - from: [GetAIPerception, ReturnValue]
            to: [CastToAIPerception, Object]
          # v7.8.19: Casted output -> BindPerception Target
          - from: [CastToAIPerception, AsAIPerceptionComponent]
            to: [BindPerception, Target]
    # Guide 4: OnPerceptionUpdated event handler - creates Goal_Alert when hostile detected
    event_graph:
      nodes:
        # Guide 4.1.1: OnPerceptionUpdated handler receives UpdatedActors array
        - id: Event_OnPerceptionUpdated
          type: CustomEvent
          properties:
            event_name: OnPerceptionUpdated_Handler
            parameters:
              - name: UpdatedActors
                type: Array
                element_type: Actor
          position: [0, 0]
        # Guide 4.1.1: For Each Loop on actors
        - id: ForEachActor
          type: ForEachLoop
          position: [200, 0]
        # v7.8.18: Get owner via OwnerController property -> GetPawn
        # NPCGoalGenerator has OwnerController (ANarrativeNPCController*)
        - id: SelfRef
          type: Self
          position: [250, 100]
        - id: GetOwnerController
          type: PropertyGet
          properties:
            property_name: OwnerController
            target_class: NPCGoalGenerator
          position: [350, 100]
        - id: GetPawn
          type: CallFunction
          properties:
            function: K2_GetPawn
            class: Controller
          position: [400, 100]
        # Guide 4.2.1.1: Get Attitude (ArsenalStatics)
        - id: GetAttitude
          type: CallFunction
          properties:
            function: GetAttitude
            class: ArsenalStatics
          position: [400, 0]
        # Guide 4.2.2: Compare to Hostile (ETeamAttitude::Hostile = 2)
        - id: MakeHostileValue
          type: MakeLiteralByte
          properties:
            value: 2
          position: [600, 100]
        - id: EqualHostile
          type: CallFunction
          properties:
            function: EqualEqual_ByteByte
            class: KismetMathLibrary
          position: [600, 0]
        # Guide 4.2.3: Branch on hostile
        - id: BranchHostile
          type: Branch
          position: [800, 0]
        # Guide 4.3.1: Get Activity Component
        - id: GetActivityComponent
          type: CallFunction
          properties:
            function: GetComponentByClass
            class: Actor
            param.ComponentClass: NPCActivityComponent
          position: [1000, 0]
        # Guide 4.3.1.2: Cast to NPCActivityComponent for proper type
        - id: CastToActivityComponent
          type: DynamicCast
          properties:
            target_class: NPCActivityComponent
          position: [1100, 0]
        # Guide 4.3.2: Get Goal By Key to check duplicates
        - id: GetGoalByKey
          type: CallFunction
          properties:
            function: GetGoalByKey
            class: NPCActivityComponent
          position: [1200, 0]
        # Guide 4.3.3: NOT OutSucceeded check
        - id: NotSucceeded
          type: CallFunction
          properties:
            function: Not_PreBool
            class: KismetMathLibrary
          position: [1400, 0]
        # Guide 4.3.3.2: Branch on no existing goal
        - id: BranchNoGoal
          type: Branch
          position: [1600, 0]
        # Guide 4.4.1: Get AlertGoalClass variable
        - id: GetAlertGoalClass
          type: VariableGet
          properties:
            variable_name: AlertGoalClass
          position: [1800, 100]
        # Guide 4.4.1: Construct Object from Class
        - id: ConstructGoal
          type: ConstructObjectFromClass
          properties:
            class: NPCGoalItem
          position: [1800, 0]
        # Guide 4.4.2: Cast to Goal_Alert
        - id: CastToGoalAlert
          type: DynamicCast
          properties:
            target_class: Goal_Alert
          position: [2000, 0]
        # Guide 4.4.3.1: SET SpottedTarget
        - id: SetSpottedTarget
          type: VariableSet
          properties:
            variable_name: SpottedTarget
            target_class: Goal_Alert
          position: [2200, 0]
        # Guide 4.4.3.2: Get Actor Location for AlertLocation
        - id: GetActorLocation
          type: CallFunction
          properties:
            function: K2_GetActorLocation
            class: Actor
          position: [2200, 200]
        # Guide 4.4.3.2: SET AlertLocation
        - id: SetAlertLocation
          type: VariableSet
          properties:
            variable_name: AlertLocation
            target_class: Goal_Alert
          position: [2400, 0]
        # Guide 4.4.3.3: Get AlertGoalBaseScore variable
        - id: GetAlertGoalBaseScore
          type: VariableGet
          properties:
            variable_name: AlertGoalBaseScore
          position: [2400, 200]
        # Guide 4.4.3.3: SET DefaultScore (NPCGoalItem.DefaultScore property)
        - id: SetDefaultScore
          type: VariableSet
          properties:
            variable_name: DefaultScore
            target_class: NPCGoalItem
          position: [2600, 0]
        # Guide 4.4.4: Add Goal to activity component
        - id: AddGoal
          type: CallFunction
          properties:
            function: AddGoal
            class: NPCActivityComponent
            param.bTriggerReselect: true
          position: [2800, 0]
      connections:
        # Event -> ForEach
        - from: [Event_OnPerceptionUpdated, Then]
          to: [ForEachActor, Exec]
        - from: [Event_OnPerceptionUpdated, UpdatedActors]
          to: [ForEachActor, Array]
        # Self -> GetOwnerController -> GetPawn (get owner character)
        - from: [SelfRef, Self]
          to: [GetOwnerController, Target]
        - from: [GetOwnerController, OwnerController]
          to: [GetPawn, Target]
        # ForEach -> GetAttitude (use owner pawn for attitude check)
        - from: [ForEachActor, LoopBody]
          to: [GetAttitude, Exec]
        - from: [GetPawn, ReturnValue]
          to: [GetAttitude, TestActor]
        - from: [ForEachActor, ArrayElement]
          to: [GetAttitude, Target]
        # GetAttitude -> Compare -> Branch
        - from: [GetAttitude, ReturnValue]
          to: [EqualHostile, A]
        - from: [MakeHostileValue, ReturnValue]
          to: [EqualHostile, B]
        - from: [GetAttitude, Then]
          to: [BranchHostile, Exec]
        - from: [EqualHostile, ReturnValue]
          to: [BranchHostile, Condition]
        # Branch True -> GetActivityComponent -> Cast -> GetGoalByKey
        - from: [BranchHostile, True]
          to: [GetActivityComponent, Exec]
        - from: [GetPawn, ReturnValue]
          to: [GetActivityComponent, Target]
        - from: [GetActivityComponent, Then]
          to: [CastToActivityComponent, Exec]
        - from: [GetActivityComponent, ReturnValue]
          to: [CastToActivityComponent, Object]
        - from: [CastToActivityComponent, Then]
          to: [GetGoalByKey, Exec]
        - from: [CastToActivityComponent, AsNPCActivityComponent]
          to: [GetGoalByKey, Target]
        - from: [GetAlertGoalClass, AlertGoalClass]
          to: [GetGoalByKey, GoalType]
        - from: [ForEachActor, ArrayElement]
          to: [GetGoalByKey, Key]
        # GetGoalByKey -> NOT -> Branch
        - from: [GetGoalByKey, OutSucceeded]
          to: [NotSucceeded, A]
        - from: [GetGoalByKey, Then]
          to: [BranchNoGoal, Exec]
        - from: [NotSucceeded, ReturnValue]
          to: [BranchNoGoal, Condition]
        # Branch True (no goal) -> Construct -> Cast -> Set properties -> AddGoal
        - from: [BranchNoGoal, True]
          to: [ConstructGoal, Exec]
        - from: [GetAlertGoalClass, AlertGoalClass]
          to: [ConstructGoal, Class]
        - from: [CastToActivityComponent, AsNPCActivityComponent]
          to: [ConstructGoal, Outer]
        - from: [ConstructGoal, Then]
          to: [CastToGoalAlert, Exec]
        - from: [ConstructGoal, ReturnValue]
          to: [CastToGoalAlert, Object]
        - from: [CastToGoalAlert, Then]
          to: [SetSpottedTarget, Exec]
        - from: [CastToGoalAlert, AsGoal_Alert]
          to: [SetSpottedTarget, Target]
        - from: [ForEachActor, ArrayElement]
          to: [SetSpottedTarget, SpottedTarget]
        - from: [SetSpottedTarget, Then]
          to: [SetAlertLocation, Exec]
        - from: [CastToGoalAlert, AsGoal_Alert]
          to: [SetAlertLocation, Target]
        - from: [GetPawn, ReturnValue]
          to: [GetActorLocation, Target]
        - from: [GetActorLocation, ReturnValue]
          to: [SetAlertLocation, AlertLocation]
        - from: [SetAlertLocation, Then]
          to: [SetDefaultScore, Exec]
        - from: [CastToGoalAlert, AsGoal_Alert]
          to: [SetDefaultScore, Target]
        - from: [GetAlertGoalBaseScore, AlertGoalBaseScore]
          to: [SetDefaultScore, DefaultScore]
        - from: [SetDefaultScore, Then]
          to: [AddGoal, Exec]
        - from: [CastToActivityComponent, AsNPCActivityComponent]
          to: [AddGoal, Target]
        - from: [CastToGoalAlert, AsGoal_Alert]
          to: [AddGoal, NewGoal]

  # v7.8.36: Goal_FormationFollow moved earlier in manifest (before BPA_FormationFollow)
  # See GUARD FORMATION GOALS section above

actor_blueprints:  # GATHERER ACTIVITIES
  # v7.8.35: Moved to actor_blueprints for variables/function_overrides support
  # v4.39.2: Full BPA_Alert implementation per Guide v1.2 L320-510
  # Spawns reinforcements when Gatherer detects threat, then flees
  - name: BPA_Alert
    folder: AI/Activities
    parent_class: NPCActivity
    # v7.8.35: CDO properties for NPCActivity
    activity_name: "Alert and Signal"
    supported_goal_type: Goal_Alert
    is_interruptable: false
    owned_tags:
      - State.NPC.Alert.Active
    variables:
      # Guide L333-339: NPCDefinition for reinforcement spawning
      - name: ReinforcementDefinition
        type: Object
        class: NPCDefinition
        instance_editable: true
        expose_on_spawn: true
      # Guide L341-346: Number of reinforcements to spawn
      - name: ReinforcementCount
        type: Integer
        default_value: "2"
        instance_editable: true
      # Guide L348-353: Radius around gatherer to spawn reinforcements
      - name: SpawnRadius
        type: Float
        default_value: "100.0"
        instance_editable: true
      # Guide L355-360: Animation to play when signaling
      - name: SignalMontage
        type: AnimMontage
        instance_editable: true
      # Guide L362-366: Cached reference to the alert goal
      - name: CachedAlertGoal
        type: Object
        class: NPCGoalItem
    # K2_RunActivity override - Guide L377-510
    function_overrides:
      - function: K2_RunActivity
        nodes:
          # v7.8.39: Self reference for PropertyGet in function override
          - id: SelfRef0
            type: Self
            position: [50, 0]
          # v7.8.35: ActivityGoal is a PROPERTY on NPCActivity, not a function parameter
          - id: GetActivityGoal
            type: PropertyGet
            properties:
              property_name: ActivityGoal
              target_class: NPCActivity
            position: [100, 0]
          # Cast ActivityGoal to Goal_Alert (Guide L385-389)
          - id: CastToGoalAlert
            type: DynamicCast
            properties:
              target_class: Goal_Alert
            position: [200, 0]
          # Cache the alert goal (Guide L389)
          - id: SetCachedGoal
            type: VariableSet
            properties:
              variable_name: CachedAlertGoal
            position: [400, 0]
          # v7.8.39: Get owner character via Self -> OwnerController -> K2_GetPawn pattern
          # [MANIFEST] Line 13012-13026 shows working pattern with Self + PropertyGet + K2_GetPawn
          - id: SelfRef1
            type: Self
            position: [400, 50]
          - id: GetOwnerController1
            type: PropertyGet
            properties:
              property_name: OwnerController
              target_class: NPCActivity
            position: [500, 0]
          - id: GetOwnerChar1
            type: CallFunction
            properties:
              function: K2_GetPawn
              class: Controller
            position: [700, 0]
          # v7.8.38: AddLooseGameplayTags (plural) with tag container
          # [ENGINE] AbilitySystemBlueprintLibrary::AddLooseGameplayTags takes Actor, TagContainer, bReplicate
          # [MANIFEST] Working pattern from line 999-1010 uses MakeLiteralGameplayTag + MakeGameplayTagContainerFromTag
          - id: MakeTagContainer_AddSignaling
            type: CallFunction
            properties:
              function: MakeGameplayTagContainerFromTag
            position: [700, 100]
          - id: MakeLiteral_SignalingTag
            type: CallFunction
            properties:
              function: MakeLiteralGameplayTag
              literal_value: State.NPC.Alert.Signaling
            position: [500, 100]
          - id: AddSignalingTag
            type: CallFunction
            properties:
              function: AddLooseGameplayTags
              class: AbilitySystemBlueprintLibrary
            position: [1000, 0]
          # Get owner for montage (Guide L402-403)
          # v7.8.39: Uses SelfRef1 and GetOwnerController1 (same controller reference)
          - id: GetOwnerChar2
            type: CallFunction
            properties:
              function: K2_GetPawn
              class: Controller
            position: [1200, 0]
          # v7.8.43: AUDIT FIX - Cast Pawn to Character for PlayAnimMontage
          - id: CastPawnToCharacter
            type: DynamicCast
            properties:
              target_class: Character
            position: [1300, 0]
          # Get signal montage variable
          - id: GetSignalMontage
            type: VariableGet
            properties:
              variable_name: SignalMontage
            position: [1200, 100]
          # Play signal animation (Guide L404-405)
          - id: PlayMontage
            type: CallFunction
            properties:
              function: PlayAnimMontage
            position: [1500, 0]
          # Delay for animation (Guide L407-408)
          - id: Delay
            type: Delay
            properties:
              duration: 2.0
            position: [1600, 0]
          # Authority check before spawning (multiplayer safety)
          - id: HasAuthority
            type: CallFunction
            properties:
              function: HasAuthority
              class: Actor
            position: [1800, 0]
          - id: AuthBranch
            type: Branch
            position: [2000, 0]
          # Get reinforcement count for loop (Guide L413-414)
          - id: GetReinforcementCount
            type: VariableGet
            properties:
              variable_name: ReinforcementCount
            position: [2200, 100]
          # Subtract 1 for last index
          - id: SubtractOne
            type: CallFunction
            properties:
              function: Subtract_IntInt
              class: KismetMathLibrary
            position: [2400, 100]
          # For loop to spawn reinforcements (Guide L410-414)
          - id: SpawnLoop
            type: ForLoop
            position: [2600, 0]
          # Validate reinforcement definition (Guide L416-421)
          - id: GetReinforcementDef
            type: VariableGet
            properties:
              variable_name: ReinforcementDefinition
            position: [2800, 100]
          - id: IsValidDef
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [3000, 0]
          - id: ValidBranch
            type: Branch
            position: [3200, 0]
          # v7.8.39: Get owner location for spawn (Guide L425-427)
          # [MANIFEST] Line 13012-13026 shows working Self -> PropertyGet -> K2_GetPawn pattern
          - id: SelfRef3
            type: Self
            position: [3200, 50]
          - id: GetOwnerController3
            type: PropertyGet
            properties:
              property_name: OwnerController
              target_class: NPCActivity
            position: [3300, 0]
          - id: GetOwnerChar3
            type: CallFunction
            properties:
              function: K2_GetPawn
              class: Controller
            position: [3500, 0]
          - id: GetOwnerLocation
            type: CallFunction
            properties:
              function: K2_GetActorLocation
              class: Actor
            position: [3600, 0]
          # Random offset (Guide L428-431)
          - id: RandomUnitVector
            type: CallFunction
            properties:
              function: RandomUnitVector
              class: KismetMathLibrary
            position: [3600, 100]
          - id: GetSpawnRadius
            type: VariableGet
            properties:
              variable_name: SpawnRadius
            position: [3600, 200]
          - id: MultiplyVectorFloat
            type: CallFunction
            properties:
              function: Multiply_VectorFloat
              class: KismetMathLibrary
            position: [3800, 100]
          # Add offset to location (Guide L432-434)
          - id: AddVectors
            type: CallFunction
            properties:
              function: Add_VectorVector
              class: KismetMathLibrary
            position: [4000, 0]
          # Get owner rotation
          - id: GetOwnerRotation
            type: CallFunction
            properties:
              function: K2_GetActorRotation
              class: Actor
            position: [4000, 150]
          # Make spawn transform (Guide L435-438)
          - id: MakeTransform
            type: CallFunction
            properties:
              function: MakeTransform
              class: KismetMathLibrary
            position: [4200, 0]
          # v7.8.38: Get subsystem for spawn (Guide L441)
          # [ENGINE] SubsystemBlueprintLibrary::GetWorldSubsystem is BlueprintCallable
          # NOTE: SpawnNPC node internally creates its own GetSubsystem, so this is redundant
          # but kept for compatibility - SpawnNPC handles the subsystem access internally
          - id: GetCharSubsystem
            type: CallFunction
            properties:
              function: GetWorldSubsystem
              class: SubsystemBlueprintLibrary
              param.Class: NarrativeCharacterSubsystem
            position: [4400, 0]
          # SpawnNPC (Guide L443-445)
          - id: SpawnReinforcement
            type: SpawnNPC
            properties:
              npc_definition_variable: ReinforcementDefinition
            position: [4600, 0]
          # v7.8.17: Add Goal_MoveToDestination to reinforcement (Guide L449-470)
          # Validate spawned reinforcement
          - id: IsValidReinforcement
            type: CallFunction
            properties:
              function: IsValid
              class: KismetSystemLibrary
            position: [4800, 0]
          - id: BranchValidReinf
            type: Branch
            position: [5000, 0]
          # Get reinforcement's Activity Component (Guide 4.9.3)
          - id: GetReinfActivityComp
            type: CallFunction
            properties:
              function: GetComponentByClass
              class: Actor
              param.ComponentClass: NPCActivityComponent
            position: [5200, 0]
          # v7.8.43: AUDIT FIX - Cast ActorComponent to NPCActivityComponent
          - id: CastToReinfActivityComp
            type: DynamicCast
            properties:
              target_class: NPCActivityComponent
            position: [5300, 0]
          # v7.8.43: AUDIT FIX - Re-cast CachedAlertGoal to Goal_Alert for PropertyGet
          - id: CastCachedGoalForMove
            type: DynamicCast
            properties:
              target_class: Goal_Alert
            position: [5350, 100]
          # Construct Goal_MoveToDestination (Guide 4.9.4)
          # v7.8.44: AUDIT FIX - Use concrete Blueprint class path (NPCGoalItem is abstract)
          - id: ConstructMoveGoal
            type: ConstructObjectFromClass
            properties:
              class: /NarrativePro/Pro/Core/AI/Activities/GoToLocation/Goal_MoveToDestination.Goal_MoveToDestination_C
            position: [5400, 0]
          # Cast to Goal_MoveToDestination (Guide 4.9.5)
          - id: CastToMoveGoal
            type: DynamicCast
            properties:
              target_class: Goal_MoveToDestination
            position: [5600, 0]
          # v7.8.38: Get AlertLocation from cached goal (Guide 4.9.6.1)
          # [MANIFEST] PropertyGet pattern for Goal properties
          - id: GetAlertLocationForMove
            type: PropertyGet
            properties:
              property_name: AlertLocation
              target_class: Goal_Alert
            position: [5600, 100]
          # Set Destination on move goal (Guide 4.9.6.1)
          # v7.8.43: AUDIT FIX - Destination is Transform type, need MakeTransform from Vector
          - id: MakeDestinationTransform
            type: CallFunction
            properties:
              function: MakeTransform
              class: KismetMathLibrary
            position: [5700, 50]
          - id: SetMoveTargetLocation
            type: VariableSet
            properties:
              variable_name: Destination
              target_class: Goal_MoveToDestination
            position: [5800, 0]
          # Set GoalScore = 3.0 (Guide 4.9.6.2)
          - id: MakeMoveGoalScore
            type: MakeLiteralFloat
            properties:
              value: "3.0"
            position: [5800, 150]
          # v7.8.43: AUDIT FIX - GoalScore → DefaultScore (actual C++ property name)
          - id: SetMoveGoalScore
            type: VariableSet
            properties:
              variable_name: DefaultScore
              target_class: NPCGoalItem
            position: [6000, 0]
          # Add Goal to reinforcement (Guide 4.9.7)
          - id: AddMoveGoal
            type: CallFunction
            properties:
              function: AddGoal
              class: NPCActivityComponent
              param.bTriggerReselect: true
            position: [6200, 0]
          # Print spawn success
          - id: PrintSpawned
            type: PrintString
            properties:
              message: "BPA_Alert: Spawned reinforcement with move goal"
            position: [6400, 0]
          # v7.8.39: After loop completes - add Goal_Flee to gatherer (Guide L472-494)
          # [MANIFEST] Line 13012-13026 shows working Self -> PropertyGet -> K2_GetPawn pattern
          - id: SelfRef4
            type: Self
            position: [6400, 50]
          - id: GetOwnerController4
            type: PropertyGet
            properties:
              property_name: OwnerController
              target_class: NPCActivity
            position: [6500, 0]
          - id: GetOwnerChar4
            type: CallFunction
            properties:
              function: K2_GetPawn
              class: Controller
            position: [6700, 0]
          # v7.8.38: GetComponentByClass pattern for ActivityComponent
          # [MANIFEST] Line 3555-3560 shows working GetComponentByClass pattern
          - id: GetActivityComp
            type: CallFunction
            properties:
              function: GetComponentByClass
              class: Actor
              param.ComponentClass: NPCActivityComponent
            position: [6900, 0]
          # v7.8.43: AUDIT FIX - Cast ActorComponent to NPCActivityComponent
          - id: CastToGathererActivityComp
            type: DynamicCast
            properties:
              target_class: NPCActivityComponent
            position: [7000, 0]
          # v7.8.17: Construct Goal_Flee for gatherer (Guide 5.2)
          # v7.8.44: AUDIT FIX - Use concrete Blueprint class path (NPCGoalItem is abstract)
          - id: ConstructFleeGoal
            type: ConstructObjectFromClass
            properties:
              class: /NarrativePro/Pro/Core/AI/Activities/Attacks/Goals/Goal_Flee.Goal_Flee_C
            position: [7000, 0]
          # Cast to Goal_Flee (Guide 5.2.2)
          - id: CastToFleeGoal
            type: DynamicCast
            properties:
              target_class: Goal_Flee
            position: [7200, 0]
          # Get SpottedTarget from cached goal (Guide 5.2.3.1)
          - id: GetCachedGoalForFlee
            type: VariableGet
            properties:
              variable_name: CachedAlertGoal
            position: [7200, 100]
          # v7.8.43: AUDIT FIX - Re-cast CachedAlertGoal to Goal_Alert for PropertyGet
          - id: CastCachedGoalForFlee
            type: DynamicCast
            properties:
              target_class: Goal_Alert
            position: [7250, 150]
          # v7.8.38: PropertyGet pattern for Goal properties
          - id: GetSpottedTargetForFlee
            type: PropertyGet
            properties:
              property_name: SpottedTarget
              target_class: Goal_Alert
            position: [7300, 200]
          # Set FleeFromTarget = SpottedTarget (Guide 5.2.3.1)
          # v7.8.43: AUDIT FIX - FleeTarget → FleeFromTarget (actual BP variable name)
          - id: SetFleeTarget
            type: VariableSet
            properties:
              variable_name: FleeFromTarget
              target_class: Goal_Flee
            position: [7400, 0]
          # Set GoalScore = 3.0 (Guide 5.2.3.2)
          - id: MakeFleeGoalScore
            type: MakeLiteralFloat
            properties:
              value: "3.0"
            position: [7400, 150]
          # v7.8.43: AUDIT FIX - GoalScore → DefaultScore (actual C++ property name)
          - id: SetFleeGoalScore
            type: VariableSet
            properties:
              variable_name: DefaultScore
              target_class: NPCGoalItem
            position: [7600, 0]
          # Add Goal_Flee to gatherer (Guide 5.3)
          - id: AddFleeGoal
            type: CallFunction
            properties:
              function: AddGoal
              class: NPCActivityComponent
              param.bTriggerReselect: false
            position: [7800, 0]
          # Get cached goal for removal
          - id: GetCachedGoal
            type: VariableGet
            properties:
              variable_name: CachedAlertGoal
            position: [7800, 100]
          # v7.8.38: Remove Goal_Alert (Guide L496-500)
          # [MANIFEST] Manifest_Audit_Master_Summary shows RemoveGoal is on NPCActivityComponent
          - id: RemoveGoal
            type: CallFunction
            properties:
              function: RemoveGoal
              class: NPCActivityComponent
            position: [5400, 0]
          # Get ASC for tag removal (Guide L504)
          # v7.8.39: Get owner for tag removal using Self -> PropertyGet -> K2_GetPawn pattern
          # [MANIFEST] Line 13012-13026 shows working pattern
          - id: SelfRef5
            type: Self
            position: [5400, 50]
          - id: GetOwnerController5
            type: PropertyGet
            properties:
              property_name: OwnerController
              target_class: NPCActivity
            position: [5500, 0]
          - id: GetOwnerChar5
            type: CallFunction
            properties:
              function: K2_GetPawn
              class: Controller
            position: [5700, 0]
          # v7.8.38: RemoveLooseGameplayTags (plural) with tag container
          # [ENGINE] AbilitySystemBlueprintLibrary::RemoveLooseGameplayTags takes Actor, TagContainer, bReplicate
          # [MANIFEST] Working pattern from line 999-1010 uses MakeLiteralGameplayTag + MakeGameplayTagContainerFromTag
          - id: MakeTagContainer_RemoveSignaling
            type: CallFunction
            properties:
              function: MakeGameplayTagContainerFromTag
            position: [5700, 100]
          - id: MakeLiteral_RemoveSignalingTag
            type: CallFunction
            properties:
              function: MakeLiteralGameplayTag
              literal_value: State.NPC.Alert.Signaling
            position: [5500, 100]
          - id: RemoveSignalingTag
            type: CallFunction
            properties:
              function: RemoveLooseGameplayTags
              class: AbilitySystemBlueprintLibrary
            position: [6000, 0]
          # Print completion
          - id: PrintComplete
            type: PrintString
            properties:
              message: "BPA_Alert: Alert sequence complete"
            position: [6200, 0]
        connections:
          # Entry -> Cast to Goal_Alert
          - from: [FunctionEntry, Then]
            to: [CastToGoalAlert, Exec]
          # v7.8.39: Self -> ActivityGoal PropertyGet
          - from: [SelfRef0, self]
            to: [GetActivityGoal, Target]
          # v7.8.35: ActivityGoal is accessed via PropertyGet, not function parameter
          - from: [GetActivityGoal, ActivityGoal]
            to: [CastToGoalAlert, Object]
          # Cast -> Set cached goal
          - from: [CastToGoalAlert, Then]
            to: [SetCachedGoal, Exec]
          - from: [CastToGoalAlert, AsGoal_Alert]
            to: [SetCachedGoal, CachedAlertGoal]
          # v7.8.39: Set -> Get owner via Self -> OwnerController -> K2_GetPawn pattern
          - from: [SetCachedGoal, Then]
            to: [GetOwnerChar1, Exec]
          - from: [SelfRef1, self]
            to: [GetOwnerController1, Target]
          - from: [GetOwnerController1, ReturnValue]
            to: [GetOwnerChar1, Target]
          # v7.8.38: AddLooseGameplayTags takes Actor directly (not ASC)
          # Create tag container from literal tag
          - from: [MakeLiteral_SignalingTag, ReturnValue]
            to: [MakeTagContainer_AddSignaling, Tag]
          - from: [GetOwnerChar1, ReturnValue]
            to: [AddSignalingTag, Actor]
          - from: [MakeTagContainer_AddSignaling, ReturnValue]
            to: [AddSignalingTag, GameplayTags]
          - from: [GetOwnerChar1, Exec]
            to: [AddSignalingTag, Exec]
          # v7.8.38: Add tag -> Get owner for montage (uses same OwnerController1)
          - from: [AddSignalingTag, Then]
            to: [GetOwnerChar2, Exec]
          - from: [GetOwnerController1, ReturnValue]
            to: [GetOwnerChar2, Target]
          # v7.8.43: AUDIT FIX - Cast Pawn to Character for PlayAnimMontage
          - from: [GetOwnerChar2, Exec]
            to: [CastPawnToCharacter, Exec]
          - from: [GetOwnerChar2, ReturnValue]
            to: [CastPawnToCharacter, Object]
          - from: [CastPawnToCharacter, AsCharacter]
            to: [PlayMontage, Target]
          # v7.8.38: Fix pin name - PlayAnimMontage uses AnimMontage not MontageToPlay
          - from: [GetSignalMontage, SignalMontage]
            to: [PlayMontage, AnimMontage]
          # v7.8.43: AUDIT FIX - Exec now goes through CastPawnToCharacter
          - from: [CastPawnToCharacter, Then]
            to: [PlayMontage, Exec]
          # Play montage -> Delay
          - from: [PlayMontage, Then]
            to: [Delay, Exec]
          # Delay -> Authority check
          - from: [Delay, Completed]
            to: [HasAuthority, Exec]
          - from: [HasAuthority, ReturnValue]
            to: [AuthBranch, Condition]
          - from: [HasAuthority, Exec]
            to: [AuthBranch, Exec]
          # Authority true -> For loop
          - from: [AuthBranch, True]
            to: [SpawnLoop, Exec]
          - from: [GetReinforcementCount, ReinforcementCount]
            to: [SubtractOne, A]
          - from: [SubtractOne, ReturnValue]
            to: [SpawnLoop, LastIndex]
          # Loop body -> Validate definition
          - from: [SpawnLoop, LoopBody]
            to: [IsValidDef, Exec]
          - from: [GetReinforcementDef, ReinforcementDefinition]
            to: [IsValidDef, Object]
          - from: [IsValidDef, ReturnValue]
            to: [ValidBranch, Condition]
          - from: [IsValidDef, Exec]
            to: [ValidBranch, Exec]
          # v7.8.39: Valid true -> Get owner via Self -> OwnerController -> K2_GetPawn pattern
          - from: [ValidBranch, True]
            to: [GetOwnerChar3, Exec]
          - from: [SelfRef3, self]
            to: [GetOwnerController3, Target]
          - from: [GetOwnerController3, ReturnValue]
            to: [GetOwnerChar3, Target]
          - from: [GetOwnerChar3, ReturnValue]
            to: [GetOwnerLocation, Target]
          - from: [GetOwnerChar3, ReturnValue]
            to: [GetOwnerRotation, Target]
          - from: [GetOwnerChar3, Exec]
            to: [GetOwnerLocation, Exec]
          # Calculate spawn location
          - from: [RandomUnitVector, ReturnValue]
            to: [MultiplyVectorFloat, A]
          - from: [GetSpawnRadius, SpawnRadius]
            to: [MultiplyVectorFloat, B]
          - from: [GetOwnerLocation, ReturnValue]
            to: [AddVectors, A]
          - from: [MultiplyVectorFloat, ReturnValue]
            to: [AddVectors, B]
          # Make transform
          - from: [AddVectors, ReturnValue]
            to: [MakeTransform, Location]
          - from: [GetOwnerRotation, ReturnValue]
            to: [MakeTransform, Rotation]
          # Spawn NPC
          - from: [GetOwnerLocation, Exec]
            to: [GetCharSubsystem, Exec]
          - from: [GetCharSubsystem, Exec]
            to: [SpawnReinforcement, Exec]
          # v7.8.38: Fix pin name - SpawnNPC uses NPCData not NPCDefinition
          - from: [GetReinforcementDef, ReinforcementDefinition]
            to: [SpawnReinforcement, NPCData]
          - from: [MakeTransform, ReturnValue]
            to: [SpawnReinforcement, Transform]
          # v7.8.17: Add Goal_MoveToDestination to reinforcement (Guide 4.9)
          # SpawnReinforcement -> IsValid check
          - from: [SpawnReinforcement, Then]
            to: [IsValidReinforcement, Exec]
          - from: [SpawnReinforcement, ReturnValue]
            to: [IsValidReinforcement, Object]
          - from: [IsValidReinforcement, ReturnValue]
            to: [BranchValidReinf, Condition]
          - from: [IsValidReinforcement, Exec]
            to: [BranchValidReinf, Exec]
          # Valid -> Get reinforcement's ActivityComponent
          - from: [BranchValidReinf, True]
            to: [GetReinfActivityComp, Exec]
          - from: [SpawnReinforcement, ReturnValue]
            to: [GetReinfActivityComp, Target]
          # v7.8.43: AUDIT FIX - Cast ActorComponent to NPCActivityComponent
          - from: [GetReinfActivityComp, Exec]
            to: [CastToReinfActivityComp, Exec]
          - from: [GetReinfActivityComp, ReturnValue]
            to: [CastToReinfActivityComp, Object]
          # Construct Goal_MoveToDestination
          - from: [CastToReinfActivityComp, Then]
            to: [ConstructMoveGoal, Exec]
          - from: [CastToReinfActivityComp, AsNPCActivityComponent]
            to: [ConstructMoveGoal, Outer]
          # Cast to Goal_MoveToDestination
          - from: [ConstructMoveGoal, Then]
            to: [CastToMoveGoal, Exec]
          - from: [ConstructMoveGoal, ReturnValue]
            to: [CastToMoveGoal, Object]
          # Get AlertLocation from CachedAlertGoal (pure)
          # v7.8.43: AUDIT FIX - Re-cast NPCGoalItem to Goal_Alert for PropertyGet
          - from: [SetCachedGoal, CachedAlertGoal]
            to: [CastCachedGoalForMove, Object]
          - from: [CastCachedGoalForMove, AsGoal_Alert]
            to: [GetAlertLocationForMove, Target]
          # Set Destination on move goal (v7.8.43: AUDIT FIX - Vector→Transform via MakeTransform)
          - from: [CastToMoveGoal, Then]
            to: [SetMoveTargetLocation, Exec]
          - from: [CastToMoveGoal, AsGoal_MoveToDestination]
            to: [SetMoveTargetLocation, Target]
          - from: [GetAlertLocationForMove, ReturnValue]
            to: [MakeDestinationTransform, Location]
          - from: [MakeDestinationTransform, ReturnValue]
            to: [SetMoveTargetLocation, Destination]
          # Set GoalScore = 3.0
          - from: [SetMoveTargetLocation, Then]
            to: [SetMoveGoalScore, Exec]
          - from: [CastToMoveGoal, AsGoal_MoveToDestination]
            to: [SetMoveGoalScore, Target]
          # v7.8.43: AUDIT FIX - GoalScore → DefaultScore
          - from: [MakeMoveGoalScore, ReturnValue]
            to: [SetMoveGoalScore, DefaultScore]
          # Add Goal to reinforcement
          - from: [SetMoveGoalScore, Then]
            to: [AddMoveGoal, Exec]
          # v7.8.43: AUDIT FIX - Use casted NPCActivityComponent
          - from: [CastToReinfActivityComp, AsNPCActivityComponent]
            to: [AddMoveGoal, Target]
          - from: [CastToMoveGoal, AsGoal_MoveToDestination]
            to: [AddMoveGoal, NewGoal]
          # Print spawned
          - from: [AddMoveGoal, Then]
            to: [PrintSpawned, Exec]
          # Invalid reinforcement -> Skip to print
          - from: [BranchValidReinf, False]
            to: [PrintSpawned, Exec]
          # v7.8.38: Loop completed -> Cleanup with Goal_Flee (Guide 5)
          # v7.8.39: Use Self -> OwnerController -> K2_GetPawn pattern
          - from: [SpawnLoop, Completed]
            to: [GetOwnerChar4, Exec]
          - from: [SelfRef4, self]
            to: [GetOwnerController4, Target]
          - from: [GetOwnerController4, ReturnValue]
            to: [GetOwnerChar4, Target]
          - from: [GetOwnerChar4, ReturnValue]
            to: [GetActivityComp, Target]
          - from: [GetOwnerChar4, Exec]
            to: [GetActivityComp, Exec]
          # v7.8.43: AUDIT FIX - Cast ActorComponent to NPCActivityComponent
          - from: [GetActivityComp, Exec]
            to: [CastToGathererActivityComp, Exec]
          - from: [GetActivityComp, ReturnValue]
            to: [CastToGathererActivityComp, Object]
          # v7.8.17: Construct Goal_Flee for gatherer
          - from: [CastToGathererActivityComp, Then]
            to: [ConstructFleeGoal, Exec]
          - from: [CastToGathererActivityComp, AsNPCActivityComponent]
            to: [ConstructFleeGoal, Outer]
          # Cast to Goal_Flee
          - from: [ConstructFleeGoal, Then]
            to: [CastToFleeGoal, Exec]
          - from: [ConstructFleeGoal, ReturnValue]
            to: [CastToFleeGoal, Object]
          # Get SpottedTarget from cached goal (pure)
          # v7.8.43: AUDIT FIX - Re-cast NPCGoalItem to Goal_Alert for PropertyGet
          - from: [GetCachedGoalForFlee, CachedAlertGoal]
            to: [CastCachedGoalForFlee, Object]
          - from: [CastCachedGoalForFlee, AsGoal_Alert]
            to: [GetSpottedTargetForFlee, Target]
          # Set FleeTarget
          - from: [CastToFleeGoal, Then]
            to: [SetFleeTarget, Exec]
          - from: [CastToFleeGoal, AsGoal_Flee]
            to: [SetFleeTarget, Target]
          # v7.8.43: AUDIT FIX - FleeTarget → FleeFromTarget
          - from: [GetSpottedTargetForFlee, ReturnValue]
            to: [SetFleeTarget, FleeFromTarget]
          # Set GoalScore = 3.0
          - from: [SetFleeTarget, Then]
            to: [SetFleeGoalScore, Exec]
          - from: [CastToFleeGoal, AsGoal_Flee]
            to: [SetFleeGoalScore, Target]
          # v7.8.43: AUDIT FIX - GoalScore → DefaultScore
          - from: [MakeFleeGoalScore, ReturnValue]
            to: [SetFleeGoalScore, DefaultScore]
          # Add Goal_Flee to gatherer
          - from: [SetFleeGoalScore, Then]
            to: [AddFleeGoal, Exec]
          # v7.8.43: AUDIT FIX - Use casted NPCActivityComponent
          - from: [CastToGathererActivityComp, AsNPCActivityComponent]
            to: [AddFleeGoal, Target]
          - from: [CastToFleeGoal, AsGoal_Flee]
            to: [AddFleeGoal, NewGoal]
          # Remove Goal_Alert
          - from: [AddFleeGoal, Then]
            to: [RemoveGoal, Exec]
          # v7.8.43: AUDIT FIX - Use casted NPCActivityComponent
          - from: [CastToGathererActivityComp, AsNPCActivityComponent]
            to: [RemoveGoal, Target]
          - from: [GetCachedGoal, CachedAlertGoal]
            to: [RemoveGoal, GoalToRemove]
          # v7.8.39: Remove signaling tag via Self -> OwnerController -> K2_GetPawn pattern
          - from: [RemoveGoal, Then]
            to: [GetOwnerChar5, Exec]
          - from: [SelfRef5, self]
            to: [GetOwnerController5, Target]
          - from: [GetOwnerController5, ReturnValue]
            to: [GetOwnerChar5, Target]
          # v7.8.38: RemoveLooseGameplayTags takes Actor directly (not ASC)
          - from: [MakeLiteral_RemoveSignalingTag, ReturnValue]
            to: [MakeTagContainer_RemoveSignaling, Tag]
          - from: [GetOwnerChar5, ReturnValue]
            to: [RemoveSignalingTag, Actor]
          - from: [MakeTagContainer_RemoveSignaling, ReturnValue]
            to: [RemoveSignalingTag, GameplayTags]
          - from: [GetOwnerChar5, Exec]
            to: [RemoveSignalingTag, Exec]
          # Print complete
          - from: [RemoveSignalingTag, Then]
            to: [PrintComplete, Exec]
          # Authority false -> Skip to cleanup (no spawn on client)
          - from: [AuthBranch, False]
            to: [GetOwnerChar4, Exec]

  # v7.8.21: DISABLED - Using existing NP BPA_Interact instead per user direction
  # BPA_Gather definition removed - now using /NarrativePro/Pro/Core/AI/Activities/Interact/Goals/BPA_Interact

# ============================================================================
# NPC SYSTEMS - STALKER RANDOM AGGRESSION (FULL BOND SYSTEM v1.0.1)
# Implements: Follow/Talk/Bond/Attack/Defend probabilistic state machine
# Audit patches: PATCH-B (delegate sig), PATCH-C (state tags), PATCH-D (BecomeAggressive)
# ============================================================================
tags:  # STALKER
  - tag: State.NPC.Returned.Following
    comment: Applied during follow state
  - tag: State.NPC.Returned.Bonded
    comment: Applied when TalkCount > 0
  - tag: State.NPC.Returned.Defending
    comment: Applied while defending player
  - tag: State.NPC.Returned.Aggressive
    comment: Applied after attacking player (PERMANENT)
  - tag: State.NPC.ReturnedStalker
    comment: Base state tag for Returned Stalker NPCs
  - tag: Narrative.TaggedDialogue.Returned.StartFollowing
    comment: When follow begins
  - tag: Narrative.TaggedDialogue.Returned.Following.First
    comment: First talk (TalkCount = 1)
  - tag: Narrative.TaggedDialogue.Returned.Following.Bonding
    comment: TalkCount 2-3
  - tag: Narrative.TaggedDialogue.Returned.Following.Deep
    comment: TalkCount 4+
  - tag: Narrative.TaggedDialogue.Returned.Defending
    comment: When defending player
  - tag: Narrative.TaggedDialogue.Returned.Attacking
    comment: When attacking player
  - tag: Narrative.TaggedDialogue.Returned.GivingUp
    comment: When timeout expires

  # Father Tagged Dialogue Tags (6)
  - tag: Narrative.TaggedDialogue.Father.Combat
    comment: Father combat barks
  - tag: Narrative.TaggedDialogue.Father.Damaged
    comment: Father damaged barks
  - tag: Narrative.TaggedDialogue.Father.FormChange
    comment: Father form change barks
  - tag: Narrative.TaggedDialogue.Father.Idle
    comment: Father idle barks
  - tag: Narrative.TaggedDialogue.Father.Reactivate
    comment: Father reactivation barks
  - tag: Narrative.TaggedDialogue.Father.Sacrifice
    comment: Father sacrifice barks

# ============================================================================
# BP_ReturnedStalker - Full BeginPlay with material setup and faction tag
# ============================================================================
actor_blueprints:  # STALKER NPC BLUEPRINT
  - name: BP_ReturnedStalker
    folder: NPCs/Returned
    parent_class: NarrativeNPCCharacter
    variables:
      # Visual feedback for bond level
      - name: BondLevelMaterial
        type: Object
        class: MaterialInstanceDynamic
        comment: MID for visual bond feedback
      # Original material for reset
      - name: OriginalMaterial
        type: Object
        class: MaterialInterface
    event_graph:
      nodes:
        # BeginPlay - Initialize visual systems and faction
        - id: Event_BeginPlay
          type: Event
          properties:
            event_name: ReceiveBeginPlay
          position: [0, 0]
        # Store original material for reset
        - id: GetMesh
          type: PropertyGet
          properties:
            property_name: Mesh
            target_class: Character
          position: [400, 0]
        - id: SelfRef
          type: Self
          position: [200, 100]
        - id: GetMaterial
          type: CallFunction
          properties:
            function: GetMaterial
            parameters:
              ElementIndex: 0
          position: [600, 0]
        - id: SetOriginalMaterial
          type: VariableSet
          properties:
            variable_name: OriginalMaterial
          position: [800, 0]
        # Create dynamic material instance for bond feedback
        - id: CreateDMI
          type: CallFunction
          properties:
            function: CreateDynamicMaterialInstance
            parameters:
              ElementIndex: 0
          position: [1000, 0]
        - id: SetBondMaterial
          type: VariableSet
          properties:
            variable_name: BondLevelMaterial
          position: [1200, 0]
        # Create tag container from single tag for AddLooseGameplayTags
        # Note: AddLooseGameplayTags takes Actor (not ASC) and internally gets the ASC
        # v7.5: Use MakeLiteralGameplayTag + MakeGameplayTagContainerFromTag pattern
        - id: MakeLiteralTag_Faction
          type: CallFunction
          properties:
            function: MakeLiteralGameplayTag
            literal_value: Narrative.Factions.Returned
          position: [1300, 150]
        - id: MakeFactionTagContainer
          type: CallFunction
          properties:
            function: MakeGameplayTagContainerFromTag
            class: BlueprintGameplayTagLibrary
          position: [1500, 100]
        - id: AddFactionTag
          type: CallFunction
          properties:
            function: AddLooseGameplayTags
            class: AbilitySystemBlueprintLibrary
          position: [1700, 0]
        # Debug print
        - id: PrintReady
          type: PrintString
          properties:
            message: "BP_ReturnedStalker: Initialized with bond visual system"
          position: [1900, 0]
      connections:
        # SelfRef to GetMesh
        - from: [SelfRef, Self]
          to: [GetMesh, Target]
        # BeginPlay exec flow (PropertyGet has no exec pins, so skip to GetMaterial)
        - from: [Event_BeginPlay, Then]
          to: [GetMaterial, Exec]
        # Data connections using Mesh output
        - from: [GetMesh, Mesh]
          to: [GetMaterial, Target]
        - from: [GetMaterial, ReturnValue]
          to: [SetOriginalMaterial, OriginalMaterial]
        - from: [GetMaterial, Then]
          to: [SetOriginalMaterial, Exec]
        - from: [SetOriginalMaterial, Then]
          to: [CreateDMI, Exec]
        - from: [GetMesh, Mesh]
          to: [CreateDMI, Target]
        - from: [CreateDMI, ReturnValue]
          to: [SetBondMaterial, BondLevelMaterial]
        - from: [CreateDMI, Then]
          to: [SetBondMaterial, Exec]
        - from: [SetBondMaterial, Then]
          to: [AddFactionTag, Exec]
        # AddLooseGameplayTags parameters: Actor (the owner), GameplayTags, ShouldReplicate
        # Pass Self (the NPC actor) - the function internally gets ASC from the actor
        - from: [SelfRef, Self]
          to: [AddFactionTag, Actor]
        # v7.5: Connect literal tag to container
        - from: [MakeLiteralTag_Faction, ReturnValue]
          to: [MakeFactionTagContainer, SingleTag]
        - from: [MakeFactionTagContainer, ReturnValue]
          to: [AddFactionTag, GameplayTags]
        - from: [AddFactionTag, Then]
          to: [PrintReady, Exec]

# ============================================================================
# GoalGenerator_RandomAggression - Full Bond System Implementation
# 35 variables, 5 functions, 6 CustomEvents
# ============================================================================
actor_blueprints:  # STALKER GOAL GENERATORS
  - name: GoalGenerator_RandomAggression
    folder: AI/GoalGenerators
    parent_class: NPCGoalGenerator
    variables:
      # ═══════════════════════════════════════════════════════════════
      # CONFIGURATION VARIABLES (17) - Instance Editable
      # ═══════════════════════════════════════════════════════════════
      # Follow Detection
      - name: FollowCheckInterval
        type: Float
        default_value: "8.0"
        instance_editable: true
        comment: Seconds between follow chance rolls
      - name: FollowChance
        type: Float
        default_value: "0.15"
        instance_editable: true
        comment: Probability to start following (15%)
      - name: DetectionRange
        type: Float
        default_value: "2000.0"
        instance_editable: true
        comment: Max distance to detect player
      - name: FollowDistance
        type: Float
        default_value: "400.0"
        instance_editable: true
        comment: Distance to maintain while following
      # Follow Duration
      - name: BaseFollowDuration
        type: Float
        default_value: "20.0"
        instance_editable: true
        comment: Base timeout before giving up (seconds)
      - name: FollowDurationPerStack
        type: Float
        default_value: "5.0"
        instance_editable: true
        comment: Extra duration per TalkCount
      # Talk/Bond System
      - name: TalkCheckInterval
        type: Float
        default_value: "8.0"
        instance_editable: true
        comment: Seconds between talk rolls
      - name: TalkChance
        type: Float
        default_value: "0.3"
        instance_editable: true
        comment: Probability of talk success (30%)
      - name: MaxTalkStacks
        type: Integer
        default_value: "5"
        instance_editable: true
        comment: Maximum bond level
      # Attack System
      - name: AttackCheckInterval
        type: Float
        default_value: "3.0"
        instance_editable: true
        comment: Seconds between attack rolls
      - name: BaseAttackChance
        type: Float
        default_value: "0.25"
        instance_editable: true
        comment: Base attack probability (25%)
      - name: AttackReductionPerStack
        type: Float
        default_value: "0.05"
        instance_editable: true
        comment: Attack chance reduction per TalkCount
      - name: MinAttackChance
        type: Float
        default_value: "0.025"
        instance_editable: true
        comment: Minimum attack chance (2.5%)
      # Defend System
      - name: BaseDefendChance
        type: Float
        default_value: "0.5"
        instance_editable: true
        comment: Base defend probability (50%)
      - name: DefendBonusPerStack
        type: Float
        default_value: "0.05"
        instance_editable: true
        comment: Defend chance bonus per TalkCount
      - name: MaxDefendChance
        type: Float
        default_value: "0.75"
        instance_editable: true
        comment: Maximum defend chance (75%)
      - name: DefendRange
        type: Float
        default_value: "1500.0"
        instance_editable: true
        comment: Max distance to attacker to trigger defend
      - name: DefendGoalClass
        type: Class
        class: Goal_Attack
        instance_editable: true
        comment: Goal class to spawn when defending player
      # ═══════════════════════════════════════════════════════════════
      # RUNTIME STATE VARIABLES (7) - Not Editable
      # ═══════════════════════════════════════════════════════════════
      - name: CurrentFollowGoal
        type: Object
        class: Goal_FollowCharacter
        comment: Active follow goal reference
      - name: CurrentDefendGoal
        type: Object
        class: Goal_Attack
        comment: Active defend goal reference
      - name: FollowStartTime
        type: Float
        default_value: "0.0"
        comment: Timestamp when following started
      - name: TalkCount
        type: Integer
        default_value: "0"
        comment: Current bond level (0-5)
      - name: bIsFollowing
        type: Boolean
        default_value: "false"
        comment: Currently following player
      - name: bIsDefending
        type: Boolean
        default_value: "false"
        comment: Currently defending player
      - name: CachedPlayerCharacter
        type: Object
        class: NarrativePlayerCharacter
        comment: Cached player reference for unbinding
      # ═══════════════════════════════════════════════════════════════
      # TIMER HANDLE VARIABLES (4)
      # ═══════════════════════════════════════════════════════════════
      - name: FollowCheckTimerHandle
        type: TimerHandle
        comment: Periodic follow chance check
      - name: TalkCheckTimerHandle
        type: TimerHandle
        comment: Periodic talk roll
      - name: AttackCheckTimerHandle
        type: TimerHandle
        comment: Periodic attack roll
      - name: FollowDurationTimerHandle
        type: TimerHandle
        comment: Timeout for giving up
      - name: HealthCheckTimerHandle
        type: TimerHandle
        comment: Periodic player health check (replaces OnDamagedBy delegate)
      # ═══════════════════════════════════════════════════════════════
      # HEALTH POLLING VARIABLES (2) - Replaces OnDamagedBy delegate per Delegate_Binding_History_FINAL.md
      # ═══════════════════════════════════════════════════════════════
      - name: HealthCheckInterval
        type: Float
        default_value: "0.5"
        instance_editable: true
        comment: Seconds between health checks (fast polling for damage detection)
      - name: LastPlayerHealth
        type: Float
        default_value: "0.0"
        comment: Player's health on last check (for change detection)
      # ═══════════════════════════════════════════════════════════════
      # TAGGED DIALOGUE TAG VARIABLES (7) - Instance Editable
      # ═══════════════════════════════════════════════════════════════
      - name: Tag_StartFollowing
        type: GameplayTag
        default_value: "Narrative.TaggedDialogue.Returned.StartFollowing"
        instance_editable: true
      - name: Tag_FollowFirst
        type: GameplayTag
        default_value: "Narrative.TaggedDialogue.Returned.Following.First"
        instance_editable: true
      - name: Tag_FollowBonding
        type: GameplayTag
        default_value: "Narrative.TaggedDialogue.Returned.Following.Bonding"
        instance_editable: true
      - name: Tag_FollowDeep
        type: GameplayTag
        default_value: "Narrative.TaggedDialogue.Returned.Following.Deep"
        instance_editable: true
      - name: Tag_Defending
        type: GameplayTag
        default_value: "Narrative.TaggedDialogue.Returned.Defending"
        instance_editable: true
      - name: Tag_Attacking
        type: GameplayTag
        default_value: "Narrative.TaggedDialogue.Returned.Attacking"
        instance_editable: true
      - name: Tag_GivingUp
        type: GameplayTag
        default_value: "Narrative.TaggedDialogue.Returned.GivingUp"
        instance_editable: true
    # ═══════════════════════════════════════════════════════════════
    # FUNCTION OVERRIDES - InitializeGoalGenerator
    # ═══════════════════════════════════════════════════════════════
    function_overrides:
      - function: InitializeGoalGenerator
        nodes:
          - id: CallParent
            type: CallParent
            position: [200, 0]
          - id: GetFollowCheckInterval
            type: VariableGet
            properties:
              variable_name: FollowCheckInterval
            position: [400, 100]
          - id: SetTimer_FollowCheck
            type: CallFunction
            properties:
              function: K2_SetTimer
              class: KismetSystemLibrary
              target_self: true
              param.FunctionName: "OnFollowCheckTimer"
              param.bLooping: true
            position: [600, 0]
          - id: SetFollowCheckHandle
            type: VariableSet
            properties:
              variable_name: FollowCheckTimerHandle
            position: [800, 0]
          - id: PrintInit
            type: PrintString
            properties:
              message: "GoalGenerator_RandomAggression: Initialized with bond system"
            position: [1000, 0]
        connections:
          - from: [FunctionEntry, Then]
            to: [CallParent, Exec]
          - from: [CallParent, Exec]
            to: [SetTimer_FollowCheck, Exec]
          - from: [GetFollowCheckInterval, FollowCheckInterval]
            to: [SetTimer_FollowCheck, Time]
          - from: [SetTimer_FollowCheck, ReturnValue]
            to: [SetFollowCheckHandle, FollowCheckTimerHandle]
          - from: [SetTimer_FollowCheck, Then]
            to: [SetFollowCheckHandle, Exec]
          - from: [SetFollowCheckHandle, Then]
            to: [PrintInit, Exec]
    # ═══════════════════════════════════════════════════════════════
    # CUSTOM FUNCTIONS (5)
    # ═══════════════════════════════════════════════════════════════
    custom_functions:
      # GetCurrentFollowDuration: BaseFollowDuration + (TalkCount * FollowDurationPerStack)
      - name: GetCurrentFollowDuration
        return_type: Float
        nodes:
          - id: GetTalkCount
            type: VariableGet
            properties:
              variable_name: TalkCount
            position: [200, 0]
          - id: ToFloat
            type: CallFunction
            properties:
              function: Conv_IntToFloat
              class: KismetMathLibrary
            position: [400, 0]
          - id: GetDurationPerStack
            type: VariableGet
            properties:
              variable_name: FollowDurationPerStack
            position: [400, 100]
          - id: Multiply
            type: CallFunction
            properties:
              function: Multiply_FloatFloat
              class: KismetMathLibrary
            position: [600, 0]
          - id: GetBaseDuration
            type: VariableGet
            properties:
              variable_name: BaseFollowDuration
            position: [600, 100]
          - id: Add
            type: CallFunction
            properties:
              function: Add_FloatFloat
              class: KismetMathLibrary
            position: [800, 0]
          - id: Return
            type: Return
            position: [1000, 0]
        connections:
          - from: [GetTalkCount, TalkCount]
            to: [ToFloat, InInt]
          - from: [ToFloat, ReturnValue]
            to: [Multiply, A]
          - from: [GetDurationPerStack, FollowDurationPerStack]
            to: [Multiply, B]
          - from: [GetBaseDuration, BaseFollowDuration]
            to: [Add, A]
          - from: [Multiply, ReturnValue]
            to: [Add, B]
          - from: [Add, ReturnValue]
            to: [Return, ReturnValue]
      # GetCurrentAttackChance: Max(BaseAttackChance - (TalkCount * AttackReductionPerStack), MinAttackChance)
      - name: GetCurrentAttackChance
        return_type: Float
        nodes:
          - id: GetTalkCount
            type: VariableGet
            properties:
              variable_name: TalkCount
            position: [200, 0]
          - id: ToFloat
            type: CallFunction
            properties:
              function: Conv_IntToFloat
              class: KismetMathLibrary
            position: [400, 0]
          - id: GetReduction
            type: VariableGet
            properties:
              variable_name: AttackReductionPerStack
            position: [400, 100]
          - id: Multiply
            type: CallFunction
            properties:
              function: Multiply_FloatFloat
              class: KismetMathLibrary
            position: [600, 0]
          - id: GetBaseChance
            type: VariableGet
            properties:
              variable_name: BaseAttackChance
            position: [600, 100]
          - id: Subtract
            type: CallFunction
            properties:
              function: Subtract_FloatFloat
              class: KismetMathLibrary
            position: [800, 0]
          - id: GetMinChance
            type: VariableGet
            properties:
              variable_name: MinAttackChance
            position: [800, 100]
          - id: Max
            type: CallFunction
            properties:
              function: FMax
              class: KismetMathLibrary
            position: [1000, 0]
          - id: Return
            type: Return
            position: [1200, 0]
        connections:
          - from: [GetTalkCount, TalkCount]
            to: [ToFloat, InInt]
          - from: [ToFloat, ReturnValue]
            to: [Multiply, A]
          - from: [GetReduction, AttackReductionPerStack]
            to: [Multiply, B]
          - from: [GetBaseChance, BaseAttackChance]
            to: [Subtract, A]
          - from: [Multiply, ReturnValue]
            to: [Subtract, B]
          - from: [Subtract, ReturnValue]
            to: [Max, A]
          - from: [GetMinChance, MinAttackChance]
            to: [Max, B]
          - from: [Max, ReturnValue]
            to: [Return, ReturnValue]
      # GetCurrentDefendChance: Min(BaseDefendChance + (TalkCount * DefendBonusPerStack), MaxDefendChance)
      - name: GetCurrentDefendChance
        return_type: Float
        nodes:
          - id: GetTalkCount
            type: VariableGet
            properties:
              variable_name: TalkCount
            position: [200, 0]
          - id: ToFloat
            type: CallFunction
            properties:
              function: Conv_IntToFloat
              class: KismetMathLibrary
            position: [400, 0]
          - id: GetBonus
            type: VariableGet
            properties:
              variable_name: DefendBonusPerStack
            position: [400, 100]
          - id: Multiply
            type: CallFunction
            properties:
              function: Multiply_FloatFloat
              class: KismetMathLibrary
            position: [600, 0]
          - id: GetBaseChance
            type: VariableGet
            properties:
              variable_name: BaseDefendChance
            position: [600, 100]
          - id: Add
            type: CallFunction
            properties:
              function: Add_FloatFloat
              class: KismetMathLibrary
            position: [800, 0]
          - id: GetMaxChance
            type: VariableGet
            properties:
              variable_name: MaxDefendChance
            position: [800, 100]
          - id: Min
            type: CallFunction
            properties:
              function: FMin
              class: KismetMathLibrary
            position: [1000, 0]
          - id: Return
            type: Return
            position: [1200, 0]
        connections:
          - from: [GetTalkCount, TalkCount]
            to: [ToFloat, InInt]
          - from: [ToFloat, ReturnValue]
            to: [Multiply, A]
          - from: [GetBonus, DefendBonusPerStack]
            to: [Multiply, B]
          - from: [GetBaseChance, BaseDefendChance]
            to: [Add, A]
          - from: [Multiply, ReturnValue]
            to: [Add, B]
          - from: [Add, ReturnValue]
            to: [Min, A]
          - from: [GetMaxChance, MaxDefendChance]
            to: [Min, B]
          - from: [Min, ReturnValue]
            to: [Return, ReturnValue]
      # StopFollowing - Cleanup for TIMEOUT (returns to patrol)
      # PATCH-C: Includes state tag removal for Following, Bonded, Defending
      # v7.8.27: Added HealthCheckTimer cleanup
      - name: StopFollowing
        nodes:
          - id: GetTalkTimer
            type: VariableGet
            properties:
              variable_name: TalkCheckTimerHandle
            position: [200, 0]
          - id: ClearTalkTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [400, 0]
          - id: GetAttackTimer
            type: VariableGet
            properties:
              variable_name: AttackCheckTimerHandle
            position: [400, 100]
          - id: ClearAttackTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [600, 0]
          - id: GetDurationTimer
            type: VariableGet
            properties:
              variable_name: FollowDurationTimerHandle
            position: [600, 100]
          - id: ClearDurationTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [800, 0]
          # v7.8.27: Clear health check timer
          - id: GetHealthTimer
            type: VariableGet
            properties:
              variable_name: HealthCheckTimerHandle
            position: [800, 100]
          - id: ClearHealthTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [900, 0]
          - id: SetNotFollowing
            type: VariableSet
            properties:
              variable_name: bIsFollowing
              value: false
            position: [1100, 0]
          - id: SetNotDefending
            type: VariableSet
            properties:
              variable_name: bIsDefending
              value: false
            position: [1300, 0]
          - id: ResetTalkCount
            type: VariableSet
            properties:
              variable_name: TalkCount
              value: 0
            position: [1400, 0]
          - id: ClearFollowGoal
            type: VariableSet
            properties:
              variable_name: CurrentFollowGoal
            position: [1600, 0]
          - id: ClearDefendGoal
            type: VariableSet
            properties:
              variable_name: CurrentDefendGoal
            position: [1800, 0]
          - id: ClearPlayer
            type: VariableSet
            properties:
              variable_name: CachedPlayerCharacter
            position: [2000, 0]
          # NOTE: PATCH-C tag removal removed - GetPawn/RemoveLooseGameplayTag are C++ inline (not UFUNCTION)
          # Tags are cleaned up naturally when NPC state changes
          - id: PrintStopped
            type: PrintString
            properties:
              message: "GoalGenerator_RandomAggression: Stopped following, returning to patrol"
            position: [2200, 0]
        connections:
          - from: [FunctionEntry, Then]
            to: [ClearTalkTimer, Exec]
          - from: [GetTalkTimer, TalkCheckTimerHandle]
            to: [ClearTalkTimer, Handle]
          - from: [ClearTalkTimer, Then]
            to: [ClearAttackTimer, Exec]
          - from: [GetAttackTimer, AttackCheckTimerHandle]
            to: [ClearAttackTimer, Handle]
          - from: [ClearAttackTimer, Then]
            to: [ClearDurationTimer, Exec]
          - from: [GetDurationTimer, FollowDurationTimerHandle]
            to: [ClearDurationTimer, Handle]
          # v7.8.27: Clear health check timer
          - from: [ClearDurationTimer, Then]
            to: [ClearHealthTimer, Exec]
          - from: [GetHealthTimer, HealthCheckTimerHandle]
            to: [ClearHealthTimer, Handle]
          - from: [ClearHealthTimer, Then]
            to: [SetNotFollowing, Exec]
          - from: [SetNotFollowing, Then]
            to: [SetNotDefending, Exec]
          - from: [SetNotDefending, Then]
            to: [ResetTalkCount, Exec]
          - from: [ResetTalkCount, Then]
            to: [ClearFollowGoal, Exec]
          - from: [ClearFollowGoal, Then]
            to: [ClearDefendGoal, Exec]
          - from: [ClearDefendGoal, Then]
            to: [ClearPlayer, Exec]
          - from: [ClearPlayer, Then]
            to: [PrintStopped, Exec]
      # BecomeAggressive - AUDIT PATCH-D: Cleanup for ATTACK (permanent aggro)
      # PATCH-C: Removes Following/Bonded tags; does NOT remove Defending (let OnDefendGoalCompleted handle it)
      - name: BecomeAggressive
        nodes:
          - id: GetTalkTimer
            type: VariableGet
            properties:
              variable_name: TalkCheckTimerHandle
            position: [200, 0]
          - id: ClearTalkTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [400, 0]
          - id: GetAttackTimer
            type: VariableGet
            properties:
              variable_name: AttackCheckTimerHandle
            position: [400, 100]
          - id: ClearAttackTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [600, 0]
          - id: GetDurationTimer
            type: VariableGet
            properties:
              variable_name: FollowDurationTimerHandle
            position: [600, 100]
          - id: ClearDurationTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [800, 0]
          # v7.8.27: Clear health check timer
          - id: GetHealthTimer
            type: VariableGet
            properties:
              variable_name: HealthCheckTimerHandle
            position: [800, 100]
          - id: ClearHealthTimer
            type: CallFunction
            properties:
              function: K2_ClearAndInvalidateTimerHandle
              class: KismetSystemLibrary
              target_self: true
            position: [900, 0]
          - id: SetNotFollowing
            type: VariableSet
            properties:
              variable_name: bIsFollowing
              value: false
            position: [1100, 0]
          - id: ClearFollowGoal
            type: VariableSet
            properties:
              variable_name: CurrentFollowGoal
            position: [1300, 0]
          - id: ClearPlayer
            type: VariableSet
            properties:
              variable_name: CachedPlayerCharacter
            position: [1500, 0]
          # NOTE: PATCH-C tag removal removed - GetPawn/RemoveLooseGameplayTag are C++ inline (not UFUNCTION)
          - id: PrintAggressive
            type: PrintString
            properties:
              message: "GoalGenerator_RandomAggression: BECAME PERMANENTLY AGGRESSIVE"
            position: [1700, 0]
        connections:
          - from: [FunctionEntry, Then]
            to: [ClearTalkTimer, Exec]
          - from: [GetTalkTimer, TalkCheckTimerHandle]
            to: [ClearTalkTimer, Handle]
          - from: [ClearTalkTimer, Then]
            to: [ClearAttackTimer, Exec]
          - from: [GetAttackTimer, AttackCheckTimerHandle]
            to: [ClearAttackTimer, Handle]
          - from: [ClearAttackTimer, Then]
            to: [ClearDurationTimer, Exec]
          - from: [GetDurationTimer, FollowDurationTimerHandle]
            to: [ClearDurationTimer, Handle]
          # v7.8.27: Clear health check timer
          - from: [ClearDurationTimer, Then]
            to: [ClearHealthTimer, Exec]
          - from: [GetHealthTimer, HealthCheckTimerHandle]
            to: [ClearHealthTimer, Handle]
          - from: [ClearHealthTimer, Then]
            to: [SetNotFollowing, Exec]
          - from: [SetNotFollowing, Then]
            to: [ClearFollowGoal, Exec]
          - from: [ClearFollowGoal, Then]
            to: [ClearPlayer, Exec]
          - from: [ClearPlayer, Then]
            to: [PrintAggressive, Exec]
    # ═══════════════════════════════════════════════════════════════
    # EVENT GRAPH - 6 CustomEvents
    # ═══════════════════════════════════════════════════════════════
    event_graph:
      nodes:
        # ─────────────────────────────────────────────────────────────
        # OnFollowCheckTimer - Periodic follow chance roll
        # ─────────────────────────────────────────────────────────────
        - id: Event_OnFollowCheckTimer
          type: CustomEvent
          properties:
            event_name: OnFollowCheckTimer
          position: [0, 0]
        - id: GetIsFollowing
          type: VariableGet
          properties:
            variable_name: bIsFollowing
          position: [200, 0]
        - id: BranchNotFollowing
          type: Branch
          position: [400, 0]
        # Roll follow chance
        - id: RandomFollowRoll
          type: CallFunction
          properties:
            function: RandomFloat
            class: KismetMathLibrary
          position: [600, 0]
        - id: GetFollowChance
          type: VariableGet
          properties:
            variable_name: FollowChance
          position: [600, 100]
        - id: LessFollowChance
          type: CallFunction
          properties:
            function: Less_DoubleDouble
            class: KismetMathLibrary
          position: [800, 0]
        - id: BranchFollowRoll
          type: Branch
          position: [1000, 0]
        # Get player
        - id: GetPlayerPawn
          type: CallFunction
          properties:
            function: GetPlayerPawn
            class: GameplayStatics
          position: [1200, 0]
        - id: CastToPlayer
          type: DynamicCast
          properties:
            target_class: NarrativePlayerCharacter
          position: [1400, 0]
        - id: IsPlayerValid
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [1600, 0]
        - id: BranchPlayerValid
          type: Branch
          position: [1800, 0]
        # Start following
        - id: CachePlayer
          type: VariableSet
          properties:
            variable_name: CachedPlayerCharacter
          position: [2000, 0]
        - id: SetFollowingTrue
          type: VariableSet
          properties:
            variable_name: bIsFollowing
            value: true
          position: [2200, 0]
        - id: PrintStartFollow
          type: PrintString
          properties:
            message: "GoalGenerator_RandomAggression: Started following player"
          position: [2400, 0]
        # ─────────────────────────────────────────────────────────────
        # Follow Setup - Goal creation, delegate binding, timer setup
        # Per Guide v2.3 Phase 4 Steps 18-25
        # ─────────────────────────────────────────────────────────────
        # Get NPC pawn from OwnerController (inherited from NPCGoalGenerator)
        - id: GetOwnerController
          type: VariableGet
          properties:
            variable_name: OwnerController
          position: [2600, 100]
        - id: GetNPCPawn
          type: CallFunction
          properties:
            function: K2_GetPawn
            class: Controller
          position: [2600, 0]
        - id: CastToNPCChar
          type: DynamicCast
          properties:
            target_class: NarrativeNPCCharacter
          position: [2800, 0]
        # Get Activity Component (pure function on NPC)
        - id: GetActivityComp
          type: CallFunction
          properties:
            function: GetActivityComponent
            class: NarrativeNPCCharacter
          position: [3000, 100]
        # Construct Goal_FollowCharacter (Guide 18.1)
        # v7.8.26: Use full Narrative Pro Blueprint path
        - id: ConstructFollowGoal
          type: ConstructObjectFromClass
          properties:
            class: /NarrativePro/Pro/Core/AI/Activities/FollowCharacter/Goal_FollowCharacter.Goal_FollowCharacter_C
          position: [3000, 0]
        - id: CastToFollowGoal
          type: DynamicCast
          properties:
            target_class: /NarrativePro/Pro/Core/AI/Activities/FollowCharacter/Goal_FollowCharacter.Goal_FollowCharacter_C
          position: [3200, 0]
        # Configure goal - set TargetToFollow (Guide 18.2.1)
        - id: SetTargetToFollow
          type: PropertySet
          properties:
            property_name: TargetToFollow
            target_class: /NarrativePro/Pro/Core/AI/Activities/FollowCharacter/Goal_FollowCharacter.Goal_FollowCharacter_C
          position: [3400, 0]
        # Store goal reference (Guide 18.3)
        - id: StoreFollowGoal
          type: VariableSet
          properties:
            variable_name: CurrentFollowGoal
          position: [3600, 0]
        # Add goal to activity component (Guide 19.1)
        - id: AddFollowGoal
          type: CallFunction
          properties:
            function: AddGoal
            class: NPCActivityComponent
            param.bTriggerReselect: true
          position: [3800, 0]
        # Play StartFollowing dialogue (Guide 21.2)
        - id: GetStartFollowTag
          type: VariableGet
          properties:
            variable_name: Tag_StartFollowing
          position: [4000, 100]
        - id: PlayStartDialogue
          type: CallFunction
          properties:
            function: PlayTaggedDialogue
            class: NarrativeNPCCharacter
          position: [4000, 0]
        # v7.8.27: Health polling replaces OnDamagedBy delegate (per Delegate_Binding_History_FINAL.md)
        # Get initial player health and start health check timer
        - id: CastPlayerToNarrativeChar
          type: DynamicCast
          properties:
            target_class: NarrativeCharacter
          position: [4200, 0]
        - id: GetInitialHealth
          type: CallFunction
          properties:
            function: GetHealth
            class: NarrativeCharacter
          position: [4400, 0]
        - id: StoreInitialHealth
          type: VariableSet
          properties:
            variable_name: LastPlayerHealth
          position: [4500, 0]
        - id: GetHealthCheckInterval
          type: VariableGet
          properties:
            variable_name: HealthCheckInterval
          position: [4600, 100]
        - id: SetTimerHealthCheck
          type: CallFunction
          properties:
            function: K2_SetTimer
            class: KismetSystemLibrary
            target_self: true
            param.FunctionName: "OnHealthCheckTimer"
            param.bLooping: true
          position: [4600, 0]
        - id: StoreHealthCheckHandle
          type: VariableSet
          properties:
            variable_name: HealthCheckTimerHandle
          position: [4700, 0]
        # Start TalkCheckTimer (Guide 23)
        - id: GetTalkInterval
          type: VariableGet
          properties:
            variable_name: TalkCheckInterval
          position: [4800, 100]
        - id: SetTimerTalk
          type: CallFunction
          properties:
            function: K2_SetTimer
            class: KismetSystemLibrary
            target_self: true
            param.FunctionName: "OnTalkCheckTimer"
            param.bLooping: true
          position: [4800, 0]
        - id: StoreTalkHandle
          type: VariableSet
          properties:
            variable_name: TalkCheckTimerHandle
          position: [5000, 0]
        # Start AttackCheckTimer (Guide 24)
        - id: GetAttackInterval
          type: VariableGet
          properties:
            variable_name: AttackCheckInterval
          position: [5200, 100]
        - id: SetTimerAttack
          type: CallFunction
          properties:
            function: K2_SetTimer
            class: KismetSystemLibrary
            target_self: true
            param.FunctionName: "OnAttackCheckTimer"
            param.bLooping: true
          position: [5200, 0]
        - id: StoreAttackHandle
          type: VariableSet
          properties:
            variable_name: AttackCheckTimerHandle
          position: [5400, 0]
        # Start FollowDurationTimer (Guide 25) - non-looping
        - id: CallGetDuration
          type: CallFunction
          properties:
            function: GetCurrentFollowDuration
            target_self: true
          position: [5600, 0]
        - id: SetTimerDuration
          type: CallFunction
          properties:
            function: K2_SetTimer
            class: KismetSystemLibrary
            target_self: true
            param.FunctionName: "OnFollowDurationExpired"
            param.bLooping: false
          position: [5800, 0]
        - id: StoreDurationHandle
          type: VariableSet
          properties:
            variable_name: FollowDurationTimerHandle
          position: [6000, 0]
        - id: PrintSetupComplete
          type: PrintString
          properties:
            message: "GoalGenerator_RandomAggression: Follow setup complete - goal added, timers started"
          position: [6200, 0]
        # ─────────────────────────────────────────────────────────────
        # OnTalkCheckTimer - Periodic talk roll
        # ─────────────────────────────────────────────────────────────
        - id: Event_OnTalkCheckTimer
          type: CustomEvent
          properties:
            event_name: OnTalkCheckTimer
          position: [0, 500]
        - id: GetIsFollowingTalk
          type: VariableGet
          properties:
            variable_name: bIsFollowing
          position: [200, 500]
        - id: BranchFollowingTalk
          type: Branch
          position: [400, 500]
        - id: GetTalkCountCheck
          type: VariableGet
          properties:
            variable_name: TalkCount
          position: [600, 500]
        - id: GetMaxTalkStacks
          type: VariableGet
          properties:
            variable_name: MaxTalkStacks
          position: [600, 600]
        - id: LessTalkMax
          type: CallFunction
          properties:
            function: Less_IntInt
            class: KismetMathLibrary
          position: [800, 500]
        - id: BranchTalkMax
          type: Branch
          position: [1000, 500]
        - id: RandomTalkRoll
          type: CallFunction
          properties:
            function: RandomFloat
            class: KismetMathLibrary
          position: [1200, 500]
        - id: GetTalkChance
          type: VariableGet
          properties:
            variable_name: TalkChance
          position: [1200, 600]
        - id: LessTalkChance
          type: CallFunction
          properties:
            function: Less_DoubleDouble
            class: KismetMathLibrary
          position: [1400, 500]
        - id: BranchTalkRoll
          type: Branch
          position: [1600, 500]
        - id: GetTalkCountInc
          type: VariableGet
          properties:
            variable_name: TalkCount
          position: [1800, 500]
        - id: AddOne
          type: CallFunction
          properties:
            function: Add_IntInt
            class: KismetMathLibrary
          position: [2000, 500]
        - id: SetTalkCount
          type: VariableSet
          properties:
            variable_name: TalkCount
          position: [2200, 500]
        - id: PrintTalkSuccess
          type: PrintString
          properties:
            message: "GoalGenerator_RandomAggression: Talk success, bond increased"
          position: [2400, 500]
        # ─────────────────────────────────────────────────────────────
        # OnAttackCheckTimer - Periodic attack roll
        # ─────────────────────────────────────────────────────────────
        - id: Event_OnAttackCheckTimer
          type: CustomEvent
          properties:
            event_name: OnAttackCheckTimer
          position: [0, 1000]
        - id: GetIsFollowingAtk
          type: VariableGet
          properties:
            variable_name: bIsFollowing
          position: [200, 1000]
        - id: BranchFollowingAtk
          type: Branch
          position: [400, 1000]
        - id: GetIsDefendingAtk
          type: VariableGet
          properties:
            variable_name: bIsDefending
          position: [600, 1000]
        - id: NotDefending
          type: CallFunction
          properties:
            function: Not_PreBool
            class: KismetMathLibrary
          position: [800, 1000]
        - id: BranchNotDefending
          type: Branch
          position: [1000, 1000]
        - id: CallGetAttackChance
          type: CallFunction
          properties:
            function: GetCurrentAttackChance
            target_self: true
          position: [1200, 1000]
        - id: RandomAttackRoll
          type: CallFunction
          properties:
            function: RandomFloat
            class: KismetMathLibrary
          position: [1400, 1000]
        - id: LessAttackChance
          type: CallFunction
          properties:
            function: Less_DoubleDouble
            class: KismetMathLibrary
          position: [1600, 1000]
        - id: BranchAttackRoll
          type: Branch
          position: [1800, 1000]
        - id: PrintAttackDecided
          type: PrintString
          properties:
            message: "GoalGenerator_RandomAggression: ATTACK ROLL SUCCESS - becoming aggressive!"
          position: [2000, 1000]
        - id: CallBecomeAggressive
          type: CallFunction
          properties:
            function: BecomeAggressive
            target_self: true
          position: [2200, 1000]
        # ─────────────────────────────────────────────────────────────
        # OnHealthCheckTimer - v7.8.27: Health polling (replaces OnDamagedBy delegate)
        # Per Delegate_Binding_History_FINAL.md: OnDamagedBy has const FGameplayEffectSpec& = DO NOT USE
        # Pattern from Support_Buffer_Healer_NPC_Implementation_Guide_v1_4.md Phase 4.3.9
        # ─────────────────────────────────────────────────────────────
        - id: Event_OnHealthCheckTimer
          type: CustomEvent
          properties:
            event_name: OnHealthCheckTimer
          position: [0, 1500]
        # Get cached player and check health change
        - id: GetCachedPlayer_Health
          type: VariableGet
          properties:
            variable_name: CachedPlayerCharacter
          position: [150, 1500]
        - id: IsPlayerValid_Health
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [300, 1500]
        - id: BranchPlayerValid_Health
          type: Branch
          position: [450, 1500]
        # Cast to NarrativeCharacter for GetHealth (per Support Buffer guide 4.3.9)
        - id: CastPlayerToNarChar
          type: DynamicCast
          properties:
            target_class: NarrativeCharacter
          position: [600, 1500]
        - id: GetCurrentHealth
          type: CallFunction
          properties:
            function: GetHealth
            class: NarrativeCharacter
          position: [750, 1500]
        - id: GetLastHealth
          type: VariableGet
          properties:
            variable_name: LastPlayerHealth
          position: [900, 1600]
        # Check if health decreased (damage detected)
        - id: HealthDecreased
          type: CallFunction
          properties:
            function: Less_DoubleDouble
            class: KismetMathLibrary
          position: [900, 1500]
        - id: BranchHealthDecreased
          type: Branch
          position: [1050, 1500]
        # Update LastPlayerHealth for next check
        - id: UpdateLastHealth
          type: VariableSet
          properties:
            variable_name: LastPlayerHealth
          position: [1200, 1500]
        # Check if following (only defend if following)
        - id: GetIsFollowingDef
          type: VariableGet
          properties:
            variable_name: bIsFollowing
          position: [1350, 1500]
        - id: BranchFollowingDef
          type: Branch
          position: [1500, 1500]
        - id: GetIsDefendingDef
          type: VariableGet
          properties:
            variable_name: bIsDefending
          position: [1650, 1500]
        - id: NotDefendingDef
          type: CallFunction
          properties:
            function: Not_PreBool
            class: KismetMathLibrary
          position: [1800, 1500]
        - id: BranchNotDefendingDef
          type: Branch
          position: [1950, 1500]
        # Get perceived hostile actors via AIPerception (already bound in InitializeGoalGenerator)
        # Use GetCurrentlyPerceivedActors from owner controller's perception component
        - id: SelfRef_Def
          type: Self
          position: [2050, 1600]
        - id: GetOwnerControllerDef
          type: PropertyGet
          properties:
            property_name: OwnerController
            target_class: NPCGoalGenerator
          position: [2100, 1500]
        - id: GetPerceptionCompDef
          type: CallFunction
          properties:
            function: GetComponentByClass
            class: Actor
            param.ComponentClass: AIPerceptionComponent
          position: [2250, 1500]
        - id: CastToPerceptionDef
          type: DynamicCast
          properties:
            target_class: AIPerceptionComponent
          position: [2400, 1500]
        - id: GetPerceivedActors
          type: CallFunction
          properties:
            function: GetCurrentlyPerceivedActors
            class: AIPerceptionComponent
          position: [2550, 1500]
        # Get first perceived actor as attacker
        # v7.8.28: Skip array size check - rely on IsValid after GetArrayItem
        # If array is empty, GetArrayItem(0) returns null which fails IsValid check
        - id: GetFirstPerceived
          type: GetArrayItem
          position: [2700, 1500]
        # Cast to NarrativeCharacter for SetDefendTarget.TargetToAttack
        - id: CastToAttacker
          type: DynamicCast
          properties:
            target_class: NarrativeCharacter
          position: [3200, 1500]
        - id: IsAttackerValid
          type: CallFunction
          properties:
            function: IsValid
            class: KismetSystemLibrary
          position: [3350, 1500]
        - id: BranchAttackerValid
          type: Branch
          position: [3500, 1500]
        - id: CallGetDefendChance
          type: CallFunction
          properties:
            function: GetCurrentDefendChance
            target_self: true
          position: [3650, 1500]
        - id: RandomDefendRoll
          type: CallFunction
          properties:
            function: RandomFloat
            class: KismetMathLibrary
          position: [3800, 1500]
        - id: LessDefendChance
          type: CallFunction
          properties:
            function: Less_DoubleDouble
            class: KismetMathLibrary
          position: [3950, 1500]
        - id: BranchDefendRoll
          type: Branch
          position: [4100, 1500]
        - id: SetDefendingTrue
          type: VariableSet
          properties:
            variable_name: bIsDefending
            value: true
          position: [4250, 1500]
        # Create Goal_Attack for defending using SpawnObject
        - id: GetDefendGoalClass
          type: VariableGet
          properties:
            variable_name: DefendGoalClass
          position: [4400, 1500]
        - id: CreateDefendGoal
          type: CallFunction
          properties:
            function: SpawnObject
            class: GameplayStatics
          position: [4550, 1500]
        # Cast to Goal_Attack to set target
        - id: CastToDefendGoal
          type: DynamicCast
          properties:
            target_class: Goal_Attack
          position: [4700, 1500]
        # Set target on defend goal (attacker is the target to attack)
        - id: SetDefendTarget
          type: PropertySet
          properties:
            property_name: TargetToAttack
            target_class: Goal_Attack
          position: [4850, 1500]
        # Store defend goal reference
        - id: StoreDefendGoal
          type: VariableSet
          properties:
            variable_name: CurrentDefendGoal
          position: [5000, 1500]
        # Get activity component (OwnerActivityComponent is a BlueprintReadOnly property on NPCGoalGenerator)
        - id: GetActivityCompDef
          type: VariableGet
          properties:
            variable_name: OwnerActivityComponent
          position: [5150, 1500]
        # ─────────────────────────────────────────────────────────────
        # OnDefendGoalCompleted - v1.0.2 PATCH-E: Bound to OnGoalRemoved
        # IMPORTANT: CustomEvent MUST be defined BEFORE the binding node (v4.37)
        # Fires when defend Goal_Attack is removed for ANY reason:
        # - Target killed (success + auto-remove)
        # - Target escapes
        # - Stalker dies
        # - Goal timeout
        # v4.36: Parameters match FOnGoalSignature delegate signature
        # ─────────────────────────────────────────────────────────────
        - id: Event_OnDefendGoalCompleted
          type: CustomEvent
          properties:
            event_name: OnDefendGoalCompleted
            param.0.name: Activity
            param.0.type: NPCActivity
            param.1.name: Goal
            param.1.type: NPCGoalItem
          position: [0, 2000]
        - id: SetDefendingFalse
          type: VariableSet
          properties:
            variable_name: bIsDefending
            value: false
          position: [200, 2000]
        - id: ClearDefendGoalRef
          type: VariableSet
          properties:
            variable_name: CurrentDefendGoal
          position: [400, 2000]
        - id: PrintDefendComplete
          type: PrintString
          properties:
            message: "GoalGenerator_RandomAggression: Defend goal completed"
          position: [600, 2000]
        # Add goal to activity component
        - id: AddDefendGoal
          type: CallFunction
          properties:
            function: AddGoal
            class: NPCActivityComponent
            param.bTriggerReselect: true
          position: [5300, 1500]
        # v1.0.2 PATCH-E: Bind to OnGoalRemoved (NOT OnGoalSucceeded + OnGoalFailed)
        # OnGoalRemoved fires in ALL termination cases (success, failure, timeout, cleanup)
        - id: BindDefendGoalRemoved
          type: CallFunction
          properties:
            function: BindEventToOnGoalRemoved
            delegate_event: OnDefendGoalCompleted
            target_class: NPCGoalItem
          position: [4200, 1500]
        - id: PrintDefending
          type: PrintString
          properties:
            message: "GoalGenerator_RandomAggression: Defending player!"
          position: [4400, 1500]
        # ─────────────────────────────────────────────────────────────
        # OnFollowDurationExpired - Timeout reached
        # ─────────────────────────────────────────────────────────────
        - id: Event_OnFollowDurationExpired
          type: CustomEvent
          properties:
            event_name: OnFollowDurationExpired
          position: [0, 2500]
        - id: PrintGivingUp
          type: PrintString
          properties:
            message: "GoalGenerator_RandomAggression: Follow duration expired, giving up"
          position: [200, 2500]
        - id: CallStopFollowing
          type: CallFunction
          properties:
            function: StopFollowing
            target_self: true
          position: [400, 2500]
      connections:
        # OnFollowCheckTimer connections
        # v7.8.29: Clean pattern - direct exec bypassing pure nodes (RandomFloat, Less_DoubleDouble)
        - from: [Event_OnFollowCheckTimer, Then]
          to: [BranchNotFollowing, Exec]
        - from: [GetIsFollowing, bIsFollowing]
          to: [BranchNotFollowing, Condition]
        - from: [BranchNotFollowing, False]
          to: [BranchFollowRoll, Exec]
        # Data flow through pure nodes
        - from: [RandomFollowRoll, ReturnValue]
          to: [LessFollowChance, A]
        - from: [GetFollowChance, FollowChance]
          to: [LessFollowChance, B]
        - from: [LessFollowChance, ReturnValue]
          to: [BranchFollowRoll, Condition]
        - from: [BranchFollowRoll, True]
          to: [GetPlayerPawn, Exec]
        - from: [GetPlayerPawn, ReturnValue]
          to: [CastToPlayer, Object]
        - from: [GetPlayerPawn, Then]
          to: [CastToPlayer, Exec]
        - from: [CastToPlayer, AsNarrativePlayerCharacter]
          to: [IsPlayerValid, Object]
        - from: [CastToPlayer, Then]
          to: [BranchPlayerValid, Exec]
        - from: [IsPlayerValid, ReturnValue]
          to: [BranchPlayerValid, Condition]
        - from: [BranchPlayerValid, True]
          to: [CachePlayer, Exec]
        - from: [CastToPlayer, AsNarrativePlayerCharacter]
          to: [CachePlayer, CachedPlayerCharacter]
        - from: [CachePlayer, Then]
          to: [SetFollowingTrue, Exec]
        - from: [SetFollowingTrue, Then]
          to: [PrintStartFollow, Exec]
        # Follow Setup connections (Guide v2.3 Phase 4 Steps 18-25)
        - from: [PrintStartFollow, Then]
          to: [GetNPCPawn, Exec]
        - from: [GetOwnerController, OwnerController]
          to: [GetNPCPawn, Target]
        - from: [GetNPCPawn, ReturnValue]
          to: [CastToNPCChar, Object]
        - from: [GetNPCPawn, Then]
          to: [CastToNPCChar, Exec]
        - from: [CastToNPCChar, AsNarrativeNPCCharacter]
          to: [GetActivityComp, Target]
        - from: [CastToNPCChar, Then]
          to: [ConstructFollowGoal, Exec]
        - from: [GetActivityComp, ReturnValue]
          to: [ConstructFollowGoal, Outer]
        - from: [ConstructFollowGoal, ReturnValue]
          to: [CastToFollowGoal, Object]
        - from: [ConstructFollowGoal, Then]
          to: [CastToFollowGoal, Exec]
        - from: [CastToFollowGoal, AsGoal_FollowCharacter]
          to: [SetTargetToFollow, Target]
        - from: [CastToPlayer, AsNarrativePlayerCharacter]
          to: [SetTargetToFollow, TargetToFollow]
        - from: [CastToFollowGoal, Then]
          to: [SetTargetToFollow, Exec]
        - from: [CastToFollowGoal, AsGoal_FollowCharacter]
          to: [StoreFollowGoal, CurrentFollowGoal]
        - from: [SetTargetToFollow, Then]
          to: [StoreFollowGoal, Exec]
        - from: [GetActivityComp, ReturnValue]
          to: [AddFollowGoal, Target]
        - from: [CastToFollowGoal, AsGoal_FollowCharacter]
          to: [AddFollowGoal, NewGoal]
        - from: [StoreFollowGoal, Then]
          to: [AddFollowGoal, Exec]
        - from: [CastToNPCChar, AsNarrativeNPCCharacter]
          to: [PlayStartDialogue, Target]
        - from: [GetStartFollowTag, Tag_StartFollowing]
          to: [PlayStartDialogue, Tag]
        - from: [CastToPlayer, AsNarrativePlayerCharacter]
          to: [PlayStartDialogue, DialogueInstigator]
        - from: [AddFollowGoal, Then]
          to: [PlayStartDialogue, Exec]
        # v7.8.27: Health polling connections (replaces OnDamagedBy delegate binding)
        - from: [CastToPlayer, AsNarrativePlayerCharacter]
          to: [CastPlayerToNarrativeChar, Object]
        - from: [PlayStartDialogue, Then]
          to: [CastPlayerToNarrativeChar, Exec]
        - from: [CastPlayerToNarrativeChar, AsNarrativeCharacter]
          to: [GetInitialHealth, Target]
        - from: [CastPlayerToNarrativeChar, Then]
          to: [GetInitialHealth, Exec]
        - from: [GetInitialHealth, ReturnValue]
          to: [StoreInitialHealth, LastPlayerHealth]
        - from: [GetInitialHealth, Then]
          to: [StoreInitialHealth, Exec]
        - from: [GetHealthCheckInterval, HealthCheckInterval]
          to: [SetTimerHealthCheck, Time]
        - from: [StoreInitialHealth, Then]
          to: [SetTimerHealthCheck, Exec]
        - from: [SetTimerHealthCheck, ReturnValue]
          to: [StoreHealthCheckHandle, HealthCheckTimerHandle]
        - from: [SetTimerHealthCheck, Then]
          to: [StoreHealthCheckHandle, Exec]
        - from: [GetTalkInterval, TalkCheckInterval]
          to: [SetTimerTalk, Time]
        - from: [StoreHealthCheckHandle, Then]
          to: [SetTimerTalk, Exec]
        - from: [SetTimerTalk, ReturnValue]
          to: [StoreTalkHandle, TalkCheckTimerHandle]
        - from: [SetTimerTalk, Then]
          to: [StoreTalkHandle, Exec]
        - from: [GetAttackInterval, AttackCheckInterval]
          to: [SetTimerAttack, Time]
        - from: [StoreTalkHandle, Then]
          to: [SetTimerAttack, Exec]
        - from: [SetTimerAttack, ReturnValue]
          to: [StoreAttackHandle, AttackCheckTimerHandle]
        - from: [SetTimerAttack, Then]
          to: [StoreAttackHandle, Exec]
        - from: [StoreAttackHandle, Then]
          to: [CallGetDuration, Exec]
        - from: [CallGetDuration, ReturnValue]
          to: [SetTimerDuration, Time]
        - from: [CallGetDuration, Then]
          to: [SetTimerDuration, Exec]
        - from: [SetTimerDuration, ReturnValue]
          to: [StoreDurationHandle, FollowDurationTimerHandle]
        - from: [SetTimerDuration, Then]
          to: [StoreDurationHandle, Exec]
        - from: [StoreDurationHandle, Then]
          to: [PrintSetupComplete, Exec]
        # OnTalkCheckTimer connections
        - from: [Event_OnTalkCheckTimer, Then]
          to: [BranchFollowingTalk, Exec]
        - from: [GetIsFollowingTalk, bIsFollowing]
          to: [BranchFollowingTalk, Condition]
        - from: [BranchFollowingTalk, True]
          to: [BranchTalkMax, Exec]
        - from: [GetTalkCountCheck, TalkCount]
          to: [LessTalkMax, A]
        - from: [GetMaxTalkStacks, MaxTalkStacks]
          to: [LessTalkMax, B]
        - from: [LessTalkMax, ReturnValue]
          to: [BranchTalkMax, Condition]
        # v7.8.29: Clean pattern - direct exec bypassing pure RandomFloat
        - from: [BranchTalkMax, True]
          to: [BranchTalkRoll, Exec]
        - from: [RandomTalkRoll, ReturnValue]
          to: [LessTalkChance, A]
        - from: [GetTalkChance, TalkChance]
          to: [LessTalkChance, B]
        - from: [LessTalkChance, ReturnValue]
          to: [BranchTalkRoll, Condition]
        - from: [BranchTalkRoll, True]
          to: [SetTalkCount, Exec]
        - from: [GetTalkCountInc, TalkCount]
          to: [AddOne, A]
        - from: [AddOne, ReturnValue]
          to: [SetTalkCount, TalkCount]
        - from: [SetTalkCount, Then]
          to: [PrintTalkSuccess, Exec]
        # OnAttackCheckTimer connections
        - from: [Event_OnAttackCheckTimer, Then]
          to: [BranchFollowingAtk, Exec]
        - from: [GetIsFollowingAtk, bIsFollowing]
          to: [BranchFollowingAtk, Condition]
        - from: [BranchFollowingAtk, True]
          to: [BranchNotDefending, Exec]
        - from: [GetIsDefendingAtk, bIsDefending]
          to: [NotDefending, A]
        - from: [NotDefending, ReturnValue]
          to: [BranchNotDefending, Condition]
        - from: [BranchNotDefending, True]
          to: [CallGetAttackChance, Exec]
        # v7.8.29: Clean pattern - direct exec bypassing pure RandomFloat
        - from: [CallGetAttackChance, Then]
          to: [BranchAttackRoll, Exec]
        - from: [RandomAttackRoll, ReturnValue]
          to: [LessAttackChance, A]
        - from: [CallGetAttackChance, ReturnValue]
          to: [LessAttackChance, B]
        - from: [LessAttackChance, ReturnValue]
          to: [BranchAttackRoll, Condition]
        - from: [BranchAttackRoll, True]
          to: [PrintAttackDecided, Exec]
        - from: [PrintAttackDecided, Then]
          to: [CallBecomeAggressive, Exec]
        # OnHealthCheckTimer connections - v7.8.27 (replaces OnPlayerDamaged per Delegate_Binding_History_FINAL.md)
        - from: [Event_OnHealthCheckTimer, Then]
          to: [IsPlayerValid_Health, Exec]
        - from: [GetCachedPlayer_Health, CachedPlayerCharacter]
          to: [IsPlayerValid_Health, Object]
        - from: [IsPlayerValid_Health, ReturnValue]
          to: [BranchPlayerValid_Health, Condition]
        - from: [IsPlayerValid_Health, Then]
          to: [BranchPlayerValid_Health, Exec]
        - from: [BranchPlayerValid_Health, True]
          to: [CastPlayerToNarChar, Exec]
        - from: [GetCachedPlayer_Health, CachedPlayerCharacter]
          to: [CastPlayerToNarChar, Object]
        - from: [CastPlayerToNarChar, AsNarrativeCharacter]
          to: [GetCurrentHealth, Target]
        - from: [CastPlayerToNarChar, Then]
          to: [GetCurrentHealth, Exec]
        - from: [GetCurrentHealth, ReturnValue]
          to: [HealthDecreased, A]
        - from: [GetLastHealth, LastPlayerHealth]
          to: [HealthDecreased, B]
        - from: [HealthDecreased, ReturnValue]
          to: [BranchHealthDecreased, Condition]
        - from: [GetCurrentHealth, Then]
          to: [BranchHealthDecreased, Exec]
        # Always update LastPlayerHealth after check
        - from: [BranchHealthDecreased, True]
          to: [UpdateLastHealth, Exec]
        - from: [GetCurrentHealth, ReturnValue]
          to: [UpdateLastHealth, LastPlayerHealth]
        - from: [UpdateLastHealth, Then]
          to: [BranchFollowingDef, Exec]
        - from: [GetIsFollowingDef, bIsFollowing]
          to: [BranchFollowingDef, Condition]
        - from: [BranchFollowingDef, True]
          to: [BranchNotDefendingDef, Exec]
        - from: [GetIsDefendingDef, bIsDefending]
          to: [NotDefendingDef, A]
        - from: [NotDefendingDef, ReturnValue]
          to: [BranchNotDefendingDef, Condition]
        - from: [BranchNotDefendingDef, True]
          to: [GetOwnerControllerDef, Exec]
        # Self reference for PropertyGet
        - from: [SelfRef_Def, Self]
          to: [GetOwnerControllerDef, self]
        # Get perceived actors for attacker detection
        # Get perceived actors for attacker detection
        - from: [GetOwnerControllerDef, OwnerController]
          to: [GetPerceptionCompDef, Target]
        - from: [GetOwnerControllerDef, Then]
          to: [GetPerceptionCompDef, Exec]
        - from: [GetPerceptionCompDef, ReturnValue]
          to: [CastToPerceptionDef, Object]
        - from: [GetPerceptionCompDef, Then]
          to: [CastToPerceptionDef, Exec]
        - from: [CastToPerceptionDef, AsAIPerceptionComponent]
          to: [GetPerceivedActors, Target]
        - from: [CastToPerceptionDef, Then]
          to: [GetPerceivedActors, Exec]
        # v7.8.28: Skip array size check - GetFirstPerceived returns null for empty array
        # which fails the downstream IsValid check
        - from: [GetPerceivedActors, OutActors]
          to: [GetFirstPerceived, Array]
        - from: [GetPerceivedActors, Then]
          to: [CastToAttacker, Exec]
        - from: [GetFirstPerceived, Output]
          to: [CastToAttacker, Object]
        - from: [CastToAttacker, AsNarrativeCharacter]
          to: [IsAttackerValid, Object]
        - from: [CastToAttacker, Then]
          to: [BranchAttackerValid, Exec]
        - from: [IsAttackerValid, ReturnValue]
          to: [BranchAttackerValid, Condition]
        - from: [BranchAttackerValid, True]
          to: [CallGetDefendChance, Exec]
        # v7.8.29: Clean pattern - direct exec bypassing pure RandomFloat
        - from: [CallGetDefendChance, Then]
          to: [BranchDefendRoll, Exec]
        - from: [RandomDefendRoll, ReturnValue]
          to: [LessDefendChance, A]
        - from: [CallGetDefendChance, ReturnValue]
          to: [LessDefendChance, B]
        - from: [LessDefendChance, ReturnValue]
          to: [BranchDefendRoll, Condition]
        - from: [BranchDefendRoll, True]
          to: [SetDefendingTrue, Exec]
        # v1.0.2: Defend goal creation and OnGoalRemoved binding (PATCH-E)
        - from: [SetDefendingTrue, Then]
          to: [CreateDefendGoal, Exec]
        - from: [GetDefendGoalClass, DefendGoalClass]
          to: [CreateDefendGoal, ObjectClass]
        - from: [CreateDefendGoal, ReturnValue]
          to: [CastToDefendGoal, Object]
        - from: [CreateDefendGoal, Then]
          to: [CastToDefendGoal, Exec]
        - from: [CastToDefendGoal, AsGoal_Attack]
          to: [SetDefendTarget, Target]
        # v7.8.27: Attacker from perceived actors (CastToAttacker already has NarrativeCharacter)
        - from: [CastToAttacker, AsNarrativeCharacter]
          to: [SetDefendTarget, TargetToAttack]
        - from: [CastToDefendGoal, Then]
          to: [SetDefendTarget, Exec]
        - from: [SetDefendTarget, Then]
          to: [StoreDefendGoal, Exec]
        - from: [CastToDefendGoal, AsGoal_Attack]
          to: [StoreDefendGoal, CurrentDefendGoal]
        - from: [StoreDefendGoal, Then]
          to: [GetActivityCompDef, Exec]
        - from: [GetActivityCompDef, ReturnValue]
          to: [AddDefendGoal, Target]
        - from: [CastToDefendGoal, AsGoal_Attack]
          to: [AddDefendGoal, NewGoal]
        - from: [GetActivityCompDef, Then]
          to: [AddDefendGoal, Exec]
        - from: [AddDefendGoal, ReturnValue]
          to: [BindDefendGoalRemoved, Target]
        - from: [AddDefendGoal, Then]
          to: [BindDefendGoalRemoved, Exec]
        - from: [BindDefendGoalRemoved, Then]
          to: [PrintDefending, Exec]
        # OnDefendGoalCompleted connections (triggered by OnGoalRemoved)
        - from: [Event_OnDefendGoalCompleted, Then]
          to: [SetDefendingFalse, Exec]
        - from: [SetDefendingFalse, Then]
          to: [ClearDefendGoalRef, Exec]
        - from: [ClearDefendGoalRef, Then]
          to: [PrintDefendComplete, Exec]
        # OnFollowDurationExpired connections
        - from: [Event_OnFollowDurationExpired, Then]
          to: [PrintGivingUp, Exec]
        - from: [PrintGivingUp, Then]
          to: [CallStopFollowing, Exec]

# ============================================================================
# TaggedDialogueSet_Returned - With dialogue blueprint references
# ============================================================================
tagged_dialogue_sets:  # STALKER
  - name: TaggedDialogueSet_Returned
    folder: Dialogue/TaggedSets
    dialogues:
      - tag: Narrative.TaggedDialogue.Returned.StartFollowing
        dialogue: DBP_Returned_StartFollow
        cooldown: 30.0
        max_distance: 5000.0
      - tag: Narrative.TaggedDialogue.Returned.Following.First
        dialogue: DBP_Returned_First
        cooldown: 30.0
        max_distance: 5000.0
      - tag: Narrative.TaggedDialogue.Returned.Following.Bonding
        dialogue: DBP_Returned_Bonding
        cooldown: 30.0
        max_distance: 5000.0
      - tag: Narrative.TaggedDialogue.Returned.Following.Deep
        dialogue: DBP_Returned_Deep
        cooldown: 30.0
        max_distance: 5000.0
      - tag: Narrative.TaggedDialogue.Returned.Defending
        dialogue: DBP_Returned_Defending
        cooldown: 5.0
        max_distance: 5000.0
      - tag: Narrative.TaggedDialogue.Returned.Attacking
        dialogue: DBP_Returned_Attacking
        cooldown: 5.0
        max_distance: 5000.0
      - tag: Narrative.TaggedDialogue.Returned.GivingUp
        dialogue: DBP_Returned_GivingUp
        cooldown: 30.0
        max_distance: 5000.0

# ============================================================================
# Dialogue Blueprints - Returned Stalker (7 placeholder dialogues)
# ============================================================================
dialogue_blueprints:  # STALKER DIALOGUES
  - name: DBP_Returned_StartFollow
    folder: Dialogue/Returned
    parent_class: Dialogue
    free_movement: true
    speakers:
      - npc_definition: NPC_ReturnedStalker
    dialogue_tree:
      root: start_node
      nodes:
        - id: start_node
          type: npc
          speaker: NPC_ReturnedStalker
          text: "*The creature tilts its head and begins following you*"
          duration: 2.0

  - name: DBP_Returned_First
    folder: Dialogue/Returned
    parent_class: Dialogue
    free_movement: true
    speakers:
      - npc_definition: NPC_ReturnedStalker
    dialogue_tree:
      root: first_node
      nodes:
        - id: first_node
          type: npc
          speaker: NPC_ReturnedStalker
          text: "*The creature makes a curious chirping sound*"
          duration: 2.0

  - name: DBP_Returned_Bonding
    folder: Dialogue/Returned
    parent_class: Dialogue
    free_movement: true
    speakers:
      - npc_definition: NPC_ReturnedStalker
    dialogue_tree:
      root: bonding_node
      nodes:
        - id: bonding_node
          type: npc
          speaker: NPC_ReturnedStalker
          text: "*The creature nuzzles closer, seeming more comfortable*"
          duration: 2.0

  - name: DBP_Returned_Deep
    folder: Dialogue/Returned
    parent_class: Dialogue
    free_movement: true
    speakers:
      - npc_definition: NPC_ReturnedStalker
    dialogue_tree:
      root: deep_node
      nodes:
        - id: deep_node
          type: npc
          speaker: NPC_ReturnedStalker
          text: "*The creature purrs contentedly, fully bonded*"
          duration: 2.0

  - name: DBP_Returned_Defending
    folder: Dialogue/Returned
    parent_class: Dialogue
    free_movement: true
    speakers:
      - npc_definition: NPC_ReturnedStalker
    dialogue_tree:
      root: defending_node
      nodes:
        - id: defending_node
          type: npc
          speaker: NPC_ReturnedStalker
          text: "*The creature SCREECHES and charges at your attacker!*"
          duration: 1.5

  - name: DBP_Returned_Attacking
    folder: Dialogue/Returned
    parent_class: Dialogue
    free_movement: true
    speakers:
      - npc_definition: NPC_ReturnedStalker
    dialogue_tree:
      root: attacking_node
      nodes:
        - id: attacking_node
          type: npc
          speaker: NPC_ReturnedStalker
          text: "*The creature's eyes turn RED as it lunges at YOU!*"
          duration: 1.5

  - name: DBP_Returned_GivingUp
    folder: Dialogue/Returned
    parent_class: Dialogue
    free_movement: true
    speakers:
      - npc_definition: NPC_ReturnedStalker
    dialogue_tree:
      root: givingup_node
      nodes:
        - id: givingup_node
          type: npc
          speaker: NPC_ReturnedStalker
          text: "*The creature loses interest and wanders away*"
          duration: 2.0

# ============================================================================
# END OF MANIFEST
# ============================================================================
