# v4.12.5 Registry-Aware Metadata Fix

## Summary

Fixed a correctness gap where decision paths (create/skip/conflict determination) only checked `UAssetUserData` for generator metadata, missing metadata stored in the central registry for `UDataAsset`, `UBlueprint`, and `UNiagaraSystem` assets.

## Problem

### Root Cause
`FGeneratorBase::GetAssetMetadata()` called `GeneratorMetadataHelpers::GetMetadata()` which only checks `UAssetUserData`. This missed registry-stored metadata because `UDataAsset` and `UBlueprint` don't implement `IInterface_AssetUserData` in UE5.7.

### Affected Decision Paths
1. **CheckExistsWithMetadata()** (GasAbilityGeneratorGenerators.cpp:1178) - skipped assets with registry-only metadata
2. **Window UI status** (GasAbilityGeneratorWindow.cpp:108) - showed "likely manual" for registry-backed assets

### Symptoms
- Generated `UDataAsset`/`UBlueprint` assets incorrectly classified as "manual"
- Regeneration skipped assets that should have been updated
- UI displayed false "No generator metadata (likely manual)" status

## Solution

### Approach
Replace pointer-based API (`UGeneratorAssetMetadata*`) with struct-based API (`FGeneratorMetadata`) in decision paths. The struct API (`GetMetadataEx()`) checks both `UAssetUserData` AND the central registry.

### Why Not "Fix" GetAssetMetadata()?
Creating transient `UGeneratorAssetMetadata` UObjects to wrap registry data would cause:
- GC/lifetime issues (who owns the transient object?)
- Risk of invalid pointers
- Potential package dirtying side effects

The safe approach: keep pointer API for `UAssetUserData`-only cases, use struct API for decision paths.

## Changes

### 1. New Helper: TryGetMetadata()
**File:** `GasAbilityGeneratorMetadata.h`

```cpp
inline bool TryGetMetadata(UObject* Asset, FGeneratorMetadata& OutMetadata)
{
    if (!Asset)
    {
        OutMetadata = FGeneratorMetadata();
        return false;
    }
    OutMetadata = GetMetadataEx(Asset);
    return OutMetadata.bIsGenerated;
}
```

- Single lookup (no double work)
- Null-safe
- Explicit success/failure contract
- Returns `bIsGenerated` to indicate "generated by us"

### 2. CheckExistsWithMetadata() Update
**File:** `GasAbilityGeneratorGenerators.cpp`

**Before:**
```cpp
UGeneratorAssetMetadata* Metadata = GetAssetMetadata(ExistingAsset);
if (!Metadata) { /* skip */ }
bool bInputChanged = Metadata->HasInputChanged(InputHash);
bool bOutputChanged = Metadata->HasOutputChanged(CurrentOutputHash);
```

**After:**
```cpp
FGeneratorMetadata Metadata;
if (!GeneratorMetadataHelpers::TryGetMetadata(ExistingAsset, Metadata)) { /* skip */ }
bool bInputChanged = Metadata.HasInputChanged(InputHash);
bool bOutputChanged = Metadata.HasOutputChanged(CurrentOutputHash);
```

### 3. Window.cpp Update
**File:** `GasAbilityGeneratorWindow.cpp`

- Added explicit `#include "GasAbilityGeneratorMetadata.h"` (compile-time guard rail)
- Same pattern as CheckExistsWithMetadata()

### 4. Locked Rule Added
**File:** `Architecture_Reference.md`

Decision paths must use registry-aware APIs:
- `GetMetadataEx()` - returns `FGeneratorMetadata` struct
- `HasMetadataEx()` - returns bool
- `TryGetMetadata()` - single lookup with explicit success/failure

**NEVER** use `GetMetadata()` or `GetAssetMetadata()` directly in decision paths.

## Verification

| Check | Status |
|-------|--------|
| `HasInputChanged()` / `HasOutputChanged()` are pure `!=` | Verified at lines 3906-3915 |
| `FGeneratorMetadata` struct has identical helpers | Verified - behavior identical |
| No transient UObject allocation | Confirmed - struct by value |
| CONFLICT/force/dry-run unchanged | Confirmed - only metadata retrieval changed |
| Explicit include added | Prevents transitive include brittleness |

## Testing

1. Build project
2. Clean generated assets folder
3. Run regeneration
4. Verify `UDataAsset`/`UBlueprint` assets no longer misclassified as manual
5. Verify CONFLICT detection still works for manually-edited assets

## Related Files

- `GasAbilityGeneratorMetadata.h` - TryGetMetadata() helper
- `GasAbilityGeneratorMetadata.cpp` - GetMetadataEx() implementation (unchanged)
- `GasAbilityGeneratorGenerators.cpp` - CheckExistsWithMetadata() fix
- `GasAbilityGeneratorWindow.cpp` - UI status fix
- `Architecture_Reference.md` - Locked rule documentation

## Session Context

This fix was developed through a GPT validation session with strict rules:
1. Check all claims against actual code
2. Challenge incorrect statements
3. Never accept by default
4. No code edits until explicitly approved

GPT raised valid concerns about:
- Pointer-based API cannot safely represent registry data
- `HasInputChanged()`/`HasOutputChanged()` semantics must be preserved
- Explicit includes prevent transitive brittleness

All concerns were verified and addressed.
