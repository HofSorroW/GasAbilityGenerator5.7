# v4.6 UX Safety System - Complete Process Map

## Table of Contents
1. [Design Decisions (LOCKED)](#1-design-decisions-locked)
2. [Data Schema](#2-data-schema)
3. [Complete Workflow A-Z](#3-complete-workflow-a-z)
4. [Safeguards Matrix](#4-safeguards-matrix)
5. [Implementation Status](#5-implementation-status)

---

## 1. Design Decisions (LOCKED)

### 1.1 Hash Policy (LOCKED)

| Outcome | Updates LastGeneratedHash? | Rationale |
|---------|---------------------------|-----------|
| Zero failures | YES | Assets match table state |
| Any failures (1+) | NO | Hash stays stale, "Out of date" persists |
| Warnings only | YES | Warnings don't block functionality |
| Skipped (unchanged) | YES | No action needed = up to date |

**Why this matters:** Prevents false "Up to date" status when generation partially failed.

### 1.2 Validation States (LOCKED)

| State | Color | Meaning | When Set |
|-------|-------|---------|----------|
| Unknown | Yellow | Needs validation | After edit, after restart, new row |
| Valid | Green | Passed validation | After successful validation |
| Invalid | Red | Has errors | After validation found issues |

**Status Bar Precedence (highest to lowest):**
1. **Errors (Red)** - `{N} errors` - validation errors exist
2. **Not validated (Yellow)** - `Not validated ({N})` - rows need validation
3. **Out of date (Amber)** - `Out of date` - validated but hash mismatch
4. **Up to date (Green)** - `Up to date` - all validated and generated

### 1.3 Soft Delete Strategy (LOCKED)

**Chosen: Option C - bDeleted flag**

| What Happens | Behavior |
|--------------|----------|
| Row marked bDeleted=true | Row stays in table, grayed out |
| During generation | Row is SKIPPED |
| Existing asset | UNTOUCHED (no delete, no modify) |
| Status bar | Shows `Deleted: {N}` count |
| XLSX export | Includes deleted rows (preserves data) |

**Why NOT other options:**
- Option A (move to _Trash folder): UE redirectors cause issues
- Option B (hard delete): Data loss, no undo

### 1.4 Window Title vs Status Bar (LOCKED)

| Location | Shows | Format |
|----------|-------|--------|
| **Window Title** | Save state (dirty/clean) | `NPC Table Editor` or `*NPC Table Editor` |
| **Status Bar** | Generation state | `Total: N │ Showing: N │ Selected: N │ [validation indicator]` |

**Why separated:** Different concerns - save state is about the file, generation state is about asset sync.

### 1.5 Save-before-Generate (LOCKED)

| Step | Action | Rationale |
|------|--------|-----------|
| 1 | User clicks "Generate" | Intent to create assets |
| 2 | **Silent auto-save of TableData** | Ensures generation uses persisted data |
| 3 | Validation runs | Gate check |
| 4 | Generation proceeds | Assets created |

**Why silent:** User intent is "generate", save is a side effect. No extra dialog.

### 1.6 Validation Gate (LOCKED)

| Condition | Dialog | Options |
|-----------|--------|---------|
| Errors = 0 | None | Proceed automatically |
| Errors > 0 | Blocking dialog | "Yes" = override and generate, "No" = cancel |

**Dialog content:**
```
Validation found {N} error(s).

[ERROR] NPCName.FieldName: Message
[ERROR] NPCName.FieldName: Message
... (up to 5)

... and {N} more errors

Errors may cause incomplete or broken asset generation.

Click 'Yes' to generate anyway (not recommended)
Click 'No' to cancel and fix issues first
```

### 1.7 Validation Cache (LOCKED)

**Chosen: Option A - Inline cache with discipline**

```cpp
// Per-row validation cache (Transient - not serialized)
UPROPERTY(Transient) EValidationState ValidationState;
UPROPERTY(Transient) FString ValidationSummary;
UPROPERTY(Transient) int32 ValidationIssueCount;
UPROPERTY(Transient) uint32 ValidationInputHash;
```

**Staleness Detection Recipe:**
```cpp
ValidationInputHash = Hash(
    Row.ComputeEditableFieldsHash() +  // Row content
    TableData->ListsVersionGuid +       // Asset list version
    TokenRegistryVersion                // Token spec version (future)
)
```

**Rules:**
- Cache is convenience only - validator is single source of truth
- Any row edit → `InvalidateValidation()` called
- `ListsVersionGuid` bump → all rows become stale
- Restart → transient fields reset to Unknown

---

## 2. Data Schema

### 2.1 UNPCTableData / UDialogueTableData

```cpp
// === Generation Tracking (v4.6) ===
UPROPERTY(VisibleAnywhere, Category = "Generation")
uint32 LastGeneratedHash = 0;

UPROPERTY(VisibleAnywhere, Category = "Generation")
FDateTime LastGeneratedTime;

UPROPERTY(VisibleAnywhere, Category = "Generation")
int32 LastGenerateFailureCount = 0;

// === Validation Versioning (v4.5) ===
UPROPERTY(EditAnywhere, Category = "Validation")
FGuid ListsVersionGuid;

// === Methods ===
uint32 ComputeAllRowsHash() const;      // Hash all row editable fields
bool AreAssetsOutOfDate() const;        // ComputeAllRowsHash() != LastGeneratedHash
void OnGenerationComplete(int32 FailureCount);  // Update tracking after generation
void BumpListsVersion();                // Invalidate all validation caches
```

### 2.2 FNPCTableRow / FDialogueTableRow

```cpp
// === Soft Delete (v4.6) ===
UPROPERTY(EditAnywhere, Category = "Meta")
bool bDeleted = false;

// === Validation Cache (v4.5, Transient) ===
UPROPERTY(Transient) EValidationState ValidationState = EValidationState::Unknown;
UPROPERTY(Transient) FString ValidationSummary;
UPROPERTY(Transient) int32 ValidationIssueCount = 0;
UPROPERTY(Transient) uint32 ValidationInputHash = 0;

// === Methods ===
void InvalidateValidation();           // Reset to Unknown state
uint32 ComputeEditableFieldsHash() const;  // Hash for staleness detection
EValidationState GetValidationState() const;
FLinearColor GetValidationColor() const;
```

### 2.3 EValidationState (Shared Enum)

```cpp
UENUM(BlueprintType)
enum class EValidationState : uint8
{
    Unknown UMETA(DisplayName = "Unknown"),   // Yellow - not validated
    Valid UMETA(DisplayName = "Valid"),       // Green - passed
    Invalid UMETA(DisplayName = "Invalid")    // Red - has errors
};
```

---

## 3. Complete Workflow A-Z

### 3.1 User Creates/Edits in UE Table Editor

```
┌─────────────────────────────────────────────────────────────────┐
│ USER ACTION: Edit cell in table                                 │
├─────────────────────────────────────────────────────────────────┤
│ 1. OnTextCommitted/OnCheckStateChanged fires                    │
│ 2. Row data updated                                             │
│ 3. Row.InvalidateValidation() called                            │
│    → ValidationState = Unknown (Yellow)                         │
│    → ValidationInputHash = 0                                    │
│ 4. MarkDirty() called                                           │
│    → Package marked dirty                                       │
│    → OnDirtyStateChanged delegate fires                         │
│ 5. UpdateTabLabel() called                                      │
│    → Window title becomes "*NPC Table Editor"                   │
│ 6. UpdateStatusBar() called                                     │
│    → Shows "Not validated (N)" in yellow                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 User Exports to XLSX

```
┌─────────────────────────────────────────────────────────────────┐
│ USER ACTION: Click "Export XLSX"                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. SyncToTableData() - ensure in-memory matches TableData       │
│ 2. File picker dialog opens                                     │
│ 3. XLSX file written with all columns including:                │
│    - All editable fields                                        │
│    - RowId (hidden column for sync identity)                    │
│    - bDeleted flag (for deleted row tracking)                   │
│ 4. Soft-deleted rows ARE exported (preserves data)              │
│ 5. Success message shown                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 User Edits in Excel

```
┌─────────────────────────────────────────────────────────────────┐
│ USER ACTION: Edit spreadsheet in Excel                          │
├─────────────────────────────────────────────────────────────────┤
│ (External to plugin - no tracking here)                         │
│                                                                 │
│ User can:                                                       │
│ - Edit any cell values                                          │
│ - Add new rows (RowId will be empty)                            │
│ - Delete rows (by removing from spreadsheet)                    │
│ - Reorder rows (RowId preserves identity)                       │
│ - Mark bDeleted=TRUE to soft-delete                             │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 User Imports from XLSX

```
┌─────────────────────────────────────────────────────────────────┐
│ USER ACTION: Click "Import XLSX"                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. File picker dialog opens                                     │
│ 2. XLSX parsed row by row                                       │
│ 3. For each row:                                                │
│    - If RowId exists in TableData → UPDATE existing row         │
│    - If RowId empty/missing → CREATE new row with new GUID      │
│ 4. All imported rows have InvalidateValidation() called         │
│    → All become Unknown (Yellow)                                │
│ 5. MarkDirty() called                                           │
│ 6. UpdateStatusBar() shows "Not validated (N)"                  │
│ 7. Success message with counts                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.5 User Clicks Validate

```
┌─────────────────────────────────────────────────────────────────┐
│ USER ACTION: Click "Validate"                                   │
├─────────────────────────────────────────────────────────────────┤
│ 1. Gather all non-deleted rows                                  │
│ 2. For each row, validator checks:                              │
│    - Required fields (NPCName, NPCId, etc.)                     │
│    - Duplicate detection (NPCId uniqueness)                     │
│    - Asset reference validity (Blueprint exists, etc.)          │
│    - Token syntax (Events/Conditions parsing)                   │
│    - Level range logic (MinLevel <= MaxLevel)                   │
│ 3. Results written to row cache:                                │
│    - ValidationState = Valid or Invalid                         │
│    - ValidationSummary = issue description                      │
│    - ValidationIssueCount = error + warning count               │
│    - ValidationInputHash = computed from current fields         │
│ 4. UpdateStatusBar() called                                     │
│    - If any Invalid → "N errors" (red)                          │
│    - If all Valid → check AreAssetsOutOfDate()                  │
│      - If out of date → "Out of date" (amber)                   │
│      - If up to date → "Up to date" (green)                     │
│ 5. Summary dialog shown                                         │
└─────────────────────────────────────────────────────────────────┘
```

### 3.6 User Clicks Generate

```
┌─────────────────────────────────────────────────────────────────┐
│ USER ACTION: Click "Generate"                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ STEP 0: SILENT SAVE                                             │
│ ─────────────────────                                           │
│ if (Package->IsDirty())                                         │
│     UPackage::SavePackage(...)                                  │
│     Log: "Auto-saved TableData before generation"               │
│                                                                 │
│ STEP 1: GATHER ROWS (skip soft-deleted)                         │
│ ────────────────────────────────────────                        │
│ for each row in AllRows:                                        │
│     if (row.bDeleted) → skip, increment DeletedCount            │
│     else → add to RowsToValidate                                │
│                                                                 │
│ if (RowsToValidate.Num() == 0)                                  │
│     Show message: "No active rows to generate"                  │
│     return                                                      │
│                                                                 │
│ STEP 2: VALIDATION                                              │
│ ──────────────────────                                          │
│ Run full validation on RowsToValidate                           │
│ Update all row caches with results                              │
│ Count errors                                                    │
│                                                                 │
│ STEP 3: VALIDATION GATE                                         │
│ ─────────────────────────                                       │
│ if (ErrorCount > 0)                                             │
│     Show blocking dialog with error list                        │
│     User choice:                                                │
│         "Yes" → continue (logged as override)                   │
│         "No"  → abort, return                                   │
│                                                                 │
│ STEP 4: ASSET GENERATION                                        │
│ ──────────────────────────                                      │
│ for each definition:                                            │
│     Result = FNPCDefinitionGenerator::Generate(def)             │
│     Track: GeneratedCount, SkippedCount, ErrorCount             │
│     Update row Status to Synced or Error                        │
│                                                                 │
│ STEP 5: UPDATE GENERATION TRACKING                              │
│ ────────────────────────────────────                            │
│ TableData->OnGenerationComplete(ErrorCount)                     │
│     → LastGeneratedTime = Now()                                 │
│     → LastGenerateFailureCount = ErrorCount                     │
│     → if (ErrorCount == 0)                                      │
│           LastGeneratedHash = ComputeAllRowsHash()              │
│       else                                                      │
│           Hash stays stale (correct!)                           │
│                                                                 │
│ STEP 6: SHOW RESULTS                                            │
│ ────────────────────────                                        │
│ Dialog shows:                                                   │
│     Generated: N                                                │
│     Skipped: N                                                  │
│     Errors: N                                                   │
│     Soft-deleted (skipped): N                                   │
│     [If ErrorCount==0] "Assets are now up to date!"             │
│     [If ErrorCount>0] "Some assets failed - run again"          │
└─────────────────────────────────────────────────────────────────┘
```

### 3.7 User Closes Editor

```
┌─────────────────────────────────────────────────────────────────┐
│ USER ACTION: Close tab/window                                   │
├─────────────────────────────────────────────────────────────────┤
│ 1. CanCloseTab() delegate fires                                 │
│ 2. Check IsTableDirty()                                         │
│    - If clean → allow close immediately                         │
│    - If dirty → show save prompt                                │
│                                                                 │
│ SAVE PROMPT DIALOG:                                             │
│ ───────────────────                                             │
│ "NPC Table has unsaved changes.                                 │
│  Do you want to save before closing?"                           │
│                                                                 │
│ [Yes] → OnSaveTable() called, then close                        │
│ [No]  → close without saving (changes lost)                     │
│ [Cancel] → abort close, stay in editor                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Safeguards Matrix

### 4.1 Data Loss Prevention

| Risk | Safeguard | Implementation |
|------|-----------|----------------|
| User forgets to save before Generate | **Auto-save before Generate** | `OnGenerateClicked()` Step 0 |
| User closes with unsaved changes | **Save-on-close prompt** | `CanCloseTab()` |
| User doesn't know file is dirty | **Dirty indicator (*)** | `UpdateTabLabel()` |
| Accidental row deletion | **Soft delete (bDeleted)** | Row stays, just skipped |
| Excel edits lose row identity | **RowId GUID tracking** | Survives reorder/filter |

### 4.2 Generation Safety

| Risk | Safeguard | Implementation |
|------|-----------|----------------|
| Generate with validation errors | **Validation gate dialog** | Blocking dialog, requires explicit override |
| Generate incomplete data | **Pre-generation validation** | Full validation before any asset creation |
| Partial failure looks like success | **Failure count tracking** | `LastGenerateFailureCount` persisted |
| Can't tell if assets match table | **Hash comparison** | `AreAssetsOutOfDate()` |
| Deleted rows generate orphan assets | **Soft delete skip** | `bDeleted` rows never sent to generator |
| Existing assets accidentally overwritten | **Soft delete preservation** | Existing assets untouched |

### 4.3 Visibility & Awareness

| Risk | Safeguard | Implementation |
|------|-----------|----------------|
| Don't know validation state | **Color-coded status bar** | Red/Yellow/Amber/Green |
| Don't know which rows have issues | **Per-row validation cache** | ValidationState per row |
| Don't know if regeneration needed | **"Out of date" indicator** | Amber status when hash mismatch |
| Status bar shows stale info | **Direct SetText() updates** | Bypasses Slate caching |
| Don't know deleted row count | **Deleted count in status** | Shown in result dialogs |

### 4.4 Conflict Prevention

| Risk | Safeguard | Implementation |
|------|-----------|----------------|
| Edit row during generation | **UI remains responsive** | Generation is synchronous but fast |
| Multiple editors on same data | **Package dirty tracking** | Standard UE package system |
| Excel import overwrites local changes | **RowId-based merge** | Existing rows updated, not replaced |
| Validation cache out of sync | **InvalidateValidation()** | Called on every edit |
| Asset list changes invalidate validation | **ListsVersionGuid** | Bump invalidates all caches |

---

## 5. Implementation Status

### 5.1 NPC Table Editor

| Feature | File | Status |
|---------|------|--------|
| Generation tracking fields | `NPCTableEditorTypes.h:379-420` | ✅ Implemented |
| bDeleted soft delete | `NPCTableEditorTypes.h:143-145` | ✅ Implemented |
| ComputeEditableFieldsHash | `NPCTableEditorTypes.h:188-210` | ✅ Implemented |
| AreAssetsOutOfDate | `NPCTableEditorTypes.h:405-408` | ✅ Implemented |
| OnGenerationComplete | `NPCTableEditorTypes.h:411-420` | ✅ Implemented |
| Save before Generate | `SNPCTableEditor.cpp:2298-2310` | ✅ Implemented |
| Soft delete skip | `SNPCTableEditor.cpp:2317-2328` | ✅ Implemented |
| Validation gate dialog | `SNPCTableEditor.cpp:2395-2413` | ✅ Implemented |
| Status bar generation state | `SNPCTableEditor.cpp:1872-1908` | ✅ Implemented |
| Dirty indicator (*) | `SNPCTableEditor.cpp:3317-3334` | ✅ Implemented |
| Save-on-close prompt | `SNPCTableEditor.cpp:3346-3373` | ✅ Implemented |
| OnDirtyStateChanged delegate | `SNPCTableEditor.h:227,238,395` | ✅ Implemented |

### 5.2 Dialogue Table Editor

| Feature | File | Status |
|---------|------|--------|
| Generation tracking fields | `DialogueTableEditorTypes.h:251-294` | ✅ Implemented |
| bDeleted soft delete | `DialogueTableEditorTypes.h:89-91` | ✅ Implemented |
| ComputeEditableFieldsHash | `DialogueTableEditorTypes.h:174-192` | ✅ Implemented |
| AreAssetsOutOfDate | `DialogueTableEditorTypes.h:279-282` | ✅ Implemented |
| OnGenerationComplete | `DialogueTableEditorTypes.h:285-294` | ✅ Implemented |
| Save before Generate | `SDialogueTableEditor.cpp:2184-2197` | ✅ Implemented |
| Soft delete skip | `SDialogueTableEditor.cpp:2203-2217` | ✅ Implemented |
| Validation gate dialog | `SDialogueTableEditor.cpp:2244-2275` | ✅ Implemented |
| Status bar generation state | `SDialogueTableEditor.cpp:1045-1110` | ✅ Implemented |
| Dirty indicator (*) | `SDialogueTableEditor.cpp:2874-2891` | ✅ Implemented |
| Save-on-close prompt | `SDialogueTableEditor.cpp:2903-2930` | ✅ Implemented |
| OnDirtyStateChanged delegate | `SDialogueTableEditor.h` | ✅ Implemented |

### 5.3 Version History

| Version | Changes |
|---------|---------|
| v4.5 | Validation system, EValidationState, ListsVersionGuid |
| v4.5.2 | Validation cache alignment between NPC/Dialogue |
| v4.6 | UX safety system - all features above |
| v4.6.1 | Status bar refinements, color precedence fix |

---

## 6. Quick Reference

### Status Bar Colors
```
RED    (1.0, 0.3, 0.3) = Validation errors exist
YELLOW (1.0, 0.9, 0.2) = Not validated yet
AMBER  (1.0, 0.7, 0.0) = Validated but out of date
GREEN  (0.3, 1.0, 0.3) = Up to date
```

### Key Methods
```cpp
// Row level
Row.InvalidateValidation()      // Reset to Unknown
Row.ComputeEditableFieldsHash() // Hash for staleness
Row.GetValidationState()        // Current state

// Table level
TableData->AreAssetsOutOfDate()           // Hash mismatch?
TableData->OnGenerationComplete(failures) // Update tracking
TableData->BumpListsVersion()             // Invalidate all caches

// Window level
UpdateStatusBar()  // Refresh status display
UpdateTabLabel()   // Update dirty indicator
CanCloseTab()      // Handle close with prompt
```

### Generate Flow Summary
```
Generate clicked
    ↓
Auto-save (silent)
    ↓
Gather non-deleted rows
    ↓
Run validation → update caches
    ↓
Errors? → [Yes] → Gate dialog → [No] → ABORT
    ↓              ↓
    ↓           [Override]
    ↓              ↓
    ←──────────────┘
    ↓
Generate assets
    ↓
Update tracking (hash only if 0 failures)
    ↓
Show results
```
